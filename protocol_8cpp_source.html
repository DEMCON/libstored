<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>libstored: src/protocol.cpp Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">libstored
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('protocol_8cpp_source.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">protocol.cpp</div>  </div>
</div><!--header-->
<div class="contents">
<a href="protocol_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;<span class="comment">/*</span></div><div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;<span class="comment"> * libstored, a Store for Embedded Debugger.</span></div><div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;<span class="comment"> * Copyright (C) 2020  Jochem Rutgers</span></div><div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;<span class="comment"> * This program is free software: you can redistribute it and/or modify</span></div><div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;<span class="comment"> * it under the terms of the GNU Lesser General Public License as published by</span></div><div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;<span class="comment"> * the Free Software Foundation, either version 3 of the License, or</span></div><div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;<span class="comment"> * (at your option) any later version.</span></div><div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;<span class="comment"> * This program is distributed in the hope that it will be useful,</span></div><div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;<span class="comment"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span></div><div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;<span class="comment"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span></div><div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;<span class="comment"> * GNU Lesser General Public License for more details.</span></div><div class="line"><a name="l00014"></a><span class="lineno">   14</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l00015"></a><span class="lineno">   15</span>&#160;<span class="comment"> * You should have received a copy of the GNU Lesser General Public License</span></div><div class="line"><a name="l00016"></a><span class="lineno">   16</span>&#160;<span class="comment"> * along with this program.  If not, see &lt;https://www.gnu.org/licenses/&gt;.</span></div><div class="line"><a name="l00017"></a><span class="lineno">   17</span>&#160;<span class="comment"> */</span></div><div class="line"><a name="l00018"></a><span class="lineno">   18</span>&#160;</div><div class="line"><a name="l00019"></a><span class="lineno">   19</span>&#160;<span class="preprocessor">#include &lt;<a class="code" href="protocol_8h.html">libstored/protocol.h</a>&gt;</span></div><div class="line"><a name="l00020"></a><span class="lineno">   20</span>&#160;<span class="preprocessor">#include &lt;<a class="code" href="util_8h.html">libstored/util.h</a>&gt;</span></div><div class="line"><a name="l00021"></a><span class="lineno">   21</span>&#160;<span class="preprocessor">#include &lt;<a class="code" href="poller_8h.html">libstored/poller.h</a>&gt;</span></div><div class="line"><a name="l00022"></a><span class="lineno">   22</span>&#160;</div><div class="line"><a name="l00023"></a><span class="lineno">   23</span>&#160;<span class="preprocessor">#ifdef STORED_OS_WINDOWS</span></div><div class="line"><a name="l00024"></a><span class="lineno">   24</span>&#160;<span class="preprocessor">#  include &lt;io.h&gt;</span></div><div class="line"><a name="l00025"></a><span class="lineno">   25</span>&#160;<span class="preprocessor">#  include &lt;fcntl.h&gt;</span></div><div class="line"><a name="l00026"></a><span class="lineno">   26</span>&#160;<span class="preprocessor">#elif !defined(STORED_OS_BAREMETAL)</span></div><div class="line"><a name="l00027"></a><span class="lineno">   27</span>&#160;<span class="preprocessor">#  include &lt;unistd.h&gt;</span></div><div class="line"><a name="l00028"></a><span class="lineno">   28</span>&#160;<span class="preprocessor">#  include &lt;fcntl.h&gt;</span></div><div class="line"><a name="l00029"></a><span class="lineno">   29</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l00030"></a><span class="lineno">   30</span>&#160;</div><div class="line"><a name="l00031"></a><span class="lineno">   31</span>&#160;<span class="preprocessor">#if defined(STORED_OS_WINDOWS)</span></div><div class="line"><a name="l00032"></a><span class="lineno">   32</span>&#160;<span class="comment">// NOLINTNEXTLINE(cppcoreguidelines-macro-usage)</span></div><div class="line"><a name="l00033"></a><span class="lineno">   33</span>&#160;<span class="preprocessor">#  define write(fd, buffer, count) _write(fd, buffer, (unsigned int)(count))</span></div><div class="line"><a name="l00034"></a><span class="lineno">   34</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l00035"></a><span class="lineno">   35</span>&#160;</div><div class="line"><a name="l00036"></a><span class="lineno">   36</span>&#160;<span class="preprocessor">#include &lt;algorithm&gt;</span></div><div class="line"><a name="l00037"></a><span class="lineno">   37</span>&#160;<span class="preprocessor">#include &lt;new&gt;</span></div><div class="line"><a name="l00038"></a><span class="lineno">   38</span>&#160;</div><div class="line"><a name="l00039"></a><span class="lineno">   39</span>&#160;<span class="keyword">namespace </span><a class="code" href="namespacestored.html">stored</a> {</div><div class="line"><a name="l00040"></a><span class="lineno">   40</span>&#160;</div><div class="line"><a name="l00041"></a><span class="lineno">   41</span>&#160;</div><div class="line"><a name="l00042"></a><span class="lineno">   42</span>&#160;</div><div class="line"><a name="l00044"></a><span class="lineno">   44</span>&#160;<span class="comment">// ProtocolLayer</span></div><div class="line"><a name="l00045"></a><span class="lineno">   45</span>&#160;<span class="comment">//</span></div><div class="line"><a name="l00046"></a><span class="lineno">   46</span>&#160;</div><div class="line"><a name="l00052"></a><span class="lineno"><a class="line" href="classstored_1_1_protocol_layer.html#a900026e43f2374c28e0cefcb6e002751">   52</a></span>&#160;<a class="code" href="classstored_1_1_protocol_layer.html#a900026e43f2374c28e0cefcb6e002751">ProtocolLayer::~ProtocolLayer</a>() {</div><div class="line"><a name="l00053"></a><span class="lineno">   53</span>&#160;    <span class="keywordflow">if</span>(<a class="code" href="classstored_1_1_protocol_layer.html#ac7cbd80b10e74166c661582027158b40">up</a>() &amp;&amp; <a class="code" href="classstored_1_1_protocol_layer.html#ac7cbd80b10e74166c661582027158b40">up</a>()-&gt;<a class="code" href="classstored_1_1_protocol_layer.html#ac9a6113262899388f922a6d466e9245a">down</a>() == <span class="keyword">this</span>)</div><div class="line"><a name="l00054"></a><span class="lineno">   54</span>&#160;        <a class="code" href="classstored_1_1_protocol_layer.html#ac7cbd80b10e74166c661582027158b40">up</a>()-&gt;<a class="code" href="classstored_1_1_protocol_layer.html#a2b2523892617a43cf7421a654bfc3b6c">setDown</a>(<a class="code" href="classstored_1_1_protocol_layer.html#ac9a6113262899388f922a6d466e9245a">down</a>());</div><div class="line"><a name="l00055"></a><span class="lineno">   55</span>&#160;    <span class="keywordflow">if</span>(<a class="code" href="classstored_1_1_protocol_layer.html#ac9a6113262899388f922a6d466e9245a">down</a>() &amp;&amp; <a class="code" href="classstored_1_1_protocol_layer.html#ac9a6113262899388f922a6d466e9245a">down</a>()-&gt;<a class="code" href="classstored_1_1_protocol_layer.html#ac7cbd80b10e74166c661582027158b40">up</a>() == <span class="keyword">this</span>)</div><div class="line"><a name="l00056"></a><span class="lineno">   56</span>&#160;        <a class="code" href="classstored_1_1_protocol_layer.html#ac9a6113262899388f922a6d466e9245a">down</a>()-&gt;<a class="code" href="classstored_1_1_protocol_layer.html#a43ca79c4b9503ce51f817ddc7fcd1cb5">setUp</a>(<a class="code" href="classstored_1_1_protocol_layer.html#ac7cbd80b10e74166c661582027158b40">up</a>());</div><div class="line"><a name="l00057"></a><span class="lineno">   57</span>&#160;}</div><div class="line"><a name="l00058"></a><span class="lineno">   58</span>&#160;</div><div class="line"><a name="l00059"></a><span class="lineno">   59</span>&#160;</div><div class="line"><a name="l00060"></a><span class="lineno">   60</span>&#160;</div><div class="line"><a name="l00061"></a><span class="lineno">   61</span>&#160;</div><div class="line"><a name="l00063"></a><span class="lineno">   63</span>&#160;<span class="comment">// AsciiEscapeLayer</span></div><div class="line"><a name="l00064"></a><span class="lineno">   64</span>&#160;<span class="comment">//</span></div><div class="line"><a name="l00065"></a><span class="lineno">   65</span>&#160;</div><div class="line"><a name="l00069"></a><span class="lineno"><a class="line" href="classstored_1_1_ascii_escape_layer.html#ad98a4887d4b5c0d8559c0b02e4cad982">   69</a></span>&#160;<a class="code" href="classstored_1_1_ascii_escape_layer.html#ab8b4f9f1ff917b09cb8853f8605a467c">AsciiEscapeLayer::AsciiEscapeLayer</a>(<span class="keywordtype">bool</span> all, <a class="code" href="classstored_1_1_protocol_layer.html">ProtocolLayer</a>* <a class="code" href="classstored_1_1_protocol_layer.html#ac7cbd80b10e74166c661582027158b40">up</a>, <a class="code" href="classstored_1_1_protocol_layer.html">ProtocolLayer</a>* <a class="code" href="classstored_1_1_protocol_layer.html#ac9a6113262899388f922a6d466e9245a">down</a>)</div><div class="line"><a name="l00070"></a><span class="lineno">   70</span>&#160;    : <a class="code" href="classstored_1_1_protocol_layer.html">base</a>(up, down)</div><div class="line"><a name="l00071"></a><span class="lineno">   71</span>&#160;    , m_all(all)</div><div class="line"><a name="l00072"></a><span class="lineno">   72</span>&#160;{}</div><div class="line"><a name="l00073"></a><span class="lineno">   73</span>&#160;</div><div class="line"><a name="l00074"></a><span class="lineno"><a class="line" href="classstored_1_1_ascii_escape_layer.html#a5acfb59ed33a8f0f3e27556421ff5245">   74</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classstored_1_1_ascii_escape_layer.html#a5acfb59ed33a8f0f3e27556421ff5245">AsciiEscapeLayer::decode</a>(<span class="keywordtype">void</span>* buffer, <span class="keywordtype">size_t</span> len) {</div><div class="line"><a name="l00075"></a><span class="lineno">   75</span>&#160;    <span class="keywordtype">char</span>* p = <span class="keyword">static_cast&lt;</span><span class="keywordtype">char</span>*<span class="keyword">&gt;</span>(buffer);</div><div class="line"><a name="l00076"></a><span class="lineno">   76</span>&#160;</div><div class="line"><a name="l00077"></a><span class="lineno">   77</span>&#160;    <span class="comment">// Common case: there is no escape character.</span></div><div class="line"><a name="l00078"></a><span class="lineno">   78</span>&#160;    <span class="keywordtype">size_t</span> i = 0;</div><div class="line"><a name="l00079"></a><span class="lineno">   79</span>&#160;    <span class="keywordflow">for</span>(; i + 1 &lt; len; i++)</div><div class="line"><a name="l00080"></a><span class="lineno">   80</span>&#160;        <span class="keywordflow">if</span>(<a class="code" href="group__libstored__util.html#gad8700448546b3b5111404cc021061fd5">unlikely</a>(p[i] == <a class="code" href="classstored_1_1_ascii_escape_layer.html#a3387a996b07c01ff22e8fadecda9277d">Esc</a> || p[i] == <span class="charliteral">&#39;\r&#39;</span>))</div><div class="line"><a name="l00081"></a><span class="lineno">   81</span>&#160;            <span class="keywordflow">goto</span> first_escape;</div><div class="line"><a name="l00082"></a><span class="lineno">   82</span>&#160;</div><div class="line"><a name="l00083"></a><span class="lineno">   83</span>&#160;    <span class="comment">// No escape characters.</span></div><div class="line"><a name="l00084"></a><span class="lineno">   84</span>&#160;    <a class="code" href="classstored_1_1_protocol_layer.html#a357b029311be09df61e019682a848ab5">base::decode</a>(buffer, len);</div><div class="line"><a name="l00085"></a><span class="lineno">   85</span>&#160;    <span class="keywordflow">return</span>;</div><div class="line"><a name="l00086"></a><span class="lineno">   86</span>&#160;</div><div class="line"><a name="l00087"></a><span class="lineno">   87</span>&#160;first_escape:</div><div class="line"><a name="l00088"></a><span class="lineno">   88</span>&#160;    <span class="comment">// Process escape sequences in-place.</span></div><div class="line"><a name="l00089"></a><span class="lineno">   89</span>&#160;    <span class="keywordtype">size_t</span> decodeOffset = i;</div><div class="line"><a name="l00090"></a><span class="lineno">   90</span>&#160;</div><div class="line"><a name="l00091"></a><span class="lineno">   91</span>&#160;    <span class="keywordflow">if</span>(p[i] == <span class="charliteral">&#39;\r&#39;</span>) {</div><div class="line"><a name="l00092"></a><span class="lineno">   92</span>&#160;        <span class="comment">// Just drop.</span></div><div class="line"><a name="l00093"></a><span class="lineno">   93</span>&#160;    } <span class="keywordflow">else</span> {</div><div class="line"><a name="l00094"></a><span class="lineno">   94</span>&#160;escape:</div><div class="line"><a name="l00095"></a><span class="lineno">   95</span>&#160;        <span class="keywordflow">if</span>(p[++i] == <a class="code" href="classstored_1_1_ascii_escape_layer.html#a3387a996b07c01ff22e8fadecda9277d">Esc</a>)</div><div class="line"><a name="l00096"></a><span class="lineno">   96</span>&#160;            p[decodeOffset] = (char)<a class="code" href="classstored_1_1_ascii_escape_layer.html#a3387a996b07c01ff22e8fadecda9277d">Esc</a>;</div><div class="line"><a name="l00097"></a><span class="lineno">   97</span>&#160;        <span class="keywordflow">else</span></div><div class="line"><a name="l00098"></a><span class="lineno">   98</span>&#160;            p[decodeOffset] = (char)((uint8_t)p[i] &amp; (uint8_t)<a class="code" href="classstored_1_1_ascii_escape_layer.html#a61f7a9fd55a71c7c6c73a0ff3d73b612">EscMask</a>);</div><div class="line"><a name="l00099"></a><span class="lineno">   99</span>&#160;        decodeOffset++;</div><div class="line"><a name="l00100"></a><span class="lineno">  100</span>&#160;    }</div><div class="line"><a name="l00101"></a><span class="lineno">  101</span>&#160;    i++;</div><div class="line"><a name="l00102"></a><span class="lineno">  102</span>&#160;</div><div class="line"><a name="l00103"></a><span class="lineno">  103</span>&#160;    <span class="comment">// The + 1 prevents it from trying to decode an escape character at the end.</span></div><div class="line"><a name="l00104"></a><span class="lineno">  104</span>&#160;    <span class="keywordflow">for</span>(; i + 1 &lt; len; i++, decodeOffset++) {</div><div class="line"><a name="l00105"></a><span class="lineno">  105</span>&#160;        <span class="keywordflow">if</span>(<a class="code" href="group__libstored__util.html#gad8700448546b3b5111404cc021061fd5">unlikely</a>(p[i] == <a class="code" href="classstored_1_1_ascii_escape_layer.html#a3387a996b07c01ff22e8fadecda9277d">Esc</a>))</div><div class="line"><a name="l00106"></a><span class="lineno">  106</span>&#160;            <span class="keywordflow">goto</span> escape;</div><div class="line"><a name="l00107"></a><span class="lineno">  107</span>&#160;        <span class="keywordflow">else</span> <span class="keywordflow">if</span>(<a class="code" href="group__libstored__util.html#gad8700448546b3b5111404cc021061fd5">unlikely</a>(p[i] == <span class="charliteral">&#39;\r&#39;</span>))</div><div class="line"><a name="l00108"></a><span class="lineno">  108</span>&#160;            decodeOffset--;</div><div class="line"><a name="l00109"></a><span class="lineno">  109</span>&#160;        <span class="keywordflow">else</span></div><div class="line"><a name="l00110"></a><span class="lineno">  110</span>&#160;            p[decodeOffset] = p[i];</div><div class="line"><a name="l00111"></a><span class="lineno">  111</span>&#160;    }</div><div class="line"><a name="l00112"></a><span class="lineno">  112</span>&#160;</div><div class="line"><a name="l00113"></a><span class="lineno">  113</span>&#160;    <span class="comment">// Always add the last character (if any).</span></div><div class="line"><a name="l00114"></a><span class="lineno">  114</span>&#160;    <span class="keywordflow">if</span>(i &lt; len)</div><div class="line"><a name="l00115"></a><span class="lineno">  115</span>&#160;        p[decodeOffset++] = p[i];</div><div class="line"><a name="l00116"></a><span class="lineno">  116</span>&#160;    <a class="code" href="classstored_1_1_protocol_layer.html#a357b029311be09df61e019682a848ab5">base::decode</a>(p, decodeOffset);</div><div class="line"><a name="l00117"></a><span class="lineno">  117</span>&#160;}</div><div class="line"><a name="l00118"></a><span class="lineno">  118</span>&#160;</div><div class="line"><a name="l00119"></a><span class="lineno"><a class="line" href="classstored_1_1_ascii_escape_layer.html#a67ca09a867826eb4f22e9b7f78ceb0b6">  119</a></span>&#160;<span class="keywordtype">char</span> <a class="code" href="classstored_1_1_ascii_escape_layer.html#a67ca09a867826eb4f22e9b7f78ceb0b6">AsciiEscapeLayer::needEscape</a>(<span class="keywordtype">char</span> c)<span class="keyword"> const </span>{</div><div class="line"><a name="l00120"></a><span class="lineno">  120</span>&#160;    <span class="keywordflow">if</span>(!((uint8_t)c &amp; (uint8_t)~(uint8_t)<a class="code" href="classstored_1_1_ascii_escape_layer.html#a61f7a9fd55a71c7c6c73a0ff3d73b612">AsciiEscapeLayer::EscMask</a>)) {</div><div class="line"><a name="l00121"></a><span class="lineno">  121</span>&#160;        <span class="keywordflow">if</span>(!m_all) {</div><div class="line"><a name="l00122"></a><span class="lineno">  122</span>&#160;            <span class="comment">// Only escape what conflicts with other protocols.</span></div><div class="line"><a name="l00123"></a><span class="lineno">  123</span>&#160;            <span class="keywordflow">switch</span>(c) {</div><div class="line"><a name="l00124"></a><span class="lineno">  124</span>&#160;            <span class="keywordflow">case</span> <span class="charliteral">&#39;\0&#39;</span>:</div><div class="line"><a name="l00125"></a><span class="lineno">  125</span>&#160;            <span class="keywordflow">case</span> <span class="stringliteral">&#39;\x11&#39;</span>: <span class="comment">// XON</span></div><div class="line"><a name="l00126"></a><span class="lineno">  126</span>&#160;            <span class="keywordflow">case</span> <span class="stringliteral">&#39;\x13&#39;</span>: <span class="comment">// XOFF</span></div><div class="line"><a name="l00127"></a><span class="lineno">  127</span>&#160;            <span class="keywordflow">case</span> <span class="stringliteral">&#39;\x1b&#39;</span>: <span class="comment">// ESC</span></div><div class="line"><a name="l00128"></a><span class="lineno">  128</span>&#160;            <span class="keywordflow">case</span> <span class="charliteral">&#39;\r&#39;</span>:</div><div class="line"><a name="l00129"></a><span class="lineno">  129</span>&#160;                <span class="comment">// Do escape \r, as Windows may inject it automatically.  So, if \r</span></div><div class="line"><a name="l00130"></a><span class="lineno">  130</span>&#160;                <span class="comment">// is meant to be sent, escape it, such that the client may remove</span></div><div class="line"><a name="l00131"></a><span class="lineno">  131</span>&#160;                <span class="comment">// all (unescaped) \r&#39;s automatically.</span></div><div class="line"><a name="l00132"></a><span class="lineno">  132</span>&#160;                <span class="keywordflow">break</span>;</div><div class="line"><a name="l00133"></a><span class="lineno">  133</span>&#160;</div><div class="line"><a name="l00134"></a><span class="lineno">  134</span>&#160;            <span class="keywordflow">default</span>:</div><div class="line"><a name="l00135"></a><span class="lineno">  135</span>&#160;                <span class="comment">// Don&#39;t escape.</span></div><div class="line"><a name="l00136"></a><span class="lineno">  136</span>&#160;                <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l00137"></a><span class="lineno">  137</span>&#160;            }</div><div class="line"><a name="l00138"></a><span class="lineno">  138</span>&#160;        }</div><div class="line"><a name="l00139"></a><span class="lineno">  139</span>&#160;        <span class="keywordflow">return</span> (<span class="keywordtype">char</span>)((uint8_t)c | 0x40u);</div><div class="line"><a name="l00140"></a><span class="lineno">  140</span>&#160;    } <span class="keywordflow">else</span> <span class="keywordflow">if</span>(c == <a class="code" href="classstored_1_1_ascii_escape_layer.html#a3387a996b07c01ff22e8fadecda9277d">AsciiEscapeLayer::Esc</a>) {</div><div class="line"><a name="l00141"></a><span class="lineno">  141</span>&#160;        <span class="keywordflow">return</span> c;</div><div class="line"><a name="l00142"></a><span class="lineno">  142</span>&#160;    } <span class="keywordflow">else</span> {</div><div class="line"><a name="l00143"></a><span class="lineno">  143</span>&#160;        <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l00144"></a><span class="lineno">  144</span>&#160;    }</div><div class="line"><a name="l00145"></a><span class="lineno">  145</span>&#160;}</div><div class="line"><a name="l00146"></a><span class="lineno">  146</span>&#160;</div><div class="line"><a name="l00147"></a><span class="lineno"><a class="line" href="classstored_1_1_ascii_escape_layer.html#a3db26741f80800ade6a58055dc89b5ee">  147</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classstored_1_1_protocol_layer.html#a66c24cec6a17c44fac68213d358a5aa8">AsciiEscapeLayer::encode</a>(<span class="keywordtype">void</span> <span class="keyword">const</span>* buffer, <span class="keywordtype">size_t</span> len, <span class="keywordtype">bool</span> last) {</div><div class="line"><a name="l00148"></a><span class="lineno">  148</span>&#160;    uint8_t <span class="keyword">const</span>* p = <span class="keyword">static_cast&lt;</span>uint8_t <a class="code" href="namespaceed2_1_1gui_1_1____main____.html#a3c1fe823c9bbaf7e7dcef9ecc9fcb915">const</a>*<span class="keyword">&gt;</span>(buffer);</div><div class="line"><a name="l00149"></a><span class="lineno">  149</span>&#160;    uint8_t <span class="keyword">const</span>* chunk = p;</div><div class="line"><a name="l00150"></a><span class="lineno">  150</span>&#160;</div><div class="line"><a name="l00151"></a><span class="lineno">  151</span>&#160;    <span class="keywordflow">for</span>(<span class="keywordtype">size_t</span> i = 0; i &lt; len; i++) {</div><div class="line"><a name="l00152"></a><span class="lineno">  152</span>&#160;        <span class="keywordtype">char</span> escaped = <a class="code" href="classstored_1_1_ascii_escape_layer.html#a67ca09a867826eb4f22e9b7f78ceb0b6">needEscape</a>((<span class="keywordtype">char</span>)p[i]);</div><div class="line"><a name="l00153"></a><span class="lineno">  153</span>&#160;        <span class="keywordflow">if</span>(<a class="code" href="group__libstored__util.html#gad8700448546b3b5111404cc021061fd5">unlikely</a>(escaped)) {</div><div class="line"><a name="l00154"></a><span class="lineno">  154</span>&#160;            <span class="comment">// This is a to-be-escaped byte.</span></div><div class="line"><a name="l00155"></a><span class="lineno">  155</span>&#160;            <span class="keywordflow">if</span>(chunk &lt; p + i)</div><div class="line"><a name="l00156"></a><span class="lineno">  156</span>&#160;                <a class="code" href="classstored_1_1_protocol_layer.html#a66c24cec6a17c44fac68213d358a5aa8">base::encode</a>(chunk, (<span class="keywordtype">size_t</span>)(p + i - chunk), <span class="keyword">false</span>);</div><div class="line"><a name="l00157"></a><span class="lineno">  157</span>&#160;</div><div class="line"><a name="l00158"></a><span class="lineno">  158</span>&#160;            uint8_t <span class="keyword">const</span> esc[2] = { <a class="code" href="classstored_1_1_ascii_escape_layer.html#a3387a996b07c01ff22e8fadecda9277d">AsciiEscapeLayer::Esc</a>, (uint8_t)escaped };</div><div class="line"><a name="l00159"></a><span class="lineno">  159</span>&#160;            <a class="code" href="classstored_1_1_protocol_layer.html#a66c24cec6a17c44fac68213d358a5aa8">base::encode</a>(esc, <span class="keyword">sizeof</span>(esc), last &amp;&amp; i + 1 == len);</div><div class="line"><a name="l00160"></a><span class="lineno">  160</span>&#160;            chunk = p + i + 1;</div><div class="line"><a name="l00161"></a><span class="lineno">  161</span>&#160;        }</div><div class="line"><a name="l00162"></a><span class="lineno">  162</span>&#160;    }</div><div class="line"><a name="l00163"></a><span class="lineno">  163</span>&#160;</div><div class="line"><a name="l00164"></a><span class="lineno">  164</span>&#160;    <span class="keywordflow">if</span>(<a class="code" href="group__libstored__util.html#gaa0672ea7123854cc5f51902a06c473fb">likely</a>(chunk &lt; p + len) || (len == 0 &amp;&amp; last))</div><div class="line"><a name="l00165"></a><span class="lineno">  165</span>&#160;        <a class="code" href="classstored_1_1_protocol_layer.html#a66c24cec6a17c44fac68213d358a5aa8">base::encode</a>(chunk, (<span class="keywordtype">size_t</span>)(p + len - chunk), last);</div><div class="line"><a name="l00166"></a><span class="lineno">  166</span>&#160;}</div><div class="line"><a name="l00167"></a><span class="lineno">  167</span>&#160;</div><div class="line"><a name="l00168"></a><span class="lineno"><a class="line" href="classstored_1_1_ascii_escape_layer.html#ac773513d7ef5330f9fc7b46f08e79442">  168</a></span>&#160;<span class="keywordtype">size_t</span> <a class="code" href="classstored_1_1_ascii_escape_layer.html#ac773513d7ef5330f9fc7b46f08e79442">AsciiEscapeLayer::mtu</a>()<span class="keyword"> const </span>{</div><div class="line"><a name="l00169"></a><span class="lineno">  169</span>&#160;    <span class="keywordtype">size_t</span> <a class="code" href="classstored_1_1_ascii_escape_layer.html#ac773513d7ef5330f9fc7b46f08e79442">mtu</a> = <a class="code" href="classstored_1_1_protocol_layer.html#a88195d7cdb7129ac7bc625ffeb24d449">base::mtu</a>();</div><div class="line"><a name="l00170"></a><span class="lineno">  170</span>&#160;    <span class="keywordflow">if</span>(mtu == 0u)</div><div class="line"><a name="l00171"></a><span class="lineno">  171</span>&#160;        <span class="keywordflow">return</span> 0u;</div><div class="line"><a name="l00172"></a><span class="lineno">  172</span>&#160;    <span class="keywordflow">if</span>(mtu == 1u)</div><div class="line"><a name="l00173"></a><span class="lineno">  173</span>&#160;        <span class="keywordflow">return</span> 1u;</div><div class="line"><a name="l00174"></a><span class="lineno">  174</span>&#160;    <span class="keywordflow">return</span> mtu / 2u;</div><div class="line"><a name="l00175"></a><span class="lineno">  175</span>&#160;}</div><div class="line"><a name="l00176"></a><span class="lineno">  176</span>&#160;</div><div class="line"><a name="l00177"></a><span class="lineno">  177</span>&#160;</div><div class="line"><a name="l00178"></a><span class="lineno">  178</span>&#160;</div><div class="line"><a name="l00179"></a><span class="lineno">  179</span>&#160;</div><div class="line"><a name="l00180"></a><span class="lineno">  180</span>&#160;</div><div class="line"><a name="l00182"></a><span class="lineno">  182</span>&#160;<span class="comment">// TerminalLayer</span></div><div class="line"><a name="l00183"></a><span class="lineno">  183</span>&#160;<span class="comment">//</span></div><div class="line"><a name="l00184"></a><span class="lineno">  184</span>&#160;</div><div class="line"><a name="l00185"></a><span class="lineno">  185</span>&#160;<span class="preprocessor">#if STORED_cplusplus &lt; 201103L</span></div><div class="line"><a name="l00186"></a><span class="lineno">  186</span>&#160;</div><div class="line"><a name="l00190"></a><span class="lineno">  190</span>&#160;<a class="code" href="classstored_1_1_terminal_layer.html#ae159ad7d286f1f1f456f4fe42e9955b7">TerminalLayer::TerminalLayer</a>(NonDebugDecodeCallback* cb, <a class="code" href="classstored_1_1_protocol_layer.html">ProtocolLayer</a>* <a class="code" href="classstored_1_1_protocol_layer.html#ac7cbd80b10e74166c661582027158b40">up</a>, <a class="code" href="classstored_1_1_protocol_layer.html">ProtocolLayer</a>* <a class="code" href="classstored_1_1_protocol_layer.html#ac9a6113262899388f922a6d466e9245a">down</a>)</div><div class="line"><a name="l00191"></a><span class="lineno">  191</span>&#160;    : <a class="code" href="classstored_1_1_ascii_escape_layer.html#ad942b156ae7ac142b44f742ed5dca3a9">base</a>(up, down)</div><div class="line"><a name="l00192"></a><span class="lineno">  192</span>&#160;    , m_nonDebugDecodeCallback(cb)</div><div class="line"><a name="l00193"></a><span class="lineno">  193</span>&#160;    , m_decodeState(StateNormal)</div><div class="line"><a name="l00194"></a><span class="lineno">  194</span>&#160;    , m_encodeState()</div><div class="line"><a name="l00195"></a><span class="lineno">  195</span>&#160;{</div><div class="line"><a name="l00196"></a><span class="lineno">  196</span>&#160;}</div><div class="line"><a name="l00197"></a><span class="lineno">  197</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l00198"></a><span class="lineno">  198</span>&#160;</div><div class="line"><a name="l00199"></a><span class="lineno"><a class="line" href="classstored_1_1_terminal_layer.html#a9d49899bffb69f90ad0a25ba1b3b017c">  199</a></span>&#160;<a class="code" href="classstored_1_1_terminal_layer.html#ae159ad7d286f1f1f456f4fe42e9955b7">TerminalLayer::TerminalLayer</a>(<a class="code" href="classstored_1_1_protocol_layer.html">ProtocolLayer</a>* up, <a class="code" href="classstored_1_1_protocol_layer.html">ProtocolLayer</a>* down)</div><div class="line"><a name="l00200"></a><span class="lineno">  200</span>&#160;    : <a class="code" href="classstored_1_1_protocol_layer.html">base</a>(up, down)</div><div class="line"><a name="l00201"></a><span class="lineno">  201</span>&#160;#if <a class="code" href="macros_8h.html#aa64cd2b6d63a68c9c8ec5fba4000cf8f">STORED_cplusplus</a> &lt; 201103L</div><div class="line"><a name="l00202"></a><span class="lineno">  202</span>&#160;    , m_nonDebugDecodeCallback()</div><div class="line"><a name="l00203"></a><span class="lineno">  203</span>&#160;#endif</div><div class="line"><a name="l00204"></a><span class="lineno">  204</span>&#160;    , m_decodeState(StateNormal)</div><div class="line"><a name="l00205"></a><span class="lineno">  205</span>&#160;    , m_encodeState()</div><div class="line"><a name="l00206"></a><span class="lineno">  206</span>&#160;{</div><div class="line"><a name="l00207"></a><span class="lineno">  207</span>&#160;}</div><div class="line"><a name="l00208"></a><span class="lineno">  208</span>&#160;</div><div class="line"><a name="l00209"></a><span class="lineno"><a class="line" href="classstored_1_1_terminal_layer.html#aa520c45c348439dbf7a56f511bd5ac39">  209</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classstored_1_1_terminal_layer.html#aa520c45c348439dbf7a56f511bd5ac39">TerminalLayer::reset</a>() {</div><div class="line"><a name="l00210"></a><span class="lineno">  210</span>&#160;    m_decodeState = StateNormal;</div><div class="line"><a name="l00211"></a><span class="lineno">  211</span>&#160;    m_encodeState = <span class="keyword">false</span>;</div><div class="line"><a name="l00212"></a><span class="lineno">  212</span>&#160;    m_buffer.clear();</div><div class="line"><a name="l00213"></a><span class="lineno">  213</span>&#160;    <a class="code" href="classstored_1_1_protocol_layer.html#a53fe78a7b405b981649112d9c84fe762">base::reset</a>();</div><div class="line"><a name="l00214"></a><span class="lineno">  214</span>&#160;}</div><div class="line"><a name="l00215"></a><span class="lineno">  215</span>&#160;</div><div class="line"><a name="l00219"></a><span class="lineno">  219</span>&#160;<a class="code" href="classstored_1_1_terminal_layer.html#a9c91e6d99a16671d0e78c120288a1bda">TerminalLayer::~TerminalLayer</a>() <a class="code" href="util_8h.html#a5e97f6533b7a0a1e8b49c4cea10f75fc">is_default</a></div><div class="line"><a name="l00220"></a><span class="lineno">  220</span>&#160;</div><div class="line"><a name="l00221"></a><span class="lineno"><a class="line" href="classstored_1_1_terminal_layer.html#a189c272877b09b93aac1b1ddc96fe58c">  221</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classstored_1_1_terminal_layer.html#a189c272877b09b93aac1b1ddc96fe58c">TerminalLayer::decode</a>(<span class="keywordtype">void</span>* buffer, <span class="keywordtype">size_t</span> len) {</div><div class="line"><a name="l00222"></a><span class="lineno">  222</span>&#160;    <span class="keywordtype">size_t</span> nonDebugOffset = m_decodeState &lt; StateDebug ? 0 : len;</div><div class="line"><a name="l00223"></a><span class="lineno">  223</span>&#160;</div><div class="line"><a name="l00224"></a><span class="lineno">  224</span>&#160;    <span class="keywordflow">for</span>(<span class="keywordtype">size_t</span> i = 0; i &lt; len; i++) {</div><div class="line"><a name="l00225"></a><span class="lineno">  225</span>&#160;        <span class="keywordtype">char</span> c = (<span class="keyword">static_cast&lt;</span><span class="keywordtype">char</span>*<span class="keyword">&gt;</span>(buffer))[i];</div><div class="line"><a name="l00226"></a><span class="lineno">  226</span>&#160;</div><div class="line"><a name="l00227"></a><span class="lineno">  227</span>&#160;        <span class="keywordflow">switch</span>(m_decodeState) {</div><div class="line"><a name="l00228"></a><span class="lineno">  228</span>&#160;        <span class="keywordflow">case</span> StateNormal:</div><div class="line"><a name="l00229"></a><span class="lineno">  229</span>&#160;            <span class="keywordflow">if</span>(<a class="code" href="group__libstored__util.html#gad8700448546b3b5111404cc021061fd5">unlikely</a>(c == <a class="code" href="classstored_1_1_terminal_layer.html#a892633ca69a59684c9a964600c0cc181">Esc</a>))</div><div class="line"><a name="l00230"></a><span class="lineno">  230</span>&#160;                m_decodeState = StateNormalEsc;</div><div class="line"><a name="l00231"></a><span class="lineno">  231</span>&#160;            <span class="keywordflow">break</span>;</div><div class="line"><a name="l00232"></a><span class="lineno">  232</span>&#160;        <span class="keywordflow">case</span> StateNormalEsc:</div><div class="line"><a name="l00233"></a><span class="lineno">  233</span>&#160;            <span class="keywordflow">if</span>(<a class="code" href="group__libstored__util.html#gaa0672ea7123854cc5f51902a06c473fb">likely</a>(c == <a class="code" href="classstored_1_1_terminal_layer.html#a641d9407a8c7517bcbfb3748b86fa43d">EscStart</a>)) {</div><div class="line"><a name="l00234"></a><span class="lineno">  234</span>&#160;                <span class="keywordflow">if</span>(i - nonDebugOffset &gt; 1u)</div><div class="line"><a name="l00235"></a><span class="lineno">  235</span>&#160;                    <a class="code" href="classstored_1_1_terminal_layer.html#a3708a9baaf0751fd543e8290f6b008c3">nonDebugDecode</a>(static_cast&lt;char*&gt;(buffer) + nonDebugOffset, i - nonDebugOffset - 1); <span class="comment">// Also skip the ESC</span></div><div class="line"><a name="l00236"></a><span class="lineno">  236</span>&#160;                m_decodeState = StateDebug;</div><div class="line"><a name="l00237"></a><span class="lineno">  237</span>&#160;                nonDebugOffset = len;</div><div class="line"><a name="l00238"></a><span class="lineno">  238</span>&#160;            } <span class="keywordflow">else</span></div><div class="line"><a name="l00239"></a><span class="lineno">  239</span>&#160;                m_decodeState = StateNormal;</div><div class="line"><a name="l00240"></a><span class="lineno">  240</span>&#160;            <span class="keywordflow">break</span>;</div><div class="line"><a name="l00241"></a><span class="lineno">  241</span>&#160;        <span class="keywordflow">case</span> StateDebug:</div><div class="line"><a name="l00242"></a><span class="lineno">  242</span>&#160;            <span class="keywordflow">if</span>(<a class="code" href="group__libstored__util.html#gad8700448546b3b5111404cc021061fd5">unlikely</a>(c == <a class="code" href="classstored_1_1_terminal_layer.html#a892633ca69a59684c9a964600c0cc181">Esc</a>))</div><div class="line"><a name="l00243"></a><span class="lineno">  243</span>&#160;                m_decodeState = StateDebugEsc;</div><div class="line"><a name="l00244"></a><span class="lineno">  244</span>&#160;            <span class="keywordflow">else</span></div><div class="line"><a name="l00245"></a><span class="lineno">  245</span>&#160;                m_buffer.push_back(c);</div><div class="line"><a name="l00246"></a><span class="lineno">  246</span>&#160;            <span class="keywordflow">break</span>;</div><div class="line"><a name="l00247"></a><span class="lineno">  247</span>&#160;        <span class="keywordflow">case</span> StateDebugEsc:</div><div class="line"><a name="l00248"></a><span class="lineno">  248</span>&#160;            <span class="keywordflow">if</span>(<a class="code" href="group__libstored__util.html#gaa0672ea7123854cc5f51902a06c473fb">likely</a>(c == <a class="code" href="classstored_1_1_terminal_layer.html#a16632f9e5395384bc8db6940eb26259f">EscEnd</a>)) {</div><div class="line"><a name="l00249"></a><span class="lineno">  249</span>&#160;                <a class="code" href="classstored_1_1_protocol_layer.html#a357b029311be09df61e019682a848ab5">base::decode</a>(&amp;m_buffer[0], m_buffer.size());</div><div class="line"><a name="l00250"></a><span class="lineno">  250</span>&#160;                m_decodeState = StateNormal;</div><div class="line"><a name="l00251"></a><span class="lineno">  251</span>&#160;                m_buffer.clear();</div><div class="line"><a name="l00252"></a><span class="lineno">  252</span>&#160;                nonDebugOffset = i + 1;</div><div class="line"><a name="l00253"></a><span class="lineno">  253</span>&#160;            } <span class="keywordflow">else</span> {</div><div class="line"><a name="l00254"></a><span class="lineno">  254</span>&#160;                m_decodeState = StateDebug;</div><div class="line"><a name="l00255"></a><span class="lineno">  255</span>&#160;                m_buffer.push_back((<span class="keywordtype">char</span>)<a class="code" href="classstored_1_1_terminal_layer.html#a892633ca69a59684c9a964600c0cc181">Esc</a>);</div><div class="line"><a name="l00256"></a><span class="lineno">  256</span>&#160;                m_buffer.push_back(c);</div><div class="line"><a name="l00257"></a><span class="lineno">  257</span>&#160;            }</div><div class="line"><a name="l00258"></a><span class="lineno">  258</span>&#160;            <span class="keywordflow">break</span>;</div><div class="line"><a name="l00259"></a><span class="lineno">  259</span>&#160;        }</div><div class="line"><a name="l00260"></a><span class="lineno">  260</span>&#160;    }</div><div class="line"><a name="l00261"></a><span class="lineno">  261</span>&#160;</div><div class="line"><a name="l00262"></a><span class="lineno">  262</span>&#160;    <span class="keywordflow">if</span>(nonDebugOffset &lt; len)</div><div class="line"><a name="l00263"></a><span class="lineno">  263</span>&#160;        <a class="code" href="classstored_1_1_terminal_layer.html#a3708a9baaf0751fd543e8290f6b008c3">nonDebugDecode</a>(static_cast&lt;char*&gt;(buffer) + nonDebugOffset, len - nonDebugOffset);</div><div class="line"><a name="l00264"></a><span class="lineno">  264</span>&#160;}</div><div class="line"><a name="l00265"></a><span class="lineno">  265</span>&#160;</div><div class="line"><a name="l00266"></a><span class="lineno"><a class="line" href="classstored_1_1_terminal_layer.html#a2a0470a57c3c8065cb28b49d9101d533">  266</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classstored_1_1_terminal_layer.html#a2a0470a57c3c8065cb28b49d9101d533">TerminalLayer::nonDebugEncode</a>(<span class="keywordtype">void</span>* buffer, <span class="keywordtype">size_t</span> len) {</div><div class="line"><a name="l00267"></a><span class="lineno">  267</span>&#160;    <a class="code" href="group__libstored__util.html#gab750e51b876450a0a4ad419588a82a4d">stored_assert</a>(!m_encodeState);</div><div class="line"><a name="l00268"></a><span class="lineno">  268</span>&#160;    <a class="code" href="classstored_1_1_protocol_layer.html#a66c24cec6a17c44fac68213d358a5aa8">encode</a>(buffer, len, <span class="keyword">true</span>);</div><div class="line"><a name="l00269"></a><span class="lineno">  269</span>&#160;}</div><div class="line"><a name="l00270"></a><span class="lineno">  270</span>&#160;</div><div class="line"><a name="l00276"></a><span class="lineno"><a class="line" href="classstored_1_1_terminal_layer.html#a3708a9baaf0751fd543e8290f6b008c3">  276</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classstored_1_1_terminal_layer.html#a3708a9baaf0751fd543e8290f6b008c3">TerminalLayer::nonDebugDecode</a>(<span class="keywordtype">void</span>* buffer, <span class="keywordtype">size_t</span> len) {</div><div class="line"><a name="l00277"></a><span class="lineno">  277</span>&#160;    <span class="keywordflow">if</span>(m_nonDebugDecodeCallback)</div><div class="line"><a name="l00278"></a><span class="lineno">  278</span>&#160;        m_nonDebugDecodeCallback(buffer, len);</div><div class="line"><a name="l00279"></a><span class="lineno">  279</span>&#160;}</div><div class="line"><a name="l00280"></a><span class="lineno">  280</span>&#160;</div><div class="line"><a name="l00281"></a><span class="lineno"><a class="line" href="classstored_1_1_terminal_layer.html#a8e4eb065c098959fb740a9862cf59164">  281</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classstored_1_1_protocol_layer.html#a66c24cec6a17c44fac68213d358a5aa8">TerminalLayer::encode</a>(<span class="keywordtype">void</span> <span class="keyword">const</span>* buffer, <span class="keywordtype">size_t</span> len, <span class="keywordtype">bool</span> last) {</div><div class="line"><a name="l00282"></a><span class="lineno">  282</span>&#160;    <a class="code" href="classstored_1_1_terminal_layer.html#ac734cdbc0cc6331ae456a530485d619a">encodeStart</a>();</div><div class="line"><a name="l00283"></a><span class="lineno">  283</span>&#160;    <a class="code" href="classstored_1_1_protocol_layer.html#a66c24cec6a17c44fac68213d358a5aa8">base::encode</a>(buffer, len, <span class="keyword">false</span>);</div><div class="line"><a name="l00284"></a><span class="lineno">  284</span>&#160;    <span class="keywordflow">if</span>(last)</div><div class="line"><a name="l00285"></a><span class="lineno">  285</span>&#160;        <a class="code" href="classstored_1_1_terminal_layer.html#a553f973e434533d14c48f898cc9d6d36">encodeEnd</a>();</div><div class="line"><a name="l00286"></a><span class="lineno">  286</span>&#160;}</div><div class="line"><a name="l00287"></a><span class="lineno">  287</span>&#160;</div><div class="line"><a name="l00293"></a><span class="lineno"><a class="line" href="classstored_1_1_terminal_layer.html#ac734cdbc0cc6331ae456a530485d619a">  293</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classstored_1_1_terminal_layer.html#ac734cdbc0cc6331ae456a530485d619a">TerminalLayer::encodeStart</a>() {</div><div class="line"><a name="l00294"></a><span class="lineno">  294</span>&#160;    <span class="keywordflow">if</span>(m_encodeState)</div><div class="line"><a name="l00295"></a><span class="lineno">  295</span>&#160;        <span class="keywordflow">return</span>;</div><div class="line"><a name="l00296"></a><span class="lineno">  296</span>&#160;</div><div class="line"><a name="l00297"></a><span class="lineno">  297</span>&#160;    m_encodeState = <span class="keyword">true</span>;</div><div class="line"><a name="l00298"></a><span class="lineno">  298</span>&#160;    <span class="keywordtype">char</span> start[2] = {<a class="code" href="classstored_1_1_terminal_layer.html#a892633ca69a59684c9a964600c0cc181">Esc</a>, <a class="code" href="classstored_1_1_terminal_layer.html#a641d9407a8c7517bcbfb3748b86fa43d">EscStart</a>};</div><div class="line"><a name="l00299"></a><span class="lineno">  299</span>&#160;    <a class="code" href="classstored_1_1_protocol_layer.html#a66c24cec6a17c44fac68213d358a5aa8">base::encode</a>((<span class="keywordtype">void</span>*)start, <span class="keyword">sizeof</span>(start), <span class="keyword">false</span>);</div><div class="line"><a name="l00300"></a><span class="lineno">  300</span>&#160;}</div><div class="line"><a name="l00301"></a><span class="lineno">  301</span>&#160;</div><div class="line"><a name="l00305"></a><span class="lineno"><a class="line" href="classstored_1_1_terminal_layer.html#a553f973e434533d14c48f898cc9d6d36">  305</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classstored_1_1_terminal_layer.html#a553f973e434533d14c48f898cc9d6d36">TerminalLayer::encodeEnd</a>() {</div><div class="line"><a name="l00306"></a><span class="lineno">  306</span>&#160;    <span class="keywordflow">if</span>(!m_encodeState)</div><div class="line"><a name="l00307"></a><span class="lineno">  307</span>&#160;        <span class="keywordflow">return</span>;</div><div class="line"><a name="l00308"></a><span class="lineno">  308</span>&#160;</div><div class="line"><a name="l00309"></a><span class="lineno">  309</span>&#160;    <span class="keywordtype">char</span> end[2] = {<a class="code" href="classstored_1_1_terminal_layer.html#a892633ca69a59684c9a964600c0cc181">Esc</a>, <a class="code" href="classstored_1_1_terminal_layer.html#a16632f9e5395384bc8db6940eb26259f">EscEnd</a>};</div><div class="line"><a name="l00310"></a><span class="lineno">  310</span>&#160;    <a class="code" href="classstored_1_1_protocol_layer.html#a66c24cec6a17c44fac68213d358a5aa8">base::encode</a>((<span class="keywordtype">void</span>*)end, <span class="keyword">sizeof</span>(end), <span class="keyword">true</span>);</div><div class="line"><a name="l00311"></a><span class="lineno">  311</span>&#160;    m_encodeState = <span class="keyword">false</span>;</div><div class="line"><a name="l00312"></a><span class="lineno">  312</span>&#160;}</div><div class="line"><a name="l00313"></a><span class="lineno">  313</span>&#160;</div><div class="line"><a name="l00314"></a><span class="lineno"><a class="line" href="classstored_1_1_terminal_layer.html#a0a19f65b341e78a98dca4f13747fb2a7">  314</a></span>&#160;<span class="keywordtype">size_t</span> <a class="code" href="classstored_1_1_terminal_layer.html#a0a19f65b341e78a98dca4f13747fb2a7">TerminalLayer::mtu</a>()<span class="keyword"> const </span>{</div><div class="line"><a name="l00315"></a><span class="lineno">  315</span>&#160;    <span class="keywordtype">size_t</span> <a class="code" href="classstored_1_1_terminal_layer.html#a0a19f65b341e78a98dca4f13747fb2a7">mtu</a> = <a class="code" href="classstored_1_1_protocol_layer.html#a88195d7cdb7129ac7bc625ffeb24d449">base::mtu</a>();</div><div class="line"><a name="l00316"></a><span class="lineno">  316</span>&#160;    <span class="keywordflow">if</span>(mtu == 0)</div><div class="line"><a name="l00317"></a><span class="lineno">  317</span>&#160;        <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l00318"></a><span class="lineno">  318</span>&#160;    <span class="keywordflow">if</span>(mtu &lt;= 4)</div><div class="line"><a name="l00319"></a><span class="lineno">  319</span>&#160;        <span class="keywordflow">return</span> 1;</div><div class="line"><a name="l00320"></a><span class="lineno">  320</span>&#160;    <span class="keywordflow">return</span> mtu - 4;</div><div class="line"><a name="l00321"></a><span class="lineno">  321</span>&#160;}</div><div class="line"><a name="l00322"></a><span class="lineno">  322</span>&#160;</div><div class="line"><a name="l00323"></a><span class="lineno">  323</span>&#160;</div><div class="line"><a name="l00324"></a><span class="lineno">  324</span>&#160;</div><div class="line"><a name="l00325"></a><span class="lineno">  325</span>&#160;</div><div class="line"><a name="l00326"></a><span class="lineno">  326</span>&#160;</div><div class="line"><a name="l00327"></a><span class="lineno">  327</span>&#160;</div><div class="line"><a name="l00329"></a><span class="lineno">  329</span>&#160;<span class="comment">// SegmentationLayer</span></div><div class="line"><a name="l00330"></a><span class="lineno">  330</span>&#160;<span class="comment">//</span></div><div class="line"><a name="l00331"></a><span class="lineno">  331</span>&#160;</div><div class="line"><a name="l00335"></a><span class="lineno"><a class="line" href="classstored_1_1_segmentation_layer.html#a792bbe3ab3e8c859078e654fbff856ab">  335</a></span>&#160;<a class="code" href="classstored_1_1_segmentation_layer.html#aba07293a3674e525d3ee929eebd3db10">SegmentationLayer::SegmentationLayer</a>(<span class="keywordtype">size_t</span> <a class="code" href="classstored_1_1_terminal_layer.html#a0a19f65b341e78a98dca4f13747fb2a7">mtu</a>, <a class="code" href="classstored_1_1_protocol_layer.html">ProtocolLayer</a>* up, <a class="code" href="classstored_1_1_protocol_layer.html">ProtocolLayer</a>* down)</div><div class="line"><a name="l00336"></a><span class="lineno">  336</span>&#160;    : <a class="code" href="classstored_1_1_protocol_layer.html">base</a>(up, down)</div><div class="line"><a name="l00337"></a><span class="lineno">  337</span>&#160;    , m_mtu(mtu)</div><div class="line"><a name="l00338"></a><span class="lineno">  338</span>&#160;    , m_encoded()</div><div class="line"><a name="l00339"></a><span class="lineno">  339</span>&#160;{</div><div class="line"><a name="l00340"></a><span class="lineno">  340</span>&#160;}</div><div class="line"><a name="l00341"></a><span class="lineno">  341</span>&#160;</div><div class="line"><a name="l00342"></a><span class="lineno"><a class="line" href="classstored_1_1_segmentation_layer.html#a3d4b430c6dab20da295fb67dacf5451a">  342</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classstored_1_1_segmentation_layer.html#a3d4b430c6dab20da295fb67dacf5451a">SegmentationLayer::reset</a>() {</div><div class="line"><a name="l00343"></a><span class="lineno">  343</span>&#160;    m_decode.clear();</div><div class="line"><a name="l00344"></a><span class="lineno">  344</span>&#160;    m_encoded = 0;</div><div class="line"><a name="l00345"></a><span class="lineno">  345</span>&#160;    <a class="code" href="classstored_1_1_protocol_layer.html#a53fe78a7b405b981649112d9c84fe762">base::reset</a>();</div><div class="line"><a name="l00346"></a><span class="lineno">  346</span>&#160;}</div><div class="line"><a name="l00347"></a><span class="lineno">  347</span>&#160;</div><div class="line"><a name="l00348"></a><span class="lineno"><a class="line" href="classstored_1_1_segmentation_layer.html#a5cd64512cd57378cf25bd2890266919a">  348</a></span>&#160;<span class="keywordtype">size_t</span> <a class="code" href="classstored_1_1_segmentation_layer.html#a5cd64512cd57378cf25bd2890266919a">SegmentationLayer::mtu</a>()<span class="keyword"> const </span>{</div><div class="line"><a name="l00349"></a><span class="lineno">  349</span>&#160;    <span class="comment">// We segment, so all layers above can use any size they want.</span></div><div class="line"><a name="l00350"></a><span class="lineno">  350</span>&#160;    <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l00351"></a><span class="lineno">  351</span>&#160;}</div><div class="line"><a name="l00352"></a><span class="lineno">  352</span>&#160;</div><div class="line"><a name="l00356"></a><span class="lineno"><a class="line" href="classstored_1_1_segmentation_layer.html#a67b205f77f8a2517e16db48cc052ea27">  356</a></span>&#160;<span class="keywordtype">size_t</span> <a class="code" href="classstored_1_1_segmentation_layer.html#a67b205f77f8a2517e16db48cc052ea27">SegmentationLayer::lowerMtu</a>()<span class="keyword"> const </span>{</div><div class="line"><a name="l00357"></a><span class="lineno">  357</span>&#160;    <span class="keywordtype">size_t</span> lower_mtu = <a class="code" href="classstored_1_1_protocol_layer.html#a88195d7cdb7129ac7bc625ffeb24d449">base::mtu</a>();</div><div class="line"><a name="l00358"></a><span class="lineno">  358</span>&#160;    <span class="keywordflow">if</span>(!m_mtu)</div><div class="line"><a name="l00359"></a><span class="lineno">  359</span>&#160;        <span class="keywordflow">return</span> lower_mtu;</div><div class="line"><a name="l00360"></a><span class="lineno">  360</span>&#160;    <span class="keywordflow">else</span> <span class="keywordflow">if</span>(!lower_mtu)</div><div class="line"><a name="l00361"></a><span class="lineno">  361</span>&#160;        <span class="keywordflow">return</span> m_mtu;</div><div class="line"><a name="l00362"></a><span class="lineno">  362</span>&#160;    <span class="keywordflow">else</span></div><div class="line"><a name="l00363"></a><span class="lineno">  363</span>&#160;        <span class="keywordflow">return</span> std::min&lt;size_t&gt;(m_mtu, lower_mtu);</div><div class="line"><a name="l00364"></a><span class="lineno">  364</span>&#160;}</div><div class="line"><a name="l00365"></a><span class="lineno">  365</span>&#160;</div><div class="line"><a name="l00366"></a><span class="lineno"><a class="line" href="classstored_1_1_segmentation_layer.html#adee6ee8d098ff67655b36c1ab269d490">  366</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classstored_1_1_segmentation_layer.html#adee6ee8d098ff67655b36c1ab269d490">SegmentationLayer::decode</a>(<span class="keywordtype">void</span>* buffer, <span class="keywordtype">size_t</span> len) {</div><div class="line"><a name="l00367"></a><span class="lineno">  367</span>&#160;    <span class="keywordflow">if</span>(len == 0)</div><div class="line"><a name="l00368"></a><span class="lineno">  368</span>&#160;        <span class="keywordflow">return</span>;</div><div class="line"><a name="l00369"></a><span class="lineno">  369</span>&#160;</div><div class="line"><a name="l00370"></a><span class="lineno">  370</span>&#160;    <span class="keywordtype">char</span>* buffer_ = <span class="keyword">static_cast&lt;</span><span class="keywordtype">char</span>*<span class="keyword">&gt;</span>(buffer);</div><div class="line"><a name="l00371"></a><span class="lineno">  371</span>&#160;    <span class="keywordflow">if</span>(!m_decode.empty() || buffer_[len - 1] != <a class="code" href="classstored_1_1_segmentation_layer.html#a85ac4ba426a9e49f2f8c1d14785bcc24">EndMarker</a>) {</div><div class="line"><a name="l00372"></a><span class="lineno">  372</span>&#160;        <span class="comment">// Save for later packet reassembling.</span></div><div class="line"><a name="l00373"></a><span class="lineno">  373</span>&#160;        <span class="keywordflow">if</span>(len &gt; 1) {</div><div class="line"><a name="l00374"></a><span class="lineno">  374</span>&#160;            <span class="keywordtype">size_t</span> start = m_decode.size();</div><div class="line"><a name="l00375"></a><span class="lineno">  375</span>&#160;            m_decode.resize(start + len - 1);</div><div class="line"><a name="l00376"></a><span class="lineno">  376</span>&#160;            memcpy(&amp;m_decode[start], buffer_, len - 1);</div><div class="line"><a name="l00377"></a><span class="lineno">  377</span>&#160;        }</div><div class="line"><a name="l00378"></a><span class="lineno">  378</span>&#160;</div><div class="line"><a name="l00379"></a><span class="lineno">  379</span>&#160;        <span class="keywordflow">if</span>(buffer_[len - 1] == <a class="code" href="classstored_1_1_segmentation_layer.html#a85ac4ba426a9e49f2f8c1d14785bcc24">EndMarker</a>) {</div><div class="line"><a name="l00380"></a><span class="lineno">  380</span>&#160;            <span class="comment">// Got it.</span></div><div class="line"><a name="l00381"></a><span class="lineno">  381</span>&#160;            <a class="code" href="classstored_1_1_protocol_layer.html#a357b029311be09df61e019682a848ab5">base::decode</a>(&amp;m_decode[0], m_decode.size());</div><div class="line"><a name="l00382"></a><span class="lineno">  382</span>&#160;            m_decode.clear();</div><div class="line"><a name="l00383"></a><span class="lineno">  383</span>&#160;        }</div><div class="line"><a name="l00384"></a><span class="lineno">  384</span>&#160;    } <span class="keywordflow">else</span> {</div><div class="line"><a name="l00385"></a><span class="lineno">  385</span>&#160;        <span class="comment">// Full packet is in buffer. Forward immediately.</span></div><div class="line"><a name="l00386"></a><span class="lineno">  386</span>&#160;        <a class="code" href="classstored_1_1_protocol_layer.html#a357b029311be09df61e019682a848ab5">base::decode</a>(buffer, len - 1);</div><div class="line"><a name="l00387"></a><span class="lineno">  387</span>&#160;    }</div><div class="line"><a name="l00388"></a><span class="lineno">  388</span>&#160;}</div><div class="line"><a name="l00389"></a><span class="lineno">  389</span>&#160;</div><div class="line"><a name="l00390"></a><span class="lineno"><a class="line" href="classstored_1_1_segmentation_layer.html#a07d8192a0db41389735cb012fc231ba0">  390</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classstored_1_1_protocol_layer.html#a66c24cec6a17c44fac68213d358a5aa8">SegmentationLayer::encode</a>(<span class="keywordtype">void</span> <span class="keyword">const</span>* buffer, <span class="keywordtype">size_t</span> len, <span class="keywordtype">bool</span> last) {</div><div class="line"><a name="l00391"></a><span class="lineno">  391</span>&#160;    <span class="keywordtype">char</span> <span class="keyword">const</span>* buffer_ = <span class="keyword">static_cast&lt;</span><span class="keywordtype">char</span> <a class="code" href="namespaceed2_1_1gui_1_1____main____.html#a3c1fe823c9bbaf7e7dcef9ecc9fcb915">const</a>*<span class="keyword">&gt;</span>(buffer);</div><div class="line"><a name="l00392"></a><span class="lineno">  392</span>&#160;</div><div class="line"><a name="l00393"></a><span class="lineno">  393</span>&#160;    <span class="keywordtype">size_t</span> <a class="code" href="classstored_1_1_segmentation_layer.html#a5cd64512cd57378cf25bd2890266919a">mtu</a> = <a class="code" href="classstored_1_1_segmentation_layer.html#a67b205f77f8a2517e16db48cc052ea27">lowerMtu</a>();</div><div class="line"><a name="l00394"></a><span class="lineno">  394</span>&#160;    <span class="keywordflow">if</span>(mtu == 0)</div><div class="line"><a name="l00395"></a><span class="lineno">  395</span>&#160;        mtu = std::numeric_limits&lt;size_t&gt;::max();</div><div class="line"><a name="l00396"></a><span class="lineno">  396</span>&#160;    <span class="keywordflow">else</span> <span class="keywordflow">if</span>(mtu == 1)</div><div class="line"><a name="l00397"></a><span class="lineno">  397</span>&#160;        mtu = 2;</div><div class="line"><a name="l00398"></a><span class="lineno">  398</span>&#160;</div><div class="line"><a name="l00399"></a><span class="lineno">  399</span>&#160;    <span class="keywordflow">while</span>(len) {</div><div class="line"><a name="l00400"></a><span class="lineno">  400</span>&#160;        <span class="keywordtype">size_t</span> remaining = mtu - m_encoded - 1;</div><div class="line"><a name="l00401"></a><span class="lineno">  401</span>&#160;        <span class="keywordtype">size_t</span> chunk = std::min(len, remaining);</div><div class="line"><a name="l00402"></a><span class="lineno">  402</span>&#160;</div><div class="line"><a name="l00403"></a><span class="lineno">  403</span>&#160;        <span class="keywordflow">if</span>(chunk) {</div><div class="line"><a name="l00404"></a><span class="lineno">  404</span>&#160;            <a class="code" href="classstored_1_1_protocol_layer.html#a66c24cec6a17c44fac68213d358a5aa8">base::encode</a>(buffer_, chunk, <span class="keyword">false</span>);</div><div class="line"><a name="l00405"></a><span class="lineno">  405</span>&#160;            len -= chunk;</div><div class="line"><a name="l00406"></a><span class="lineno">  406</span>&#160;            buffer_ += chunk;</div><div class="line"><a name="l00407"></a><span class="lineno">  407</span>&#160;        }</div><div class="line"><a name="l00408"></a><span class="lineno">  408</span>&#160;</div><div class="line"><a name="l00409"></a><span class="lineno">  409</span>&#160;        <span class="keywordflow">if</span>(chunk == remaining &amp;&amp; len) {</div><div class="line"><a name="l00410"></a><span class="lineno">  410</span>&#160;            <span class="comment">// Full MTU.</span></div><div class="line"><a name="l00411"></a><span class="lineno">  411</span>&#160;            <span class="keywordtype">char</span> cont = <a class="code" href="classstored_1_1_segmentation_layer.html#a36b6e6bf8545558a5e1c95c9a3bbcd27">ContinueMarker</a>;</div><div class="line"><a name="l00412"></a><span class="lineno">  412</span>&#160;            <a class="code" href="classstored_1_1_protocol_layer.html#a66c24cec6a17c44fac68213d358a5aa8">base::encode</a>(&amp;cont, 1, <span class="keyword">true</span>);</div><div class="line"><a name="l00413"></a><span class="lineno">  413</span>&#160;            m_encoded = 0;</div><div class="line"><a name="l00414"></a><span class="lineno">  414</span>&#160;        } <span class="keywordflow">else</span> {</div><div class="line"><a name="l00415"></a><span class="lineno">  415</span>&#160;            <span class="comment">// Partial MTU. Record that we already filled some of the packet.</span></div><div class="line"><a name="l00416"></a><span class="lineno">  416</span>&#160;            m_encoded += chunk;</div><div class="line"><a name="l00417"></a><span class="lineno">  417</span>&#160;        }</div><div class="line"><a name="l00418"></a><span class="lineno">  418</span>&#160;    }</div><div class="line"><a name="l00419"></a><span class="lineno">  419</span>&#160;</div><div class="line"><a name="l00420"></a><span class="lineno">  420</span>&#160;    <span class="keywordflow">if</span>(last) {</div><div class="line"><a name="l00421"></a><span class="lineno">  421</span>&#160;        <span class="comment">// The marker always ends the packet.</span></div><div class="line"><a name="l00422"></a><span class="lineno">  422</span>&#160;        <span class="keywordtype">char</span> end = <a class="code" href="classstored_1_1_segmentation_layer.html#a85ac4ba426a9e49f2f8c1d14785bcc24">EndMarker</a>;</div><div class="line"><a name="l00423"></a><span class="lineno">  423</span>&#160;        <a class="code" href="classstored_1_1_protocol_layer.html#a66c24cec6a17c44fac68213d358a5aa8">base::encode</a>(&amp;end, 1, <span class="keyword">true</span>);</div><div class="line"><a name="l00424"></a><span class="lineno">  424</span>&#160;        m_encoded = 0;</div><div class="line"><a name="l00425"></a><span class="lineno">  425</span>&#160;    }</div><div class="line"><a name="l00426"></a><span class="lineno">  426</span>&#160;}</div><div class="line"><a name="l00427"></a><span class="lineno">  427</span>&#160;</div><div class="line"><a name="l00428"></a><span class="lineno">  428</span>&#160;</div><div class="line"><a name="l00429"></a><span class="lineno">  429</span>&#160;</div><div class="line"><a name="l00431"></a><span class="lineno">  431</span>&#160;<span class="comment">// ArqLayer</span></div><div class="line"><a name="l00432"></a><span class="lineno">  432</span>&#160;<span class="comment">//</span></div><div class="line"><a name="l00433"></a><span class="lineno">  433</span>&#160;</div><div class="line"><a name="l00441"></a><span class="lineno"><a class="line" href="classstored_1_1_arq_layer.html#a38bd267c41bd6d7fd9b5231b398ac176">  441</a></span>&#160;<a class="code" href="classstored_1_1_arq_layer.html#a8424408abd1c64b603fef6bf1d2b5052">ArqLayer::ArqLayer</a>(<span class="keywordtype">size_t</span> maxEncodeBuffer, <a class="code" href="classstored_1_1_protocol_layer.html">ProtocolLayer</a>* up, <a class="code" href="classstored_1_1_protocol_layer.html">ProtocolLayer</a>* down)</div><div class="line"><a name="l00442"></a><span class="lineno">  442</span>&#160;    : <a class="code" href="classstored_1_1_protocol_layer.html">base</a>(up, down)</div><div class="line"><a name="l00443"></a><span class="lineno">  443</span>&#160;#if <a class="code" href="macros_8h.html#aa64cd2b6d63a68c9c8ec5fba4000cf8f">STORED_cplusplus</a> &lt; 201103L</div><div class="line"><a name="l00444"></a><span class="lineno">  444</span>&#160;    , m_cb()</div><div class="line"><a name="l00445"></a><span class="lineno">  445</span>&#160;    , m_cbArg()</div><div class="line"><a name="l00446"></a><span class="lineno">  446</span>&#160;#endif</div><div class="line"><a name="l00447"></a><span class="lineno">  447</span>&#160;    , m_maxEncodeBuffer(maxEncodeBuffer)</div><div class="line"><a name="l00448"></a><span class="lineno">  448</span>&#160;    , m_encodeQueueSize()</div><div class="line"><a name="l00449"></a><span class="lineno">  449</span>&#160;    , m_encodeState(EncodeStateIdle)</div><div class="line"><a name="l00450"></a><span class="lineno">  450</span>&#160;    , m_didTransmit()</div><div class="line"><a name="l00451"></a><span class="lineno">  451</span>&#160;    , m_retransmits()</div><div class="line"><a name="l00452"></a><span class="lineno">  452</span>&#160;    , m_sendSeq()</div><div class="line"><a name="l00453"></a><span class="lineno">  453</span>&#160;    , m_recvSeq()</div><div class="line"><a name="l00454"></a><span class="lineno">  454</span>&#160;{</div><div class="line"><a name="l00455"></a><span class="lineno">  455</span>&#160;    <span class="comment">// Empty encode with seq 0, which indicates a reset message.</span></div><div class="line"><a name="l00456"></a><span class="lineno">  456</span>&#160;    <a class="code" href="classstored_1_1_arq_layer.html#ab1d2c6282a3ecad2e561ddb517421b09">keepAlive</a>();</div><div class="line"><a name="l00457"></a><span class="lineno">  457</span>&#160;}</div><div class="line"><a name="l00458"></a><span class="lineno">  458</span>&#160;</div><div class="line"><a name="l00462"></a><span class="lineno"><a class="line" href="classstored_1_1_arq_layer.html#afbab2b5061d597434e4e1f6620bb110f">  462</a></span>&#160;<a class="code" href="classstored_1_1_arq_layer.html#afbab2b5061d597434e4e1f6620bb110f">ArqLayer::~ArqLayer</a>() {</div><div class="line"><a name="l00463"></a><span class="lineno">  463</span>&#160;    <span class="keywordflow">for</span>(std::deque&lt;std::string*&gt;::iterator it = m_encodeQueue.begin(); it != m_encodeQueue.end(); ++it)</div><div class="line"><a name="l00464"></a><span class="lineno">  464</span>&#160;        <span class="keyword">delete</span> *it; <span class="comment">// NOLINT(cppcoreguidelines-owning-memory)</span></div><div class="line"><a name="l00465"></a><span class="lineno">  465</span>&#160;    <span class="keywordflow">for</span>(std::deque&lt;std::string*&gt;::iterator it = m_spare.begin(); it != m_spare.end(); ++it)</div><div class="line"><a name="l00466"></a><span class="lineno">  466</span>&#160;        <span class="keyword">delete</span> *it; <span class="comment">// NOLINT(cppcoreguidelines-owning-memory)</span></div><div class="line"><a name="l00467"></a><span class="lineno">  467</span>&#160;}</div><div class="line"><a name="l00468"></a><span class="lineno">  468</span>&#160;</div><div class="line"><a name="l00469"></a><span class="lineno"><a class="line" href="classstored_1_1_arq_layer.html#ab2f83fa2caaab88f9ee29855b3c527a7">  469</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classstored_1_1_arq_layer.html#ab2f83fa2caaab88f9ee29855b3c527a7">ArqLayer::reset</a>() {</div><div class="line"><a name="l00470"></a><span class="lineno">  470</span>&#160;    <span class="keywordflow">while</span>(!m_encodeQueue.empty())</div><div class="line"><a name="l00471"></a><span class="lineno">  471</span>&#160;        <a class="code" href="classstored_1_1_arq_layer.html#a1b2f96a8e25063dbf2631c5d2c765920">popEncodeQueue</a>();</div><div class="line"><a name="l00472"></a><span class="lineno">  472</span>&#160;    <a class="code" href="group__libstored__util.html#gab750e51b876450a0a4ad419588a82a4d">stored_assert</a>(m_encodeQueueSize == 0);</div><div class="line"><a name="l00473"></a><span class="lineno">  473</span>&#160;</div><div class="line"><a name="l00474"></a><span class="lineno">  474</span>&#160;    m_encodeState = <a class="code" href="classstored_1_1_arq_layer.html#a5afc54c8eec96b06ba9c0a99d4dca7c1adc66734e4631a5349dcaba9bcf8dd524">EncodeStateIdle</a>;</div><div class="line"><a name="l00475"></a><span class="lineno">  475</span>&#160;    m_didTransmit = <span class="keyword">false</span>;</div><div class="line"><a name="l00476"></a><span class="lineno">  476</span>&#160;    m_retransmits = 0;</div><div class="line"><a name="l00477"></a><span class="lineno">  477</span>&#160;    m_sendSeq = 0;</div><div class="line"><a name="l00478"></a><span class="lineno">  478</span>&#160;    m_recvSeq = 0;</div><div class="line"><a name="l00479"></a><span class="lineno">  479</span>&#160;    <a class="code" href="classstored_1_1_protocol_layer.html#a53fe78a7b405b981649112d9c84fe762">base::reset</a>();</div><div class="line"><a name="l00480"></a><span class="lineno">  480</span>&#160;    <a class="code" href="classstored_1_1_arq_layer.html#ab1d2c6282a3ecad2e561ddb517421b09">keepAlive</a>();</div><div class="line"><a name="l00481"></a><span class="lineno">  481</span>&#160;}</div><div class="line"><a name="l00482"></a><span class="lineno">  482</span>&#160;</div><div class="line"><a name="l00483"></a><span class="lineno"><a class="line" href="classstored_1_1_arq_layer.html#aae0973f22504fbff0b98fefec8d53013">  483</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classstored_1_1_arq_layer.html#aae0973f22504fbff0b98fefec8d53013">ArqLayer::decode</a>(<span class="keywordtype">void</span>* buffer, <span class="keywordtype">size_t</span> len) {</div><div class="line"><a name="l00484"></a><span class="lineno">  484</span>&#160;    uint8_t* buffer_ = <span class="keyword">static_cast&lt;</span>uint8_t*<span class="keyword">&gt;</span>(buffer);</div><div class="line"><a name="l00485"></a><span class="lineno">  485</span>&#160;</div><div class="line"><a name="l00486"></a><span class="lineno">  486</span>&#160;next:</div><div class="line"><a name="l00487"></a><span class="lineno">  487</span>&#160;    <span class="keywordflow">if</span>(len == 0)</div><div class="line"><a name="l00488"></a><span class="lineno">  488</span>&#160;        <span class="keywordflow">return</span>;</div><div class="line"><a name="l00489"></a><span class="lineno">  489</span>&#160;</div><div class="line"><a name="l00490"></a><span class="lineno">  490</span>&#160;    <span class="keywordflow">if</span>(buffer_[0] &amp; <a class="code" href="classstored_1_1_arq_layer.html#a4af8faa0449d4c0c048be13a0d250384">AckFlag</a>) {</div><div class="line"><a name="l00491"></a><span class="lineno">  491</span>&#160;        <span class="keywordflow">if</span>(<a class="code" href="classstored_1_1_arq_layer.html#a57d385c32e28f7684d75567aeca702f4">waitingForAck</a>() &amp;&amp; (buffer_[0] &amp; <a class="code" href="classstored_1_1_arq_layer.html#a6d481c24d715ceef8dcc2fd9cd19eab1">SeqMask</a>) == ((uint8_t)(*m_encodeQueue.front())[0] &amp; <a class="code" href="classstored_1_1_arq_layer.html#a6d481c24d715ceef8dcc2fd9cd19eab1">SeqMask</a>)) {</div><div class="line"><a name="l00492"></a><span class="lineno">  492</span>&#160;            <span class="comment">// They got our last transmission.</span></div><div class="line"><a name="l00493"></a><span class="lineno">  493</span>&#160;            <a class="code" href="classstored_1_1_arq_layer.html#a1b2f96a8e25063dbf2631c5d2c765920">popEncodeQueue</a>();</div><div class="line"><a name="l00494"></a><span class="lineno">  494</span>&#160;            m_retransmits = 0;</div><div class="line"><a name="l00495"></a><span class="lineno">  495</span>&#160;</div><div class="line"><a name="l00496"></a><span class="lineno">  496</span>&#160;            <span class="comment">// Transmit next message, if any.</span></div><div class="line"><a name="l00497"></a><span class="lineno">  497</span>&#160;            <a class="code" href="classstored_1_1_arq_layer.html#a06104ba40460c0852457bbe651ddba48">transmit</a>();</div><div class="line"><a name="l00498"></a><span class="lineno">  498</span>&#160;        }</div><div class="line"><a name="l00499"></a><span class="lineno">  499</span>&#160;</div><div class="line"><a name="l00500"></a><span class="lineno">  500</span>&#160;        buffer_++;</div><div class="line"><a name="l00501"></a><span class="lineno">  501</span>&#160;        len--;</div><div class="line"><a name="l00502"></a><span class="lineno">  502</span>&#160;        <span class="keywordflow">goto</span> next;</div><div class="line"><a name="l00503"></a><span class="lineno">  503</span>&#160;    }</div><div class="line"><a name="l00504"></a><span class="lineno">  504</span>&#160;</div><div class="line"><a name="l00505"></a><span class="lineno">  505</span>&#160;    <span class="keywordflow">if</span>(<a class="code" href="group__libstored__util.html#gaa0672ea7123854cc5f51902a06c473fb">likely</a>((buffer_[0] &amp; <a class="code" href="classstored_1_1_arq_layer.html#a6d481c24d715ceef8dcc2fd9cd19eab1">SeqMask</a>) == m_recvSeq)) {</div><div class="line"><a name="l00506"></a><span class="lineno">  506</span>&#160;        <span class="comment">// This is a proper next message.</span></div><div class="line"><a name="l00507"></a><span class="lineno">  507</span>&#160;        uint8_t ack = (uint8_t)(m_recvSeq | AckFlag);</div><div class="line"><a name="l00508"></a><span class="lineno">  508</span>&#160;        <a class="code" href="classstored_1_1_protocol_layer.html#a66c24cec6a17c44fac68213d358a5aa8">base::encode</a>(&amp;ack, 1, <span class="keyword">false</span>);</div><div class="line"><a name="l00509"></a><span class="lineno">  509</span>&#160;        m_recvSeq = <a class="code" href="classstored_1_1_arq_layer.html#aa6414510a8e158dd1df01b8738ac565b">nextSeq</a>(m_recvSeq);</div><div class="line"><a name="l00510"></a><span class="lineno">  510</span>&#160;        <a class="code" href="classstored_1_1_arq_layer.html#ad385593c1549539ec000943046860404">resetDidTransmit</a>();</div><div class="line"><a name="l00511"></a><span class="lineno">  511</span>&#160;</div><div class="line"><a name="l00512"></a><span class="lineno">  512</span>&#160;        <span class="keywordflow">if</span>(<a class="code" href="group__libstored__util.html#gaa0672ea7123854cc5f51902a06c473fb">likely</a>(!(buffer_[0] &amp; <a class="code" href="classstored_1_1_arq_layer.html#a335ff281a24fb2aac70b381451589424">NopFlag</a>))) {</div><div class="line"><a name="l00513"></a><span class="lineno">  513</span>&#160;            <span class="comment">// Go process the payload.</span></div><div class="line"><a name="l00514"></a><span class="lineno">  514</span>&#160;            <a class="code" href="classstored_1_1_protocol_layer.html#a357b029311be09df61e019682a848ab5">base::decode</a>(buffer_ + 1, len - 1);</div><div class="line"><a name="l00515"></a><span class="lineno">  515</span>&#160;        }</div><div class="line"><a name="l00516"></a><span class="lineno">  516</span>&#160;</div><div class="line"><a name="l00517"></a><span class="lineno">  517</span>&#160;        <span class="keywordflow">if</span>(!<a class="code" href="classstored_1_1_arq_layer.html#a72a34dd87ec3fcee83db2a44f7e8a8e5">didTransmit</a>())</div><div class="line"><a name="l00518"></a><span class="lineno">  518</span>&#160;            <a class="code" href="classstored_1_1_arq_layer.html#a06104ba40460c0852457bbe651ddba48">transmit</a>();</div><div class="line"><a name="l00519"></a><span class="lineno">  519</span>&#160;</div><div class="line"><a name="l00520"></a><span class="lineno">  520</span>&#160;        <span class="comment">// cppcheck-suppress duplicateCondition</span></div><div class="line"><a name="l00521"></a><span class="lineno">  521</span>&#160;        <span class="keywordflow">if</span>(!<a class="code" href="classstored_1_1_arq_layer.html#a72a34dd87ec3fcee83db2a44f7e8a8e5">didTransmit</a>()) {</div><div class="line"><a name="l00522"></a><span class="lineno">  522</span>&#160;            <a class="code" href="classstored_1_1_protocol_layer.html#a66c24cec6a17c44fac68213d358a5aa8">base::encode</a>(<span class="keyword">nullptr</span>, 0, <span class="keyword">true</span>);</div><div class="line"><a name="l00523"></a><span class="lineno">  523</span>&#160;            m_didTransmit = <span class="keyword">true</span>;</div><div class="line"><a name="l00524"></a><span class="lineno">  524</span>&#160;        }</div><div class="line"><a name="l00525"></a><span class="lineno">  525</span>&#160;    } <span class="keywordflow">else</span> <span class="keywordflow">if</span>(<a class="code" href="classstored_1_1_arq_layer.html#aa6414510a8e158dd1df01b8738ac565b">nextSeq</a>((uint8_t)(buffer_[0] &amp; SeqMask)) == m_recvSeq) {</div><div class="line"><a name="l00526"></a><span class="lineno">  526</span>&#160;        <span class="comment">// This is a retransmit of the previous message.</span></div><div class="line"><a name="l00527"></a><span class="lineno">  527</span>&#160;        <span class="comment">// Send ack again.</span></div><div class="line"><a name="l00528"></a><span class="lineno">  528</span>&#160;        uint8_t ack = (uint8_t)((uint8_t)(buffer_[0] &amp; <a class="code" href="classstored_1_1_arq_layer.html#a6d481c24d715ceef8dcc2fd9cd19eab1">SeqMask</a>) | AckFlag);</div><div class="line"><a name="l00529"></a><span class="lineno">  529</span>&#160;        <a class="code" href="classstored_1_1_protocol_layer.html#a66c24cec6a17c44fac68213d358a5aa8">base::encode</a>(&amp;ack, 1, <span class="keyword">true</span>);</div><div class="line"><a name="l00530"></a><span class="lineno">  530</span>&#160;    } <span class="keywordflow">else</span> <span class="keywordflow">if</span>((buffer_[0] &amp; SeqMask) == 0) {</div><div class="line"><a name="l00531"></a><span class="lineno">  531</span>&#160;        <span class="comment">// This is an unexpected reset message.</span></div><div class="line"><a name="l00532"></a><span class="lineno">  532</span>&#160;        <a class="code" href="classstored_1_1_arq_layer.html#af8bb680d2105264eaf4b7103eb0a3319">event</a>(<a class="code" href="classstored_1_1_arq_layer.html#a1d3b18fc5b159e527b087385ac961e52a695faff43603c7debd9ac61f8b607c99">EventReconnect</a>);</div><div class="line"><a name="l00533"></a><span class="lineno">  533</span>&#160;    } <span class="comment">// else drop silently</span></div><div class="line"><a name="l00534"></a><span class="lineno">  534</span>&#160;}</div><div class="line"><a name="l00535"></a><span class="lineno">  535</span>&#160;</div><div class="line"><a name="l00539"></a><span class="lineno"><a class="line" href="classstored_1_1_arq_layer.html#a57d385c32e28f7684d75567aeca702f4">  539</a></span>&#160;<span class="keywordtype">bool</span> <a class="code" href="classstored_1_1_arq_layer.html#a57d385c32e28f7684d75567aeca702f4">ArqLayer::waitingForAck</a>()<span class="keyword"> const </span>{</div><div class="line"><a name="l00540"></a><span class="lineno">  540</span>&#160;    <span class="keywordflow">if</span>(m_encodeQueue.empty())</div><div class="line"><a name="l00541"></a><span class="lineno">  541</span>&#160;        <span class="keywordflow">return</span> <span class="keyword">false</span>;</div><div class="line"><a name="l00542"></a><span class="lineno">  542</span>&#160;</div><div class="line"><a name="l00543"></a><span class="lineno">  543</span>&#160;    <span class="keywordflow">if</span>(m_encodeQueue.size() == 1 &amp;&amp; m_encodeState != <a class="code" href="classstored_1_1_arq_layer.html#a5afc54c8eec96b06ba9c0a99d4dca7c1adc66734e4631a5349dcaba9bcf8dd524">EncodeStateIdle</a>)</div><div class="line"><a name="l00544"></a><span class="lineno">  544</span>&#160;        <span class="keywordflow">return</span> <span class="keyword">false</span>;</div><div class="line"><a name="l00545"></a><span class="lineno">  545</span>&#160;</div><div class="line"><a name="l00546"></a><span class="lineno">  546</span>&#160;    <a class="code" href="group__libstored__util.html#gab750e51b876450a0a4ad419588a82a4d">stored_assert</a>(m_encodeQueue.front() &amp;&amp; !m_encodeQueue.front()-&gt;empty());</div><div class="line"><a name="l00547"></a><span class="lineno">  547</span>&#160;    <span class="keywordflow">return</span> <span class="keyword">true</span>;</div><div class="line"><a name="l00548"></a><span class="lineno">  548</span>&#160;}</div><div class="line"><a name="l00549"></a><span class="lineno">  549</span>&#160;</div><div class="line"><a name="l00550"></a><span class="lineno"><a class="line" href="classstored_1_1_arq_layer.html#a156d3e684ca880a6d5a4e57da36d585e">  550</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classstored_1_1_protocol_layer.html#a66c24cec6a17c44fac68213d358a5aa8">ArqLayer::encode</a>(<span class="keywordtype">void</span> <span class="keyword">const</span>* buffer, <span class="keywordtype">size_t</span> len, <span class="keywordtype">bool</span> last) {</div><div class="line"><a name="l00551"></a><span class="lineno">  551</span>&#160;    <span class="keywordflow">if</span>(m_maxEncodeBuffer &gt; 0 &amp;&amp; m_maxEncodeBuffer &lt; m_encodeQueueSize + len)</div><div class="line"><a name="l00552"></a><span class="lineno">  552</span>&#160;        <a class="code" href="classstored_1_1_arq_layer.html#af8bb680d2105264eaf4b7103eb0a3319">event</a>(<a class="code" href="classstored_1_1_arq_layer.html#a1d3b18fc5b159e527b087385ac961e52afec9d8b5d2c8fe338525458da4909a48">EventEncodeBufferOverflow</a>);</div><div class="line"><a name="l00553"></a><span class="lineno">  553</span>&#160;</div><div class="line"><a name="l00554"></a><span class="lineno">  554</span>&#160;    <span class="keywordflow">switch</span>(m_encodeState) {</div><div class="line"><a name="l00555"></a><span class="lineno">  555</span>&#160;    <span class="keywordflow">case</span> <a class="code" href="classstored_1_1_arq_layer.html#a5afc54c8eec96b06ba9c0a99d4dca7c1adc66734e4631a5349dcaba9bcf8dd524">EncodeStateIdle</a>:</div><div class="line"><a name="l00556"></a><span class="lineno">  556</span>&#160;        <a class="code" href="classstored_1_1_arq_layer.html#a9a411e363eaca7a8060277363feee51b">pushEncodeQueue</a>(buffer, len);</div><div class="line"><a name="l00557"></a><span class="lineno">  557</span>&#160;</div><div class="line"><a name="l00558"></a><span class="lineno">  558</span>&#160;        <span class="keywordflow">if</span>(!last)</div><div class="line"><a name="l00559"></a><span class="lineno">  559</span>&#160;            m_encodeState = <a class="code" href="classstored_1_1_arq_layer.html#a5afc54c8eec96b06ba9c0a99d4dca7c1a6a87d422220f79f0357e0f9c8d2dce8b">EncodeStateEncoding</a>;</div><div class="line"><a name="l00560"></a><span class="lineno">  560</span>&#160;</div><div class="line"><a name="l00561"></a><span class="lineno">  561</span>&#160;        <span class="keywordflow">break</span>;</div><div class="line"><a name="l00562"></a><span class="lineno">  562</span>&#160;</div><div class="line"><a name="l00563"></a><span class="lineno">  563</span>&#160;    <span class="keywordflow">case</span> <a class="code" href="classstored_1_1_arq_layer.html#a5afc54c8eec96b06ba9c0a99d4dca7c1a6a87d422220f79f0357e0f9c8d2dce8b">EncodeStateEncoding</a>:</div><div class="line"><a name="l00564"></a><span class="lineno">  564</span>&#160;        <a class="code" href="group__libstored__util.html#gab750e51b876450a0a4ad419588a82a4d">stored_assert</a>(!m_encodeQueue.empty());</div><div class="line"><a name="l00565"></a><span class="lineno">  565</span>&#160;        m_encodeQueueSize += len;</div><div class="line"><a name="l00566"></a><span class="lineno">  566</span>&#160;        m_encodeQueue.back()-&gt;append(static_cast&lt;char const*&gt;(buffer), len);</div><div class="line"><a name="l00567"></a><span class="lineno">  567</span>&#160;</div><div class="line"><a name="l00568"></a><span class="lineno">  568</span>&#160;        <span class="keywordflow">if</span>(last)</div><div class="line"><a name="l00569"></a><span class="lineno">  569</span>&#160;            m_encodeState = <a class="code" href="classstored_1_1_arq_layer.html#a5afc54c8eec96b06ba9c0a99d4dca7c1adc66734e4631a5349dcaba9bcf8dd524">EncodeStateIdle</a>;</div><div class="line"><a name="l00570"></a><span class="lineno">  570</span>&#160;        <span class="keywordflow">break</span>;</div><div class="line"><a name="l00571"></a><span class="lineno">  571</span>&#160;    }</div><div class="line"><a name="l00572"></a><span class="lineno">  572</span>&#160;</div><div class="line"><a name="l00573"></a><span class="lineno">  573</span>&#160;    <a class="code" href="classstored_1_1_arq_layer.html#a06104ba40460c0852457bbe651ddba48">transmit</a>();</div><div class="line"><a name="l00574"></a><span class="lineno">  574</span>&#160;}</div><div class="line"><a name="l00575"></a><span class="lineno">  575</span>&#160;</div><div class="line"><a name="l00576"></a><span class="lineno"><a class="line" href="classstored_1_1_arq_layer.html#abf63088fb9952dcc6599a023d0491d12">  576</a></span>&#160;<span class="keywordtype">bool</span> <a class="code" href="classstored_1_1_arq_layer.html#abf63088fb9952dcc6599a023d0491d12">ArqLayer::flush</a>() {</div><div class="line"><a name="l00577"></a><span class="lineno">  577</span>&#160;    <span class="keywordtype">bool</span> <a class="code" href="namespaceed2_1_1gui_1_1____main____.html#a11587f112b0486278fe041290b1db064">res</a> = !<a class="code" href="classstored_1_1_arq_layer.html#a06104ba40460c0852457bbe651ddba48">transmit</a>();</div><div class="line"><a name="l00578"></a><span class="lineno">  578</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="classstored_1_1_protocol_layer.html#a654466d2b7502efdbd5b1b1e95263194">base::flush</a>() &amp;&amp; <a class="code" href="namespaceed2_1_1gui_1_1____main____.html#a11587f112b0486278fe041290b1db064">res</a>;</div><div class="line"><a name="l00579"></a><span class="lineno">  579</span>&#160;}</div><div class="line"><a name="l00580"></a><span class="lineno">  580</span>&#160;</div><div class="line"><a name="l00585"></a><span class="lineno"><a class="line" href="classstored_1_1_arq_layer.html#a06104ba40460c0852457bbe651ddba48">  585</a></span>&#160;<span class="keywordtype">bool</span> <a class="code" href="classstored_1_1_arq_layer.html#a06104ba40460c0852457bbe651ddba48">ArqLayer::transmit</a>() {</div><div class="line"><a name="l00586"></a><span class="lineno">  586</span>&#160;    <span class="keywordflow">if</span>(m_encodeQueue.empty())</div><div class="line"><a name="l00587"></a><span class="lineno">  587</span>&#160;        <span class="comment">// Nothing to send.</span></div><div class="line"><a name="l00588"></a><span class="lineno">  588</span>&#160;        <span class="keywordflow">return</span> <span class="keyword">false</span>;</div><div class="line"><a name="l00589"></a><span class="lineno">  589</span>&#160;</div><div class="line"><a name="l00590"></a><span class="lineno">  590</span>&#160;    <span class="keywordflow">if</span>(m_encodeQueue.size() == 1 &amp;&amp; m_encodeState == <a class="code" href="classstored_1_1_arq_layer.html#a5afc54c8eec96b06ba9c0a99d4dca7c1a6a87d422220f79f0357e0f9c8d2dce8b">EncodeStateEncoding</a>)</div><div class="line"><a name="l00591"></a><span class="lineno">  591</span>&#160;        <span class="comment">// Still assembling first message, but there is nothing to flush (yet).</span></div><div class="line"><a name="l00592"></a><span class="lineno">  592</span>&#160;        <span class="keywordflow">return</span> <span class="keyword">false</span>;</div><div class="line"><a name="l00593"></a><span class="lineno">  593</span>&#160;</div><div class="line"><a name="l00594"></a><span class="lineno">  594</span>&#160;    <span class="comment">// Update administration first, in case base::encode() has some recursive</span></div><div class="line"><a name="l00595"></a><span class="lineno">  595</span>&#160;    <span class="comment">// call back to decode()/encode().</span></div><div class="line"><a name="l00596"></a><span class="lineno">  596</span>&#160;    m_didTransmit = <span class="keyword">true</span>;</div><div class="line"><a name="l00597"></a><span class="lineno">  597</span>&#160;    <span class="keywordflow">if</span>(m_retransmits &lt; std::numeric_limits&lt;decltype(m_retransmits)&gt;::max())</div><div class="line"><a name="l00598"></a><span class="lineno">  598</span>&#160;        m_retransmits++;</div><div class="line"><a name="l00599"></a><span class="lineno">  599</span>&#160;    <span class="keywordflow">if</span>(m_retransmits &gt;= <a class="code" href="classstored_1_1_arq_layer.html#ad50ec60b848261f45640a39380f3ed74a39ab31057c8c5eea4f5e0afb1a8fcbc7">RetransmitCallbackThreshold</a>)</div><div class="line"><a name="l00600"></a><span class="lineno">  600</span>&#160;        <a class="code" href="classstored_1_1_arq_layer.html#af8bb680d2105264eaf4b7103eb0a3319">event</a>(<a class="code" href="classstored_1_1_arq_layer.html#a1d3b18fc5b159e527b087385ac961e52a67b425c96fa51d033359fbea7f1c344a">EventRetransmit</a>);</div><div class="line"><a name="l00601"></a><span class="lineno">  601</span>&#160;</div><div class="line"><a name="l00602"></a><span class="lineno">  602</span>&#160;    <span class="comment">// (Re)transmit first message.</span></div><div class="line"><a name="l00603"></a><span class="lineno">  603</span>&#160;    <a class="code" href="classstored_1_1_protocol_layer.html#a66c24cec6a17c44fac68213d358a5aa8">base::encode</a>(m_encodeQueue.front()-&gt;data(), m_encodeQueue.front()-&gt;size(), <span class="keyword">true</span>);</div><div class="line"><a name="l00604"></a><span class="lineno">  604</span>&#160;</div><div class="line"><a name="l00605"></a><span class="lineno">  605</span>&#160;    <a class="code" href="group__libstored__util.html#gab750e51b876450a0a4ad419588a82a4d">stored_assert</a>(<a class="code" href="classstored_1_1_arq_layer.html#a57d385c32e28f7684d75567aeca702f4">waitingForAck</a>());</div><div class="line"><a name="l00606"></a><span class="lineno">  606</span>&#160;    <span class="keywordflow">return</span> <span class="keyword">true</span>;</div><div class="line"><a name="l00607"></a><span class="lineno">  607</span>&#160;}</div><div class="line"><a name="l00608"></a><span class="lineno">  608</span>&#160;</div><div class="line"><a name="l00612"></a><span class="lineno"><a class="line" href="classstored_1_1_arq_layer.html#af8bb680d2105264eaf4b7103eb0a3319">  612</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classstored_1_1_arq_layer.html#af8bb680d2105264eaf4b7103eb0a3319">ArqLayer::event</a>(<a class="code" href="classstored_1_1_arq_layer.html#a1d3b18fc5b159e527b087385ac961e52">ArqLayer::Event</a> e) {</div><div class="line"><a name="l00613"></a><span class="lineno">  613</span>&#160;    <span class="keywordflow">if</span>(m_cb) {</div><div class="line"><a name="l00614"></a><span class="lineno">  614</span>&#160;<span class="preprocessor">#if STORED_cplusplus &lt; 201103L</span></div><div class="line"><a name="l00615"></a><span class="lineno">  615</span>&#160;        m_cb(*<span class="keyword">this</span>, e, m_cbArg);</div><div class="line"><a name="l00616"></a><span class="lineno">  616</span>&#160;<span class="preprocessor">#else</span></div><div class="line"><a name="l00617"></a><span class="lineno">  617</span>&#160;        m_cb(*<span class="keyword">this</span>, e);</div><div class="line"><a name="l00618"></a><span class="lineno">  618</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l00619"></a><span class="lineno">  619</span>&#160;    } <span class="keywordflow">else</span> {</div><div class="line"><a name="l00620"></a><span class="lineno">  620</span>&#160;        <span class="keywordflow">switch</span>(e) {</div><div class="line"><a name="l00621"></a><span class="lineno">  621</span>&#160;        <span class="keywordflow">case</span> <a class="code" href="classstored_1_1_arq_layer.html#a1d3b18fc5b159e527b087385ac961e52ad7a25330d281170fe07445ea0b491f05">EventNone</a>:</div><div class="line"><a name="l00622"></a><span class="lineno">  622</span>&#160;        <span class="keywordflow">case</span> <a class="code" href="classstored_1_1_arq_layer.html#a1d3b18fc5b159e527b087385ac961e52a695faff43603c7debd9ac61f8b607c99">EventReconnect</a>:</div><div class="line"><a name="l00623"></a><span class="lineno">  623</span>&#160;        <span class="keywordflow">case</span> <a class="code" href="classstored_1_1_arq_layer.html#a1d3b18fc5b159e527b087385ac961e52a67b425c96fa51d033359fbea7f1c344a">EventRetransmit</a>:</div><div class="line"><a name="l00624"></a><span class="lineno">  624</span>&#160;            <span class="comment">// By default, ignore.</span></div><div class="line"><a name="l00625"></a><span class="lineno">  625</span>&#160;            <span class="keywordflow">break</span>;</div><div class="line"><a name="l00626"></a><span class="lineno">  626</span>&#160;        <span class="keywordflow">case</span> <a class="code" href="classstored_1_1_arq_layer.html#a1d3b18fc5b159e527b087385ac961e52afec9d8b5d2c8fe338525458da4909a48">EventEncodeBufferOverflow</a>:</div><div class="line"><a name="l00627"></a><span class="lineno">  627</span>&#160;            <span class="comment">// Cannot handle this.</span></div><div class="line"><a name="l00628"></a><span class="lineno">  628</span>&#160;            abort();</div><div class="line"><a name="l00629"></a><span class="lineno">  629</span>&#160;        }</div><div class="line"><a name="l00630"></a><span class="lineno">  630</span>&#160;    }</div><div class="line"><a name="l00631"></a><span class="lineno">  631</span>&#160;}</div><div class="line"><a name="l00632"></a><span class="lineno">  632</span>&#160;</div><div class="line"><a name="l00636"></a><span class="lineno"><a class="line" href="classstored_1_1_arq_layer.html#aa6414510a8e158dd1df01b8738ac565b">  636</a></span>&#160;uint8_t <a class="code" href="classstored_1_1_arq_layer.html#aa6414510a8e158dd1df01b8738ac565b">ArqLayer::nextSeq</a>(uint8_t seq) {</div><div class="line"><a name="l00637"></a><span class="lineno">  637</span>&#160;    seq = (uint8_t)((seq + 1u) &amp; <a class="code" href="classstored_1_1_arq_layer.html#a6d481c24d715ceef8dcc2fd9cd19eab1">SeqMask</a>);</div><div class="line"><a name="l00638"></a><span class="lineno">  638</span>&#160;    <span class="keywordflow">return</span> seq ? seq : 1u;</div><div class="line"><a name="l00639"></a><span class="lineno">  639</span>&#160;}</div><div class="line"><a name="l00640"></a><span class="lineno">  640</span>&#160;</div><div class="line"><a name="l00641"></a><span class="lineno"><a class="line" href="classstored_1_1_arq_layer.html#a1efacad0bccc60d7d202663ce984aab2">  641</a></span>&#160;<span class="keywordtype">size_t</span> <a class="code" href="classstored_1_1_arq_layer.html#a1efacad0bccc60d7d202663ce984aab2">ArqLayer::mtu</a>()<span class="keyword"> const </span>{</div><div class="line"><a name="l00642"></a><span class="lineno">  642</span>&#160;    <span class="keywordtype">size_t</span> <a class="code" href="classstored_1_1_arq_layer.html#a1efacad0bccc60d7d202663ce984aab2">mtu</a> = <a class="code" href="classstored_1_1_protocol_layer.html#a88195d7cdb7129ac7bc625ffeb24d449">base::mtu</a>();</div><div class="line"><a name="l00643"></a><span class="lineno">  643</span>&#160;    <span class="keywordflow">if</span>(mtu == 0)</div><div class="line"><a name="l00644"></a><span class="lineno">  644</span>&#160;        <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l00645"></a><span class="lineno">  645</span>&#160;    <span class="keywordflow">if</span>(mtu &lt;= 2u)</div><div class="line"><a name="l00646"></a><span class="lineno">  646</span>&#160;        <span class="keywordflow">return</span> 1u;</div><div class="line"><a name="l00647"></a><span class="lineno">  647</span>&#160;    <span class="keywordflow">return</span> mtu - 2u;</div><div class="line"><a name="l00648"></a><span class="lineno">  648</span>&#160;}</div><div class="line"><a name="l00649"></a><span class="lineno">  649</span>&#160;</div><div class="line"><a name="l00663"></a><span class="lineno"><a class="line" href="classstored_1_1_arq_layer.html#a72a34dd87ec3fcee83db2a44f7e8a8e5">  663</a></span>&#160;<span class="keywordtype">bool</span> <a class="code" href="classstored_1_1_arq_layer.html#a72a34dd87ec3fcee83db2a44f7e8a8e5">ArqLayer::didTransmit</a>()<span class="keyword"> const </span>{</div><div class="line"><a name="l00664"></a><span class="lineno">  664</span>&#160;    <span class="keywordflow">return</span> m_didTransmit;</div><div class="line"><a name="l00665"></a><span class="lineno">  665</span>&#160;}</div><div class="line"><a name="l00666"></a><span class="lineno">  666</span>&#160;</div><div class="line"><a name="l00671"></a><span class="lineno"><a class="line" href="classstored_1_1_arq_layer.html#ad385593c1549539ec000943046860404">  671</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classstored_1_1_arq_layer.html#ad385593c1549539ec000943046860404">ArqLayer::resetDidTransmit</a>() {</div><div class="line"><a name="l00672"></a><span class="lineno">  672</span>&#160;    m_didTransmit = <span class="keyword">false</span>;</div><div class="line"><a name="l00673"></a><span class="lineno">  673</span>&#160;}</div><div class="line"><a name="l00674"></a><span class="lineno">  674</span>&#160;</div><div class="line"><a name="l00681"></a><span class="lineno"><a class="line" href="classstored_1_1_arq_layer.html#a7fc718f8b8c05aef735e2c861535eabc">  681</a></span>&#160;<span class="keywordtype">size_t</span> <a class="code" href="classstored_1_1_arq_layer.html#a7fc718f8b8c05aef735e2c861535eabc">ArqLayer::retransmits</a>()<span class="keyword"> const </span>{</div><div class="line"><a name="l00682"></a><span class="lineno">  682</span>&#160;    <span class="keywordflow">return</span> m_retransmits ? m_retransmits - 1u : 0u;</div><div class="line"><a name="l00683"></a><span class="lineno">  683</span>&#160;}</div><div class="line"><a name="l00684"></a><span class="lineno">  684</span>&#160;</div><div class="line"><a name="l00693"></a><span class="lineno"><a class="line" href="classstored_1_1_arq_layer.html#ab1d2c6282a3ecad2e561ddb517421b09">  693</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classstored_1_1_arq_layer.html#ab1d2c6282a3ecad2e561ddb517421b09">ArqLayer::keepAlive</a>() {</div><div class="line"><a name="l00694"></a><span class="lineno">  694</span>&#160;    <span class="keywordflow">if</span>(m_encodeQueue.empty()) {</div><div class="line"><a name="l00695"></a><span class="lineno">  695</span>&#160;        <span class="comment">// Send empty message. This will trigger (re)transmits, so a broken</span></div><div class="line"><a name="l00696"></a><span class="lineno">  696</span>&#160;        <span class="comment">// connection will be detected.</span></div><div class="line"><a name="l00697"></a><span class="lineno">  697</span>&#160;        <a class="code" href="classstored_1_1_arq_layer.html#a7e32f0946f88adc172b501b335c68632">pushEncodeQueueRaw</a>().push_back((<span class="keywordtype">char</span>)(m_sendSeq | <a class="code" href="classstored_1_1_arq_layer.html#a335ff281a24fb2aac70b381451589424">NopFlag</a>));</div><div class="line"><a name="l00698"></a><span class="lineno">  698</span>&#160;        m_encodeQueueSize++;</div><div class="line"><a name="l00699"></a><span class="lineno">  699</span>&#160;        m_sendSeq = <a class="code" href="classstored_1_1_arq_layer.html#aa6414510a8e158dd1df01b8738ac565b">nextSeq</a>(m_sendSeq);</div><div class="line"><a name="l00700"></a><span class="lineno">  700</span>&#160;    }</div><div class="line"><a name="l00701"></a><span class="lineno">  701</span>&#160;</div><div class="line"><a name="l00702"></a><span class="lineno">  702</span>&#160;    <a class="code" href="classstored_1_1_arq_layer.html#a06104ba40460c0852457bbe651ddba48">transmit</a>();</div><div class="line"><a name="l00703"></a><span class="lineno">  703</span>&#160;}</div><div class="line"><a name="l00704"></a><span class="lineno">  704</span>&#160;</div><div class="line"><a name="l00708"></a><span class="lineno"><a class="line" href="classstored_1_1_arq_layer.html#a1b2f96a8e25063dbf2631c5d2c765920">  708</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classstored_1_1_arq_layer.html#a1b2f96a8e25063dbf2631c5d2c765920">ArqLayer::popEncodeQueue</a>() {</div><div class="line"><a name="l00709"></a><span class="lineno">  709</span>&#160;    <a class="code" href="group__libstored__util.html#gab750e51b876450a0a4ad419588a82a4d">stored_assert</a>(!m_encodeQueue.empty());</div><div class="line"><a name="l00710"></a><span class="lineno">  710</span>&#160;    m_encodeQueueSize -= m_encodeQueue.front()-&gt;size();</div><div class="line"><a name="l00711"></a><span class="lineno">  711</span>&#160;    m_encodeQueue.front()-&gt;clear();</div><div class="line"><a name="l00712"></a><span class="lineno">  712</span>&#160;</div><div class="line"><a name="l00713"></a><span class="lineno">  713</span>&#160;<span class="preprocessor">#if STORED_cplusplus &gt;= 201103L</span></div><div class="line"><a name="l00714"></a><span class="lineno">  714</span>&#160;    m_spare.emplace_back(m_encodeQueue.front());</div><div class="line"><a name="l00715"></a><span class="lineno">  715</span>&#160;<span class="preprocessor">#else</span></div><div class="line"><a name="l00716"></a><span class="lineno">  716</span>&#160;    m_spare.push_back(m_encodeQueue.front());</div><div class="line"><a name="l00717"></a><span class="lineno">  717</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l00718"></a><span class="lineno">  718</span>&#160;</div><div class="line"><a name="l00719"></a><span class="lineno">  719</span>&#160;    m_encodeQueue.pop_front();</div><div class="line"><a name="l00720"></a><span class="lineno">  720</span>&#160;}</div><div class="line"><a name="l00721"></a><span class="lineno">  721</span>&#160;</div><div class="line"><a name="l00725"></a><span class="lineno"><a class="line" href="classstored_1_1_arq_layer.html#a9a411e363eaca7a8060277363feee51b">  725</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classstored_1_1_arq_layer.html#a9a411e363eaca7a8060277363feee51b">ArqLayer::pushEncodeQueue</a>(<span class="keywordtype">void</span> <span class="keyword">const</span>* buffer, <span class="keywordtype">size_t</span> len) {</div><div class="line"><a name="l00726"></a><span class="lineno">  726</span>&#160;    std::string&amp; s = <a class="code" href="classstored_1_1_arq_layer.html#a7e32f0946f88adc172b501b335c68632">pushEncodeQueueRaw</a>();</div><div class="line"><a name="l00727"></a><span class="lineno">  727</span>&#160;    s.push_back((<span class="keywordtype">char</span>)m_sendSeq);</div><div class="line"><a name="l00728"></a><span class="lineno">  728</span>&#160;    s.append(static_cast&lt;char const*&gt;(buffer), len);</div><div class="line"><a name="l00729"></a><span class="lineno">  729</span>&#160;    m_sendSeq = <a class="code" href="classstored_1_1_arq_layer.html#aa6414510a8e158dd1df01b8738ac565b">nextSeq</a>(m_sendSeq);</div><div class="line"><a name="l00730"></a><span class="lineno">  730</span>&#160;    m_encodeQueueSize += len;</div><div class="line"><a name="l00731"></a><span class="lineno">  731</span>&#160;}</div><div class="line"><a name="l00732"></a><span class="lineno">  732</span>&#160;</div><div class="line"><a name="l00739"></a><span class="lineno"><a class="line" href="classstored_1_1_arq_layer.html#a7e32f0946f88adc172b501b335c68632">  739</a></span>&#160;std::string&amp; <a class="code" href="classstored_1_1_arq_layer.html#a7e32f0946f88adc172b501b335c68632">ArqLayer::pushEncodeQueueRaw</a>() {</div><div class="line"><a name="l00740"></a><span class="lineno">  740</span>&#160;    std::string* s = <span class="keyword">nullptr</span>;</div><div class="line"><a name="l00741"></a><span class="lineno">  741</span>&#160;</div><div class="line"><a name="l00742"></a><span class="lineno">  742</span>&#160;    <span class="keywordflow">if</span>(m_spare.empty()) {</div><div class="line"><a name="l00743"></a><span class="lineno">  743</span>&#160;        <span class="comment">// NOLINTNEXTLINE(cppcoreguidelines-owning-memory)</span></div><div class="line"><a name="l00744"></a><span class="lineno">  744</span>&#160;        s = <span class="keyword">new</span> std::string;</div><div class="line"><a name="l00745"></a><span class="lineno">  745</span>&#160;</div><div class="line"><a name="l00746"></a><span class="lineno">  746</span>&#160;        m_encodeQueue.</div><div class="line"><a name="l00747"></a><span class="lineno">  747</span>&#160;#<span class="keywordflow">if</span> <a class="code" href="macros_8h.html#aa64cd2b6d63a68c9c8ec5fba4000cf8f">STORED_cplusplus</a> &gt;= 201103L</div><div class="line"><a name="l00748"></a><span class="lineno">  748</span>&#160;            emplace_back(s);</div><div class="line"><a name="l00749"></a><span class="lineno">  749</span>&#160;<span class="preprocessor">#else</span></div><div class="line"><a name="l00750"></a><span class="lineno">  750</span>&#160;            push_back(s);</div><div class="line"><a name="l00751"></a><span class="lineno">  751</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l00752"></a><span class="lineno">  752</span>&#160;    } <span class="keywordflow">else</span> {</div><div class="line"><a name="l00753"></a><span class="lineno">  753</span>&#160;        s = m_spare.back();</div><div class="line"><a name="l00754"></a><span class="lineno">  754</span>&#160;        m_spare.pop_back();</div><div class="line"><a name="l00755"></a><span class="lineno">  755</span>&#160;</div><div class="line"><a name="l00756"></a><span class="lineno">  756</span>&#160;        m_encodeQueue.</div><div class="line"><a name="l00757"></a><span class="lineno">  757</span>&#160;#<span class="keywordflow">if</span> <a class="code" href="macros_8h.html#aa64cd2b6d63a68c9c8ec5fba4000cf8f">STORED_cplusplus</a> &gt;= 201103L</div><div class="line"><a name="l00758"></a><span class="lineno">  758</span>&#160;            emplace_back(s);</div><div class="line"><a name="l00759"></a><span class="lineno">  759</span>&#160;<span class="preprocessor">#else</span></div><div class="line"><a name="l00760"></a><span class="lineno">  760</span>&#160;            push_back(s);</div><div class="line"><a name="l00761"></a><span class="lineno">  761</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l00762"></a><span class="lineno">  762</span>&#160;    }</div><div class="line"><a name="l00763"></a><span class="lineno">  763</span>&#160;</div><div class="line"><a name="l00764"></a><span class="lineno">  764</span>&#160;    <a class="code" href="group__libstored__util.html#gab750e51b876450a0a4ad419588a82a4d">stored_assert</a>(s-&gt;empty());</div><div class="line"><a name="l00765"></a><span class="lineno">  765</span>&#160;    <span class="keywordflow">return</span> *s;</div><div class="line"><a name="l00766"></a><span class="lineno">  766</span>&#160;}</div><div class="line"><a name="l00767"></a><span class="lineno">  767</span>&#160;</div><div class="line"><a name="l00771"></a><span class="lineno"><a class="line" href="classstored_1_1_arq_layer.html#ad8b06247c0e2efa0f54c8a1addac8e2d">  771</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classstored_1_1_arq_layer.html#ad8b06247c0e2efa0f54c8a1addac8e2d">ArqLayer::shrink_to_fit</a>() {</div><div class="line"><a name="l00772"></a><span class="lineno">  772</span>&#160;    <span class="keywordflow">for</span>(std::deque&lt;std::string*&gt;::iterator it = m_encodeQueue.begin(); it != m_encodeQueue.end(); ++it)</div><div class="line"><a name="l00773"></a><span class="lineno">  773</span>&#160;#<span class="keywordflow">if</span> <a class="code" href="macros_8h.html#aa64cd2b6d63a68c9c8ec5fba4000cf8f">STORED_cplusplus</a> &gt;= 201103L</div><div class="line"><a name="l00774"></a><span class="lineno">  774</span>&#160;        (*it)-&gt;shrink_to_fit();</div><div class="line"><a name="l00775"></a><span class="lineno">  775</span>&#160;<span class="preprocessor">#else</span></div><div class="line"><a name="l00776"></a><span class="lineno">  776</span>&#160;        (*it)-&gt;reserve((*it)-&gt;size());</div><div class="line"><a name="l00777"></a><span class="lineno">  777</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l00778"></a><span class="lineno">  778</span>&#160;</div><div class="line"><a name="l00779"></a><span class="lineno">  779</span>&#160;    <span class="keywordflow">for</span>(std::deque&lt;std::string*&gt;::iterator it = m_spare.begin(); it != m_spare.end(); ++it)</div><div class="line"><a name="l00780"></a><span class="lineno">  780</span>&#160;        <span class="keyword">delete</span> *it; <span class="comment">// NOLINT(cppcoreguidelines-owning-memory)</span></div><div class="line"><a name="l00781"></a><span class="lineno">  781</span>&#160;</div><div class="line"><a name="l00782"></a><span class="lineno">  782</span>&#160;    m_spare.clear();</div><div class="line"><a name="l00783"></a><span class="lineno">  783</span>&#160;<span class="preprocessor">#if STORED_cplusplus &gt;= 201103L</span></div><div class="line"><a name="l00784"></a><span class="lineno">  784</span>&#160;    m_spare.shrink_to_fit();</div><div class="line"><a name="l00785"></a><span class="lineno">  785</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l00786"></a><span class="lineno">  786</span>&#160;}</div><div class="line"><a name="l00787"></a><span class="lineno">  787</span>&#160;</div><div class="line"><a name="l00788"></a><span class="lineno">  788</span>&#160;</div><div class="line"><a name="l00790"></a><span class="lineno">  790</span>&#160;<span class="comment">// DebugArqLayer</span></div><div class="line"><a name="l00791"></a><span class="lineno">  791</span>&#160;<span class="comment">//</span></div><div class="line"><a name="l00792"></a><span class="lineno">  792</span>&#160;</div><div class="line"><a name="l00796"></a><span class="lineno"><a class="line" href="classstored_1_1_debug_arq_layer.html#a3b233392e7f1d2094789656d5c7f672d">  796</a></span>&#160;<a class="code" href="classstored_1_1_debug_arq_layer.html#ab96014cb5967321bc4d06871d5f7a727">DebugArqLayer::DebugArqLayer</a>(<span class="keywordtype">size_t</span> maxEncodeBuffer, <a class="code" href="classstored_1_1_protocol_layer.html">ProtocolLayer</a>* up, <a class="code" href="classstored_1_1_protocol_layer.html">ProtocolLayer</a>* down)</div><div class="line"><a name="l00797"></a><span class="lineno">  797</span>&#160;    : <a class="code" href="classstored_1_1_protocol_layer.html">base</a>(up, down)</div><div class="line"><a name="l00798"></a><span class="lineno">  798</span>&#160;    , m_decodeState(DecodeStateIdle)</div><div class="line"><a name="l00799"></a><span class="lineno">  799</span>&#160;    , m_decodeSeq(1)</div><div class="line"><a name="l00800"></a><span class="lineno">  800</span>&#160;    , m_decodeSeqStart()</div><div class="line"><a name="l00801"></a><span class="lineno">  801</span>&#160;    , m_encodeState(<a class="code" href="classstored_1_1_arq_layer.html#a5afc54c8eec96b06ba9c0a99d4dca7c1adc66734e4631a5349dcaba9bcf8dd524">EncodeStateIdle</a>)</div><div class="line"><a name="l00802"></a><span class="lineno">  802</span>&#160;    , m_encodeSeq(1)</div><div class="line"><a name="l00803"></a><span class="lineno">  803</span>&#160;    , m_encodeSeqReset(true)</div><div class="line"><a name="l00804"></a><span class="lineno">  804</span>&#160;    , m_maxEncodeBuffer(maxEncodeBuffer)</div><div class="line"><a name="l00805"></a><span class="lineno">  805</span>&#160;    , m_encodeBufferSize()</div><div class="line"><a name="l00806"></a><span class="lineno">  806</span>&#160;{</div><div class="line"><a name="l00807"></a><span class="lineno">  807</span>&#160;}</div><div class="line"><a name="l00808"></a><span class="lineno">  808</span>&#160;</div><div class="line"><a name="l00809"></a><span class="lineno"><a class="line" href="classstored_1_1_debug_arq_layer.html#a6b16bc8ebeb3d6e2bc3fa2fd42a82998">  809</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classstored_1_1_debug_arq_layer.html#a6b16bc8ebeb3d6e2bc3fa2fd42a82998">DebugArqLayer::reset</a>() {</div><div class="line"><a name="l00810"></a><span class="lineno">  810</span>&#160;    m_decodeState = DecodeStateIdle;</div><div class="line"><a name="l00811"></a><span class="lineno">  811</span>&#160;    m_decodeSeq = 1;</div><div class="line"><a name="l00812"></a><span class="lineno">  812</span>&#160;    m_decodeSeqStart = 0;</div><div class="line"><a name="l00813"></a><span class="lineno">  813</span>&#160;    m_encodeState = EncodeStateIdle;</div><div class="line"><a name="l00814"></a><span class="lineno">  814</span>&#160;    m_encodeSeq = 1;</div><div class="line"><a name="l00815"></a><span class="lineno">  815</span>&#160;    m_encodeSeqReset = <span class="keyword">true</span>;</div><div class="line"><a name="l00816"></a><span class="lineno">  816</span>&#160;    m_encodeBuffer.clear();</div><div class="line"><a name="l00817"></a><span class="lineno">  817</span>&#160;    m_encodeBufferSize = 0;</div><div class="line"><a name="l00818"></a><span class="lineno">  818</span>&#160;    <a class="code" href="classstored_1_1_protocol_layer.html#a53fe78a7b405b981649112d9c84fe762">base::reset</a>();</div><div class="line"><a name="l00819"></a><span class="lineno">  819</span>&#160;}</div><div class="line"><a name="l00820"></a><span class="lineno">  820</span>&#160;</div><div class="line"><a name="l00821"></a><span class="lineno"><a class="line" href="classstored_1_1_debug_arq_layer.html#a2dc5a377d6c5f636cd0e3cf4343ddea4">  821</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classstored_1_1_debug_arq_layer.html#a2dc5a377d6c5f636cd0e3cf4343ddea4">DebugArqLayer::decode</a>(<span class="keywordtype">void</span>* buffer, <span class="keywordtype">size_t</span> len) {</div><div class="line"><a name="l00822"></a><span class="lineno">  822</span>&#160;    <span class="keywordflow">if</span>(len == 0)</div><div class="line"><a name="l00823"></a><span class="lineno">  823</span>&#160;        <span class="keywordflow">return</span>;</div><div class="line"><a name="l00824"></a><span class="lineno">  824</span>&#160;</div><div class="line"><a name="l00825"></a><span class="lineno">  825</span>&#160;    uint8_t* buffer_ = <span class="keyword">static_cast&lt;</span>uint8_t*<span class="keyword">&gt;</span>(buffer);</div><div class="line"><a name="l00826"></a><span class="lineno">  826</span>&#160;    uint8_t flags = *buffer_;</div><div class="line"><a name="l00827"></a><span class="lineno">  827</span>&#160;    uint32_t seq = <a class="code" href="classstored_1_1_debug_arq_layer.html#a0a71050aa34e149b3fd0a326c16d5c6a">decodeSeq</a>(buffer_, len);</div><div class="line"><a name="l00828"></a><span class="lineno">  828</span>&#160;    <span class="keywordflow">if</span>(<a class="code" href="group__libstored__util.html#gad8700448546b3b5111404cc021061fd5">unlikely</a>(flags &amp; <a class="code" href="classstored_1_1_debug_arq_layer.html#a87a309300610933db0afa522a0ae517a">ResetFlag</a>)) {</div><div class="line"><a name="l00829"></a><span class="lineno">  829</span>&#160;        <span class="comment">// Reset communication state.</span></div><div class="line"><a name="l00830"></a><span class="lineno">  830</span>&#160;        m_decodeState = DecodeStateIdle;</div><div class="line"><a name="l00831"></a><span class="lineno">  831</span>&#160;        m_encodeState = EncodeStateIdle;</div><div class="line"><a name="l00832"></a><span class="lineno">  832</span>&#160;        m_encodeBuffer.clear();</div><div class="line"><a name="l00833"></a><span class="lineno">  833</span>&#160;        m_encodeBufferSize = 0;</div><div class="line"><a name="l00834"></a><span class="lineno">  834</span>&#160;        m_decodeSeq = <a class="code" href="classstored_1_1_debug_arq_layer.html#ac5dab34e5ae9a79154eba3265be14bd1">nextSeq</a>(seq);</div><div class="line"><a name="l00835"></a><span class="lineno">  835</span>&#160;        m_encodeSeq = 1;</div><div class="line"><a name="l00836"></a><span class="lineno">  836</span>&#160;        <a class="code" href="classstored_1_1_debug_arq_layer.html#a036abba40a16df72e93b9fd9a9251bbb">setPurgeableResponse</a>(<span class="keyword">false</span>);</div><div class="line"><a name="l00837"></a><span class="lineno">  837</span>&#160;        uint8_t ack = <a class="code" href="classstored_1_1_debug_arq_layer.html#a87a309300610933db0afa522a0ae517a">ResetFlag</a>;</div><div class="line"><a name="l00838"></a><span class="lineno">  838</span>&#160;        <a class="code" href="classstored_1_1_protocol_layer.html#a66c24cec6a17c44fac68213d358a5aa8">base::encode</a>(&amp;ack, <span class="keyword">sizeof</span>(ack), <span class="keyword">true</span>);</div><div class="line"><a name="l00839"></a><span class="lineno">  839</span>&#160;        m_encodeSeqReset = <span class="keyword">false</span>;</div><div class="line"><a name="l00840"></a><span class="lineno">  840</span>&#160;    }</div><div class="line"><a name="l00841"></a><span class="lineno">  841</span>&#160;</div><div class="line"><a name="l00842"></a><span class="lineno">  842</span>&#160;    <span class="keywordflow">switch</span>(m_decodeState) {</div><div class="line"><a name="l00843"></a><span class="lineno">  843</span>&#160;    <span class="keywordflow">case</span> DecodeStateDecoded:</div><div class="line"><a name="l00844"></a><span class="lineno">  844</span>&#160;        <a class="code" href="group__libstored__util.html#gab750e51b876450a0a4ad419588a82a4d">stored_assert</a>(m_encodeState == EncodeStateIdle || m_encodeState == EncodeStateUnbufferedIdle);</div><div class="line"><a name="l00845"></a><span class="lineno">  845</span>&#160;</div><div class="line"><a name="l00846"></a><span class="lineno">  846</span>&#160;        <span class="keywordflow">if</span>(seq == m_decodeSeq) {</div><div class="line"><a name="l00847"></a><span class="lineno">  847</span>&#160;            <span class="comment">// This is the next command. The previous one was received, apparently.</span></div><div class="line"><a name="l00848"></a><span class="lineno">  848</span>&#160;            m_decodeState = DecodeStateIdle;</div><div class="line"><a name="l00849"></a><span class="lineno">  849</span>&#160;            m_encodeState = EncodeStateIdle;</div><div class="line"><a name="l00850"></a><span class="lineno">  850</span>&#160;            m_encodeBuffer.clear();</div><div class="line"><a name="l00851"></a><span class="lineno">  851</span>&#160;            m_encodeBufferSize = 0;</div><div class="line"><a name="l00852"></a><span class="lineno">  852</span>&#160;            <a class="code" href="classstored_1_1_debug_arq_layer.html#a036abba40a16df72e93b9fd9a9251bbb">setPurgeableResponse</a>(<span class="keyword">false</span>);</div><div class="line"><a name="l00853"></a><span class="lineno">  853</span>&#160;        } <span class="keywordflow">else</span></div><div class="line"><a name="l00854"></a><span class="lineno">  854</span>&#160;            <span class="comment">// fall-through</span></div><div class="line"><a name="l00855"></a><span class="lineno">  855</span>&#160;    <span class="keywordflow">case</span> DecodeStateRetransmit:</div><div class="line"><a name="l00856"></a><span class="lineno">  856</span>&#160;        <span class="keywordflow">if</span>(seq == m_decodeSeqStart) {</div><div class="line"><a name="l00857"></a><span class="lineno">  857</span>&#160;            <span class="comment">// This seems to be a retransmit of the current command.</span></div><div class="line"><a name="l00858"></a><span class="lineno">  858</span>&#160;            <span class="keywordflow">switch</span>(m_encodeState) {</div><div class="line"><a name="l00859"></a><span class="lineno">  859</span>&#160;            <span class="keywordflow">case</span> EncodeStateUnbufferedIdle:</div><div class="line"><a name="l00860"></a><span class="lineno">  860</span>&#160;                <span class="comment">// We must reexecute the command. Reset the sequence number, as the content may change.</span></div><div class="line"><a name="l00861"></a><span class="lineno">  861</span>&#160;                <a class="code" href="classstored_1_1_debug_arq_layer.html#a036abba40a16df72e93b9fd9a9251bbb">setPurgeableResponse</a>(<span class="keyword">false</span>);</div><div class="line"><a name="l00862"></a><span class="lineno">  862</span>&#160;                m_decodeSeq = m_decodeSeqStart;</div><div class="line"><a name="l00863"></a><span class="lineno">  863</span>&#160;                m_decodeState = DecodeStateIdle;</div><div class="line"><a name="l00864"></a><span class="lineno">  864</span>&#160;                m_encodeSeqReset = <span class="keyword">true</span>;</div><div class="line"><a name="l00865"></a><span class="lineno">  865</span>&#160;                <span class="keywordflow">break</span>;</div><div class="line"><a name="l00866"></a><span class="lineno">  866</span>&#160;            <span class="keywordflow">case</span> EncodeStateIdle:</div><div class="line"><a name="l00867"></a><span class="lineno">  867</span>&#160;                <span class="comment">// Wait for full retransmit of the command, but do not actually decode.</span></div><div class="line"><a name="l00868"></a><span class="lineno">  868</span>&#160;                m_decodeState = DecodeStateRetransmit;</div><div class="line"><a name="l00869"></a><span class="lineno">  869</span>&#160;                <span class="keywordflow">break</span>;</div><div class="line"><a name="l00870"></a><span class="lineno">  870</span>&#160;            <span class="keywordflow">default</span>:</div><div class="line"><a name="l00871"></a><span class="lineno">  871</span>&#160;                <a class="code" href="group__libstored__util.html#gab750e51b876450a0a4ad419588a82a4d">stored_assert</a>(<span class="keyword">false</span>); <span class="comment">// NOLINT(hicpp-static-assert,misc-static-assert)</span></div><div class="line"><a name="l00872"></a><span class="lineno">  872</span>&#160;            }</div><div class="line"><a name="l00873"></a><span class="lineno">  873</span>&#160;        } <span class="comment">// else: unexpected seq; ignore.</span></div><div class="line"><a name="l00874"></a><span class="lineno">  874</span>&#160;        <span class="keywordflow">break</span>;</div><div class="line"><a name="l00875"></a><span class="lineno">  875</span>&#160;    <span class="keywordflow">default</span>:;</div><div class="line"><a name="l00876"></a><span class="lineno">  876</span>&#160;    }</div><div class="line"><a name="l00877"></a><span class="lineno">  877</span>&#160;</div><div class="line"><a name="l00878"></a><span class="lineno">  878</span>&#160;    <span class="keywordflow">switch</span>(m_decodeState) {</div><div class="line"><a name="l00879"></a><span class="lineno">  879</span>&#160;    <span class="keywordflow">case</span> DecodeStateRetransmit:</div><div class="line"><a name="l00880"></a><span class="lineno">  880</span>&#160;        <span class="keywordflow">if</span>(<a class="code" href="classstored_1_1_debug_arq_layer.html#ac5dab34e5ae9a79154eba3265be14bd1">nextSeq</a>(seq) == m_decodeSeq) {</div><div class="line"><a name="l00881"></a><span class="lineno">  881</span>&#160;            <span class="comment">// Got the last part of the command. Retransmit the response buffer.</span></div><div class="line"><a name="l00882"></a><span class="lineno">  882</span>&#160;            <span class="keywordflow">for</span>(std::vector&lt;std::string&gt;::const_iterator it = m_encodeBuffer.begin(); it != m_encodeBuffer.end(); ++it)</div><div class="line"><a name="l00883"></a><span class="lineno">  883</span>&#160;                <a class="code" href="classstored_1_1_protocol_layer.html#a66c24cec6a17c44fac68213d358a5aa8">base::encode</a>(it-&gt;data(), it-&gt;size(), <span class="keyword">true</span>);</div><div class="line"><a name="l00884"></a><span class="lineno">  884</span>&#160;            m_decodeState = DecodeStateDecoded;</div><div class="line"><a name="l00885"></a><span class="lineno">  885</span>&#160;        }</div><div class="line"><a name="l00886"></a><span class="lineno">  886</span>&#160;        <span class="keywordflow">break</span>;</div><div class="line"><a name="l00887"></a><span class="lineno">  887</span>&#160;    <span class="keywordflow">case</span> DecodeStateIdle:</div><div class="line"><a name="l00888"></a><span class="lineno">  888</span>&#160;        m_decodeSeqStart = m_decodeSeq;</div><div class="line"><a name="l00889"></a><span class="lineno">  889</span>&#160;        m_decodeState = DecodeStateDecoding;</div><div class="line"><a name="l00890"></a><span class="lineno">  890</span>&#160;        <span class="comment">// fall-through</span></div><div class="line"><a name="l00891"></a><span class="lineno">  891</span>&#160;    <span class="keywordflow">case</span> DecodeStateDecoding:</div><div class="line"><a name="l00892"></a><span class="lineno">  892</span>&#160;        <span class="keywordflow">if</span>(<a class="code" href="group__libstored__util.html#gaa0672ea7123854cc5f51902a06c473fb">likely</a>(seq == m_decodeSeq)) {</div><div class="line"><a name="l00893"></a><span class="lineno">  893</span>&#160;            <span class="comment">// Properly in sequence.</span></div><div class="line"><a name="l00894"></a><span class="lineno">  894</span>&#160;            <a class="code" href="classstored_1_1_protocol_layer.html#a357b029311be09df61e019682a848ab5">base::decode</a>(buffer_, len);</div><div class="line"><a name="l00895"></a><span class="lineno">  895</span>&#160;            m_decodeSeq = <a class="code" href="classstored_1_1_debug_arq_layer.html#ac5dab34e5ae9a79154eba3265be14bd1">nextSeq</a>(m_decodeSeq);</div><div class="line"><a name="l00896"></a><span class="lineno">  896</span>&#160;</div><div class="line"><a name="l00897"></a><span class="lineno">  897</span>&#160;            <span class="comment">// Should not wrap-around during a request.</span></div><div class="line"><a name="l00898"></a><span class="lineno">  898</span>&#160;            <a class="code" href="group__libstored__util.html#gab750e51b876450a0a4ad419588a82a4d">stored_assert</a>(m_decodeSeq != m_decodeSeqStart);</div><div class="line"><a name="l00899"></a><span class="lineno">  899</span>&#160;        }</div><div class="line"><a name="l00900"></a><span class="lineno">  900</span>&#160;        <span class="keywordflow">break</span>;</div><div class="line"><a name="l00901"></a><span class="lineno">  901</span>&#160;    <span class="keywordflow">default</span>:;</div><div class="line"><a name="l00902"></a><span class="lineno">  902</span>&#160;    }</div><div class="line"><a name="l00903"></a><span class="lineno">  903</span>&#160;}</div><div class="line"><a name="l00904"></a><span class="lineno">  904</span>&#160;</div><div class="line"><a name="l00905"></a><span class="lineno"><a class="line" href="classstored_1_1_debug_arq_layer.html#af737904b1c5650a91dd00b7e21176d05">  905</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classstored_1_1_protocol_layer.html#a66c24cec6a17c44fac68213d358a5aa8">DebugArqLayer::encode</a>(<span class="keywordtype">void</span> <span class="keyword">const</span>* buffer, <span class="keywordtype">size_t</span> len, <span class="keywordtype">bool</span> last) {</div><div class="line"><a name="l00906"></a><span class="lineno">  906</span>&#160;    <span class="keywordflow">if</span>(m_decodeState == DecodeStateDecoding) {</div><div class="line"><a name="l00907"></a><span class="lineno">  907</span>&#160;        <span class="comment">// This seems to be the first part of the response.</span></div><div class="line"><a name="l00908"></a><span class="lineno">  908</span>&#160;        <span class="comment">// So, the request message must have been complete.</span></div><div class="line"><a name="l00909"></a><span class="lineno">  909</span>&#160;        m_decodeState = DecodeStateDecoded;</div><div class="line"><a name="l00910"></a><span class="lineno">  910</span>&#160;        <a class="code" href="group__libstored__util.html#gab750e51b876450a0a4ad419588a82a4d">stored_assert</a>(m_encodeState == EncodeStateIdle || m_encodeState == EncodeStateUnbufferedIdle);</div><div class="line"><a name="l00911"></a><span class="lineno">  911</span>&#160;    }</div><div class="line"><a name="l00912"></a><span class="lineno">  912</span>&#160;</div><div class="line"><a name="l00913"></a><span class="lineno">  913</span>&#160;    <span class="keywordflow">switch</span>(m_encodeState) {</div><div class="line"><a name="l00914"></a><span class="lineno">  914</span>&#160;    <span class="keywordflow">case</span> EncodeStateIdle:</div><div class="line"><a name="l00915"></a><span class="lineno">  915</span>&#160;    <span class="keywordflow">case</span> EncodeStateEncoding:</div><div class="line"><a name="l00916"></a><span class="lineno">  916</span>&#160;        <span class="keywordflow">if</span>(<a class="code" href="group__libstored__util.html#gad8700448546b3b5111404cc021061fd5">unlikely</a>(m_maxEncodeBuffer &gt; 0 &amp;&amp; m_encodeBufferSize + len &gt; m_maxEncodeBuffer)) {</div><div class="line"><a name="l00917"></a><span class="lineno">  917</span>&#160;            <span class="comment">// Overflow.</span></div><div class="line"><a name="l00918"></a><span class="lineno">  918</span>&#160;            <a class="code" href="classstored_1_1_debug_arq_layer.html#a036abba40a16df72e93b9fd9a9251bbb">setPurgeableResponse</a>();</div><div class="line"><a name="l00919"></a><span class="lineno">  919</span>&#160;        }</div><div class="line"><a name="l00920"></a><span class="lineno">  920</span>&#160;        <span class="keywordflow">break</span>;</div><div class="line"><a name="l00921"></a><span class="lineno">  921</span>&#160;    <span class="keywordflow">default</span>:;</div><div class="line"><a name="l00922"></a><span class="lineno">  922</span>&#160;    }</div><div class="line"><a name="l00923"></a><span class="lineno">  923</span>&#160;</div><div class="line"><a name="l00924"></a><span class="lineno">  924</span>&#160;    uint8_t seq[4];</div><div class="line"><a name="l00925"></a><span class="lineno">  925</span>&#160;    <span class="keywordtype">size_t</span> seqlen = 0;</div><div class="line"><a name="l00926"></a><span class="lineno">  926</span>&#160;</div><div class="line"><a name="l00927"></a><span class="lineno">  927</span>&#160;    <span class="keywordflow">switch</span>(m_encodeState) {</div><div class="line"><a name="l00928"></a><span class="lineno">  928</span>&#160;    <span class="keywordflow">case</span> EncodeStateUnbufferedIdle:</div><div class="line"><a name="l00929"></a><span class="lineno">  929</span>&#160;    <span class="keywordflow">case</span> EncodeStateIdle:</div><div class="line"><a name="l00930"></a><span class="lineno">  930</span>&#160;        seqlen = <a class="code" href="classstored_1_1_debug_arq_layer.html#a4f99570d92e54c761f31f330968187fb">encodeSeq</a>(m_encodeSeq, seq);</div><div class="line"><a name="l00931"></a><span class="lineno">  931</span>&#160;        <a class="code" href="group__libstored__util.html#gab750e51b876450a0a4ad419588a82a4d">stored_assert</a>(seqlen &lt;= <span class="keyword">sizeof</span>(seq));</div><div class="line"><a name="l00932"></a><span class="lineno">  932</span>&#160;        m_encodeSeq = <a class="code" href="classstored_1_1_debug_arq_layer.html#ac5dab34e5ae9a79154eba3265be14bd1">nextSeq</a>(m_encodeSeq);</div><div class="line"><a name="l00933"></a><span class="lineno">  933</span>&#160;        <span class="comment">// Assume a wrap-around will be noticed, as it contains at least 128 MB of data.</span></div><div class="line"><a name="l00934"></a><span class="lineno">  934</span>&#160;        <span class="keywordflow">if</span>(m_encodeSeqReset) {</div><div class="line"><a name="l00935"></a><span class="lineno">  935</span>&#160;            seq[0] = (uint8_t)(seq[0] | <a class="code" href="classstored_1_1_debug_arq_layer.html#a87a309300610933db0afa522a0ae517a">ResetFlag</a>);</div><div class="line"><a name="l00936"></a><span class="lineno">  936</span>&#160;            m_encodeSeqReset = <span class="keyword">false</span>;</div><div class="line"><a name="l00937"></a><span class="lineno">  937</span>&#160;        }</div><div class="line"><a name="l00938"></a><span class="lineno">  938</span>&#160;        <span class="keywordflow">break</span>;</div><div class="line"><a name="l00939"></a><span class="lineno">  939</span>&#160;    <span class="keywordflow">default</span>:;</div><div class="line"><a name="l00940"></a><span class="lineno">  940</span>&#160;    }</div><div class="line"><a name="l00941"></a><span class="lineno">  941</span>&#160;</div><div class="line"><a name="l00942"></a><span class="lineno">  942</span>&#160;    <span class="keywordflow">switch</span>(m_encodeState) {</div><div class="line"><a name="l00943"></a><span class="lineno">  943</span>&#160;    <span class="keywordflow">case</span> EncodeStateUnbufferedIdle:</div><div class="line"><a name="l00944"></a><span class="lineno">  944</span>&#160;        <a class="code" href="classstored_1_1_protocol_layer.html#a66c24cec6a17c44fac68213d358a5aa8">base::encode</a>(seq, seqlen, <span class="keyword">false</span>);</div><div class="line"><a name="l00945"></a><span class="lineno">  945</span>&#160;        m_encodeState = EncodeStateUnbufferedEncoding;</div><div class="line"><a name="l00946"></a><span class="lineno">  946</span>&#160;        <span class="comment">// fall-through</span></div><div class="line"><a name="l00947"></a><span class="lineno">  947</span>&#160;    <span class="keywordflow">case</span> EncodeStateUnbufferedEncoding:</div><div class="line"><a name="l00948"></a><span class="lineno">  948</span>&#160;        <a class="code" href="classstored_1_1_protocol_layer.html#a66c24cec6a17c44fac68213d358a5aa8">base::encode</a>(buffer, len, last);</div><div class="line"><a name="l00949"></a><span class="lineno">  949</span>&#160;        <span class="keywordflow">if</span>(last)</div><div class="line"><a name="l00950"></a><span class="lineno">  950</span>&#160;            m_encodeState = EncodeStateUnbufferedIdle;</div><div class="line"><a name="l00951"></a><span class="lineno">  951</span>&#160;        <span class="keywordflow">break</span>;</div><div class="line"><a name="l00952"></a><span class="lineno">  952</span>&#160;</div><div class="line"><a name="l00953"></a><span class="lineno">  953</span>&#160;    <span class="keywordflow">case</span> EncodeStateIdle:</div><div class="line"><a name="l00954"></a><span class="lineno">  954</span>&#160;<span class="preprocessor">#if STORED_cplusplus &gt;= 201103L</span></div><div class="line"><a name="l00955"></a><span class="lineno">  955</span>&#160;        <span class="comment">// NOLINTNEXTLINE(cppcoreguidelines-pro-type-reinterpret-cast)</span></div><div class="line"><a name="l00956"></a><span class="lineno">  956</span>&#160;        m_encodeBuffer.emplace_back(reinterpret_cast&lt;char*&gt;(seq), seqlen);</div><div class="line"><a name="l00957"></a><span class="lineno">  957</span>&#160;<span class="preprocessor">#else</span></div><div class="line"><a name="l00958"></a><span class="lineno">  958</span>&#160;        <span class="comment">// NOLINTNEXTLINE(cppcoreguidelines-pro-type-reinterpret-cast)</span></div><div class="line"><a name="l00959"></a><span class="lineno">  959</span>&#160;        m_encodeBuffer.push_back(std::string(reinterpret_cast&lt;char*&gt;(seq), seqlen));</div><div class="line"><a name="l00960"></a><span class="lineno">  960</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l00961"></a><span class="lineno">  961</span>&#160;        m_encodeState = EncodeStateEncoding;</div><div class="line"><a name="l00962"></a><span class="lineno">  962</span>&#160;        m_encodeBufferSize += seqlen;</div><div class="line"><a name="l00963"></a><span class="lineno">  963</span>&#160;        <span class="comment">// fall-through</span></div><div class="line"><a name="l00964"></a><span class="lineno">  964</span>&#160;    <span class="keywordflow">case</span> EncodeStateEncoding:</div><div class="line"><a name="l00965"></a><span class="lineno">  965</span>&#160;        <a class="code" href="group__libstored__util.html#gab750e51b876450a0a4ad419588a82a4d">stored_assert</a>(!m_encodeBuffer.empty());</div><div class="line"><a name="l00966"></a><span class="lineno">  966</span>&#160;        m_encodeBufferSize += len;</div><div class="line"><a name="l00967"></a><span class="lineno">  967</span>&#160;        m_encodeBuffer.back().append(static_cast&lt;char const*&gt;(buffer), len);</div><div class="line"><a name="l00968"></a><span class="lineno">  968</span>&#160;</div><div class="line"><a name="l00969"></a><span class="lineno">  969</span>&#160;        <span class="keywordflow">if</span>(last) {</div><div class="line"><a name="l00970"></a><span class="lineno">  970</span>&#160;            <a class="code" href="classstored_1_1_protocol_layer.html#a66c24cec6a17c44fac68213d358a5aa8">base::encode</a>(m_encodeBuffer.back().data(), m_encodeBuffer.back().size(), <span class="keyword">true</span>);</div><div class="line"><a name="l00971"></a><span class="lineno">  971</span>&#160;            m_encodeState = EncodeStateIdle;</div><div class="line"><a name="l00972"></a><span class="lineno">  972</span>&#160;        }</div><div class="line"><a name="l00973"></a><span class="lineno">  973</span>&#160;    }</div><div class="line"><a name="l00974"></a><span class="lineno">  974</span>&#160;}</div><div class="line"><a name="l00975"></a><span class="lineno">  975</span>&#160;</div><div class="line"><a name="l00976"></a><span class="lineno"><a class="line" href="classstored_1_1_debug_arq_layer.html#a036abba40a16df72e93b9fd9a9251bbb">  976</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classstored_1_1_debug_arq_layer.html#a036abba40a16df72e93b9fd9a9251bbb">DebugArqLayer::setPurgeableResponse</a>(<span class="keywordtype">bool</span> purgeable) {</div><div class="line"><a name="l00977"></a><span class="lineno">  977</span>&#160;    <span class="keywordtype">bool</span> wasPurgeable = m_encodeState == EncodeStateUnbufferedIdle || m_encodeState == EncodeStateUnbufferedEncoding;</div><div class="line"><a name="l00978"></a><span class="lineno">  978</span>&#160;</div><div class="line"><a name="l00979"></a><span class="lineno">  979</span>&#160;    <span class="keywordflow">if</span>(wasPurgeable == purgeable)</div><div class="line"><a name="l00980"></a><span class="lineno">  980</span>&#160;        <span class="keywordflow">return</span>;</div><div class="line"><a name="l00981"></a><span class="lineno">  981</span>&#160;</div><div class="line"><a name="l00982"></a><span class="lineno">  982</span>&#160;    <span class="keywordflow">if</span>(purgeable) {</div><div class="line"><a name="l00983"></a><span class="lineno">  983</span>&#160;        <span class="comment">// Switch to purgeable.</span></div><div class="line"><a name="l00984"></a><span class="lineno">  984</span>&#160;        <a class="code" href="classstored_1_1_protocol_layer.html#a8e8b913345f11bf3cf3999c305905681">base::setPurgeableResponse</a>(<span class="keyword">true</span>);</div><div class="line"><a name="l00985"></a><span class="lineno">  985</span>&#160;</div><div class="line"><a name="l00986"></a><span class="lineno">  986</span>&#160;        <span class="keywordflow">switch</span>(m_encodeState) {</div><div class="line"><a name="l00987"></a><span class="lineno">  987</span>&#160;        <span class="keywordflow">case</span> EncodeStateEncoding: {</div><div class="line"><a name="l00988"></a><span class="lineno">  988</span>&#160;            std::string <span class="keyword">const</span>&amp; s = m_encodeBuffer.back();</div><div class="line"><a name="l00989"></a><span class="lineno">  989</span>&#160;            <a class="code" href="classstored_1_1_protocol_layer.html#a66c24cec6a17c44fac68213d358a5aa8">base::encode</a>(s.data(), s.size(), <span class="keyword">false</span>);</div><div class="line"><a name="l00990"></a><span class="lineno">  990</span>&#160;            m_encodeState = EncodeStateUnbufferedEncoding;</div><div class="line"><a name="l00991"></a><span class="lineno">  991</span>&#160;            <span class="keywordflow">break</span>; }</div><div class="line"><a name="l00992"></a><span class="lineno">  992</span>&#160;        <span class="keywordflow">case</span> EncodeStateIdle:</div><div class="line"><a name="l00993"></a><span class="lineno">  993</span>&#160;            m_encodeState = EncodeStateUnbufferedIdle;</div><div class="line"><a name="l00994"></a><span class="lineno">  994</span>&#160;            <span class="keywordflow">break</span>;</div><div class="line"><a name="l00995"></a><span class="lineno">  995</span>&#160;        <span class="keywordflow">default</span>:</div><div class="line"><a name="l00996"></a><span class="lineno">  996</span>&#160;            <a class="code" href="group__libstored__util.html#gab750e51b876450a0a4ad419588a82a4d">stored_assert</a>(<span class="keyword">false</span>); <span class="comment">// NOLINT(hicpp-static-assert,misc-static-assert)</span></div><div class="line"><a name="l00997"></a><span class="lineno">  997</span>&#160;        }</div><div class="line"><a name="l00998"></a><span class="lineno">  998</span>&#160;</div><div class="line"><a name="l00999"></a><span class="lineno">  999</span>&#160;        m_encodeBuffer.clear();</div><div class="line"><a name="l01000"></a><span class="lineno"> 1000</span>&#160;        m_encodeBufferSize = 0;</div><div class="line"><a name="l01001"></a><span class="lineno"> 1001</span>&#160;    } <span class="keywordflow">else</span> {</div><div class="line"><a name="l01002"></a><span class="lineno"> 1002</span>&#160;        <span class="comment">// Switch to precious.</span></div><div class="line"><a name="l01003"></a><span class="lineno"> 1003</span>&#160;        <span class="keywordflow">switch</span>(m_encodeState) {</div><div class="line"><a name="l01004"></a><span class="lineno"> 1004</span>&#160;        <span class="keywordflow">case</span> EncodeStateUnbufferedEncoding:</div><div class="line"><a name="l01005"></a><span class="lineno"> 1005</span>&#160;            <span class="comment">// First part already sent. Can&#39;t switch to precious right now.</span></div><div class="line"><a name="l01006"></a><span class="lineno"> 1006</span>&#160;            <span class="comment">// Wait till start of next command.</span></div><div class="line"><a name="l01007"></a><span class="lineno"> 1007</span>&#160;            <span class="keywordflow">break</span>;</div><div class="line"><a name="l01008"></a><span class="lineno"> 1008</span>&#160;        <span class="keywordflow">case</span> EncodeStateUnbufferedIdle:</div><div class="line"><a name="l01009"></a><span class="lineno"> 1009</span>&#160;            <a class="code" href="classstored_1_1_protocol_layer.html#a8e8b913345f11bf3cf3999c305905681">base::setPurgeableResponse</a>(<span class="keyword">false</span>);</div><div class="line"><a name="l01010"></a><span class="lineno"> 1010</span>&#160;            m_encodeState = EncodeStateIdle;</div><div class="line"><a name="l01011"></a><span class="lineno"> 1011</span>&#160;            <span class="keywordflow">break</span>;</div><div class="line"><a name="l01012"></a><span class="lineno"> 1012</span>&#160;        <span class="keywordflow">default</span>:</div><div class="line"><a name="l01013"></a><span class="lineno"> 1013</span>&#160;            <a class="code" href="group__libstored__util.html#gab750e51b876450a0a4ad419588a82a4d">stored_assert</a>(<span class="keyword">false</span>); <span class="comment">// NOLINT(hicpp-static-assert,misc-static-assert)</span></div><div class="line"><a name="l01014"></a><span class="lineno"> 1014</span>&#160;        }</div><div class="line"><a name="l01015"></a><span class="lineno"> 1015</span>&#160;    }</div><div class="line"><a name="l01016"></a><span class="lineno"> 1016</span>&#160;}</div><div class="line"><a name="l01017"></a><span class="lineno"> 1017</span>&#160;</div><div class="line"><a name="l01018"></a><span class="lineno"><a class="line" href="classstored_1_1_debug_arq_layer.html#adb2ab020fb7e6aeca00c97be9545ced7"> 1018</a></span>&#160;<span class="keywordtype">size_t</span> <a class="code" href="classstored_1_1_debug_arq_layer.html#adb2ab020fb7e6aeca00c97be9545ced7">DebugArqLayer::mtu</a>()<span class="keyword"> const </span>{</div><div class="line"><a name="l01019"></a><span class="lineno"> 1019</span>&#160;    <span class="keywordtype">size_t</span> <a class="code" href="classstored_1_1_debug_arq_layer.html#adb2ab020fb7e6aeca00c97be9545ced7">mtu</a> = <a class="code" href="classstored_1_1_protocol_layer.html#a88195d7cdb7129ac7bc625ffeb24d449">base::mtu</a>();</div><div class="line"><a name="l01020"></a><span class="lineno"> 1020</span>&#160;    <span class="keywordflow">if</span>(mtu == 0)</div><div class="line"><a name="l01021"></a><span class="lineno"> 1021</span>&#160;        <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l01022"></a><span class="lineno"> 1022</span>&#160;    <span class="keywordflow">if</span>(mtu &lt;= 4u)</div><div class="line"><a name="l01023"></a><span class="lineno"> 1023</span>&#160;        <span class="keywordflow">return</span> 1u;</div><div class="line"><a name="l01024"></a><span class="lineno"> 1024</span>&#160;    <span class="keywordflow">return</span> mtu - 4u;</div><div class="line"><a name="l01025"></a><span class="lineno"> 1025</span>&#160;}</div><div class="line"><a name="l01026"></a><span class="lineno"> 1026</span>&#160;</div><div class="line"><a name="l01030"></a><span class="lineno"><a class="line" href="classstored_1_1_debug_arq_layer.html#ac5dab34e5ae9a79154eba3265be14bd1"> 1030</a></span>&#160;uint32_t <a class="code" href="classstored_1_1_debug_arq_layer.html#ac5dab34e5ae9a79154eba3265be14bd1">DebugArqLayer::nextSeq</a>(uint32_t seq) {</div><div class="line"><a name="l01031"></a><span class="lineno"> 1031</span>&#160;    seq = (uint32_t)((seq + 1u) % 0x8000000);</div><div class="line"><a name="l01032"></a><span class="lineno"> 1032</span>&#160;    <span class="keywordflow">return</span> seq ? seq : 1u;</div><div class="line"><a name="l01033"></a><span class="lineno"> 1033</span>&#160;}</div><div class="line"><a name="l01034"></a><span class="lineno"> 1034</span>&#160;</div><div class="line"><a name="l01038"></a><span class="lineno"><a class="line" href="classstored_1_1_debug_arq_layer.html#a0a71050aa34e149b3fd0a326c16d5c6a"> 1038</a></span>&#160;uint32_t <a class="code" href="classstored_1_1_debug_arq_layer.html#a0a71050aa34e149b3fd0a326c16d5c6a">DebugArqLayer::decodeSeq</a>(uint8_t*&amp; buffer, <span class="keywordtype">size_t</span>&amp; len) {</div><div class="line"><a name="l01039"></a><span class="lineno"> 1039</span>&#160;    uint32_t seq = 0;</div><div class="line"><a name="l01040"></a><span class="lineno"> 1040</span>&#160;    uint8_t flag = 0x40;</div><div class="line"><a name="l01041"></a><span class="lineno"> 1041</span>&#160;</div><div class="line"><a name="l01042"></a><span class="lineno"> 1042</span>&#160;    <span class="keywordflow">while</span>(<span class="keyword">true</span>) {</div><div class="line"><a name="l01043"></a><span class="lineno"> 1043</span>&#160;        <span class="keywordflow">if</span>(!len--)</div><div class="line"><a name="l01044"></a><span class="lineno"> 1044</span>&#160;            <span class="keywordflow">return</span> ~0u;</div><div class="line"><a name="l01045"></a><span class="lineno"> 1045</span>&#160;        seq = (seq &lt;&lt; 7u) | (*buffer &amp; (flag - 1u));</div><div class="line"><a name="l01046"></a><span class="lineno"> 1046</span>&#160;        <span class="keywordflow">if</span>(!(*buffer++ &amp; flag))</div><div class="line"><a name="l01047"></a><span class="lineno"> 1047</span>&#160;            <span class="keywordflow">return</span> seq;</div><div class="line"><a name="l01048"></a><span class="lineno"> 1048</span>&#160;        flag = 0x80;</div><div class="line"><a name="l01049"></a><span class="lineno"> 1049</span>&#160;    }</div><div class="line"><a name="l01050"></a><span class="lineno"> 1050</span>&#160;}</div><div class="line"><a name="l01051"></a><span class="lineno"> 1051</span>&#160;</div><div class="line"><a name="l01056"></a><span class="lineno"><a class="line" href="classstored_1_1_debug_arq_layer.html#a4f99570d92e54c761f31f330968187fb"> 1056</a></span>&#160;<span class="keywordtype">size_t</span> <a class="code" href="classstored_1_1_debug_arq_layer.html#a4f99570d92e54c761f31f330968187fb">DebugArqLayer::encodeSeq</a>(uint32_t seq, <span class="keywordtype">void</span>* buffer) {</div><div class="line"><a name="l01057"></a><span class="lineno"> 1057</span>&#160;    uint8_t* buffer_ = <span class="keyword">static_cast&lt;</span>uint8_t*<span class="keyword">&gt;</span>(buffer);</div><div class="line"><a name="l01058"></a><span class="lineno"> 1058</span>&#160;    <span class="keywordflow">if</span>(seq &lt; 0x40u) {</div><div class="line"><a name="l01059"></a><span class="lineno"> 1059</span>&#160;        buffer_[0] = (uint8_t)(seq &amp; 0x3fu);</div><div class="line"><a name="l01060"></a><span class="lineno"> 1060</span>&#160;        <span class="keywordflow">return</span> 1;</div><div class="line"><a name="l01061"></a><span class="lineno"> 1061</span>&#160;    } <span class="keywordflow">else</span> <span class="keywordflow">if</span>(seq &lt; 0x2000) {</div><div class="line"><a name="l01062"></a><span class="lineno"> 1062</span>&#160;        buffer_[0] = (uint8_t)(0x40u | ((seq &gt;&gt; 7u) &amp; 0x3fu));</div><div class="line"><a name="l01063"></a><span class="lineno"> 1063</span>&#160;        buffer_[1] = (uint8_t)(seq &amp; 0x7fu);</div><div class="line"><a name="l01064"></a><span class="lineno"> 1064</span>&#160;        <span class="keywordflow">return</span> 2;</div><div class="line"><a name="l01065"></a><span class="lineno"> 1065</span>&#160;    } <span class="keywordflow">else</span> <span class="keywordflow">if</span>(seq &lt; 0x100000) {</div><div class="line"><a name="l01066"></a><span class="lineno"> 1066</span>&#160;        buffer_[0] = (uint8_t)(0x40u | ((seq &gt;&gt; 14u) &amp; 0x3fu));</div><div class="line"><a name="l01067"></a><span class="lineno"> 1067</span>&#160;        buffer_[1] = (uint8_t)(0x80u | ((seq &gt;&gt; 7u) &amp; 0x7fu));</div><div class="line"><a name="l01068"></a><span class="lineno"> 1068</span>&#160;        buffer_[2] = (uint8_t)(seq &amp; 0x7fu);</div><div class="line"><a name="l01069"></a><span class="lineno"> 1069</span>&#160;        <span class="keywordflow">return</span> 3;</div><div class="line"><a name="l01070"></a><span class="lineno"> 1070</span>&#160;    } <span class="keywordflow">else</span> <span class="keywordflow">if</span>(seq &lt; 0x8000000) {</div><div class="line"><a name="l01071"></a><span class="lineno"> 1071</span>&#160;        buffer_[0] = (uint8_t)(0x40u | ((seq &gt;&gt; 21u) &amp; 0x3fu));</div><div class="line"><a name="l01072"></a><span class="lineno"> 1072</span>&#160;        buffer_[1] = (uint8_t)(0x80u | ((seq &gt;&gt; 14u) &amp; 0x7fu));</div><div class="line"><a name="l01073"></a><span class="lineno"> 1073</span>&#160;        buffer_[2] = (uint8_t)(0x80u | ((seq &gt;&gt; 7u) &amp; 0x7fu));</div><div class="line"><a name="l01074"></a><span class="lineno"> 1074</span>&#160;        buffer_[3] = (uint8_t)(seq &amp; 0x7fu);</div><div class="line"><a name="l01075"></a><span class="lineno"> 1075</span>&#160;        <span class="keywordflow">return</span> 4;</div><div class="line"><a name="l01076"></a><span class="lineno"> 1076</span>&#160;    } <span class="keywordflow">else</span> {</div><div class="line"><a name="l01077"></a><span class="lineno"> 1077</span>&#160;        <span class="keywordflow">return</span> <a class="code" href="classstored_1_1_debug_arq_layer.html#a4f99570d92e54c761f31f330968187fb">encodeSeq</a>(seq % 0x8000000, buffer);</div><div class="line"><a name="l01078"></a><span class="lineno"> 1078</span>&#160;    }</div><div class="line"><a name="l01079"></a><span class="lineno"> 1079</span>&#160;}</div><div class="line"><a name="l01080"></a><span class="lineno"> 1080</span>&#160;</div><div class="line"><a name="l01081"></a><span class="lineno"> 1081</span>&#160;</div><div class="line"><a name="l01082"></a><span class="lineno"> 1082</span>&#160;</div><div class="line"><a name="l01083"></a><span class="lineno"> 1083</span>&#160;</div><div class="line"><a name="l01084"></a><span class="lineno"> 1084</span>&#160;</div><div class="line"><a name="l01086"></a><span class="lineno"> 1086</span>&#160;<span class="comment">// Crc8Layer</span></div><div class="line"><a name="l01087"></a><span class="lineno"> 1087</span>&#160;<span class="comment">//</span></div><div class="line"><a name="l01088"></a><span class="lineno"> 1088</span>&#160;</div><div class="line"><a name="l01089"></a><span class="lineno"> 1089</span>&#160;<span class="comment">// Generated by http://www.sunshine2k.de/coding/javascript/crc/crc_js.html</span></div><div class="line"><a name="l01090"></a><span class="lineno"> 1090</span>&#160;<span class="keyword">static</span> <span class="keyword">const</span> uint8_t crc8_table[] = {</div><div class="line"><a name="l01091"></a><span class="lineno"> 1091</span>&#160;    0x00, 0xA6, 0xEA, 0x4C, 0x72, 0xD4, 0x98, 0x3E, 0xE4, 0x42, 0x0E, 0xA8, 0x96, 0x30, 0x7C, 0xDA,</div><div class="line"><a name="l01092"></a><span class="lineno"> 1092</span>&#160;    0x6E, 0xC8, 0x84, 0x22, 0x1C, 0xBA, 0xF6, 0x50, 0x8A, 0x2C, 0x60, 0xC6, 0xF8, 0x5E, 0x12, 0xB4,</div><div class="line"><a name="l01093"></a><span class="lineno"> 1093</span>&#160;    0xDC, 0x7A, 0x36, 0x90, 0xAE, 0x08, 0x44, 0xE2, 0x38, 0x9E, 0xD2, 0x74, 0x4A, 0xEC, 0xA0, 0x06,</div><div class="line"><a name="l01094"></a><span class="lineno"> 1094</span>&#160;    0xB2, 0x14, 0x58, 0xFE, 0xC0, 0x66, 0x2A, 0x8C, 0x56, 0xF0, 0xBC, 0x1A, 0x24, 0x82, 0xCE, 0x68,</div><div class="line"><a name="l01095"></a><span class="lineno"> 1095</span>&#160;    0x1E, 0xB8, 0xF4, 0x52, 0x6C, 0xCA, 0x86, 0x20, 0xFA, 0x5C, 0x10, 0xB6, 0x88, 0x2E, 0x62, 0xC4,</div><div class="line"><a name="l01096"></a><span class="lineno"> 1096</span>&#160;    0x70, 0xD6, 0x9A, 0x3C, 0x02, 0xA4, 0xE8, 0x4E, 0x94, 0x32, 0x7E, 0xD8, 0xE6, 0x40, 0x0C, 0xAA,</div><div class="line"><a name="l01097"></a><span class="lineno"> 1097</span>&#160;    0xC2, 0x64, 0x28, 0x8E, 0xB0, 0x16, 0x5A, 0xFC, 0x26, 0x80, 0xCC, 0x6A, 0x54, 0xF2, 0xBE, 0x18,</div><div class="line"><a name="l01098"></a><span class="lineno"> 1098</span>&#160;    0xAC, 0x0A, 0x46, 0xE0, 0xDE, 0x78, 0x34, 0x92, 0x48, 0xEE, 0xA2, 0x04, 0x3A, 0x9C, 0xD0, 0x76,</div><div class="line"><a name="l01099"></a><span class="lineno"> 1099</span>&#160;    0x3C, 0x9A, 0xD6, 0x70, 0x4E, 0xE8, 0xA4, 0x02, 0xD8, 0x7E, 0x32, 0x94, 0xAA, 0x0C, 0x40, 0xE6,</div><div class="line"><a name="l01100"></a><span class="lineno"> 1100</span>&#160;    0x52, 0xF4, 0xB8, 0x1E, 0x20, 0x86, 0xCA, 0x6C, 0xB6, 0x10, 0x5C, 0xFA, 0xC4, 0x62, 0x2E, 0x88,</div><div class="line"><a name="l01101"></a><span class="lineno"> 1101</span>&#160;    0xE0, 0x46, 0x0A, 0xAC, 0x92, 0x34, 0x78, 0xDE, 0x04, 0xA2, 0xEE, 0x48, 0x76, 0xD0, 0x9C, 0x3A,</div><div class="line"><a name="l01102"></a><span class="lineno"> 1102</span>&#160;    0x8E, 0x28, 0x64, 0xC2, 0xFC, 0x5A, 0x16, 0xB0, 0x6A, 0xCC, 0x80, 0x26, 0x18, 0xBE, 0xF2, 0x54,</div><div class="line"><a name="l01103"></a><span class="lineno"> 1103</span>&#160;    0x22, 0x84, 0xC8, 0x6E, 0x50, 0xF6, 0xBA, 0x1C, 0xC6, 0x60, 0x2C, 0x8A, 0xB4, 0x12, 0x5E, 0xF8,</div><div class="line"><a name="l01104"></a><span class="lineno"> 1104</span>&#160;    0x4C, 0xEA, 0xA6, 0x00, 0x3E, 0x98, 0xD4, 0x72, 0xA8, 0x0E, 0x42, 0xE4, 0xDA, 0x7C, 0x30, 0x96,</div><div class="line"><a name="l01105"></a><span class="lineno"> 1105</span>&#160;    0xFE, 0x58, 0x14, 0xB2, 0x8C, 0x2A, 0x66, 0xC0, 0x1A, 0xBC, 0xF0, 0x56, 0x68, 0xCE, 0x82, 0x24,</div><div class="line"><a name="l01106"></a><span class="lineno"> 1106</span>&#160;    0x90, 0x36, 0x7A, 0xDC, 0xE2, 0x44, 0x08, 0xAE, 0x74, 0xD2, 0x9E, 0x38, 0x06, 0xA0, 0xEC, 0x4A</div><div class="line"><a name="l01107"></a><span class="lineno"> 1107</span>&#160;};</div><div class="line"><a name="l01108"></a><span class="lineno"> 1108</span>&#160;</div><div class="line"><a name="l01112"></a><span class="lineno"><a class="line" href="classstored_1_1_crc8_layer.html#a7921554b093428c40cc19bb0c910afcc"> 1112</a></span>&#160;<a class="code" href="classstored_1_1_crc8_layer.html#a5f87d2e04db6efb8d91e72d89266ef73">Crc8Layer::Crc8Layer</a>(<a class="code" href="classstored_1_1_protocol_layer.html">ProtocolLayer</a>* up, <a class="code" href="classstored_1_1_protocol_layer.html">ProtocolLayer</a>* down)</div><div class="line"><a name="l01113"></a><span class="lineno"> 1113</span>&#160;    : <a class="code" href="classstored_1_1_protocol_layer.html">base</a>(up, down)</div><div class="line"><a name="l01114"></a><span class="lineno"> 1114</span>&#160;    , m_crc(init)</div><div class="line"><a name="l01115"></a><span class="lineno"> 1115</span>&#160;{</div><div class="line"><a name="l01116"></a><span class="lineno"> 1116</span>&#160;}</div><div class="line"><a name="l01117"></a><span class="lineno"> 1117</span>&#160;</div><div class="line"><a name="l01118"></a><span class="lineno"><a class="line" href="classstored_1_1_crc8_layer.html#af9a6cc6ac539027ee452c485611ec0ac"> 1118</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classstored_1_1_crc8_layer.html#af9a6cc6ac539027ee452c485611ec0ac">Crc8Layer::reset</a>() {</div><div class="line"><a name="l01119"></a><span class="lineno"> 1119</span>&#160;    m_crc = <a class="code" href="classstored_1_1_crc8_layer.html#a3278e564ad9394b851dc727d9891bdaca1631c674509e8d7d495cab564f1cd8eb">init</a>;</div><div class="line"><a name="l01120"></a><span class="lineno"> 1120</span>&#160;    <a class="code" href="classstored_1_1_protocol_layer.html#a53fe78a7b405b981649112d9c84fe762">base::reset</a>();</div><div class="line"><a name="l01121"></a><span class="lineno"> 1121</span>&#160;}</div><div class="line"><a name="l01122"></a><span class="lineno"> 1122</span>&#160;</div><div class="line"><a name="l01123"></a><span class="lineno"><a class="line" href="classstored_1_1_crc8_layer.html#a53910dd8cb7f74db64011b5918c8c52a"> 1123</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classstored_1_1_crc8_layer.html#a53910dd8cb7f74db64011b5918c8c52a">Crc8Layer::decode</a>(<span class="keywordtype">void</span>* buffer, <span class="keywordtype">size_t</span> len) {</div><div class="line"><a name="l01124"></a><span class="lineno"> 1124</span>&#160;    <span class="keywordflow">if</span>(len == 0)</div><div class="line"><a name="l01125"></a><span class="lineno"> 1125</span>&#160;        <span class="keywordflow">return</span>;</div><div class="line"><a name="l01126"></a><span class="lineno"> 1126</span>&#160;</div><div class="line"><a name="l01127"></a><span class="lineno"> 1127</span>&#160;    uint8_t* buffer_ = <span class="keyword">static_cast&lt;</span>uint8_t*<span class="keyword">&gt;</span>(buffer);</div><div class="line"><a name="l01128"></a><span class="lineno"> 1128</span>&#160;    uint8_t crc = <a class="code" href="classstored_1_1_crc8_layer.html#a3278e564ad9394b851dc727d9891bdaca1631c674509e8d7d495cab564f1cd8eb">init</a>;</div><div class="line"><a name="l01129"></a><span class="lineno"> 1129</span>&#160;    <span class="keywordflow">for</span>(<span class="keywordtype">size_t</span> i = 0; i &lt; len - 1; i++)</div><div class="line"><a name="l01130"></a><span class="lineno"> 1130</span>&#160;        crc = <a class="code" href="classstored_1_1_crc8_layer.html#a92eeb73a06af54090715da5f336a2217">compute</a>(crc, buffer_[i]);</div><div class="line"><a name="l01131"></a><span class="lineno"> 1131</span>&#160;</div><div class="line"><a name="l01132"></a><span class="lineno"> 1132</span>&#160;    <span class="keywordflow">if</span>(crc != buffer_[len - 1])</div><div class="line"><a name="l01133"></a><span class="lineno"> 1133</span>&#160;        <span class="comment">// Invalid.</span></div><div class="line"><a name="l01134"></a><span class="lineno"> 1134</span>&#160;        <span class="keywordflow">return</span>;</div><div class="line"><a name="l01135"></a><span class="lineno"> 1135</span>&#160;</div><div class="line"><a name="l01136"></a><span class="lineno"> 1136</span>&#160;    <a class="code" href="classstored_1_1_protocol_layer.html#a357b029311be09df61e019682a848ab5">base::decode</a>(buffer, len - 1);</div><div class="line"><a name="l01137"></a><span class="lineno"> 1137</span>&#160;}</div><div class="line"><a name="l01138"></a><span class="lineno"> 1138</span>&#160;</div><div class="line"><a name="l01139"></a><span class="lineno"><a class="line" href="classstored_1_1_crc8_layer.html#a5181019b72aefb28daee0cd8889daab2"> 1139</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classstored_1_1_protocol_layer.html#a66c24cec6a17c44fac68213d358a5aa8">Crc8Layer::encode</a>(<span class="keywordtype">void</span> <span class="keyword">const</span>* buffer, <span class="keywordtype">size_t</span> len, <span class="keywordtype">bool</span> last) {</div><div class="line"><a name="l01140"></a><span class="lineno"> 1140</span>&#160;    uint8_t <span class="keyword">const</span>* buffer_ = <span class="keyword">static_cast&lt;</span>uint8_t <a class="code" href="namespaceed2_1_1gui_1_1____main____.html#a3c1fe823c9bbaf7e7dcef9ecc9fcb915">const</a>*<span class="keyword">&gt;</span>(buffer);</div><div class="line"><a name="l01141"></a><span class="lineno"> 1141</span>&#160;    <span class="keywordflow">for</span>(<span class="keywordtype">size_t</span> i = 0; i &lt; len; i++)</div><div class="line"><a name="l01142"></a><span class="lineno"> 1142</span>&#160;        m_crc = <a class="code" href="classstored_1_1_crc8_layer.html#a92eeb73a06af54090715da5f336a2217">compute</a>(m_crc, buffer_[i]);</div><div class="line"><a name="l01143"></a><span class="lineno"> 1143</span>&#160;</div><div class="line"><a name="l01144"></a><span class="lineno"> 1144</span>&#160;    <a class="code" href="classstored_1_1_protocol_layer.html#a66c24cec6a17c44fac68213d358a5aa8">base::encode</a>(buffer, len, <span class="keyword">false</span>);</div><div class="line"><a name="l01145"></a><span class="lineno"> 1145</span>&#160;</div><div class="line"><a name="l01146"></a><span class="lineno"> 1146</span>&#160;    <span class="keywordflow">if</span>(last) {</div><div class="line"><a name="l01147"></a><span class="lineno"> 1147</span>&#160;        <a class="code" href="classstored_1_1_protocol_layer.html#a66c24cec6a17c44fac68213d358a5aa8">base::encode</a>(&amp;m_crc, 1, <span class="keyword">true</span>);</div><div class="line"><a name="l01148"></a><span class="lineno"> 1148</span>&#160;        m_crc = <a class="code" href="classstored_1_1_crc8_layer.html#a3278e564ad9394b851dc727d9891bdaca1631c674509e8d7d495cab564f1cd8eb">init</a>;</div><div class="line"><a name="l01149"></a><span class="lineno"> 1149</span>&#160;    }</div><div class="line"><a name="l01150"></a><span class="lineno"> 1150</span>&#160;}</div><div class="line"><a name="l01151"></a><span class="lineno"> 1151</span>&#160;</div><div class="line"><a name="l01152"></a><span class="lineno"><a class="line" href="classstored_1_1_crc8_layer.html#a92eeb73a06af54090715da5f336a2217"> 1152</a></span>&#160;uint8_t <a class="code" href="classstored_1_1_crc8_layer.html#a92eeb73a06af54090715da5f336a2217">Crc8Layer::compute</a>(uint8_t input, uint8_t crc) {</div><div class="line"><a name="l01153"></a><span class="lineno"> 1153</span>&#160;    <span class="comment">// NOLINTNEXTLINE(cppcoreguidelines-pro-bounds-constant-array-index)</span></div><div class="line"><a name="l01154"></a><span class="lineno"> 1154</span>&#160;    <span class="keywordflow">return</span> crc8_table[(uint8_t)(input ^ crc)];</div><div class="line"><a name="l01155"></a><span class="lineno"> 1155</span>&#160;}</div><div class="line"><a name="l01156"></a><span class="lineno"> 1156</span>&#160;</div><div class="line"><a name="l01157"></a><span class="lineno"><a class="line" href="classstored_1_1_crc8_layer.html#ac3bb509c6ebf1a8c9c98f4985ea91bde"> 1157</a></span>&#160;<span class="keywordtype">size_t</span> <a class="code" href="classstored_1_1_crc8_layer.html#ac3bb509c6ebf1a8c9c98f4985ea91bde">Crc8Layer::mtu</a>()<span class="keyword"> const </span>{</div><div class="line"><a name="l01158"></a><span class="lineno"> 1158</span>&#160;    <span class="keywordtype">size_t</span> <a class="code" href="classstored_1_1_crc8_layer.html#ac3bb509c6ebf1a8c9c98f4985ea91bde">mtu</a> = <a class="code" href="classstored_1_1_protocol_layer.html#a88195d7cdb7129ac7bc625ffeb24d449">base::mtu</a>();</div><div class="line"><a name="l01159"></a><span class="lineno"> 1159</span>&#160;    <span class="keywordflow">if</span>(mtu == 0 || mtu &gt; 256u)</div><div class="line"><a name="l01160"></a><span class="lineno"> 1160</span>&#160;        <span class="keywordflow">return</span> 256u;</div><div class="line"><a name="l01161"></a><span class="lineno"> 1161</span>&#160;    <span class="keywordflow">if</span>(mtu &lt;= 2u)</div><div class="line"><a name="l01162"></a><span class="lineno"> 1162</span>&#160;        <span class="keywordflow">return</span> 1u;</div><div class="line"><a name="l01163"></a><span class="lineno"> 1163</span>&#160;    <span class="keywordflow">return</span> mtu - 1u;</div><div class="line"><a name="l01164"></a><span class="lineno"> 1164</span>&#160;}</div><div class="line"><a name="l01165"></a><span class="lineno"> 1165</span>&#160;</div><div class="line"><a name="l01166"></a><span class="lineno"> 1166</span>&#160;</div><div class="line"><a name="l01167"></a><span class="lineno"> 1167</span>&#160;</div><div class="line"><a name="l01168"></a><span class="lineno"> 1168</span>&#160;</div><div class="line"><a name="l01169"></a><span class="lineno"> 1169</span>&#160;</div><div class="line"><a name="l01171"></a><span class="lineno"> 1171</span>&#160;<span class="comment">// Crc16Layer</span></div><div class="line"><a name="l01172"></a><span class="lineno"> 1172</span>&#160;<span class="comment">//</span></div><div class="line"><a name="l01173"></a><span class="lineno"> 1173</span>&#160;</div><div class="line"><a name="l01174"></a><span class="lineno"> 1174</span>&#160;<span class="comment">// Generated by http://www.sunshine2k.de/coding/javascript/crc/crc_js.html</span></div><div class="line"><a name="l01175"></a><span class="lineno"> 1175</span>&#160;<span class="keyword">static</span> <span class="keyword">const</span> uint16_t crc16_table[] = {</div><div class="line"><a name="l01176"></a><span class="lineno"> 1176</span>&#160;    0x0000, 0xBAAD, 0xCFF7, 0x755A, 0x2543, 0x9FEE, 0xEAB4, 0x5019, 0x4A86, 0xF02B, 0x8571, 0x3FDC, 0x6FC5, 0xD568, 0xA032, 0x1A9F,</div><div class="line"><a name="l01177"></a><span class="lineno"> 1177</span>&#160;    0x950C, 0x2FA1, 0x5AFB, 0xE056, 0xB04F, 0x0AE2, 0x7FB8, 0xC515, 0xDF8A, 0x6527, 0x107D, 0xAAD0, 0xFAC9, 0x4064, 0x353E, 0x8F93,</div><div class="line"><a name="l01178"></a><span class="lineno"> 1178</span>&#160;    0x90B5, 0x2A18, 0x5F42, 0xE5EF, 0xB5F6, 0x0F5B, 0x7A01, 0xC0AC, 0xDA33, 0x609E, 0x15C4, 0xAF69, 0xFF70, 0x45DD, 0x3087, 0x8A2A,</div><div class="line"><a name="l01179"></a><span class="lineno"> 1179</span>&#160;    0x05B9, 0xBF14, 0xCA4E, 0x70E3, 0x20FA, 0x9A57, 0xEF0D, 0x55A0, 0x4F3F, 0xF592, 0x80C8, 0x3A65, 0x6A7C, 0xD0D1, 0xA58B, 0x1F26,</div><div class="line"><a name="l01180"></a><span class="lineno"> 1180</span>&#160;    0x9BC7, 0x216A, 0x5430, 0xEE9D, 0xBE84, 0x0429, 0x7173, 0xCBDE, 0xD141, 0x6BEC, 0x1EB6, 0xA41B, 0xF402, 0x4EAF, 0x3BF5, 0x8158,</div><div class="line"><a name="l01181"></a><span class="lineno"> 1181</span>&#160;    0x0ECB, 0xB466, 0xC13C, 0x7B91, 0x2B88, 0x9125, 0xE47F, 0x5ED2, 0x444D, 0xFEE0, 0x8BBA, 0x3117, 0x610E, 0xDBA3, 0xAEF9, 0x1454,</div><div class="line"><a name="l01182"></a><span class="lineno"> 1182</span>&#160;    0x0B72, 0xB1DF, 0xC485, 0x7E28, 0x2E31, 0x949C, 0xE1C6, 0x5B6B, 0x41F4, 0xFB59, 0x8E03, 0x34AE, 0x64B7, 0xDE1A, 0xAB40, 0x11ED,</div><div class="line"><a name="l01183"></a><span class="lineno"> 1183</span>&#160;    0x9E7E, 0x24D3, 0x5189, 0xEB24, 0xBB3D, 0x0190, 0x74CA, 0xCE67, 0xD4F8, 0x6E55, 0x1B0F, 0xA1A2, 0xF1BB, 0x4B16, 0x3E4C, 0x84E1,</div><div class="line"><a name="l01184"></a><span class="lineno"> 1184</span>&#160;    0x8D23, 0x378E, 0x42D4, 0xF879, 0xA860, 0x12CD, 0x6797, 0xDD3A, 0xC7A5, 0x7D08, 0x0852, 0xB2FF, 0xE2E6, 0x584B, 0x2D11, 0x97BC,</div><div class="line"><a name="l01185"></a><span class="lineno"> 1185</span>&#160;    0x182F, 0xA282, 0xD7D8, 0x6D75, 0x3D6C, 0x87C1, 0xF29B, 0x4836, 0x52A9, 0xE804, 0x9D5E, 0x27F3, 0x77EA, 0xCD47, 0xB81D, 0x02B0,</div><div class="line"><a name="l01186"></a><span class="lineno"> 1186</span>&#160;    0x1D96, 0xA73B, 0xD261, 0x68CC, 0x38D5, 0x8278, 0xF722, 0x4D8F, 0x5710, 0xEDBD, 0x98E7, 0x224A, 0x7253, 0xC8FE, 0xBDA4, 0x0709,</div><div class="line"><a name="l01187"></a><span class="lineno"> 1187</span>&#160;    0x889A, 0x3237, 0x476D, 0xFDC0, 0xADD9, 0x1774, 0x622E, 0xD883, 0xC21C, 0x78B1, 0x0DEB, 0xB746, 0xE75F, 0x5DF2, 0x28A8, 0x9205,</div><div class="line"><a name="l01188"></a><span class="lineno"> 1188</span>&#160;    0x16E4, 0xAC49, 0xD913, 0x63BE, 0x33A7, 0x890A, 0xFC50, 0x46FD, 0x5C62, 0xE6CF, 0x9395, 0x2938, 0x7921, 0xC38C, 0xB6D6, 0x0C7B,</div><div class="line"><a name="l01189"></a><span class="lineno"> 1189</span>&#160;    0x83E8, 0x3945, 0x4C1F, 0xF6B2, 0xA6AB, 0x1C06, 0x695C, 0xD3F1, 0xC96E, 0x73C3, 0x0699, 0xBC34, 0xEC2D, 0x5680, 0x23DA, 0x9977,</div><div class="line"><a name="l01190"></a><span class="lineno"> 1190</span>&#160;    0x8651, 0x3CFC, 0x49A6, 0xF30B, 0xA312, 0x19BF, 0x6CE5, 0xD648, 0xCCD7, 0x767A, 0x0320, 0xB98D, 0xE994, 0x5339, 0x2663, 0x9CCE,</div><div class="line"><a name="l01191"></a><span class="lineno"> 1191</span>&#160;    0x135D, 0xA9F0, 0xDCAA, 0x6607, 0x361E, 0x8CB3, 0xF9E9, 0x4344, 0x59DB, 0xE376, 0x962C, 0x2C81, 0x7C98, 0xC635, 0xB36F, 0x09C2,</div><div class="line"><a name="l01192"></a><span class="lineno"> 1192</span>&#160;};</div><div class="line"><a name="l01193"></a><span class="lineno"> 1193</span>&#160;</div><div class="line"><a name="l01197"></a><span class="lineno"><a class="line" href="classstored_1_1_crc16_layer.html#ac332e25fb8984cdc0c95dc2905e3cb62"> 1197</a></span>&#160;<a class="code" href="classstored_1_1_crc16_layer.html#af23ed68b74cf787171cf53ba75214b79">Crc16Layer::Crc16Layer</a>(<a class="code" href="classstored_1_1_protocol_layer.html">ProtocolLayer</a>* up, <a class="code" href="classstored_1_1_protocol_layer.html">ProtocolLayer</a>* down)</div><div class="line"><a name="l01198"></a><span class="lineno"> 1198</span>&#160;    : <a class="code" href="classstored_1_1_protocol_layer.html">base</a>(up, down)</div><div class="line"><a name="l01199"></a><span class="lineno"> 1199</span>&#160;    , m_crc(<a class="code" href="classstored_1_1_crc8_layer.html#a3278e564ad9394b851dc727d9891bdaca1631c674509e8d7d495cab564f1cd8eb">init</a>)</div><div class="line"><a name="l01200"></a><span class="lineno"> 1200</span>&#160;{</div><div class="line"><a name="l01201"></a><span class="lineno"> 1201</span>&#160;}</div><div class="line"><a name="l01202"></a><span class="lineno"> 1202</span>&#160;</div><div class="line"><a name="l01203"></a><span class="lineno"><a class="line" href="classstored_1_1_crc16_layer.html#a00610c4aeabd33c565f5331a5aef3e01"> 1203</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classstored_1_1_crc16_layer.html#a00610c4aeabd33c565f5331a5aef3e01">Crc16Layer::reset</a>() {</div><div class="line"><a name="l01204"></a><span class="lineno"> 1204</span>&#160;    m_crc = <a class="code" href="classstored_1_1_crc16_layer.html#a58ea0fcf8981aa38941947c057f00ffaaeb8e182958fd03c1968f253e0bcb11c6">init</a>;</div><div class="line"><a name="l01205"></a><span class="lineno"> 1205</span>&#160;    <a class="code" href="classstored_1_1_protocol_layer.html#a53fe78a7b405b981649112d9c84fe762">base::reset</a>();</div><div class="line"><a name="l01206"></a><span class="lineno"> 1206</span>&#160;}</div><div class="line"><a name="l01207"></a><span class="lineno"> 1207</span>&#160;</div><div class="line"><a name="l01208"></a><span class="lineno"><a class="line" href="classstored_1_1_crc16_layer.html#afc268baaaa18446a10a8ab23bf04e967"> 1208</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classstored_1_1_crc16_layer.html#afc268baaaa18446a10a8ab23bf04e967">Crc16Layer::decode</a>(<span class="keywordtype">void</span>* buffer, <span class="keywordtype">size_t</span> len) {</div><div class="line"><a name="l01209"></a><span class="lineno"> 1209</span>&#160;    <span class="keywordflow">if</span>(len &lt; 2)</div><div class="line"><a name="l01210"></a><span class="lineno"> 1210</span>&#160;        <span class="keywordflow">return</span>;</div><div class="line"><a name="l01211"></a><span class="lineno"> 1211</span>&#160;</div><div class="line"><a name="l01212"></a><span class="lineno"> 1212</span>&#160;    uint8_t* buffer_ = <span class="keyword">static_cast&lt;</span>uint8_t*<span class="keyword">&gt;</span>(buffer);</div><div class="line"><a name="l01213"></a><span class="lineno"> 1213</span>&#160;    uint16_t crc = <a class="code" href="classstored_1_1_crc16_layer.html#a58ea0fcf8981aa38941947c057f00ffaaeb8e182958fd03c1968f253e0bcb11c6">init</a>;</div><div class="line"><a name="l01214"></a><span class="lineno"> 1214</span>&#160;    <span class="keywordflow">for</span>(<span class="keywordtype">size_t</span> i = 0; i &lt; len - 2; i++)</div><div class="line"><a name="l01215"></a><span class="lineno"> 1215</span>&#160;        crc = <a class="code" href="classstored_1_1_crc16_layer.html#a4b48d4c95eb8f590ab7428e94221197b">compute</a>(buffer_[i], crc);</div><div class="line"><a name="l01216"></a><span class="lineno"> 1216</span>&#160;</div><div class="line"><a name="l01217"></a><span class="lineno"> 1217</span>&#160;    <span class="keywordflow">if</span>(crc != ((uint16_t)((uint16_t)(buffer_[len - 2] &lt;&lt; 8u) | buffer_[len - 1])))</div><div class="line"><a name="l01218"></a><span class="lineno"> 1218</span>&#160;        <span class="comment">// Invalid.</span></div><div class="line"><a name="l01219"></a><span class="lineno"> 1219</span>&#160;        <span class="keywordflow">return</span>;</div><div class="line"><a name="l01220"></a><span class="lineno"> 1220</span>&#160;</div><div class="line"><a name="l01221"></a><span class="lineno"> 1221</span>&#160;    <a class="code" href="classstored_1_1_protocol_layer.html#a357b029311be09df61e019682a848ab5">base::decode</a>(buffer, len - 2);</div><div class="line"><a name="l01222"></a><span class="lineno"> 1222</span>&#160;}</div><div class="line"><a name="l01223"></a><span class="lineno"> 1223</span>&#160;</div><div class="line"><a name="l01224"></a><span class="lineno"><a class="line" href="classstored_1_1_crc16_layer.html#aaa370f1466d22991713a951f1a8e9bfd"> 1224</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classstored_1_1_protocol_layer.html#a66c24cec6a17c44fac68213d358a5aa8">Crc16Layer::encode</a>(<span class="keywordtype">void</span> <span class="keyword">const</span>* buffer, <span class="keywordtype">size_t</span> len, <span class="keywordtype">bool</span> last) {</div><div class="line"><a name="l01225"></a><span class="lineno"> 1225</span>&#160;    uint8_t <span class="keyword">const</span>* buffer_ = <span class="keyword">static_cast&lt;</span>uint8_t <a class="code" href="namespaceed2_1_1gui_1_1____main____.html#a3c1fe823c9bbaf7e7dcef9ecc9fcb915">const</a>*<span class="keyword">&gt;</span>(buffer);</div><div class="line"><a name="l01226"></a><span class="lineno"> 1226</span>&#160;    <span class="keywordflow">for</span>(<span class="keywordtype">size_t</span> i = 0; i &lt; len; i++)</div><div class="line"><a name="l01227"></a><span class="lineno"> 1227</span>&#160;        m_crc = <a class="code" href="classstored_1_1_crc16_layer.html#a4b48d4c95eb8f590ab7428e94221197b">compute</a>(buffer_[i], m_crc);</div><div class="line"><a name="l01228"></a><span class="lineno"> 1228</span>&#160;</div><div class="line"><a name="l01229"></a><span class="lineno"> 1229</span>&#160;    <a class="code" href="classstored_1_1_protocol_layer.html#a66c24cec6a17c44fac68213d358a5aa8">base::encode</a>(buffer, len, <span class="keyword">false</span>);</div><div class="line"><a name="l01230"></a><span class="lineno"> 1230</span>&#160;</div><div class="line"><a name="l01231"></a><span class="lineno"> 1231</span>&#160;    <span class="keywordflow">if</span>(last) {</div><div class="line"><a name="l01232"></a><span class="lineno"> 1232</span>&#160;        uint8_t crc[2] = { (uint8_t)(m_crc &gt;&gt; 8u), (uint8_t)m_crc };</div><div class="line"><a name="l01233"></a><span class="lineno"> 1233</span>&#160;        <a class="code" href="classstored_1_1_protocol_layer.html#a66c24cec6a17c44fac68213d358a5aa8">base::encode</a>(crc, <span class="keyword">sizeof</span>(crc), <span class="keyword">true</span>);</div><div class="line"><a name="l01234"></a><span class="lineno"> 1234</span>&#160;        m_crc = <a class="code" href="classstored_1_1_crc16_layer.html#a58ea0fcf8981aa38941947c057f00ffaaeb8e182958fd03c1968f253e0bcb11c6">init</a>;</div><div class="line"><a name="l01235"></a><span class="lineno"> 1235</span>&#160;    }</div><div class="line"><a name="l01236"></a><span class="lineno"> 1236</span>&#160;}</div><div class="line"><a name="l01237"></a><span class="lineno"> 1237</span>&#160;</div><div class="line"><a name="l01238"></a><span class="lineno"><a class="line" href="classstored_1_1_crc16_layer.html#a4b48d4c95eb8f590ab7428e94221197b"> 1238</a></span>&#160;uint16_t <a class="code" href="classstored_1_1_crc16_layer.html#a4b48d4c95eb8f590ab7428e94221197b">Crc16Layer::compute</a>(uint8_t input, uint16_t crc) {</div><div class="line"><a name="l01239"></a><span class="lineno"> 1239</span>&#160;    <span class="comment">// NOLINTNEXTLINE(cppcoreguidelines-pro-bounds-constant-array-index)</span></div><div class="line"><a name="l01240"></a><span class="lineno"> 1240</span>&#160;    <span class="keywordflow">return</span> (uint16_t)(crc16_table[input ^ (uint8_t)(crc &gt;&gt; 8u)] ^ (uint16_t)(crc &lt;&lt; 8u));</div><div class="line"><a name="l01241"></a><span class="lineno"> 1241</span>&#160;}</div><div class="line"><a name="l01242"></a><span class="lineno"> 1242</span>&#160;</div><div class="line"><a name="l01243"></a><span class="lineno"><a class="line" href="classstored_1_1_crc16_layer.html#a82d88b7503bdb383c9416e2a0cad8503"> 1243</a></span>&#160;<span class="keywordtype">size_t</span> <a class="code" href="classstored_1_1_crc16_layer.html#a82d88b7503bdb383c9416e2a0cad8503">Crc16Layer::mtu</a>()<span class="keyword"> const </span>{</div><div class="line"><a name="l01244"></a><span class="lineno"> 1244</span>&#160;    <span class="keywordtype">size_t</span> <a class="code" href="classstored_1_1_crc16_layer.html#a82d88b7503bdb383c9416e2a0cad8503">mtu</a> = <a class="code" href="classstored_1_1_protocol_layer.html#a88195d7cdb7129ac7bc625ffeb24d449">base::mtu</a>();</div><div class="line"><a name="l01245"></a><span class="lineno"> 1245</span>&#160;    <span class="keywordflow">if</span>(mtu == 0 || mtu &gt; 256u)</div><div class="line"><a name="l01246"></a><span class="lineno"> 1246</span>&#160;        <span class="keywordflow">return</span> 256u;</div><div class="line"><a name="l01247"></a><span class="lineno"> 1247</span>&#160;    <span class="keywordflow">if</span>(mtu &lt;= 3u)</div><div class="line"><a name="l01248"></a><span class="lineno"> 1248</span>&#160;        <span class="keywordflow">return</span> 1u;</div><div class="line"><a name="l01249"></a><span class="lineno"> 1249</span>&#160;    <span class="keywordflow">return</span> mtu - 2u;</div><div class="line"><a name="l01250"></a><span class="lineno"> 1250</span>&#160;}</div><div class="line"><a name="l01251"></a><span class="lineno"> 1251</span>&#160;</div><div class="line"><a name="l01252"></a><span class="lineno"> 1252</span>&#160;</div><div class="line"><a name="l01253"></a><span class="lineno"> 1253</span>&#160;</div><div class="line"><a name="l01255"></a><span class="lineno"> 1255</span>&#160;<span class="comment">// BufferLayer</span></div><div class="line"><a name="l01256"></a><span class="lineno"> 1256</span>&#160;<span class="comment">//</span></div><div class="line"><a name="l01257"></a><span class="lineno"> 1257</span>&#160;</div><div class="line"><a name="l01263"></a><span class="lineno"><a class="line" href="classstored_1_1_buffer_layer.html#a37030ff4ad22eff63d818ea535362f29"> 1263</a></span>&#160;<a class="code" href="classstored_1_1_buffer_layer.html#a587c9ead02b35cfadabe5ea931a8874d">BufferLayer::BufferLayer</a>(<span class="keywordtype">size_t</span> size, <a class="code" href="classstored_1_1_protocol_layer.html">ProtocolLayer</a>* up, <a class="code" href="classstored_1_1_protocol_layer.html">ProtocolLayer</a>* down)</div><div class="line"><a name="l01264"></a><span class="lineno"> 1264</span>&#160;    : <a class="code" href="classstored_1_1_protocol_layer.html">base</a>(up, down)</div><div class="line"><a name="l01265"></a><span class="lineno"> 1265</span>&#160;    , m_size(size ? size : <a class="code" href="namespacestd.html">std</a>::numeric_limits&lt;size_t&gt;::max())</div><div class="line"><a name="l01266"></a><span class="lineno"> 1266</span>&#160;{}</div><div class="line"><a name="l01267"></a><span class="lineno"> 1267</span>&#160;</div><div class="line"><a name="l01268"></a><span class="lineno"><a class="line" href="classstored_1_1_buffer_layer.html#a106b4baa477a0fac388215fc87a54fd4"> 1268</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classstored_1_1_buffer_layer.html#a106b4baa477a0fac388215fc87a54fd4">BufferLayer::reset</a>() {</div><div class="line"><a name="l01269"></a><span class="lineno"> 1269</span>&#160;    m_buffer.clear();</div><div class="line"><a name="l01270"></a><span class="lineno"> 1270</span>&#160;    <a class="code" href="classstored_1_1_protocol_layer.html#a53fe78a7b405b981649112d9c84fe762">base::reset</a>();</div><div class="line"><a name="l01271"></a><span class="lineno"> 1271</span>&#160;}</div><div class="line"><a name="l01272"></a><span class="lineno"> 1272</span>&#160;</div><div class="line"><a name="l01276"></a><span class="lineno"><a class="line" href="classstored_1_1_buffer_layer.html#aa33bb526174b8ab92a7243175009140d"> 1276</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classstored_1_1_protocol_layer.html#a66c24cec6a17c44fac68213d358a5aa8">BufferLayer::encode</a>(<span class="keywordtype">void</span> <span class="keyword">const</span>* buffer, <span class="keywordtype">size_t</span> len, <span class="keywordtype">bool</span> last) {</div><div class="line"><a name="l01277"></a><span class="lineno"> 1277</span>&#160;    <span class="keywordtype">char</span> <span class="keyword">const</span>* buffer_ = <span class="keyword">static_cast&lt;</span><span class="keywordtype">char</span> <a class="code" href="namespaceed2_1_1gui_1_1____main____.html#a3c1fe823c9bbaf7e7dcef9ecc9fcb915">const</a>*<span class="keyword">&gt;</span>(buffer);</div><div class="line"><a name="l01278"></a><span class="lineno"> 1278</span>&#160;</div><div class="line"><a name="l01279"></a><span class="lineno"> 1279</span>&#160;    <span class="keywordtype">size_t</span> remaining = m_size - m_buffer.size();</div><div class="line"><a name="l01280"></a><span class="lineno"> 1280</span>&#160;</div><div class="line"><a name="l01281"></a><span class="lineno"> 1281</span>&#160;    <span class="keywordflow">while</span>(remaining &lt; len) {</div><div class="line"><a name="l01282"></a><span class="lineno"> 1282</span>&#160;        <span class="comment">// Does not fit in our buffer. Forward immediately.</span></div><div class="line"><a name="l01283"></a><span class="lineno"> 1283</span>&#160;        <span class="keywordflow">if</span>(m_buffer.empty()) {</div><div class="line"><a name="l01284"></a><span class="lineno"> 1284</span>&#160;            <a class="code" href="classstored_1_1_protocol_layer.html#a66c24cec6a17c44fac68213d358a5aa8">base::encode</a>(buffer_, remaining, <span class="keyword">false</span>);</div><div class="line"><a name="l01285"></a><span class="lineno"> 1285</span>&#160;        } <span class="keywordflow">else</span> {</div><div class="line"><a name="l01286"></a><span class="lineno"> 1286</span>&#160;            m_buffer.append(buffer_, remaining);</div><div class="line"><a name="l01287"></a><span class="lineno"> 1287</span>&#160;            <a class="code" href="classstored_1_1_protocol_layer.html#a66c24cec6a17c44fac68213d358a5aa8">base::encode</a>(m_buffer.data(), m_buffer.size(), <span class="keyword">false</span>);</div><div class="line"><a name="l01288"></a><span class="lineno"> 1288</span>&#160;            m_buffer.clear();</div><div class="line"><a name="l01289"></a><span class="lineno"> 1289</span>&#160;        }</div><div class="line"><a name="l01290"></a><span class="lineno"> 1290</span>&#160;        buffer_ += remaining;</div><div class="line"><a name="l01291"></a><span class="lineno"> 1291</span>&#160;        len -= remaining;</div><div class="line"><a name="l01292"></a><span class="lineno"> 1292</span>&#160;        remaining = m_size;</div><div class="line"><a name="l01293"></a><span class="lineno"> 1293</span>&#160;    }</div><div class="line"><a name="l01294"></a><span class="lineno"> 1294</span>&#160;</div><div class="line"><a name="l01295"></a><span class="lineno"> 1295</span>&#160;    <span class="keywordflow">if</span>(last || len == remaining) {</div><div class="line"><a name="l01296"></a><span class="lineno"> 1296</span>&#160;        <span class="keywordflow">if</span>(m_buffer.empty()) {</div><div class="line"><a name="l01297"></a><span class="lineno"> 1297</span>&#160;            <span class="comment">// Pass through immediately.</span></div><div class="line"><a name="l01298"></a><span class="lineno"> 1298</span>&#160;            <a class="code" href="classstored_1_1_protocol_layer.html#a66c24cec6a17c44fac68213d358a5aa8">base::encode</a>(buffer_, len, last);</div><div class="line"><a name="l01299"></a><span class="lineno"> 1299</span>&#160;        } <span class="keywordflow">else</span> {</div><div class="line"><a name="l01300"></a><span class="lineno"> 1300</span>&#160;            <span class="comment">// Got already something in the buffer. Concat and forward.</span></div><div class="line"><a name="l01301"></a><span class="lineno"> 1301</span>&#160;            m_buffer.append(buffer_, len);</div><div class="line"><a name="l01302"></a><span class="lineno"> 1302</span>&#160;            <a class="code" href="classstored_1_1_protocol_layer.html#a66c24cec6a17c44fac68213d358a5aa8">base::encode</a>(m_buffer.data(), m_buffer.size(), last);</div><div class="line"><a name="l01303"></a><span class="lineno"> 1303</span>&#160;            m_buffer.clear();</div><div class="line"><a name="l01304"></a><span class="lineno"> 1304</span>&#160;        }</div><div class="line"><a name="l01305"></a><span class="lineno"> 1305</span>&#160;    } <span class="keywordflow">else</span> {</div><div class="line"><a name="l01306"></a><span class="lineno"> 1306</span>&#160;        <span class="comment">// Save for later.</span></div><div class="line"><a name="l01307"></a><span class="lineno"> 1307</span>&#160;        m_buffer.append(buffer_, len);</div><div class="line"><a name="l01308"></a><span class="lineno"> 1308</span>&#160;    }</div><div class="line"><a name="l01309"></a><span class="lineno"> 1309</span>&#160;}</div><div class="line"><a name="l01310"></a><span class="lineno"> 1310</span>&#160;</div><div class="line"><a name="l01311"></a><span class="lineno"> 1311</span>&#160;</div><div class="line"><a name="l01313"></a><span class="lineno"> 1313</span>&#160;<span class="comment">// PrintLayer</span></div><div class="line"><a name="l01314"></a><span class="lineno"> 1314</span>&#160;<span class="comment">//</span></div><div class="line"><a name="l01315"></a><span class="lineno"> 1315</span>&#160;</div><div class="line"><a name="l01324"></a><span class="lineno"><a class="line" href="classstored_1_1_print_layer.html#a7ed0289ba08ea88ce711354ffef603a6"> 1324</a></span>&#160;<a class="code" href="classstored_1_1_print_layer.html#aa77d727ebfa1e502f9383ab717b9724d">PrintLayer::PrintLayer</a>(FILE* f, <span class="keywordtype">char</span> <span class="keyword">const</span>* <a class="code" href="namespacesetup.html#ab3a7a0638d76a01367c5bc3cc699447f">name</a>, <a class="code" href="classstored_1_1_protocol_layer.html">ProtocolLayer</a>* up, <a class="code" href="classstored_1_1_protocol_layer.html">ProtocolLayer</a>* down)</div><div class="line"><a name="l01325"></a><span class="lineno"> 1325</span>&#160;    : <a class="code" href="classstored_1_1_protocol_layer.html">base</a>(up, down)</div><div class="line"><a name="l01326"></a><span class="lineno"> 1326</span>&#160;    , m_f(f)</div><div class="line"><a name="l01327"></a><span class="lineno"> 1327</span>&#160;    , m_name(name)</div><div class="line"><a name="l01328"></a><span class="lineno"> 1328</span>&#160;{</div><div class="line"><a name="l01329"></a><span class="lineno"> 1329</span>&#160;}</div><div class="line"><a name="l01330"></a><span class="lineno"> 1330</span>&#160;</div><div class="line"><a name="l01331"></a><span class="lineno"><a class="line" href="classstored_1_1_print_layer.html#af92198162e84a80d70afbd76143df369"> 1331</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classstored_1_1_print_layer.html#af92198162e84a80d70afbd76143df369">PrintLayer::decode</a>(<span class="keywordtype">void</span>* buffer, <span class="keywordtype">size_t</span> len) {</div><div class="line"><a name="l01332"></a><span class="lineno"> 1332</span>&#160;    <span class="keywordflow">if</span>(m_f) {</div><div class="line"><a name="l01333"></a><span class="lineno"> 1333</span>&#160;        std::string <a class="code" href="namespaceed2_1_1cli_1_1____main____.html#a7dd4a7db291fe246593191db75b1fdca">prefix</a>;</div><div class="line"><a name="l01334"></a><span class="lineno"> 1334</span>&#160;        <span class="keywordflow">if</span>(m_name)</div><div class="line"><a name="l01335"></a><span class="lineno"> 1335</span>&#160;            prefix += m_name;</div><div class="line"><a name="l01336"></a><span class="lineno"> 1336</span>&#160;        prefix += <span class="stringliteral">&quot; &lt; &quot;</span>;</div><div class="line"><a name="l01337"></a><span class="lineno"> 1337</span>&#160;</div><div class="line"><a name="l01338"></a><span class="lineno"> 1338</span>&#160;        std::string s = <a class="code" href="group__libstored__util.html#ga6953f0800ee0798ebed8c960e3412d17">string_literal</a>(buffer, len, prefix.c_str());</div><div class="line"><a name="l01339"></a><span class="lineno"> 1339</span>&#160;        s += <span class="stringliteral">&quot;\n&quot;</span>;</div><div class="line"><a name="l01340"></a><span class="lineno"> 1340</span>&#160;        fputs(s.c_str(), m_f);</div><div class="line"><a name="l01341"></a><span class="lineno"> 1341</span>&#160;    }</div><div class="line"><a name="l01342"></a><span class="lineno"> 1342</span>&#160;</div><div class="line"><a name="l01343"></a><span class="lineno"> 1343</span>&#160;    <a class="code" href="classstored_1_1_protocol_layer.html#a357b029311be09df61e019682a848ab5">base::decode</a>(buffer, len);</div><div class="line"><a name="l01344"></a><span class="lineno"> 1344</span>&#160;}</div><div class="line"><a name="l01345"></a><span class="lineno"> 1345</span>&#160;</div><div class="line"><a name="l01346"></a><span class="lineno"><a class="line" href="classstored_1_1_print_layer.html#a226eb9431e9d6a646fb120258d30717d"> 1346</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classstored_1_1_protocol_layer.html#a66c24cec6a17c44fac68213d358a5aa8">PrintLayer::encode</a>(<span class="keywordtype">void</span> <span class="keyword">const</span>* buffer, <span class="keywordtype">size_t</span> len, <span class="keywordtype">bool</span> last) {</div><div class="line"><a name="l01347"></a><span class="lineno"> 1347</span>&#160;    <span class="keywordflow">if</span>(m_f) {</div><div class="line"><a name="l01348"></a><span class="lineno"> 1348</span>&#160;        std::string <a class="code" href="namespaceed2_1_1cli_1_1____main____.html#a7dd4a7db291fe246593191db75b1fdca">prefix</a>;</div><div class="line"><a name="l01349"></a><span class="lineno"> 1349</span>&#160;        <span class="keywordflow">if</span>(m_name)</div><div class="line"><a name="l01350"></a><span class="lineno"> 1350</span>&#160;            prefix += m_name;</div><div class="line"><a name="l01351"></a><span class="lineno"> 1351</span>&#160;</div><div class="line"><a name="l01352"></a><span class="lineno"> 1352</span>&#160;        <span class="keywordflow">if</span>(last)</div><div class="line"><a name="l01353"></a><span class="lineno"> 1353</span>&#160;            prefix += <span class="stringliteral">&quot; &gt; &quot;</span>;</div><div class="line"><a name="l01354"></a><span class="lineno"> 1354</span>&#160;        <span class="keywordflow">else</span></div><div class="line"><a name="l01355"></a><span class="lineno"> 1355</span>&#160;            prefix += <span class="stringliteral">&quot; * &quot;</span>;</div><div class="line"><a name="l01356"></a><span class="lineno"> 1356</span>&#160;</div><div class="line"><a name="l01357"></a><span class="lineno"> 1357</span>&#160;        std::string s = <a class="code" href="group__libstored__util.html#ga6953f0800ee0798ebed8c960e3412d17">string_literal</a>(buffer, len, prefix.c_str());</div><div class="line"><a name="l01358"></a><span class="lineno"> 1358</span>&#160;        s += <span class="stringliteral">&quot;\n&quot;</span>;</div><div class="line"><a name="l01359"></a><span class="lineno"> 1359</span>&#160;        fputs(s.c_str(), m_f);</div><div class="line"><a name="l01360"></a><span class="lineno"> 1360</span>&#160;    }</div><div class="line"><a name="l01361"></a><span class="lineno"> 1361</span>&#160;</div><div class="line"><a name="l01362"></a><span class="lineno"> 1362</span>&#160;    <a class="code" href="classstored_1_1_protocol_layer.html#a66c24cec6a17c44fac68213d358a5aa8">base::encode</a>(buffer, len, last);</div><div class="line"><a name="l01363"></a><span class="lineno"> 1363</span>&#160;}</div><div class="line"><a name="l01364"></a><span class="lineno"> 1364</span>&#160;</div><div class="line"><a name="l01369"></a><span class="lineno"><a class="line" href="classstored_1_1_print_layer.html#aea312a1d43697789e614a761927288f9"> 1369</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classstored_1_1_print_layer.html#aea312a1d43697789e614a761927288f9">PrintLayer::setFile</a>(FILE* f) {</div><div class="line"><a name="l01370"></a><span class="lineno"> 1370</span>&#160;    m_f = f;</div><div class="line"><a name="l01371"></a><span class="lineno"> 1371</span>&#160;}</div><div class="line"><a name="l01372"></a><span class="lineno"> 1372</span>&#160;</div><div class="line"><a name="l01373"></a><span class="lineno"> 1373</span>&#160;</div><div class="line"><a name="l01374"></a><span class="lineno"> 1374</span>&#160;</div><div class="line"><a name="l01376"></a><span class="lineno"> 1376</span>&#160;<span class="comment">// Loopback</span></div><div class="line"><a name="l01377"></a><span class="lineno"> 1377</span>&#160;<span class="comment">//</span></div><div class="line"><a name="l01378"></a><span class="lineno"> 1378</span>&#160;</div><div class="line"><a name="l01382"></a><span class="lineno"><a class="line" href="classstored_1_1impl_1_1_loopback1.html#a1f4cc611f2fa3c9579adf29b1eed452d"> 1382</a></span>&#160;<a class="code" href="classstored_1_1impl_1_1_loopback1.html#a9ba9fec3c3b31d3cc7a09086ee70fdc8">impl::Loopback1::Loopback1</a>(<a class="code" href="classstored_1_1_protocol_layer.html">ProtocolLayer</a>&amp; from, <a class="code" href="classstored_1_1_protocol_layer.html">ProtocolLayer</a>&amp; to)</div><div class="line"><a name="l01383"></a><span class="lineno"> 1383</span>&#160;    : m_to(to)</div><div class="line"><a name="l01384"></a><span class="lineno"> 1384</span>&#160;    , m_buffer()</div><div class="line"><a name="l01385"></a><span class="lineno"> 1385</span>&#160;    , m_capacity()</div><div class="line"><a name="l01386"></a><span class="lineno"> 1386</span>&#160;    , m_len()</div><div class="line"><a name="l01387"></a><span class="lineno"> 1387</span>&#160;{</div><div class="line"><a name="l01388"></a><span class="lineno"> 1388</span>&#160;    <a class="code" href="classstored_1_1_protocol_layer.html#a7d2f0987462196f77ca9067c050db09d">wrap</a>(from);</div><div class="line"><a name="l01389"></a><span class="lineno"> 1389</span>&#160;}</div><div class="line"><a name="l01390"></a><span class="lineno"> 1390</span>&#160;</div><div class="line"><a name="l01394"></a><span class="lineno"><a class="line" href="classstored_1_1impl_1_1_loopback1.html#aa11ce490e7cb0f959dc692f78305cc5c"> 1394</a></span>&#160;<a class="code" href="classstored_1_1impl_1_1_loopback1.html#aa11ce490e7cb0f959dc692f78305cc5c">impl::Loopback1::~Loopback1</a>() {</div><div class="line"><a name="l01395"></a><span class="lineno"> 1395</span>&#160;    <span class="comment">// NOLINTNEXTLINE(cppcoreguidelines-owning-memory, cppcoreguidelines-no-malloc)</span></div><div class="line"><a name="l01396"></a><span class="lineno"> 1396</span>&#160;    free(m_buffer);</div><div class="line"><a name="l01397"></a><span class="lineno"> 1397</span>&#160;}</div><div class="line"><a name="l01398"></a><span class="lineno"> 1398</span>&#160;</div><div class="line"><a name="l01399"></a><span class="lineno"><a class="line" href="classstored_1_1impl_1_1_loopback1.html#ac2f4ef6e8200a9391d6c04728922198b"> 1399</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classstored_1_1impl_1_1_loopback1.html#ac2f4ef6e8200a9391d6c04728922198b">impl::Loopback1::reset</a>() {</div><div class="line"><a name="l01400"></a><span class="lineno"> 1400</span>&#160;    m_len = 0;</div><div class="line"><a name="l01401"></a><span class="lineno"> 1401</span>&#160;    <a class="code" href="classstored_1_1_protocol_layer.html#a53fe78a7b405b981649112d9c84fe762">base::reset</a>();</div><div class="line"><a name="l01402"></a><span class="lineno"> 1402</span>&#160;}</div><div class="line"><a name="l01403"></a><span class="lineno"> 1403</span>&#160;</div><div class="line"><a name="l01407"></a><span class="lineno"><a class="line" href="classstored_1_1impl_1_1_loopback1.html#a253415479c82702a73eb0f5b7435354a"> 1407</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classstored_1_1_protocol_layer.html#a66c24cec6a17c44fac68213d358a5aa8">impl::Loopback1::encode</a>(<span class="keywordtype">void</span> <span class="keyword">const</span>* buffer, <span class="keywordtype">size_t</span> len, <span class="keywordtype">bool</span> last) {</div><div class="line"><a name="l01408"></a><span class="lineno"> 1408</span>&#160;    <span class="keywordflow">if</span>(<a class="code" href="group__libstored__util.html#gaa0672ea7123854cc5f51902a06c473fb">likely</a>(len &gt; 0)) {</div><div class="line"><a name="l01409"></a><span class="lineno"> 1409</span>&#160;        <span class="keywordflow">if</span>(<a class="code" href="group__libstored__util.html#gad8700448546b3b5111404cc021061fd5">unlikely</a>(m_len + len &gt; m_capacity)) {</div><div class="line"><a name="l01410"></a><span class="lineno"> 1410</span>&#160;            <span class="keywordtype">size_t</span> capacity = m_len + len + <a class="code" href="classstored_1_1impl_1_1_loopback1.html#a467b311cc00912a44ad9a1af3a901274a594188343a255bdf58034bdc4eaa2ac2">ExtraAlloc</a>;</div><div class="line"><a name="l01411"></a><span class="lineno"> 1411</span>&#160;            <span class="comment">// NOLINTNEXTLINE(cppcoreguidelines-owning-memory, cppcoreguidelines-no-malloc)</span></div><div class="line"><a name="l01412"></a><span class="lineno"> 1412</span>&#160;            <span class="keywordtype">void</span>* p = realloc(m_buffer, capacity);</div><div class="line"><a name="l01413"></a><span class="lineno"> 1413</span>&#160;            <span class="keywordflow">if</span>(!p)</div><div class="line"><a name="l01414"></a><span class="lineno"> 1414</span>&#160;                <span class="keywordflow">throw</span> std::bad_alloc();</div><div class="line"><a name="l01415"></a><span class="lineno"> 1415</span>&#160;            m_buffer = <span class="keyword">static_cast&lt;</span><span class="keywordtype">char</span>*<span class="keyword">&gt;</span>(p);</div><div class="line"><a name="l01416"></a><span class="lineno"> 1416</span>&#160;            m_capacity = capacity;</div><div class="line"><a name="l01417"></a><span class="lineno"> 1417</span>&#160;        }</div><div class="line"><a name="l01418"></a><span class="lineno"> 1418</span>&#160;</div><div class="line"><a name="l01419"></a><span class="lineno"> 1419</span>&#160;        memcpy(m_buffer + m_len, buffer, len);</div><div class="line"><a name="l01420"></a><span class="lineno"> 1420</span>&#160;        m_len += len;</div><div class="line"><a name="l01421"></a><span class="lineno"> 1421</span>&#160;    }</div><div class="line"><a name="l01422"></a><span class="lineno"> 1422</span>&#160;</div><div class="line"><a name="l01423"></a><span class="lineno"> 1423</span>&#160;    <span class="keywordflow">if</span>(last) {</div><div class="line"><a name="l01424"></a><span class="lineno"> 1424</span>&#160;        m_to.<a class="code" href="classstored_1_1_protocol_layer.html#a357b029311be09df61e019682a848ab5">decode</a>(m_buffer, m_len);</div><div class="line"><a name="l01425"></a><span class="lineno"> 1425</span>&#160;        m_len = 0;</div><div class="line"><a name="l01426"></a><span class="lineno"> 1426</span>&#160;    }</div><div class="line"><a name="l01427"></a><span class="lineno"> 1427</span>&#160;}</div><div class="line"><a name="l01428"></a><span class="lineno"> 1428</span>&#160;</div><div class="line"><a name="l01432"></a><span class="lineno"><a class="line" href="classstored_1_1_loopback.html#ae239087665db4aeee2b4ac4d88769688"> 1432</a></span>&#160;<a class="code" href="classstored_1_1_loopback.html#a26f5377becabea23ff50ff180c52a6d8">Loopback::Loopback</a>(<a class="code" href="classstored_1_1_protocol_layer.html">ProtocolLayer</a>&amp; a, <a class="code" href="classstored_1_1_protocol_layer.html">ProtocolLayer</a>&amp; b)</div><div class="line"><a name="l01433"></a><span class="lineno"> 1433</span>&#160;    : m_a2b(a, b)</div><div class="line"><a name="l01434"></a><span class="lineno"> 1434</span>&#160;    , m_b2a(b, a)</div><div class="line"><a name="l01435"></a><span class="lineno"> 1435</span>&#160;{</div><div class="line"><a name="l01436"></a><span class="lineno"> 1436</span>&#160;}</div><div class="line"><a name="l01437"></a><span class="lineno"> 1437</span>&#160;</div><div class="line"><a name="l01438"></a><span class="lineno"> 1438</span>&#160;</div><div class="line"><a name="l01439"></a><span class="lineno"> 1439</span>&#160;</div><div class="line"><a name="l01440"></a><span class="lineno"> 1440</span>&#160;</div><div class="line"><a name="l01442"></a><span class="lineno"> 1442</span>&#160;<span class="comment">// PolledLayer</span></div><div class="line"><a name="l01443"></a><span class="lineno"> 1443</span>&#160;<span class="comment">//</span></div><div class="line"><a name="l01444"></a><span class="lineno"> 1444</span>&#160;</div><div class="line"><a name="l01445"></a><span class="lineno"><a class="line" href="classstored_1_1_polled_layer.html#a21006ea40e3651fb8ce21e28126b0ec8"> 1445</a></span>&#160;<a class="code" href="classstored_1_1_polled_layer.html#a21006ea40e3651fb8ce21e28126b0ec8">PolledLayer::~PolledLayer</a>() {</div><div class="line"><a name="l01446"></a><span class="lineno"> 1446</span>&#160;    <span class="comment">// We would like to close(), but at this point, the subclass was</span></div><div class="line"><a name="l01447"></a><span class="lineno"> 1447</span>&#160;    <span class="comment">// already destructed. So, make sure to close the handles</span></div><div class="line"><a name="l01448"></a><span class="lineno"> 1448</span>&#160;    <span class="comment">// in your subclass dtor.</span></div><div class="line"><a name="l01449"></a><span class="lineno"> 1449</span>&#160;    <span class="comment">//close();</span></div><div class="line"><a name="l01450"></a><span class="lineno"> 1450</span>&#160;</div><div class="line"><a name="l01451"></a><span class="lineno"> 1451</span>&#160;    <span class="keyword">delete</span> m_poller;</div><div class="line"><a name="l01452"></a><span class="lineno"> 1452</span>&#160;}</div><div class="line"><a name="l01453"></a><span class="lineno"> 1453</span>&#160;</div><div class="line"><a name="l01454"></a><span class="lineno"><a class="line" href="classstored_1_1_polled_layer.html#a79de5a08490722c111347ed8274d0f3a"> 1454</a></span>&#160;<span class="keywordtype">int</span> <a class="code" href="classstored_1_1_polled_layer.html#a79de5a08490722c111347ed8274d0f3a">PolledLayer::block</a>(<a class="code" href="classstored_1_1_polled_layer.html#a4c9bc21201b7bd79875972d03fc1b7dc">PolledLayer::fd_type</a> fd, <span class="keywordtype">bool</span> forReading, <span class="keywordtype">bool</span> suspend) {</div><div class="line"><a name="l01455"></a><span class="lineno"> 1455</span>&#160;    setLastError(0);</div><div class="line"><a name="l01456"></a><span class="lineno"> 1456</span>&#160;</div><div class="line"><a name="l01457"></a><span class="lineno"> 1457</span>&#160;    <a class="code" href="classstored_1_1_poller.html">Poller</a>&amp; poller = this-&gt;poller();</div><div class="line"><a name="l01458"></a><span class="lineno"> 1458</span>&#160;</div><div class="line"><a name="l01459"></a><span class="lineno"> 1459</span>&#160;    <a class="code" href="classstored_1_1_poller.html#a6d543d60c57a87422fdda7b8ea299b84">Poller::events_t</a> events = forReading ? <a class="code" href="classstored_1_1_poller.html#a64dc1f4e5440d90ddaa1c971ed636fac">Poller::PollIn</a> : <a class="code" href="classstored_1_1_poller.html#a563ec33f78322f6d39047dae05df0a4c">Poller::PollOut</a>;</div><div class="line"><a name="l01460"></a><span class="lineno"> 1460</span>&#160;</div><div class="line"><a name="l01461"></a><span class="lineno"> 1461</span>&#160;    <span class="keywordtype">int</span> err = 0;</div><div class="line"><a name="l01462"></a><span class="lineno"> 1462</span>&#160;    <span class="keywordtype">int</span> <a class="code" href="namespaceed2_1_1gui_1_1____main____.html#a11587f112b0486278fe041290b1db064">res</a> = 0;</div><div class="line"><a name="l01463"></a><span class="lineno"> 1463</span>&#160;    <span class="keywordflow">if</span>((res = poller.<a class="code" href="classstored_1_1_poller.html#a7fe572aa2ac38892434063776cf3b09d">add</a>(fd, <span class="keyword">nullptr</span>, events))) {</div><div class="line"><a name="l01464"></a><span class="lineno"> 1464</span>&#160;        err = <a class="code" href="namespaceed2_1_1gui_1_1____main____.html#a11587f112b0486278fe041290b1db064">res</a>;</div><div class="line"><a name="l01465"></a><span class="lineno"> 1465</span>&#160;        <span class="keywordflow">goto</span> done;</div><div class="line"><a name="l01466"></a><span class="lineno"> 1466</span>&#160;    }</div><div class="line"><a name="l01467"></a><span class="lineno"> 1467</span>&#160;</div><div class="line"><a name="l01468"></a><span class="lineno"> 1468</span>&#160;    <span class="keywordflow">while</span>(<span class="keyword">true</span>) {</div><div class="line"><a name="l01469"></a><span class="lineno"> 1469</span>&#160;        <a class="code" href="classstored_1_1_poller.html#a28a96951d17fc9795ec7f81ad931dc0e">Poller::Result</a> <span class="keyword">const</span>&amp; pres = poller.<a class="code" href="classstored_1_1_poller.html#a34425a048a7959779ae5ec1df09c633d">poll</a>(-1, suspend);</div><div class="line"><a name="l01470"></a><span class="lineno"> 1470</span>&#160;</div><div class="line"><a name="l01471"></a><span class="lineno"> 1471</span>&#160;        <span class="keywordflow">if</span>(pres.empty()) {</div><div class="line"><a name="l01472"></a><span class="lineno"> 1472</span>&#160;            <span class="comment">// Should not happen.</span></div><div class="line"><a name="l01473"></a><span class="lineno"> 1473</span>&#160;            err = EINVAL;</div><div class="line"><a name="l01474"></a><span class="lineno"> 1474</span>&#160;            <span class="keywordflow">break</span>;</div><div class="line"><a name="l01475"></a><span class="lineno"> 1475</span>&#160;        } <span class="keywordflow">else</span> <span class="keywordflow">if</span>(((<a class="code" href="classstored_1_1_poller.html#a6d543d60c57a87422fdda7b8ea299b84">Poller::events_t</a>)pres[0].events) &amp; (<a class="code" href="classstored_1_1_poller.html#a6d543d60c57a87422fdda7b8ea299b84">Poller::events_t</a>)(<a class="code" href="classstored_1_1_poller.html#a540da5e0b855335235527e751eb704c4">Poller::PollErr</a> | <a class="code" href="classstored_1_1_poller.html#aaae1953951626d294a17b65164794d92">Poller::PollHup</a>)) {</div><div class="line"><a name="l01476"></a><span class="lineno"> 1476</span>&#160;            <span class="comment">// Something is wrong with the pipe/socket.</span></div><div class="line"><a name="l01477"></a><span class="lineno"> 1477</span>&#160;            err = EIO;</div><div class="line"><a name="l01478"></a><span class="lineno"> 1478</span>&#160;            <span class="keywordflow">break</span>;</div><div class="line"><a name="l01479"></a><span class="lineno"> 1479</span>&#160;        } <span class="keywordflow">else</span> <span class="keywordflow">if</span>(((<a class="code" href="classstored_1_1_poller.html#a6d543d60c57a87422fdda7b8ea299b84">Poller::events_t</a>)pres[0].events) &amp; events) {</div><div class="line"><a name="l01480"></a><span class="lineno"> 1480</span>&#160;            <span class="comment">// Got it.</span></div><div class="line"><a name="l01481"></a><span class="lineno"> 1481</span>&#160;            <span class="keywordflow">break</span>;</div><div class="line"><a name="l01482"></a><span class="lineno"> 1482</span>&#160;        }</div><div class="line"><a name="l01483"></a><span class="lineno"> 1483</span>&#160;    }</div><div class="line"><a name="l01484"></a><span class="lineno"> 1484</span>&#160;</div><div class="line"><a name="l01485"></a><span class="lineno"> 1485</span>&#160;    <span class="keywordflow">if</span>((res = poller.<a class="code" href="classstored_1_1_poller.html#a04390a8167a3ede3ea54b7d0879bdd1d">remove</a>(fd)))</div><div class="line"><a name="l01486"></a><span class="lineno"> 1486</span>&#160;        <span class="keywordflow">if</span>(!err)</div><div class="line"><a name="l01487"></a><span class="lineno"> 1487</span>&#160;            err = <a class="code" href="namespaceed2_1_1gui_1_1____main____.html#a11587f112b0486278fe041290b1db064">res</a>;</div><div class="line"><a name="l01488"></a><span class="lineno"> 1488</span>&#160;</div><div class="line"><a name="l01489"></a><span class="lineno"> 1489</span>&#160;done:</div><div class="line"><a name="l01490"></a><span class="lineno"> 1490</span>&#160;    <span class="keywordflow">if</span>(err)</div><div class="line"><a name="l01491"></a><span class="lineno"> 1491</span>&#160;        close();</div><div class="line"><a name="l01492"></a><span class="lineno"> 1492</span>&#160;</div><div class="line"><a name="l01493"></a><span class="lineno"> 1493</span>&#160;    <span class="keywordflow">return</span> setLastError(err);</div><div class="line"><a name="l01494"></a><span class="lineno"> 1494</span>&#160;}</div><div class="line"><a name="l01495"></a><span class="lineno"> 1495</span>&#160;</div><div class="line"><a name="l01496"></a><span class="lineno"><a class="line" href="classstored_1_1_polled_layer.html#a52a33d958169ab79bd11efc34cc2f0c9"> 1496</a></span>&#160;<a class="code" href="classstored_1_1_poller.html">Poller</a>&amp; <a class="code" href="classstored_1_1_polled_layer.html#a52a33d958169ab79bd11efc34cc2f0c9">PolledLayer::poller</a>() {</div><div class="line"><a name="l01497"></a><span class="lineno"> 1497</span>&#160;    <span class="keywordflow">if</span>(!m_poller)</div><div class="line"><a name="l01498"></a><span class="lineno"> 1498</span>&#160;        m_poller = <span class="keyword">new</span> <a class="code" href="classstored_1_1_poller.html">Poller</a>(); <span class="comment">// NOLINT(cppcoreguidelines-owning-memory)</span></div><div class="line"><a name="l01499"></a><span class="lineno"> 1499</span>&#160;</div><div class="line"><a name="l01500"></a><span class="lineno"> 1500</span>&#160;    <span class="keywordflow">return</span> *m_poller;</div><div class="line"><a name="l01501"></a><span class="lineno"> 1501</span>&#160;}</div><div class="line"><a name="l01502"></a><span class="lineno"> 1502</span>&#160;</div><div class="line"><a name="l01503"></a><span class="lineno"> 1503</span>&#160;</div><div class="line"><a name="l01505"></a><span class="lineno"> 1505</span>&#160;<span class="comment">// FileLayer</span></div><div class="line"><a name="l01506"></a><span class="lineno"> 1506</span>&#160;<span class="comment">//</span></div><div class="line"><a name="l01507"></a><span class="lineno"> 1507</span>&#160;</div><div class="line"><a name="l01508"></a><span class="lineno"> 1508</span>&#160;<span class="preprocessor">#ifndef STORED_OS_WINDOWS</span></div><div class="line"><a name="l01509"></a><span class="lineno"> 1509</span>&#160;</div><div class="line"><a name="l01510"></a><span class="lineno"><a class="line" href="classstored_1_1_file_layer.html#a7d1e96b38073bee0483b54a28e0c3463"> 1510</a></span>&#160;<a class="code" href="classstored_1_1_file_layer.html#af0f0a290b2bb5209b825ad8dd29e7ff0">FileLayer::FileLayer</a>(<a class="code" href="classstored_1_1_protocol_layer.html">ProtocolLayer</a>* up, <a class="code" href="classstored_1_1_protocol_layer.html">ProtocolLayer</a>* down)</div><div class="line"><a name="l01511"></a><span class="lineno"> 1511</span>&#160;    : <a class="code" href="classstored_1_1_polled_layer.html">base</a>(up, down)</div><div class="line"><a name="l01512"></a><span class="lineno"> 1512</span>&#160;    , m_fd_r(-1)</div><div class="line"><a name="l01513"></a><span class="lineno"> 1513</span>&#160;    , m_fd_w(-1)</div><div class="line"><a name="l01514"></a><span class="lineno"> 1514</span>&#160;{</div><div class="line"><a name="l01515"></a><span class="lineno"> 1515</span>&#160;    <a class="code" href="classstored_1_1_polled_layer.html#a70378f51cf130ff4aed4dce90a1b403a">setLastError</a>(EBADF);</div><div class="line"><a name="l01516"></a><span class="lineno"> 1516</span>&#160;}</div><div class="line"><a name="l01517"></a><span class="lineno"> 1517</span>&#160;</div><div class="line"><a name="l01518"></a><span class="lineno"><a class="line" href="classstored_1_1_file_layer.html#acf7e73440e7f9cc631e85c92aa87b031"> 1518</a></span>&#160;<a class="code" href="classstored_1_1_file_layer.html#af0f0a290b2bb5209b825ad8dd29e7ff0">FileLayer::FileLayer</a>(<span class="keywordtype">int</span> <a class="code" href="classstored_1_1_file_layer.html#ac1a3bb7c1dd0c85bde2072288f30024d">fd_r</a>, <span class="keywordtype">int</span> <a class="code" href="classstored_1_1_file_layer.html#a4aebe2812c392f4b25d12aa16021a65f">fd_w</a>, <a class="code" href="classstored_1_1_protocol_layer.html">ProtocolLayer</a>* up, <a class="code" href="classstored_1_1_protocol_layer.html">ProtocolLayer</a>* down)</div><div class="line"><a name="l01519"></a><span class="lineno"> 1519</span>&#160;    : <a class="code" href="classstored_1_1_polled_layer.html">base</a>(up, down)</div><div class="line"><a name="l01520"></a><span class="lineno"> 1520</span>&#160;    , m_fd_r(-1)</div><div class="line"><a name="l01521"></a><span class="lineno"> 1521</span>&#160;    , m_fd_w(-1)</div><div class="line"><a name="l01522"></a><span class="lineno"> 1522</span>&#160;{</div><div class="line"><a name="l01523"></a><span class="lineno"> 1523</span>&#160;<span class="preprocessor">#  ifdef STORED_OS_POSIX</span></div><div class="line"><a name="l01524"></a><span class="lineno"> 1524</span>&#160;    <span class="comment">// NOLINTNEXTLINE(hicpp-signed-bitwise)</span></div><div class="line"><a name="l01525"></a><span class="lineno"> 1525</span>&#160;    fcntl(fd_r, F_SETFL, fcntl(fd_r, F_GETFL) | O_NONBLOCK);</div><div class="line"><a name="l01526"></a><span class="lineno"> 1526</span>&#160;    <span class="comment">// NOLINTNEXTLINE(hicpp-signed-bitwise)</span></div><div class="line"><a name="l01527"></a><span class="lineno"> 1527</span>&#160;    fcntl(fd_w, F_SETFL, fcntl(fd_w, F_GETFL) | O_NONBLOCK);</div><div class="line"><a name="l01528"></a><span class="lineno"> 1528</span>&#160;<span class="preprocessor">#  endif</span></div><div class="line"><a name="l01529"></a><span class="lineno"> 1529</span>&#160;</div><div class="line"><a name="l01530"></a><span class="lineno"> 1530</span>&#160;    <a class="code" href="classstored_1_1_file_layer.html#a53480909edeb9ba1c033552dc27fe309">init</a>(fd_r, fd_w == -1 ? fd_r : fd_w);</div><div class="line"><a name="l01531"></a><span class="lineno"> 1531</span>&#160;}</div><div class="line"><a name="l01532"></a><span class="lineno"> 1532</span>&#160;</div><div class="line"><a name="l01533"></a><span class="lineno"><a class="line" href="classstored_1_1_file_layer.html#a81f2848546058e8ea14d0b1e123d57e8"> 1533</a></span>&#160;<a class="code" href="classstored_1_1_file_layer.html#af0f0a290b2bb5209b825ad8dd29e7ff0">FileLayer::FileLayer</a>(<span class="keywordtype">char</span> <span class="keyword">const</span>* name_r, <span class="keywordtype">char</span> <span class="keyword">const</span>* name_w, <a class="code" href="classstored_1_1_protocol_layer.html">ProtocolLayer</a>* up, <a class="code" href="classstored_1_1_protocol_layer.html">ProtocolLayer</a>* down)</div><div class="line"><a name="l01534"></a><span class="lineno"> 1534</span>&#160;    : <a class="code" href="classstored_1_1_polled_layer.html">base</a>(up, down)</div><div class="line"><a name="l01535"></a><span class="lineno"> 1535</span>&#160;    , m_fd_r(-1)</div><div class="line"><a name="l01536"></a><span class="lineno"> 1536</span>&#160;    , m_fd_w(-1)</div><div class="line"><a name="l01537"></a><span class="lineno"> 1537</span>&#160;{</div><div class="line"><a name="l01538"></a><span class="lineno"> 1538</span>&#160;    <span class="keywordtype">int</span> r = -1;</div><div class="line"><a name="l01539"></a><span class="lineno"> 1539</span>&#160;    <span class="keywordtype">int</span> w = -1;</div><div class="line"><a name="l01540"></a><span class="lineno"> 1540</span>&#160;</div><div class="line"><a name="l01541"></a><span class="lineno"> 1541</span>&#160;    <span class="keywordflow">if</span>(!name_w || strcmp(name_r, name_w) == 0) {</div><div class="line"><a name="l01542"></a><span class="lineno"> 1542</span>&#160;        <span class="comment">// NOLINTNEXTLINE(hicpp-signed-bitwise)</span></div><div class="line"><a name="l01543"></a><span class="lineno"> 1543</span>&#160;        <span class="keywordflow">if</span>((w = r = open(name_r, O_RDWR | O_APPEND | O_CREAT | O_NONBLOCK, 0666)) == -1)</div><div class="line"><a name="l01544"></a><span class="lineno"> 1544</span>&#160;            <span class="keywordflow">goto</span> error;</div><div class="line"><a name="l01545"></a><span class="lineno"> 1545</span>&#160;</div><div class="line"><a name="l01546"></a><span class="lineno"> 1546</span>&#160;    <span class="comment">// NOLINTNEXTLINE(hicpp-signed-bitwise)</span></div><div class="line"><a name="l01547"></a><span class="lineno"> 1547</span>&#160;    } <span class="keywordflow">else</span> <span class="keywordflow">if</span>((r = open(name_r, O_RDONLY | O_CREAT | O_NONBLOCK, 0666)) == -1) {</div><div class="line"><a name="l01548"></a><span class="lineno"> 1548</span>&#160;        <span class="keywordflow">goto</span> error;</div><div class="line"><a name="l01549"></a><span class="lineno"> 1549</span>&#160;</div><div class="line"><a name="l01550"></a><span class="lineno"> 1550</span>&#160;    <span class="comment">// NOLINTNEXTLINE(hicpp-signed-bitwise)</span></div><div class="line"><a name="l01551"></a><span class="lineno"> 1551</span>&#160;    } <span class="keywordflow">else</span> <span class="keywordflow">if</span>((w = open(name_w, O_WRONLY | O_APPEND | O_CREAT | O_NONBLOCK, 0666)) == -1) {</div><div class="line"><a name="l01552"></a><span class="lineno"> 1552</span>&#160;        <span class="keywordflow">goto</span> error;</div><div class="line"><a name="l01553"></a><span class="lineno"> 1553</span>&#160;    }</div><div class="line"><a name="l01554"></a><span class="lineno"> 1554</span>&#160;</div><div class="line"><a name="l01555"></a><span class="lineno"> 1555</span>&#160;    <a class="code" href="classstored_1_1_file_layer.html#a53480909edeb9ba1c033552dc27fe309">init</a>(r, w);</div><div class="line"><a name="l01556"></a><span class="lineno"> 1556</span>&#160;    <span class="keywordflow">return</span>;</div><div class="line"><a name="l01557"></a><span class="lineno"> 1557</span>&#160;</div><div class="line"><a name="l01558"></a><span class="lineno"> 1558</span>&#160;error:</div><div class="line"><a name="l01559"></a><span class="lineno"> 1559</span>&#160;    <span class="keywordflow">if</span>(r != -1)</div><div class="line"><a name="l01560"></a><span class="lineno"> 1560</span>&#160;        <a class="code" href="classstored_1_1_file_layer.html#ab9e526fff86fae14f35909ac23983131">::close</a>(r);</div><div class="line"><a name="l01561"></a><span class="lineno"> 1561</span>&#160;    <span class="keywordflow">if</span>(w != -1)</div><div class="line"><a name="l01562"></a><span class="lineno"> 1562</span>&#160;        <a class="code" href="classstored_1_1_file_layer.html#ab9e526fff86fae14f35909ac23983131">::close</a>(w);</div><div class="line"><a name="l01563"></a><span class="lineno"> 1563</span>&#160;    <a class="code" href="classstored_1_1_polled_layer.html#a70378f51cf130ff4aed4dce90a1b403a">setLastError</a>(errno ? errno : EBADF);</div><div class="line"><a name="l01564"></a><span class="lineno"> 1564</span>&#160;}</div><div class="line"><a name="l01565"></a><span class="lineno"> 1565</span>&#160;</div><div class="line"><a name="l01566"></a><span class="lineno"> 1566</span>&#160;<span class="comment">// cppcheck-suppress passedByValue</span></div><div class="line"><a name="l01567"></a><span class="lineno"><a class="line" href="classstored_1_1_file_layer.html#a53480909edeb9ba1c033552dc27fe309"> 1567</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classstored_1_1_file_layer.html#a53480909edeb9ba1c033552dc27fe309">FileLayer::init</a>(<a class="code" href="classstored_1_1_file_layer.html#a4c9bc21201b7bd79875972d03fc1b7dc">FileLayer::fd_type</a> <a class="code" href="classstored_1_1_file_layer.html#ac1a3bb7c1dd0c85bde2072288f30024d">fd_r</a>, <a class="code" href="classstored_1_1_file_layer.html#a4c9bc21201b7bd79875972d03fc1b7dc">FileLayer::fd_type</a> <a class="code" href="classstored_1_1_file_layer.html#a4aebe2812c392f4b25d12aa16021a65f">fd_w</a>) {</div><div class="line"><a name="l01568"></a><span class="lineno"> 1568</span>&#160;    <a class="code" href="group__libstored__util.html#gab750e51b876450a0a4ad419588a82a4d">stored_assert</a>(m_fd_r == -1);</div><div class="line"><a name="l01569"></a><span class="lineno"> 1569</span>&#160;    <a class="code" href="group__libstored__util.html#gab750e51b876450a0a4ad419588a82a4d">stored_assert</a>(m_fd_w == -1);</div><div class="line"><a name="l01570"></a><span class="lineno"> 1570</span>&#160;</div><div class="line"><a name="l01571"></a><span class="lineno"> 1571</span>&#160;    m_fd_r = <a class="code" href="classstored_1_1_file_layer.html#ac1a3bb7c1dd0c85bde2072288f30024d">fd_r</a>;</div><div class="line"><a name="l01572"></a><span class="lineno"> 1572</span>&#160;    m_fd_w = <a class="code" href="classstored_1_1_file_layer.html#a4aebe2812c392f4b25d12aa16021a65f">fd_w</a>;</div><div class="line"><a name="l01573"></a><span class="lineno"> 1573</span>&#160;</div><div class="line"><a name="l01574"></a><span class="lineno"> 1574</span>&#160;    <span class="keywordflow">if</span>(m_fd_r == -1 || m_fd_w == -1) {</div><div class="line"><a name="l01575"></a><span class="lineno"> 1575</span>&#160;        <a class="code" href="classstored_1_1_polled_layer.html#a70378f51cf130ff4aed4dce90a1b403a">setLastError</a>(EBADF);</div><div class="line"><a name="l01576"></a><span class="lineno"> 1576</span>&#160;    } <span class="keywordflow">else</span> {</div><div class="line"><a name="l01577"></a><span class="lineno"> 1577</span>&#160;        m_bufferRead.resize(<a class="code" href="classstored_1_1_file_layer.html#add1204842977b02378bba7b8ae4f122fa2927e7823f567f182fe3f7f28e9f9abf">BufferSize</a>);</div><div class="line"><a name="l01578"></a><span class="lineno"> 1578</span>&#160;        <a class="code" href="classstored_1_1_polled_layer.html#a70378f51cf130ff4aed4dce90a1b403a">setLastError</a>(0);</div><div class="line"><a name="l01579"></a><span class="lineno"> 1579</span>&#160;    }</div><div class="line"><a name="l01580"></a><span class="lineno"> 1580</span>&#160;}</div><div class="line"><a name="l01581"></a><span class="lineno"> 1581</span>&#160;</div><div class="line"><a name="l01582"></a><span class="lineno"><a class="line" href="classstored_1_1_file_layer.html#addb5cf9fb3707fa3da6dbf092faa0d82"> 1582</a></span>&#160;<a class="code" href="classstored_1_1_file_layer.html#addb5cf9fb3707fa3da6dbf092faa0d82">FileLayer::~FileLayer</a>() {</div><div class="line"><a name="l01583"></a><span class="lineno"> 1583</span>&#160;    <a class="code" href="classstored_1_1_file_layer.html#aa319f69ae9b0d305b60e139ed4a941fa">close_</a>();</div><div class="line"><a name="l01584"></a><span class="lineno"> 1584</span>&#160;}</div><div class="line"><a name="l01585"></a><span class="lineno"> 1585</span>&#160;</div><div class="line"><a name="l01586"></a><span class="lineno"><a class="line" href="classstored_1_1_file_layer.html#ab9e526fff86fae14f35909ac23983131"> 1586</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classstored_1_1_file_layer.html#ab9e526fff86fae14f35909ac23983131">FileLayer::close</a>() {</div><div class="line"><a name="l01587"></a><span class="lineno"> 1587</span>&#160;    <a class="code" href="classstored_1_1_file_layer.html#aa319f69ae9b0d305b60e139ed4a941fa">close_</a>();</div><div class="line"><a name="l01588"></a><span class="lineno"> 1588</span>&#160;}</div><div class="line"><a name="l01589"></a><span class="lineno"> 1589</span>&#160;</div><div class="line"><a name="l01590"></a><span class="lineno"><a class="line" href="classstored_1_1_file_layer.html#aa319f69ae9b0d305b60e139ed4a941fa"> 1590</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classstored_1_1_file_layer.html#aa319f69ae9b0d305b60e139ed4a941fa">FileLayer::close_</a>() {</div><div class="line"><a name="l01591"></a><span class="lineno"> 1591</span>&#160;    <span class="keywordflow">if</span>(m_fd_r != -1)</div><div class="line"><a name="l01592"></a><span class="lineno"> 1592</span>&#160;        <a class="code" href="classstored_1_1_file_layer.html#ab9e526fff86fae14f35909ac23983131">::close</a>(m_fd_r);</div><div class="line"><a name="l01593"></a><span class="lineno"> 1593</span>&#160;</div><div class="line"><a name="l01594"></a><span class="lineno"> 1594</span>&#160;    <span class="keywordflow">if</span>(m_fd_w != -1 &amp;&amp; m_fd_r != m_fd_w)</div><div class="line"><a name="l01595"></a><span class="lineno"> 1595</span>&#160;        <a class="code" href="classstored_1_1_file_layer.html#ab9e526fff86fae14f35909ac23983131">::close</a>(m_fd_w);</div><div class="line"><a name="l01596"></a><span class="lineno"> 1596</span>&#160;</div><div class="line"><a name="l01597"></a><span class="lineno"> 1597</span>&#160;    m_fd_r = -1;</div><div class="line"><a name="l01598"></a><span class="lineno"> 1598</span>&#160;    m_fd_w = -1;</div><div class="line"><a name="l01599"></a><span class="lineno"> 1599</span>&#160;</div><div class="line"><a name="l01600"></a><span class="lineno"> 1600</span>&#160;    <a class="code" href="classstored_1_1_polled_layer.html#af5b7fffdba945fa6063da0e4accd0ace">base::close</a>();</div><div class="line"><a name="l01601"></a><span class="lineno"> 1601</span>&#160;}</div><div class="line"><a name="l01602"></a><span class="lineno"> 1602</span>&#160;</div><div class="line"><a name="l01603"></a><span class="lineno"><a class="line" href="classstored_1_1_file_layer.html#a653122ce5a77c5d5999008337bce58b7"> 1603</a></span>&#160;<span class="keywordtype">bool</span> <a class="code" href="classstored_1_1_file_layer.html#a653122ce5a77c5d5999008337bce58b7">FileLayer::isOpen</a>()<span class="keyword"> const </span>{</div><div class="line"><a name="l01604"></a><span class="lineno"> 1604</span>&#160;    <span class="keywordflow">return</span> m_fd_r != -1;</div><div class="line"><a name="l01605"></a><span class="lineno"> 1605</span>&#160;}</div><div class="line"><a name="l01606"></a><span class="lineno"> 1606</span>&#160;</div><div class="line"><a name="l01607"></a><span class="lineno"><a class="line" href="classstored_1_1_file_layer.html#aa0d6e70fc9ba1a40c1436b055dbdc1e9"> 1607</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classstored_1_1_protocol_layer.html#a66c24cec6a17c44fac68213d358a5aa8">FileLayer::encode</a>(<span class="keywordtype">void</span> <span class="keyword">const</span>* buffer, <span class="keywordtype">size_t</span> len, <span class="keywordtype">bool</span> last) {</div><div class="line"><a name="l01608"></a><span class="lineno"> 1608</span>&#160;    <span class="keywordflow">if</span>(m_fd_w == -1) {</div><div class="line"><a name="l01609"></a><span class="lineno"> 1609</span>&#160;        <a class="code" href="classstored_1_1_polled_layer.html#a70378f51cf130ff4aed4dce90a1b403a">setLastError</a>(EBADF);</div><div class="line"><a name="l01610"></a><span class="lineno"> 1610</span>&#160;done:</div><div class="line"><a name="l01611"></a><span class="lineno"> 1611</span>&#160;        <a class="code" href="classstored_1_1_protocol_layer.html#a66c24cec6a17c44fac68213d358a5aa8">base::encode</a>(buffer, len, last);</div><div class="line"><a name="l01612"></a><span class="lineno"> 1612</span>&#160;        <span class="keywordflow">return</span>;</div><div class="line"><a name="l01613"></a><span class="lineno"> 1613</span>&#160;    }</div><div class="line"><a name="l01614"></a><span class="lineno"> 1614</span>&#160;</div><div class="line"><a name="l01615"></a><span class="lineno"> 1615</span>&#160;    <span class="keywordtype">char</span> <span class="keyword">const</span>* buf = <span class="keyword">static_cast&lt;</span><span class="keywordtype">char</span> <a class="code" href="namespaceed2_1_1gui_1_1____main____.html#a3c1fe823c9bbaf7e7dcef9ecc9fcb915">const</a>*<span class="keyword">&gt;</span>(buffer);</div><div class="line"><a name="l01616"></a><span class="lineno"> 1616</span>&#160;    <span class="keywordtype">size_t</span> buflen = len;</div><div class="line"><a name="l01617"></a><span class="lineno"> 1617</span>&#160;</div><div class="line"><a name="l01618"></a><span class="lineno"> 1618</span>&#160;    <span class="keywordflow">if</span>(m_fd_w == STDOUT_FILENO)</div><div class="line"><a name="l01619"></a><span class="lineno"> 1619</span>&#160;        <span class="comment">// Do not reorder stdout&#39;s FILE buffer and our write()s. Flush first.</span></div><div class="line"><a name="l01620"></a><span class="lineno"> 1620</span>&#160;        fflush(stdout);</div><div class="line"><a name="l01621"></a><span class="lineno"> 1621</span>&#160;</div><div class="line"><a name="l01622"></a><span class="lineno"> 1622</span>&#160;    <span class="keywordflow">while</span>(buflen &gt; 0) {</div><div class="line"><a name="l01623"></a><span class="lineno"> 1623</span>&#160;        ssize_t written = write(m_fd_w, buf, buflen);</div><div class="line"><a name="l01624"></a><span class="lineno"> 1624</span>&#160;</div><div class="line"><a name="l01625"></a><span class="lineno"> 1625</span>&#160;        <span class="keywordflow">switch</span>(written) {</div><div class="line"><a name="l01626"></a><span class="lineno"> 1626</span>&#160;        <span class="keywordflow">case</span> -1:</div><div class="line"><a name="l01627"></a><span class="lineno"> 1627</span>&#160;            <span class="keywordflow">switch</span>(errno) {</div><div class="line"><a name="l01628"></a><span class="lineno"> 1628</span>&#160;<span class="preprocessor">#if EAGAIN != EWOULDBLOCK</span></div><div class="line"><a name="l01629"></a><span class="lineno"> 1629</span>&#160;            <span class="keywordflow">case</span> EWOULDBLOCK:</div><div class="line"><a name="l01630"></a><span class="lineno"> 1630</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l01631"></a><span class="lineno"> 1631</span>&#160;            <span class="keywordflow">case</span> EAGAIN: {</div><div class="line"><a name="l01632"></a><span class="lineno"> 1632</span>&#160;                <span class="keywordflow">if</span>(this-&gt;<a class="code" href="classstored_1_1_polled_layer.html#a79de5a08490722c111347ed8274d0f3a">block</a>(m_fd_w, <span class="keyword">false</span>, m_fd_w == STDOUT_FILENO))</div><div class="line"><a name="l01633"></a><span class="lineno"> 1633</span>&#160;                    <span class="keywordflow">return</span>;</div><div class="line"><a name="l01634"></a><span class="lineno"> 1634</span>&#160;</div><div class="line"><a name="l01635"></a><span class="lineno"> 1635</span>&#160;                <span class="comment">// We should be able to write more now. Retry.</span></div><div class="line"><a name="l01636"></a><span class="lineno"> 1636</span>&#160;                <span class="keywordflow">continue</span>;</div><div class="line"><a name="l01637"></a><span class="lineno"> 1637</span>&#160;            }</div><div class="line"><a name="l01638"></a><span class="lineno"> 1638</span>&#160;            <span class="keywordflow">default</span>:</div><div class="line"><a name="l01639"></a><span class="lineno"> 1639</span>&#160;                <span class="keywordflow">goto</span> error;</div><div class="line"><a name="l01640"></a><span class="lineno"> 1640</span>&#160;            }</div><div class="line"><a name="l01641"></a><span class="lineno"> 1641</span>&#160;            <span class="keywordflow">break</span>;</div><div class="line"><a name="l01642"></a><span class="lineno"> 1642</span>&#160;        <span class="keywordflow">case</span> 0:</div><div class="line"><a name="l01643"></a><span class="lineno"> 1643</span>&#160;            errno = EIO;</div><div class="line"><a name="l01644"></a><span class="lineno"> 1644</span>&#160;            <span class="keywordflow">goto</span> error;</div><div class="line"><a name="l01645"></a><span class="lineno"> 1645</span>&#160;        <span class="keywordflow">default</span>:</div><div class="line"><a name="l01646"></a><span class="lineno"> 1646</span>&#160;            <a class="code" href="group__libstored__util.html#gab750e51b876450a0a4ad419588a82a4d">stored_assert</a>(buflen &gt;= (<span class="keywordtype">size_t</span>)written);</div><div class="line"><a name="l01647"></a><span class="lineno"> 1647</span>&#160;            buflen -= (size_t)written;</div><div class="line"><a name="l01648"></a><span class="lineno"> 1648</span>&#160;            buf += written;</div><div class="line"><a name="l01649"></a><span class="lineno"> 1649</span>&#160;        }</div><div class="line"><a name="l01650"></a><span class="lineno"> 1650</span>&#160;    }</div><div class="line"><a name="l01651"></a><span class="lineno"> 1651</span>&#160;</div><div class="line"><a name="l01652"></a><span class="lineno"> 1652</span>&#160;    <a class="code" href="classstored_1_1_polled_layer.html#a70378f51cf130ff4aed4dce90a1b403a">setLastError</a>(0);</div><div class="line"><a name="l01653"></a><span class="lineno"> 1653</span>&#160;    <span class="keywordflow">goto</span> done;</div><div class="line"><a name="l01654"></a><span class="lineno"> 1654</span>&#160;</div><div class="line"><a name="l01655"></a><span class="lineno"> 1655</span>&#160;error:</div><div class="line"><a name="l01656"></a><span class="lineno"> 1656</span>&#160;    <a class="code" href="classstored_1_1_file_layer.html#ab9e526fff86fae14f35909ac23983131">close</a>();</div><div class="line"><a name="l01657"></a><span class="lineno"> 1657</span>&#160;    <a class="code" href="classstored_1_1_polled_layer.html#a70378f51cf130ff4aed4dce90a1b403a">setLastError</a>(errno ? errno : EIO);</div><div class="line"><a name="l01658"></a><span class="lineno"> 1658</span>&#160;    <span class="keywordflow">goto</span> done;</div><div class="line"><a name="l01659"></a><span class="lineno"> 1659</span>&#160;}</div><div class="line"><a name="l01660"></a><span class="lineno"> 1660</span>&#160;</div><div class="line"><a name="l01661"></a><span class="lineno"><a class="line" href="classstored_1_1_file_layer.html#a58badaa958c01f0f22eaf298788148e8"> 1661</a></span>&#160;<a class="code" href="classstored_1_1_file_layer.html#a4c9bc21201b7bd79875972d03fc1b7dc">FileLayer::fd_type</a> <a class="code" href="classstored_1_1_file_layer.html#a58badaa958c01f0f22eaf298788148e8">FileLayer::fd</a>()<span class="keyword"> const </span>{</div><div class="line"><a name="l01662"></a><span class="lineno"> 1662</span>&#160;    <span class="keywordflow">return</span> m_fd_r;</div><div class="line"><a name="l01663"></a><span class="lineno"> 1663</span>&#160;}</div><div class="line"><a name="l01664"></a><span class="lineno"> 1664</span>&#160;</div><div class="line"><a name="l01665"></a><span class="lineno"><a class="line" href="classstored_1_1_file_layer.html#ac1a3bb7c1dd0c85bde2072288f30024d"> 1665</a></span>&#160;<a class="code" href="classstored_1_1_file_layer.html#a4c9bc21201b7bd79875972d03fc1b7dc">FileLayer::fd_type</a> <a class="code" href="classstored_1_1_file_layer.html#ac1a3bb7c1dd0c85bde2072288f30024d">FileLayer::fd_r</a>()<span class="keyword"> const </span>{</div><div class="line"><a name="l01666"></a><span class="lineno"> 1666</span>&#160;    <span class="keywordflow">return</span> m_fd_r;</div><div class="line"><a name="l01667"></a><span class="lineno"> 1667</span>&#160;}</div><div class="line"><a name="l01668"></a><span class="lineno"> 1668</span>&#160;</div><div class="line"><a name="l01669"></a><span class="lineno"><a class="line" href="classstored_1_1_file_layer.html#a4aebe2812c392f4b25d12aa16021a65f"> 1669</a></span>&#160;<a class="code" href="classstored_1_1_file_layer.html#a4c9bc21201b7bd79875972d03fc1b7dc">FileLayer::fd_type</a> <a class="code" href="classstored_1_1_file_layer.html#a4aebe2812c392f4b25d12aa16021a65f">FileLayer::fd_w</a>()<span class="keyword"> const </span>{</div><div class="line"><a name="l01670"></a><span class="lineno"> 1670</span>&#160;    <span class="keywordflow">return</span> m_fd_w;</div><div class="line"><a name="l01671"></a><span class="lineno"> 1671</span>&#160;}</div><div class="line"><a name="l01672"></a><span class="lineno"> 1672</span>&#160;</div><div class="line"><a name="l01673"></a><span class="lineno"><a class="line" href="classstored_1_1_file_layer.html#af12a800260514618e1ef49179a78dbd1"> 1673</a></span>&#160;<span class="keywordtype">int</span> <a class="code" href="classstored_1_1_file_layer.html#af12a800260514618e1ef49179a78dbd1">FileLayer::recv</a>(<span class="keywordtype">bool</span> <a class="code" href="classstored_1_1_polled_layer.html#a79de5a08490722c111347ed8274d0f3a">block</a>) {</div><div class="line"><a name="l01674"></a><span class="lineno"> 1674</span>&#160;    <span class="keywordflow">if</span>(<a class="code" href="classstored_1_1_file_layer.html#ac1a3bb7c1dd0c85bde2072288f30024d">fd_r</a>() == -1)</div><div class="line"><a name="l01675"></a><span class="lineno"> 1675</span>&#160;        <span class="keywordflow">return</span> <a class="code" href="classstored_1_1_polled_layer.html#a70378f51cf130ff4aed4dce90a1b403a">setLastError</a>(EBADF);</div><div class="line"><a name="l01676"></a><span class="lineno"> 1676</span>&#160;</div><div class="line"><a name="l01677"></a><span class="lineno"> 1677</span>&#160;again:</div><div class="line"><a name="l01678"></a><span class="lineno"> 1678</span>&#160;    ssize_t cnt = read(<a class="code" href="classstored_1_1_file_layer.html#ac1a3bb7c1dd0c85bde2072288f30024d">fd_r</a>(), &amp;m_bufferRead[0], m_bufferRead.size());</div><div class="line"><a name="l01679"></a><span class="lineno"> 1679</span>&#160;</div><div class="line"><a name="l01680"></a><span class="lineno"> 1680</span>&#160;    <span class="keywordflow">if</span>(cnt == -1) {</div><div class="line"><a name="l01681"></a><span class="lineno"> 1681</span>&#160;        <span class="keywordflow">switch</span>(errno) {</div><div class="line"><a name="l01682"></a><span class="lineno"> 1682</span>&#160;        <span class="keywordflow">case</span> EAGAIN:</div><div class="line"><a name="l01683"></a><span class="lineno"> 1683</span>&#160;<span class="preprocessor">#if EAGAIN != EWOULDBLOCK</span></div><div class="line"><a name="l01684"></a><span class="lineno"> 1684</span>&#160;        <span class="keywordflow">case</span> EWOULDBLOCK:</div><div class="line"><a name="l01685"></a><span class="lineno"> 1685</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l01686"></a><span class="lineno"> 1686</span>&#160;            <span class="keywordflow">if</span>(!block)</div><div class="line"><a name="l01687"></a><span class="lineno"> 1687</span>&#160;                <span class="keywordflow">return</span> <a class="code" href="classstored_1_1_polled_layer.html#a70378f51cf130ff4aed4dce90a1b403a">setLastError</a>(errno);</div><div class="line"><a name="l01688"></a><span class="lineno"> 1688</span>&#160;</div><div class="line"><a name="l01689"></a><span class="lineno"> 1689</span>&#160;            <span class="keywordflow">if</span>(this-&gt;<a class="code" href="classstored_1_1_polled_layer.html#a79de5a08490722c111347ed8274d0f3a">block</a>(<a class="code" href="classstored_1_1_file_layer.html#ac1a3bb7c1dd0c85bde2072288f30024d">fd_r</a>(), <span class="keyword">true</span>))</div><div class="line"><a name="l01690"></a><span class="lineno"> 1690</span>&#160;                <span class="keywordflow">return</span> <a class="code" href="classstored_1_1_polled_layer.html#a5f93b36636abab8f4cacb5f1b4fbcd82">lastError</a>();</div><div class="line"><a name="l01691"></a><span class="lineno"> 1691</span>&#160;</div><div class="line"><a name="l01692"></a><span class="lineno"> 1692</span>&#160;            <span class="keywordflow">goto</span> again;</div><div class="line"><a name="l01693"></a><span class="lineno"> 1693</span>&#160;        <span class="keywordflow">default</span>:</div><div class="line"><a name="l01694"></a><span class="lineno"> 1694</span>&#160;            <a class="code" href="classstored_1_1_file_layer.html#ab9e526fff86fae14f35909ac23983131">close</a>();</div><div class="line"><a name="l01695"></a><span class="lineno"> 1695</span>&#160;            <span class="keywordflow">return</span> <a class="code" href="classstored_1_1_polled_layer.html#a70378f51cf130ff4aed4dce90a1b403a">setLastError</a>(errno);</div><div class="line"><a name="l01696"></a><span class="lineno"> 1696</span>&#160;        }</div><div class="line"><a name="l01697"></a><span class="lineno"> 1697</span>&#160;    } <span class="keywordflow">else</span> <span class="keywordflow">if</span>(cnt == 0) {</div><div class="line"><a name="l01698"></a><span class="lineno"> 1698</span>&#160;        <span class="comment">// EOF</span></div><div class="line"><a name="l01699"></a><span class="lineno"> 1699</span>&#160;        <a class="code" href="classstored_1_1_file_layer.html#ab9e526fff86fae14f35909ac23983131">close</a>();</div><div class="line"><a name="l01700"></a><span class="lineno"> 1700</span>&#160;        <span class="keywordflow">return</span> <a class="code" href="classstored_1_1_polled_layer.html#a70378f51cf130ff4aed4dce90a1b403a">setLastError</a>(EAGAIN);</div><div class="line"><a name="l01701"></a><span class="lineno"> 1701</span>&#160;    } <span class="keywordflow">else</span> {</div><div class="line"><a name="l01702"></a><span class="lineno"> 1702</span>&#160;        <a class="code" href="classstored_1_1_protocol_layer.html#a357b029311be09df61e019682a848ab5">decode</a>(&amp;m_bufferRead[0], (<span class="keywordtype">size_t</span>)cnt);</div><div class="line"><a name="l01703"></a><span class="lineno"> 1703</span>&#160;        <span class="keywordflow">return</span> <a class="code" href="classstored_1_1_polled_layer.html#a70378f51cf130ff4aed4dce90a1b403a">setLastError</a>(0);</div><div class="line"><a name="l01704"></a><span class="lineno"> 1704</span>&#160;    }</div><div class="line"><a name="l01705"></a><span class="lineno"> 1705</span>&#160;}</div><div class="line"><a name="l01706"></a><span class="lineno"> 1706</span>&#160;</div><div class="line"><a name="l01707"></a><span class="lineno"> 1707</span>&#160;<span class="preprocessor">#else // STORED_OS_WINDOWS</span></div><div class="line"><a name="l01708"></a><span class="lineno"> 1708</span>&#160;</div><div class="line"><a name="l01709"></a><span class="lineno"> 1709</span>&#160;<span class="keyword">static</span> <span class="keywordtype">bool</span> isValidHandle(HANDLE h) {</div><div class="line"><a name="l01710"></a><span class="lineno"> 1710</span>&#160;    <span class="comment">// NOLINTNEXTLINE(cppcoreguidelines-pro-type-cstyle-cast)</span></div><div class="line"><a name="l01711"></a><span class="lineno"> 1711</span>&#160;    <span class="keywordflow">return</span> h != INVALID_HANDLE_VALUE;</div><div class="line"><a name="l01712"></a><span class="lineno"> 1712</span>&#160;}</div><div class="line"><a name="l01713"></a><span class="lineno"> 1713</span>&#160;</div><div class="line"><a name="l01714"></a><span class="lineno"> 1714</span>&#160;<span class="comment">// Convenience ctor for use. Do not use in subclass.</span></div><div class="line"><a name="l01715"></a><span class="lineno"> 1715</span>&#160;<a class="code" href="classstored_1_1_file_layer.html#af0f0a290b2bb5209b825ad8dd29e7ff0">FileLayer::FileLayer</a>(<span class="keywordtype">int</span> <a class="code" href="classstored_1_1_file_layer.html#ac1a3bb7c1dd0c85bde2072288f30024d">fd_r</a>, <span class="keywordtype">int</span> <a class="code" href="classstored_1_1_file_layer.html#a4aebe2812c392f4b25d12aa16021a65f">fd_w</a>, <a class="code" href="classstored_1_1_protocol_layer.html">ProtocolLayer</a>* up, <a class="code" href="classstored_1_1_protocol_layer.html">ProtocolLayer</a>* down)</div><div class="line"><a name="l01716"></a><span class="lineno"> 1716</span>&#160;    : <a class="code" href="classstored_1_1_file_layer.html#a62a89dd5d15ce541bccdab3c2c8326d1">base</a>(up, down)</div><div class="line"><a name="l01717"></a><span class="lineno"> 1717</span>&#160;    , m_fd_r(INVALID_HANDLE_VALUE) <span class="comment">// NOLINT(cppcoreguidelines-pro-type-cstyle-cast)</span></div><div class="line"><a name="l01718"></a><span class="lineno"> 1718</span>&#160;    , m_fd_w(INVALID_HANDLE_VALUE) <span class="comment">// NOLINT(cppcoreguidelines-pro-type-cstyle-cast)</span></div><div class="line"><a name="l01719"></a><span class="lineno"> 1719</span>&#160;    , m_overlappedRead()</div><div class="line"><a name="l01720"></a><span class="lineno"> 1720</span>&#160;    , m_overlappedWrite()</div><div class="line"><a name="l01721"></a><span class="lineno"> 1721</span>&#160;    , m_this(<span class="keyword">this</span>)</div><div class="line"><a name="l01722"></a><span class="lineno"> 1722</span>&#160;    , m_writeLen()</div><div class="line"><a name="l01723"></a><span class="lineno"> 1723</span>&#160;{</div><div class="line"><a name="l01724"></a><span class="lineno"> 1724</span>&#160;    <span class="comment">// NOLINTNEXTLINE(cppcoreguidelines-pro-type-cstyle-cast)</span></div><div class="line"><a name="l01725"></a><span class="lineno"> 1725</span>&#160;    HANDLE h_r = (HANDLE)_get_osfhandle(fd_r);</div><div class="line"><a name="l01726"></a><span class="lineno"> 1726</span>&#160;    <span class="comment">// NOLINTNEXTLINE(cppcoreguidelines-pro-type-cstyle-cast)</span></div><div class="line"><a name="l01727"></a><span class="lineno"> 1727</span>&#160;    HANDLE h_w = fd_w == -1 ? h_r : (HANDLE)_get_osfhandle(fd_w);</div><div class="line"><a name="l01728"></a><span class="lineno"> 1728</span>&#160;    <a class="code" href="classstored_1_1_file_layer.html#a53480909edeb9ba1c033552dc27fe309">init</a>(h_r, h_w);</div><div class="line"><a name="l01729"></a><span class="lineno"> 1729</span>&#160;}</div><div class="line"><a name="l01730"></a><span class="lineno"> 1730</span>&#160;</div><div class="line"><a name="l01731"></a><span class="lineno"> 1731</span>&#160;<span class="comment">// Convenience ctor for use. Do not use in subclass.</span></div><div class="line"><a name="l01732"></a><span class="lineno"> 1732</span>&#160;<a class="code" href="classstored_1_1_file_layer.html#af0f0a290b2bb5209b825ad8dd29e7ff0">FileLayer::FileLayer</a>(<span class="keywordtype">char</span> <span class="keyword">const</span>* name_r, <span class="keywordtype">char</span> <span class="keyword">const</span>* name_w, <a class="code" href="classstored_1_1_protocol_layer.html">ProtocolLayer</a>* up, <a class="code" href="classstored_1_1_protocol_layer.html">ProtocolLayer</a>* down)</div><div class="line"><a name="l01733"></a><span class="lineno"> 1733</span>&#160;    : <a class="code" href="classstored_1_1_file_layer.html#a62a89dd5d15ce541bccdab3c2c8326d1">base</a>(up, down)</div><div class="line"><a name="l01734"></a><span class="lineno"> 1734</span>&#160;    , m_fd_r(INVALID_HANDLE_VALUE) <span class="comment">// NOLINT(cppcoreguidelines-pro-type-cstyle-cast)</span></div><div class="line"><a name="l01735"></a><span class="lineno"> 1735</span>&#160;    , m_fd_w(INVALID_HANDLE_VALUE) <span class="comment">// NOLINT(cppcoreguidelines-pro-type-cstyle-cast)</span></div><div class="line"><a name="l01736"></a><span class="lineno"> 1736</span>&#160;    , m_overlappedRead()</div><div class="line"><a name="l01737"></a><span class="lineno"> 1737</span>&#160;    , m_overlappedWrite()</div><div class="line"><a name="l01738"></a><span class="lineno"> 1738</span>&#160;    , m_this(<span class="keyword">this</span>)</div><div class="line"><a name="l01739"></a><span class="lineno"> 1739</span>&#160;    , m_writeLen()</div><div class="line"><a name="l01740"></a><span class="lineno"> 1740</span>&#160;{</div><div class="line"><a name="l01741"></a><span class="lineno"> 1741</span>&#160;    <a class="code" href="classstored_1_1_polled_layer.html#a70378f51cf130ff4aed4dce90a1b403a">setLastError</a>(EBADF);</div><div class="line"><a name="l01742"></a><span class="lineno"> 1742</span>&#160;</div><div class="line"><a name="l01743"></a><span class="lineno"> 1743</span>&#160;    <span class="keywordflow">if</span>(!name_w || strcmp(name_r, name_w) == 0) {</div><div class="line"><a name="l01744"></a><span class="lineno"> 1744</span>&#160;        HANDLE h = INVALID_HANDLE_VALUE; <span class="comment">// NOLINT(cppcoreguidelines-pro-type-cstyle-cast)</span></div><div class="line"><a name="l01745"></a><span class="lineno"> 1745</span>&#160;        <span class="keywordflow">if</span>(!isValidHandle((h = CreateFile(name_r,</div><div class="line"><a name="l01746"></a><span class="lineno"> 1746</span>&#160;            GENERIC_READ | GENERIC_WRITE,                   <span class="comment">// NOLINT(hicpp-signed-bitwise)</span></div><div class="line"><a name="l01747"></a><span class="lineno"> 1747</span>&#160;            FILE_SHARE_READ | FILE_SHARE_WRITE,             <span class="comment">// NOLINT(hicpp-signed-bitwise)</span></div><div class="line"><a name="l01748"></a><span class="lineno"> 1748</span>&#160;            NULL, OPEN_ALWAYS,</div><div class="line"><a name="l01749"></a><span class="lineno"> 1749</span>&#160;            FILE_ATTRIBUTE_NORMAL | FILE_FLAG_OVERLAPPED,   <span class="comment">// NOLINT(hicpp-signed-bitwise)</span></div><div class="line"><a name="l01750"></a><span class="lineno"> 1750</span>&#160;            NULL))))</div><div class="line"><a name="l01751"></a><span class="lineno"> 1751</span>&#160;        {</div><div class="line"><a name="l01752"></a><span class="lineno"> 1752</span>&#160;            <a class="code" href="classstored_1_1_polled_layer.html#a70378f51cf130ff4aed4dce90a1b403a">setLastError</a>(EINVAL);</div><div class="line"><a name="l01753"></a><span class="lineno"> 1753</span>&#160;            <span class="keywordflow">return</span>;</div><div class="line"><a name="l01754"></a><span class="lineno"> 1754</span>&#160;        }</div><div class="line"><a name="l01755"></a><span class="lineno"> 1755</span>&#160;</div><div class="line"><a name="l01756"></a><span class="lineno"> 1756</span>&#160;        <a class="code" href="classstored_1_1_file_layer.html#a53480909edeb9ba1c033552dc27fe309">init</a>(h, h);</div><div class="line"><a name="l01757"></a><span class="lineno"> 1757</span>&#160;    } <span class="keywordflow">else</span> {</div><div class="line"><a name="l01758"></a><span class="lineno"> 1758</span>&#160;        HANDLE h_r = INVALID_HANDLE_VALUE; <span class="comment">// NOLINT(cppcoreguidelines-pro-type-cstyle-cast)</span></div><div class="line"><a name="l01759"></a><span class="lineno"> 1759</span>&#160;        <span class="keywordflow">if</span>(!isValidHandle((h_r = CreateFile(name_r,</div><div class="line"><a name="l01760"></a><span class="lineno"> 1760</span>&#160;            GENERIC_READ,</div><div class="line"><a name="l01761"></a><span class="lineno"> 1761</span>&#160;            FILE_SHARE_READ | FILE_SHARE_WRITE,             <span class="comment">// NOLINT(hicpp-signed-bitwise)</span></div><div class="line"><a name="l01762"></a><span class="lineno"> 1762</span>&#160;            NULL, OPEN_ALWAYS,</div><div class="line"><a name="l01763"></a><span class="lineno"> 1763</span>&#160;            FILE_ATTRIBUTE_NORMAL | FILE_FLAG_OVERLAPPED,   <span class="comment">// NOLINT(hicpp-signed-bitwise)</span></div><div class="line"><a name="l01764"></a><span class="lineno"> 1764</span>&#160;            NULL))))</div><div class="line"><a name="l01765"></a><span class="lineno"> 1765</span>&#160;        {</div><div class="line"><a name="l01766"></a><span class="lineno"> 1766</span>&#160;            <a class="code" href="classstored_1_1_polled_layer.html#a70378f51cf130ff4aed4dce90a1b403a">setLastError</a>(EINVAL);</div><div class="line"><a name="l01767"></a><span class="lineno"> 1767</span>&#160;            <span class="keywordflow">return</span>;</div><div class="line"><a name="l01768"></a><span class="lineno"> 1768</span>&#160;        }</div><div class="line"><a name="l01769"></a><span class="lineno"> 1769</span>&#160;</div><div class="line"><a name="l01770"></a><span class="lineno"> 1770</span>&#160;        HANDLE h_w = INVALID_HANDLE_VALUE; <span class="comment">// NOLINT(cppcoreguidelines-pro-type-cstyle-cast)</span></div><div class="line"><a name="l01771"></a><span class="lineno"> 1771</span>&#160;        <span class="keywordflow">if</span>(!isValidHandle((h_w = CreateFile(name_w,</div><div class="line"><a name="l01772"></a><span class="lineno"> 1772</span>&#160;            GENERIC_WRITE,</div><div class="line"><a name="l01773"></a><span class="lineno"> 1773</span>&#160;            FILE_SHARE_READ | FILE_SHARE_WRITE,             <span class="comment">// NOLINT(hicpp-signed-bitwise)</span></div><div class="line"><a name="l01774"></a><span class="lineno"> 1774</span>&#160;            NULL, OPEN_ALWAYS,</div><div class="line"><a name="l01775"></a><span class="lineno"> 1775</span>&#160;            FILE_ATTRIBUTE_NORMAL | FILE_FLAG_OVERLAPPED,   <span class="comment">// NOLINT(hicpp-signed-bitwise)</span></div><div class="line"><a name="l01776"></a><span class="lineno"> 1776</span>&#160;            NULL))))</div><div class="line"><a name="l01777"></a><span class="lineno"> 1777</span>&#160;        {</div><div class="line"><a name="l01778"></a><span class="lineno"> 1778</span>&#160;            <a class="code" href="classstored_1_1_polled_layer.html#a70378f51cf130ff4aed4dce90a1b403a">setLastError</a>(EINVAL);</div><div class="line"><a name="l01779"></a><span class="lineno"> 1779</span>&#160;            <span class="keywordflow">return</span>;</div><div class="line"><a name="l01780"></a><span class="lineno"> 1780</span>&#160;        }</div><div class="line"><a name="l01781"></a><span class="lineno"> 1781</span>&#160;</div><div class="line"><a name="l01782"></a><span class="lineno"> 1782</span>&#160;        <a class="code" href="classstored_1_1_file_layer.html#a53480909edeb9ba1c033552dc27fe309">init</a>(h_r, h_w);</div><div class="line"><a name="l01783"></a><span class="lineno"> 1783</span>&#160;    }</div><div class="line"><a name="l01784"></a><span class="lineno"> 1784</span>&#160;}</div><div class="line"><a name="l01785"></a><span class="lineno"> 1785</span>&#160;</div><div class="line"><a name="l01786"></a><span class="lineno"> 1786</span>&#160;<span class="comment">// Convenience ctor for use. Do not use in subclass.</span></div><div class="line"><a name="l01787"></a><span class="lineno"> 1787</span>&#160;<a class="code" href="classstored_1_1_file_layer.html#af0f0a290b2bb5209b825ad8dd29e7ff0">FileLayer::FileLayer</a>(HANDLE h_r, HANDLE h_w, <a class="code" href="classstored_1_1_protocol_layer.html">ProtocolLayer</a>* up, <a class="code" href="classstored_1_1_protocol_layer.html">ProtocolLayer</a>* down)</div><div class="line"><a name="l01788"></a><span class="lineno"> 1788</span>&#160;    : <a class="code" href="classstored_1_1_file_layer.html#a62a89dd5d15ce541bccdab3c2c8326d1">base</a>(up, down)</div><div class="line"><a name="l01789"></a><span class="lineno"> 1789</span>&#160;    , m_fd_r(INVALID_HANDLE_VALUE) <span class="comment">// NOLINT(cppcoreguidelines-pro-type-cstyle-cast)</span></div><div class="line"><a name="l01790"></a><span class="lineno"> 1790</span>&#160;    , m_fd_w(INVALID_HANDLE_VALUE) <span class="comment">// NOLINT(cppcoreguidelines-pro-type-cstyle-cast)</span></div><div class="line"><a name="l01791"></a><span class="lineno"> 1791</span>&#160;    , m_overlappedRead()</div><div class="line"><a name="l01792"></a><span class="lineno"> 1792</span>&#160;    , m_overlappedWrite()</div><div class="line"><a name="l01793"></a><span class="lineno"> 1793</span>&#160;    , m_this(<span class="keyword">this</span>)</div><div class="line"><a name="l01794"></a><span class="lineno"> 1794</span>&#160;    , m_writeLen()</div><div class="line"><a name="l01795"></a><span class="lineno"> 1795</span>&#160;{</div><div class="line"><a name="l01796"></a><span class="lineno"> 1796</span>&#160;    <a class="code" href="classstored_1_1_file_layer.html#a53480909edeb9ba1c033552dc27fe309">init</a>(h_r, !isValidHandle(h_w) ? h_r : h_w);</div><div class="line"><a name="l01797"></a><span class="lineno"> 1797</span>&#160;}</div><div class="line"><a name="l01798"></a><span class="lineno"> 1798</span>&#160;</div><div class="line"><a name="l01799"></a><span class="lineno"> 1799</span>&#160;<a class="code" href="classstored_1_1_file_layer.html#af0f0a290b2bb5209b825ad8dd29e7ff0">FileLayer::FileLayer</a>(<a class="code" href="classstored_1_1_protocol_layer.html">ProtocolLayer</a>* up, <a class="code" href="classstored_1_1_protocol_layer.html">ProtocolLayer</a>* down)</div><div class="line"><a name="l01800"></a><span class="lineno"> 1800</span>&#160;    : <a class="code" href="classstored_1_1_file_layer.html#a62a89dd5d15ce541bccdab3c2c8326d1">base</a>(up, down)</div><div class="line"><a name="l01801"></a><span class="lineno"> 1801</span>&#160;    , m_fd_r(INVALID_HANDLE_VALUE) <span class="comment">// NOLINT(cppcoreguidelines-pro-type-cstyle-cast)</span></div><div class="line"><a name="l01802"></a><span class="lineno"> 1802</span>&#160;    , m_fd_w(INVALID_HANDLE_VALUE) <span class="comment">// NOLINT(cppcoreguidelines-pro-type-cstyle-cast)</span></div><div class="line"><a name="l01803"></a><span class="lineno"> 1803</span>&#160;    , m_overlappedRead()</div><div class="line"><a name="l01804"></a><span class="lineno"> 1804</span>&#160;    , m_overlappedWrite()</div><div class="line"><a name="l01805"></a><span class="lineno"> 1805</span>&#160;    , m_this(<span class="keyword">this</span>)</div><div class="line"><a name="l01806"></a><span class="lineno"> 1806</span>&#160;    , m_writeLen()</div><div class="line"><a name="l01807"></a><span class="lineno"> 1807</span>&#160;{</div><div class="line"><a name="l01808"></a><span class="lineno"> 1808</span>&#160;    <a class="code" href="classstored_1_1_polled_layer.html#a70378f51cf130ff4aed4dce90a1b403a">setLastError</a>(EBADF);</div><div class="line"><a name="l01809"></a><span class="lineno"> 1809</span>&#160;}</div><div class="line"><a name="l01810"></a><span class="lineno"> 1810</span>&#160;</div><div class="line"><a name="l01811"></a><span class="lineno"> 1811</span>&#160;<span class="keywordtype">void</span> <a class="code" href="classstored_1_1_file_layer.html#a53480909edeb9ba1c033552dc27fe309">FileLayer::init</a>(<a class="code" href="classstored_1_1_file_layer.html#a4c9bc21201b7bd79875972d03fc1b7dc">FileLayer::fd_type</a> fd_r, <a class="code" href="classstored_1_1_file_layer.html#a4c9bc21201b7bd79875972d03fc1b7dc">FileLayer::fd_type</a> fd_w) {</div><div class="line"><a name="l01812"></a><span class="lineno"> 1812</span>&#160;    <a class="code" href="group__libstored__util.html#gab750e51b876450a0a4ad419588a82a4d">stored_assert</a>(!isValidHandle(m_fd_r));</div><div class="line"><a name="l01813"></a><span class="lineno"> 1813</span>&#160;    <a class="code" href="group__libstored__util.html#gab750e51b876450a0a4ad419588a82a4d">stored_assert</a>(!isValidHandle(m_fd_w));</div><div class="line"><a name="l01814"></a><span class="lineno"> 1814</span>&#160;</div><div class="line"><a name="l01815"></a><span class="lineno"> 1815</span>&#160;    <span class="keywordflow">if</span>(!isValidHandle(fd_r)) {</div><div class="line"><a name="l01816"></a><span class="lineno"> 1816</span>&#160;        <a class="code" href="classstored_1_1_polled_layer.html#a70378f51cf130ff4aed4dce90a1b403a">setLastError</a>(EBADF);</div><div class="line"><a name="l01817"></a><span class="lineno"> 1817</span>&#160;        <span class="keywordflow">goto</span> error;</div><div class="line"><a name="l01818"></a><span class="lineno"> 1818</span>&#160;    }</div><div class="line"><a name="l01819"></a><span class="lineno"> 1819</span>&#160;</div><div class="line"><a name="l01820"></a><span class="lineno"> 1820</span>&#160;    <span class="keywordflow">if</span>(!isValidHandle(fd_w)) {</div><div class="line"><a name="l01821"></a><span class="lineno"> 1821</span>&#160;        <a class="code" href="classstored_1_1_polled_layer.html#a70378f51cf130ff4aed4dce90a1b403a">setLastError</a>(EBADF);</div><div class="line"><a name="l01822"></a><span class="lineno"> 1822</span>&#160;        <span class="keywordflow">goto</span> error;</div><div class="line"><a name="l01823"></a><span class="lineno"> 1823</span>&#160;    }</div><div class="line"><a name="l01824"></a><span class="lineno"> 1824</span>&#160;</div><div class="line"><a name="l01825"></a><span class="lineno"> 1825</span>&#160;    m_fd_r = <a class="code" href="classstored_1_1_file_layer.html#ac1a3bb7c1dd0c85bde2072288f30024d">fd_r</a>;</div><div class="line"><a name="l01826"></a><span class="lineno"> 1826</span>&#160;    m_fd_w = <a class="code" href="classstored_1_1_file_layer.html#a4aebe2812c392f4b25d12aa16021a65f">fd_w</a>;</div><div class="line"><a name="l01827"></a><span class="lineno"> 1827</span>&#160;</div><div class="line"><a name="l01828"></a><span class="lineno"> 1828</span>&#160;    <a class="code" href="classstored_1_1_polled_layer.html#a70378f51cf130ff4aed4dce90a1b403a">setLastError</a>(0);</div><div class="line"><a name="l01829"></a><span class="lineno"> 1829</span>&#160;</div><div class="line"><a name="l01830"></a><span class="lineno"> 1830</span>&#160;    m_bufferRead.resize(<a class="code" href="classstored_1_1_file_layer.html#add1204842977b02378bba7b8ae4f122fa2927e7823f567f182fe3f7f28e9f9abf">BufferSize</a>);</div><div class="line"><a name="l01831"></a><span class="lineno"> 1831</span>&#160;</div><div class="line"><a name="l01832"></a><span class="lineno"> 1832</span>&#160;    m_overlappedRead.hEvent = CreateEvent(NULL, TRUE, FALSE, NULL);</div><div class="line"><a name="l01833"></a><span class="lineno"> 1833</span>&#160;    <span class="keywordflow">if</span>(!m_overlappedRead.hEvent) {</div><div class="line"><a name="l01834"></a><span class="lineno"> 1834</span>&#160;        <span class="comment">// NOLINTNEXTLINE(cppcoreguidelines-pro-type-cstyle-cast)</span></div><div class="line"><a name="l01835"></a><span class="lineno"> 1835</span>&#160;        m_overlappedRead.hEvent = INVALID_HANDLE_VALUE;</div><div class="line"><a name="l01836"></a><span class="lineno"> 1836</span>&#160;        <a class="code" href="classstored_1_1_polled_layer.html#a70378f51cf130ff4aed4dce90a1b403a">setLastError</a>(ENOMEM);</div><div class="line"><a name="l01837"></a><span class="lineno"> 1837</span>&#160;        <span class="keywordflow">goto</span> error;</div><div class="line"><a name="l01838"></a><span class="lineno"> 1838</span>&#160;    }</div><div class="line"><a name="l01839"></a><span class="lineno"> 1839</span>&#160;</div><div class="line"><a name="l01840"></a><span class="lineno"> 1840</span>&#160;    m_overlappedWrite.hEvent = CreateEvent(NULL, TRUE, FALSE, NULL);</div><div class="line"><a name="l01841"></a><span class="lineno"> 1841</span>&#160;    <span class="keywordflow">if</span>(!m_overlappedWrite.hEvent) {</div><div class="line"><a name="l01842"></a><span class="lineno"> 1842</span>&#160;        <span class="comment">// NOLINTNEXTLINE(cppcoreguidelines-pro-type-cstyle-cast)</span></div><div class="line"><a name="l01843"></a><span class="lineno"> 1843</span>&#160;        m_overlappedWrite.hEvent = INVALID_HANDLE_VALUE;</div><div class="line"><a name="l01844"></a><span class="lineno"> 1844</span>&#160;        <a class="code" href="classstored_1_1_polled_layer.html#a70378f51cf130ff4aed4dce90a1b403a">setLastError</a>(ENOMEM);</div><div class="line"><a name="l01845"></a><span class="lineno"> 1845</span>&#160;        <span class="keywordflow">goto</span> error;</div><div class="line"><a name="l01846"></a><span class="lineno"> 1846</span>&#160;    }</div><div class="line"><a name="l01847"></a><span class="lineno"> 1847</span>&#160;</div><div class="line"><a name="l01848"></a><span class="lineno"> 1848</span>&#160;    <span class="comment">// If init() is called by a ctor, which was invoked by a subclass,</span></div><div class="line"><a name="l01849"></a><span class="lineno"> 1849</span>&#160;    <span class="comment">// FileLayer::startRead() is called, not the one of the subclass.</span></div><div class="line"><a name="l01850"></a><span class="lineno"> 1850</span>&#160;    <span class="comment">// Therefore, a subclass should use the FileRead(up,down) ctor, and</span></div><div class="line"><a name="l01851"></a><span class="lineno"> 1851</span>&#160;    <span class="comment">// call init() afterwards.</span></div><div class="line"><a name="l01852"></a><span class="lineno"> 1852</span>&#160;    <span class="comment">//</span></div><div class="line"><a name="l01853"></a><span class="lineno"> 1853</span>&#160;    <span class="comment">// NOLINTNEXTLINE(clang-analyzer-optin.cplusplus.VirtualCall)</span></div><div class="line"><a name="l01854"></a><span class="lineno"> 1854</span>&#160;    startRead();</div><div class="line"><a name="l01855"></a><span class="lineno"> 1855</span>&#160;    <span class="keywordflow">return</span>;</div><div class="line"><a name="l01856"></a><span class="lineno"> 1856</span>&#160;</div><div class="line"><a name="l01857"></a><span class="lineno"> 1857</span>&#160;error:</div><div class="line"><a name="l01858"></a><span class="lineno"> 1858</span>&#160;    <a class="code" href="classstored_1_1_file_layer.html#aa319f69ae9b0d305b60e139ed4a941fa">close_</a>();</div><div class="line"><a name="l01859"></a><span class="lineno"> 1859</span>&#160;</div><div class="line"><a name="l01860"></a><span class="lineno"> 1860</span>&#160;    <span class="keywordflow">if</span>(!<a class="code" href="classstored_1_1_polled_layer.html#a5f93b36636abab8f4cacb5f1b4fbcd82">lastError</a>())</div><div class="line"><a name="l01861"></a><span class="lineno"> 1861</span>&#160;        <a class="code" href="classstored_1_1_polled_layer.html#a70378f51cf130ff4aed4dce90a1b403a">setLastError</a>(EIO);</div><div class="line"><a name="l01862"></a><span class="lineno"> 1862</span>&#160;}</div><div class="line"><a name="l01863"></a><span class="lineno"> 1863</span>&#160;</div><div class="line"><a name="l01864"></a><span class="lineno"> 1864</span>&#160;<a class="code" href="classstored_1_1_file_layer.html#addb5cf9fb3707fa3da6dbf092faa0d82">FileLayer::~FileLayer</a>() {</div><div class="line"><a name="l01865"></a><span class="lineno"> 1865</span>&#160;    <a class="code" href="classstored_1_1_file_layer.html#aa319f69ae9b0d305b60e139ed4a941fa">close_</a>();</div><div class="line"><a name="l01866"></a><span class="lineno"> 1866</span>&#160;}</div><div class="line"><a name="l01867"></a><span class="lineno"> 1867</span>&#160;</div><div class="line"><a name="l01868"></a><span class="lineno"> 1868</span>&#160;<span class="keywordtype">void</span> <a class="code" href="classstored_1_1_file_layer.html#ab9e526fff86fae14f35909ac23983131">FileLayer::close</a>() {</div><div class="line"><a name="l01869"></a><span class="lineno"> 1869</span>&#160;    <a class="code" href="classstored_1_1_file_layer.html#aa319f69ae9b0d305b60e139ed4a941fa">close_</a>();</div><div class="line"><a name="l01870"></a><span class="lineno"> 1870</span>&#160;}</div><div class="line"><a name="l01871"></a><span class="lineno"> 1871</span>&#160;</div><div class="line"><a name="l01872"></a><span class="lineno"> 1872</span>&#160;<span class="keywordtype">void</span> <a class="code" href="classstored_1_1_file_layer.html#aa319f69ae9b0d305b60e139ed4a941fa">FileLayer::close_</a>() {</div><div class="line"><a name="l01873"></a><span class="lineno"> 1873</span>&#160;    <span class="keywordflow">if</span>(m_fd_r != m_fd_w &amp;&amp; isValidHandle(m_fd_w)) {</div><div class="line"><a name="l01874"></a><span class="lineno"> 1874</span>&#160;        FlushFileBuffers(m_fd_w);</div><div class="line"><a name="l01875"></a><span class="lineno"> 1875</span>&#160;        CancelIo(m_fd_w);</div><div class="line"><a name="l01876"></a><span class="lineno"> 1876</span>&#160;        CloseHandle(m_fd_w);</div><div class="line"><a name="l01877"></a><span class="lineno"> 1877</span>&#160;    }</div><div class="line"><a name="l01878"></a><span class="lineno"> 1878</span>&#160;    <span class="comment">// NOLINTNEXTLINE(cppcoreguidelines-pro-type-cstyle-cast)</span></div><div class="line"><a name="l01879"></a><span class="lineno"> 1879</span>&#160;    m_fd_w = INVALID_HANDLE_VALUE;</div><div class="line"><a name="l01880"></a><span class="lineno"> 1880</span>&#160;</div><div class="line"><a name="l01881"></a><span class="lineno"> 1881</span>&#160;    <span class="keywordflow">if</span>(isValidHandle(m_fd_r)) {</div><div class="line"><a name="l01882"></a><span class="lineno"> 1882</span>&#160;        FlushFileBuffers(m_fd_r);</div><div class="line"><a name="l01883"></a><span class="lineno"> 1883</span>&#160;        CancelIo(m_fd_r);</div><div class="line"><a name="l01884"></a><span class="lineno"> 1884</span>&#160;        CloseHandle(m_fd_r);</div><div class="line"><a name="l01885"></a><span class="lineno"> 1885</span>&#160;        <span class="comment">// NOLINTNEXTLINE(cppcoreguidelines-pro-type-cstyle-cast)</span></div><div class="line"><a name="l01886"></a><span class="lineno"> 1886</span>&#160;        m_fd_r = INVALID_HANDLE_VALUE;</div><div class="line"><a name="l01887"></a><span class="lineno"> 1887</span>&#160;    }</div><div class="line"><a name="l01888"></a><span class="lineno"> 1888</span>&#160;</div><div class="line"><a name="l01889"></a><span class="lineno"> 1889</span>&#160;    <span class="keywordflow">if</span>(m_overlappedRead.hEvent) {</div><div class="line"><a name="l01890"></a><span class="lineno"> 1890</span>&#160;        CloseHandle(m_overlappedRead.hEvent);</div><div class="line"><a name="l01891"></a><span class="lineno"> 1891</span>&#160;        m_overlappedRead.hEvent = NULL;</div><div class="line"><a name="l01892"></a><span class="lineno"> 1892</span>&#160;    }</div><div class="line"><a name="l01893"></a><span class="lineno"> 1893</span>&#160;</div><div class="line"><a name="l01894"></a><span class="lineno"> 1894</span>&#160;    <span class="keywordflow">if</span>(m_overlappedWrite.hEvent) {</div><div class="line"><a name="l01895"></a><span class="lineno"> 1895</span>&#160;        CloseHandle(m_overlappedWrite.hEvent);</div><div class="line"><a name="l01896"></a><span class="lineno"> 1896</span>&#160;        m_overlappedWrite.hEvent = NULL;</div><div class="line"><a name="l01897"></a><span class="lineno"> 1897</span>&#160;    }</div><div class="line"><a name="l01898"></a><span class="lineno"> 1898</span>&#160;</div><div class="line"><a name="l01899"></a><span class="lineno"> 1899</span>&#160;    <a class="code" href="classstored_1_1_polled_layer.html#af5b7fffdba945fa6063da0e4accd0ace">base::close</a>();</div><div class="line"><a name="l01900"></a><span class="lineno"> 1900</span>&#160;}</div><div class="line"><a name="l01901"></a><span class="lineno"> 1901</span>&#160;</div><div class="line"><a name="l01902"></a><span class="lineno"> 1902</span>&#160;<span class="keywordtype">bool</span> <a class="code" href="classstored_1_1_file_layer.html#a653122ce5a77c5d5999008337bce58b7">FileLayer::isOpen</a>()<span class="keyword"> const </span>{</div><div class="line"><a name="l01903"></a><span class="lineno"> 1903</span>&#160;    <span class="keywordflow">return</span> isValidHandle(m_fd_r);</div><div class="line"><a name="l01904"></a><span class="lineno"> 1904</span>&#160;}</div><div class="line"><a name="l01905"></a><span class="lineno"> 1905</span>&#160;</div><div class="line"><a name="l01906"></a><span class="lineno"> 1906</span>&#160;<span class="keywordtype">int</span> FileLayer::finishWrite(<span class="keywordtype">bool</span> <a class="code" href="classstored_1_1_polled_layer.html#a79de5a08490722c111347ed8274d0f3a">block</a>) {</div><div class="line"><a name="l01907"></a><span class="lineno"> 1907</span>&#160;    <span class="keywordtype">size_t</span> offset = 0;</div><div class="line"><a name="l01908"></a><span class="lineno"> 1908</span>&#160;</div><div class="line"><a name="l01909"></a><span class="lineno"> 1909</span>&#160;wait_prev_write:</div><div class="line"><a name="l01910"></a><span class="lineno"> 1910</span>&#160;    <span class="keywordflow">if</span>(!HasOverlappedIoCompleted(&amp;m_overlappedWrite)) {</div><div class="line"><a name="l01911"></a><span class="lineno"> 1911</span>&#160;        <span class="keywordflow">if</span>(block)</div><div class="line"><a name="l01912"></a><span class="lineno"> 1912</span>&#160;            <span class="keywordflow">if</span>(this-&gt;<a class="code" href="classstored_1_1_polled_layer.html#a79de5a08490722c111347ed8274d0f3a">block</a>(<a class="code" href="classstored_1_1_file_layer.html#a4aebe2812c392f4b25d12aa16021a65f">fd_w</a>(), <span class="keyword">false</span>))</div><div class="line"><a name="l01913"></a><span class="lineno"> 1913</span>&#160;                <span class="keywordflow">return</span> <a class="code" href="classstored_1_1_polled_layer.html#a5f93b36636abab8f4cacb5f1b4fbcd82">lastError</a>();</div><div class="line"><a name="l01914"></a><span class="lineno"> 1914</span>&#160;</div><div class="line"><a name="l01915"></a><span class="lineno"> 1915</span>&#160;        DWORD written = 0;</div><div class="line"><a name="l01916"></a><span class="lineno"> 1916</span>&#160;        <span class="keywordflow">if</span>(!GetOverlappedResult(<a class="code" href="classstored_1_1_file_layer.html#a4aebe2812c392f4b25d12aa16021a65f">fd_w</a>(), &amp;m_overlappedWrite, &amp;written, FALSE)) {</div><div class="line"><a name="l01917"></a><span class="lineno"> 1917</span>&#160;            <span class="keywordflow">switch</span>(GetLastError()) {</div><div class="line"><a name="l01918"></a><span class="lineno"> 1918</span>&#160;            <span class="keywordflow">case</span> ERROR_IO_INCOMPLETE:</div><div class="line"><a name="l01919"></a><span class="lineno"> 1919</span>&#160;            <span class="keywordflow">case</span> ERROR_IO_PENDING:</div><div class="line"><a name="l01920"></a><span class="lineno"> 1920</span>&#160;                <a class="code" href="group__libstored__util.html#gab750e51b876450a0a4ad419588a82a4d">stored_assert</a>(!block);</div><div class="line"><a name="l01921"></a><span class="lineno"> 1921</span>&#160;                <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l01922"></a><span class="lineno"> 1922</span>&#160;            <span class="keywordflow">default</span>:</div><div class="line"><a name="l01923"></a><span class="lineno"> 1923</span>&#160;                <span class="keywordflow">goto</span> error;</div><div class="line"><a name="l01924"></a><span class="lineno"> 1924</span>&#160;            }</div><div class="line"><a name="l01925"></a><span class="lineno"> 1925</span>&#160;        }</div><div class="line"><a name="l01926"></a><span class="lineno"> 1926</span>&#160;</div><div class="line"><a name="l01927"></a><span class="lineno"> 1927</span>&#160;        <span class="keywordflow">while</span>(written &lt; m_writeLen) {</div><div class="line"><a name="l01928"></a><span class="lineno"> 1928</span>&#160;            <span class="comment">// Restart for the remaining data.</span></div><div class="line"><a name="l01929"></a><span class="lineno"> 1929</span>&#160;            offset += written;</div><div class="line"><a name="l01930"></a><span class="lineno"> 1930</span>&#160;            resetOverlappedWrite();</div><div class="line"><a name="l01931"></a><span class="lineno"> 1931</span>&#160;            m_writeLen -= written;</div><div class="line"><a name="l01932"></a><span class="lineno"> 1932</span>&#160;            <span class="keywordflow">if</span>(block) {</div><div class="line"><a name="l01933"></a><span class="lineno"> 1933</span>&#160;                <span class="keywordflow">if</span>(WriteFile(<a class="code" href="classstored_1_1_file_layer.html#a4aebe2812c392f4b25d12aa16021a65f">fd_w</a>(), &amp;m_bufferWrite[offset],</div><div class="line"><a name="l01934"></a><span class="lineno"> 1934</span>&#160;                    (DWORD)m_writeLen, &amp;written, &amp;m_overlappedWrite))</div><div class="line"><a name="l01935"></a><span class="lineno"> 1935</span>&#160;                {</div><div class="line"><a name="l01936"></a><span class="lineno"> 1936</span>&#160;                    <span class="comment">// Completed immediately.</span></div><div class="line"><a name="l01937"></a><span class="lineno"> 1937</span>&#160;                } <span class="keywordflow">else</span> {</div><div class="line"><a name="l01938"></a><span class="lineno"> 1938</span>&#160;                    <span class="keywordflow">switch</span>(GetLastError()) {</div><div class="line"><a name="l01939"></a><span class="lineno"> 1939</span>&#160;                    <span class="keywordflow">case</span> ERROR_IO_INCOMPLETE:</div><div class="line"><a name="l01940"></a><span class="lineno"> 1940</span>&#160;                    <span class="keywordflow">case</span> ERROR_IO_PENDING:</div><div class="line"><a name="l01941"></a><span class="lineno"> 1941</span>&#160;                        <span class="keywordflow">goto</span> wait_prev_write;</div><div class="line"><a name="l01942"></a><span class="lineno"> 1942</span>&#160;                    <span class="keywordflow">default</span>:</div><div class="line"><a name="l01943"></a><span class="lineno"> 1943</span>&#160;                        <span class="keywordflow">goto</span> error;</div><div class="line"><a name="l01944"></a><span class="lineno"> 1944</span>&#160;                    }</div><div class="line"><a name="l01945"></a><span class="lineno"> 1945</span>&#160;                }</div><div class="line"><a name="l01946"></a><span class="lineno"> 1946</span>&#160;            } <span class="keywordflow">else</span> {</div><div class="line"><a name="l01947"></a><span class="lineno"> 1947</span>&#160;                <span class="keywordflow">if</span>(WriteFileEx(<a class="code" href="classstored_1_1_file_layer.html#a4aebe2812c392f4b25d12aa16021a65f">fd_w</a>(), &amp;m_bufferWrite[offset],</div><div class="line"><a name="l01948"></a><span class="lineno"> 1948</span>&#160;                    (DWORD)m_writeLen, &amp;m_overlappedWrite,</div><div class="line"><a name="l01949"></a><span class="lineno"> 1949</span>&#160;                    <span class="comment">// NOLINTNEXTLINE(cppcoreguidelines-pro-type-cstyle-cast)</span></div><div class="line"><a name="l01950"></a><span class="lineno"> 1950</span>&#160;                    (LPOVERLAPPED_COMPLETION_ROUTINE)(<span class="keywordtype">void</span>*)&amp;writeCompletionRoutine))</div><div class="line"><a name="l01951"></a><span class="lineno"> 1951</span>&#160;                    <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l01952"></a><span class="lineno"> 1952</span>&#160;                <span class="keywordflow">else</span></div><div class="line"><a name="l01953"></a><span class="lineno"> 1953</span>&#160;                    <span class="keywordflow">goto</span> error;</div><div class="line"><a name="l01954"></a><span class="lineno"> 1954</span>&#160;            }</div><div class="line"><a name="l01955"></a><span class="lineno"> 1955</span>&#160;        }</div><div class="line"><a name="l01956"></a><span class="lineno"> 1956</span>&#160;    }</div><div class="line"><a name="l01957"></a><span class="lineno"> 1957</span>&#160;</div><div class="line"><a name="l01958"></a><span class="lineno"> 1958</span>&#160;    SetEvent(m_overlappedWrite.hEvent);</div><div class="line"><a name="l01959"></a><span class="lineno"> 1959</span>&#160;    <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l01960"></a><span class="lineno"> 1960</span>&#160;</div><div class="line"><a name="l01961"></a><span class="lineno"> 1961</span>&#160;error:</div><div class="line"><a name="l01962"></a><span class="lineno"> 1962</span>&#160;    <a class="code" href="classstored_1_1_file_layer.html#ab9e526fff86fae14f35909ac23983131">close</a>();</div><div class="line"><a name="l01963"></a><span class="lineno"> 1963</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="classstored_1_1_polled_layer.html#a70378f51cf130ff4aed4dce90a1b403a">setLastError</a>(EIO);</div><div class="line"><a name="l01964"></a><span class="lineno"> 1964</span>&#160;}</div><div class="line"><a name="l01965"></a><span class="lineno"> 1965</span>&#160;</div><div class="line"><a name="l01966"></a><span class="lineno"> 1966</span>&#160;<span class="keywordtype">void</span> FileLayer::writeCompletionRoutine(DWORD dwErrorCode, DWORD <a class="code" href="macros_8h.html#af17ee1aea7e7e70c19dc325e02552ed0">UNUSED_PAR</a>(dwNumberOfBytesTransfered), LPOVERLAPPED lpOverlapped) {</div><div class="line"><a name="l01967"></a><span class="lineno"> 1967</span>&#160;    <span class="comment">// NOLINTNEXTLINE(cppcoreguidelines-pro-type-cstyle-cast)</span></div><div class="line"><a name="l01968"></a><span class="lineno"> 1968</span>&#160;    <a class="code" href="classstored_1_1_file_layer.html">FileLayer</a>* that = (<a class="code" href="classstored_1_1_file_layer.html">FileLayer</a>*)((uintptr_t)lpOverlapped + <span class="keyword">sizeof</span>(*lpOverlapped));</div><div class="line"><a name="l01969"></a><span class="lineno"> 1969</span>&#160;    <a class="code" href="group__libstored__util.html#gab750e51b876450a0a4ad419588a82a4d">stored_assert</a>(that);</div><div class="line"><a name="l01970"></a><span class="lineno"> 1970</span>&#160;</div><div class="line"><a name="l01971"></a><span class="lineno"> 1971</span>&#160;    <span class="keywordflow">if</span>(dwErrorCode == 0) {</div><div class="line"><a name="l01972"></a><span class="lineno"> 1972</span>&#160;        that-&gt;<a class="code" href="classstored_1_1_file_layer.html#ab9e526fff86fae14f35909ac23983131">close</a>();</div><div class="line"><a name="l01973"></a><span class="lineno"> 1973</span>&#160;        that-&gt;<a class="code" href="classstored_1_1_polled_layer.html#a70378f51cf130ff4aed4dce90a1b403a">setLastError</a>(EIO);</div><div class="line"><a name="l01974"></a><span class="lineno"> 1974</span>&#160;    } <span class="keywordflow">else</span> {</div><div class="line"><a name="l01975"></a><span class="lineno"> 1975</span>&#160;        <span class="comment">// Make sure all data has been transferred.</span></div><div class="line"><a name="l01976"></a><span class="lineno"> 1976</span>&#160;        that-&gt;finishWrite(<span class="keyword">false</span>);</div><div class="line"><a name="l01977"></a><span class="lineno"> 1977</span>&#160;    }</div><div class="line"><a name="l01978"></a><span class="lineno"> 1978</span>&#160;}</div><div class="line"><a name="l01979"></a><span class="lineno"> 1979</span>&#160;</div><div class="line"><a name="l01980"></a><span class="lineno"> 1980</span>&#160;<span class="keywordtype">void</span> <a class="code" href="classstored_1_1_protocol_layer.html#a66c24cec6a17c44fac68213d358a5aa8">FileLayer::encode</a>(<span class="keywordtype">void</span> <span class="keyword">const</span>* buffer, <span class="keywordtype">size_t</span> len, <span class="keywordtype">bool</span> last) {</div><div class="line"><a name="l01981"></a><span class="lineno"> 1981</span>&#160;    <span class="keywordflow">if</span>(!isValidHandle(<a class="code" href="classstored_1_1_file_layer.html#a4aebe2812c392f4b25d12aa16021a65f">fd_w</a>())) {</div><div class="line"><a name="l01982"></a><span class="lineno"> 1982</span>&#160;done:</div><div class="line"><a name="l01983"></a><span class="lineno"> 1983</span>&#160;        <span class="comment">// Done. It might be the case that the write already finished, but</span></div><div class="line"><a name="l01984"></a><span class="lineno"> 1984</span>&#160;        <span class="comment">// not all data has been written. Let the next invocation of encode() handle that.</span></div><div class="line"><a name="l01985"></a><span class="lineno"> 1985</span>&#160;        <a class="code" href="classstored_1_1_protocol_layer.html#a66c24cec6a17c44fac68213d358a5aa8">base::encode</a>(buffer, len, last);</div><div class="line"><a name="l01986"></a><span class="lineno"> 1986</span>&#160;        <span class="keywordflow">return</span>;</div><div class="line"><a name="l01987"></a><span class="lineno"> 1987</span>&#160;    }</div><div class="line"><a name="l01988"></a><span class="lineno"> 1988</span>&#160;</div><div class="line"><a name="l01989"></a><span class="lineno"> 1989</span>&#160;    finishWrite(<span class="keyword">true</span>);</div><div class="line"><a name="l01990"></a><span class="lineno"> 1990</span>&#160;</div><div class="line"><a name="l01991"></a><span class="lineno"> 1991</span>&#160;    <span class="comment">// Issue a new write.</span></div><div class="line"><a name="l01992"></a><span class="lineno"> 1992</span>&#160;    <a class="code" href="group__libstored__util.html#gab750e51b876450a0a4ad419588a82a4d">stored_assert</a>(len &lt; (<span class="keywordtype">size_t</span>)std::numeric_limits&lt;DWORD&gt;::max());</div><div class="line"><a name="l01993"></a><span class="lineno"> 1993</span>&#160;    m_bufferWrite.resize(len);</div><div class="line"><a name="l01994"></a><span class="lineno"> 1994</span>&#160;    memcpy(&amp;m_bufferWrite[0], buffer, len);</div><div class="line"><a name="l01995"></a><span class="lineno"> 1995</span>&#160;    <a class="code" href="classstored_1_1_polled_layer.html#a70378f51cf130ff4aed4dce90a1b403a">setLastError</a>(0);</div><div class="line"><a name="l01996"></a><span class="lineno"> 1996</span>&#160;    resetOverlappedWrite();</div><div class="line"><a name="l01997"></a><span class="lineno"> 1997</span>&#160;    <span class="keywordflow">if</span>(WriteFileEx(<a class="code" href="classstored_1_1_file_layer.html#a4aebe2812c392f4b25d12aa16021a65f">fd_w</a>(), &amp;m_bufferWrite[0], (DWORD)len, &amp;m_overlappedWrite,</div><div class="line"><a name="l01998"></a><span class="lineno"> 1998</span>&#160;        <span class="comment">// NOLINTNEXTLINE(cppcoreguidelines-pro-type-cstyle-cast)</span></div><div class="line"><a name="l01999"></a><span class="lineno"> 1999</span>&#160;        (LPOVERLAPPED_COMPLETION_ROUTINE)(<span class="keywordtype">void</span>*)&amp;writeCompletionRoutine))</div><div class="line"><a name="l02000"></a><span class="lineno"> 2000</span>&#160;    {</div><div class="line"><a name="l02001"></a><span class="lineno"> 2001</span>&#160;        <span class="comment">// Already finished.</span></div><div class="line"><a name="l02002"></a><span class="lineno"> 2002</span>&#160;    } <span class="keywordflow">else</span> {</div><div class="line"><a name="l02003"></a><span class="lineno"> 2003</span>&#160;        <span class="keywordflow">switch</span>(GetLastError()) {</div><div class="line"><a name="l02004"></a><span class="lineno"> 2004</span>&#160;        <span class="keywordflow">case</span> ERROR_IO_INCOMPLETE:</div><div class="line"><a name="l02005"></a><span class="lineno"> 2005</span>&#160;        <span class="keywordflow">case</span> ERROR_IO_PENDING:</div><div class="line"><a name="l02006"></a><span class="lineno"> 2006</span>&#160;            <span class="keywordflow">break</span>;</div><div class="line"><a name="l02007"></a><span class="lineno"> 2007</span>&#160;        <span class="keywordflow">default</span>:</div><div class="line"><a name="l02008"></a><span class="lineno"> 2008</span>&#160;            <span class="keywordflow">goto</span> error;</div><div class="line"><a name="l02009"></a><span class="lineno"> 2009</span>&#160;        }</div><div class="line"><a name="l02010"></a><span class="lineno"> 2010</span>&#160;    }</div><div class="line"><a name="l02011"></a><span class="lineno"> 2011</span>&#160;</div><div class="line"><a name="l02012"></a><span class="lineno"> 2012</span>&#160;    <span class="keywordflow">goto</span> done;</div><div class="line"><a name="l02013"></a><span class="lineno"> 2013</span>&#160;</div><div class="line"><a name="l02014"></a><span class="lineno"> 2014</span>&#160;error:</div><div class="line"><a name="l02015"></a><span class="lineno"> 2015</span>&#160;    <a class="code" href="classstored_1_1_file_layer.html#ab9e526fff86fae14f35909ac23983131">close</a>();</div><div class="line"><a name="l02016"></a><span class="lineno"> 2016</span>&#160;    <a class="code" href="classstored_1_1_polled_layer.html#a70378f51cf130ff4aed4dce90a1b403a">setLastError</a>(EIO);</div><div class="line"><a name="l02017"></a><span class="lineno"> 2017</span>&#160;    <span class="keywordflow">goto</span> done;</div><div class="line"><a name="l02018"></a><span class="lineno"> 2018</span>&#160;}</div><div class="line"><a name="l02019"></a><span class="lineno"> 2019</span>&#160;</div><div class="line"><a name="l02020"></a><span class="lineno"> 2020</span>&#160;<a class="code" href="classstored_1_1_file_layer.html#a4c9bc21201b7bd79875972d03fc1b7dc">FileLayer::fd_type</a> <a class="code" href="classstored_1_1_file_layer.html#a58badaa958c01f0f22eaf298788148e8">FileLayer::fd</a>()<span class="keyword"> const </span>{</div><div class="line"><a name="l02021"></a><span class="lineno"> 2021</span>&#160;    <span class="keywordflow">return</span> m_overlappedRead.hEvent;</div><div class="line"><a name="l02022"></a><span class="lineno"> 2022</span>&#160;}</div><div class="line"><a name="l02023"></a><span class="lineno"> 2023</span>&#160;</div><div class="line"><a name="l02024"></a><span class="lineno"> 2024</span>&#160;<a class="code" href="classstored_1_1_file_layer.html#a4c9bc21201b7bd79875972d03fc1b7dc">FileLayer::fd_type</a> <a class="code" href="classstored_1_1_file_layer.html#ac1a3bb7c1dd0c85bde2072288f30024d">FileLayer::fd_r</a>()<span class="keyword"> const </span>{</div><div class="line"><a name="l02025"></a><span class="lineno"> 2025</span>&#160;    <span class="keywordflow">return</span> m_fd_r;</div><div class="line"><a name="l02026"></a><span class="lineno"> 2026</span>&#160;}</div><div class="line"><a name="l02027"></a><span class="lineno"> 2027</span>&#160;</div><div class="line"><a name="l02028"></a><span class="lineno"> 2028</span>&#160;<a class="code" href="classstored_1_1_file_layer.html#a4c9bc21201b7bd79875972d03fc1b7dc">FileLayer::fd_type</a> <a class="code" href="classstored_1_1_file_layer.html#a4aebe2812c392f4b25d12aa16021a65f">FileLayer::fd_w</a>()<span class="keyword"> const </span>{</div><div class="line"><a name="l02029"></a><span class="lineno"> 2029</span>&#160;    <span class="keywordflow">return</span> m_fd_w;</div><div class="line"><a name="l02030"></a><span class="lineno"> 2030</span>&#160;}</div><div class="line"><a name="l02031"></a><span class="lineno"> 2031</span>&#160;</div><div class="line"><a name="l02032"></a><span class="lineno"> 2032</span>&#160;<span class="keywordtype">int</span> FileLayer::startRead() {</div><div class="line"><a name="l02033"></a><span class="lineno"> 2033</span>&#160;    <span class="keywordtype">bool</span> didDecode = <span class="keyword">false</span>;</div><div class="line"><a name="l02034"></a><span class="lineno"> 2034</span>&#160;</div><div class="line"><a name="l02035"></a><span class="lineno"> 2035</span>&#160;again:</div><div class="line"><a name="l02036"></a><span class="lineno"> 2036</span>&#160;    <span class="keywordflow">if</span>(!isValidHandle(m_fd_r))</div><div class="line"><a name="l02037"></a><span class="lineno"> 2037</span>&#160;        <span class="keywordflow">return</span> <a class="code" href="classstored_1_1_polled_layer.html#a70378f51cf130ff4aed4dce90a1b403a">setLastError</a>(EBADF);</div><div class="line"><a name="l02038"></a><span class="lineno"> 2038</span>&#160;</div><div class="line"><a name="l02039"></a><span class="lineno"> 2039</span>&#160;    <span class="keywordtype">size_t</span> readable = available();</div><div class="line"><a name="l02040"></a><span class="lineno"> 2040</span>&#160;    <span class="keywordflow">if</span>(readable == 0) {</div><div class="line"><a name="l02041"></a><span class="lineno"> 2041</span>&#160;        <a class="code" href="classstored_1_1_file_layer.html#ab9e526fff86fae14f35909ac23983131">close</a>();</div><div class="line"><a name="l02042"></a><span class="lineno"> 2042</span>&#160;        <span class="keywordflow">return</span> <a class="code" href="classstored_1_1_polled_layer.html#a70378f51cf130ff4aed4dce90a1b403a">setLastError</a>(EIO);</div><div class="line"><a name="l02043"></a><span class="lineno"> 2043</span>&#160;    }</div><div class="line"><a name="l02044"></a><span class="lineno"> 2044</span>&#160;</div><div class="line"><a name="l02045"></a><span class="lineno"> 2045</span>&#160;    <span class="keywordflow">if</span>(readable &gt; m_bufferRead.size())</div><div class="line"><a name="l02046"></a><span class="lineno"> 2046</span>&#160;        readable = m_bufferRead.size();</div><div class="line"><a name="l02047"></a><span class="lineno"> 2047</span>&#160;</div><div class="line"><a name="l02048"></a><span class="lineno"> 2048</span>&#160;    <span class="keywordflow">if</span>(readable &gt; std::numeric_limits&lt;DWORD&gt;::max())</div><div class="line"><a name="l02049"></a><span class="lineno"> 2049</span>&#160;        readable = std::numeric_limits&lt;DWORD&gt;::max();</div><div class="line"><a name="l02050"></a><span class="lineno"> 2050</span>&#160;</div><div class="line"><a name="l02051"></a><span class="lineno"> 2051</span>&#160;    DWORD bytesRead = 0;</div><div class="line"><a name="l02052"></a><span class="lineno"> 2052</span>&#160;</div><div class="line"><a name="l02053"></a><span class="lineno"> 2053</span>&#160;    <span class="comment">// Read everything there is to read.</span></div><div class="line"><a name="l02054"></a><span class="lineno"> 2054</span>&#160;    <span class="comment">// This should be finished quickly.</span></div><div class="line"><a name="l02055"></a><span class="lineno"> 2055</span>&#160;    resetOverlappedRead();</div><div class="line"><a name="l02056"></a><span class="lineno"> 2056</span>&#160;    <span class="keywordflow">if</span>(ReadFile(m_fd_r, &amp;m_bufferRead[0],</div><div class="line"><a name="l02057"></a><span class="lineno"> 2057</span>&#160;        (DWORD)readable,</div><div class="line"><a name="l02058"></a><span class="lineno"> 2058</span>&#160;        &amp;bytesRead, &amp;m_overlappedRead))</div><div class="line"><a name="l02059"></a><span class="lineno"> 2059</span>&#160;    {</div><div class="line"><a name="l02060"></a><span class="lineno"> 2060</span>&#160;        <span class="comment">// Finished immediately.</span></div><div class="line"><a name="l02061"></a><span class="lineno"> 2061</span>&#160;        <a class="code" href="classstored_1_1_protocol_layer.html#a357b029311be09df61e019682a848ab5">decode</a>(&amp;m_bufferRead[0], (<span class="keywordtype">size_t</span>)bytesRead);</div><div class="line"><a name="l02062"></a><span class="lineno"> 2062</span>&#160;        didDecode = <span class="keyword">true</span>;</div><div class="line"><a name="l02063"></a><span class="lineno"> 2063</span>&#160;        <span class="keywordflow">goto</span> again;</div><div class="line"><a name="l02064"></a><span class="lineno"> 2064</span>&#160;    } <span class="keywordflow">else</span> {</div><div class="line"><a name="l02065"></a><span class="lineno"> 2065</span>&#160;        <span class="keywordflow">switch</span>(GetLastError()) {</div><div class="line"><a name="l02066"></a><span class="lineno"> 2066</span>&#160;        <span class="keywordflow">case</span> ERROR_IO_INCOMPLETE:</div><div class="line"><a name="l02067"></a><span class="lineno"> 2067</span>&#160;        <span class="keywordflow">case</span> ERROR_IO_PENDING:</div><div class="line"><a name="l02068"></a><span class="lineno"> 2068</span>&#160;            <span class="comment">// The read is pending.</span></div><div class="line"><a name="l02069"></a><span class="lineno"> 2069</span>&#160;            <span class="keywordflow">return</span> <a class="code" href="classstored_1_1_polled_layer.html#a70378f51cf130ff4aed4dce90a1b403a">setLastError</a>(didDecode ? 0 : EAGAIN);</div><div class="line"><a name="l02070"></a><span class="lineno"> 2070</span>&#160;        <span class="keywordflow">default</span>:</div><div class="line"><a name="l02071"></a><span class="lineno"> 2071</span>&#160;            <a class="code" href="classstored_1_1_file_layer.html#ab9e526fff86fae14f35909ac23983131">close</a>();</div><div class="line"><a name="l02072"></a><span class="lineno"> 2072</span>&#160;            <span class="keywordflow">return</span> <a class="code" href="classstored_1_1_polled_layer.html#a70378f51cf130ff4aed4dce90a1b403a">setLastError</a>(EIO);</div><div class="line"><a name="l02073"></a><span class="lineno"> 2073</span>&#160;        }</div><div class="line"><a name="l02074"></a><span class="lineno"> 2074</span>&#160;    }</div><div class="line"><a name="l02075"></a><span class="lineno"> 2075</span>&#160;}</div><div class="line"><a name="l02076"></a><span class="lineno"> 2076</span>&#160;</div><div class="line"><a name="l02077"></a><span class="lineno"> 2077</span>&#160;<span class="keywordtype">size_t</span> FileLayer::available() {</div><div class="line"><a name="l02078"></a><span class="lineno"> 2078</span>&#160;    <span class="keywordflow">if</span>(!isValidHandle(m_fd_r))</div><div class="line"><a name="l02079"></a><span class="lineno"> 2079</span>&#160;        <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l02080"></a><span class="lineno"> 2080</span>&#160;</div><div class="line"><a name="l02081"></a><span class="lineno"> 2081</span>&#160;    <span class="keywordflow">switch</span>(GetFileType(m_fd_r)) {</div><div class="line"><a name="l02082"></a><span class="lineno"> 2082</span>&#160;    <span class="keywordflow">case</span> FILE_TYPE_DISK: {</div><div class="line"><a name="l02083"></a><span class="lineno"> 2083</span>&#160;        LONG posHigh = 0L;</div><div class="line"><a name="l02084"></a><span class="lineno"> 2084</span>&#160;        DWORD <a class="code" href="namespaceed2_1_1gui_1_1____main____.html#a11587f112b0486278fe041290b1db064">res</a> = SetFilePointer(m_fd_r, 0L, &amp;posHigh, FILE_CURRENT);</div><div class="line"><a name="l02085"></a><span class="lineno"> 2085</span>&#160;        <span class="keywordflow">if</span>(res == INVALID_SET_FILE_POINTER)</div><div class="line"><a name="l02086"></a><span class="lineno"> 2086</span>&#160;            <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l02087"></a><span class="lineno"> 2087</span>&#160;</div><div class="line"><a name="l02088"></a><span class="lineno"> 2088</span>&#160;        uint64_t pos = (uint64_t)res | ((uint64_t)posHigh &lt;&lt; 32u);</div><div class="line"><a name="l02089"></a><span class="lineno"> 2089</span>&#160;</div><div class="line"><a name="l02090"></a><span class="lineno"> 2090</span>&#160;        DWORD sizeHigh = 0;</div><div class="line"><a name="l02091"></a><span class="lineno"> 2091</span>&#160;        res = GetFileSize(m_fd_r, &amp;sizeHigh);</div><div class="line"><a name="l02092"></a><span class="lineno"> 2092</span>&#160;        <span class="keywordflow">if</span>(res == INVALID_FILE_SIZE)</div><div class="line"><a name="l02093"></a><span class="lineno"> 2093</span>&#160;            <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l02094"></a><span class="lineno"> 2094</span>&#160;</div><div class="line"><a name="l02095"></a><span class="lineno"> 2095</span>&#160;        uint64_t size = (uint64_t)res | ((uint64_t)sizeHigh &lt;&lt; 32u);</div><div class="line"><a name="l02096"></a><span class="lineno"> 2096</span>&#160;</div><div class="line"><a name="l02097"></a><span class="lineno"> 2097</span>&#160;        <a class="code" href="group__libstored__util.html#gab750e51b876450a0a4ad419588a82a4d">stored_assert</a>(size &gt;= pos);</div><div class="line"><a name="l02098"></a><span class="lineno"> 2098</span>&#160;</div><div class="line"><a name="l02099"></a><span class="lineno"> 2099</span>&#160;        uint64_t avail = size - pos;</div><div class="line"><a name="l02100"></a><span class="lineno"> 2100</span>&#160;        <span class="keywordflow">return</span> (<span class="keywordtype">size_t</span>)std::min&lt;uint64_t&gt;(avail, std::numeric_limits&lt;size_t&gt;::max());</div><div class="line"><a name="l02101"></a><span class="lineno"> 2101</span>&#160;    }</div><div class="line"><a name="l02102"></a><span class="lineno"> 2102</span>&#160;    <span class="keywordflow">case</span> FILE_TYPE_PIPE: {</div><div class="line"><a name="l02103"></a><span class="lineno"> 2103</span>&#160;        DWORD readable = 0;</div><div class="line"><a name="l02104"></a><span class="lineno"> 2104</span>&#160;        <span class="keywordflow">if</span>(!PeekNamedPipe(m_fd_r, NULL, 0, NULL, &amp;readable, NULL))</div><div class="line"><a name="l02105"></a><span class="lineno"> 2105</span>&#160;            <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l02106"></a><span class="lineno"> 2106</span>&#160;</div><div class="line"><a name="l02107"></a><span class="lineno"> 2107</span>&#160;        <span class="keywordflow">if</span>(readable == 0)</div><div class="line"><a name="l02108"></a><span class="lineno"> 2108</span>&#160;            <span class="comment">// There is nothing to read. Issue a read of 1 byte, which will overlap/block.</span></div><div class="line"><a name="l02109"></a><span class="lineno"> 2109</span>&#160;            <span class="keywordflow">return</span> 1;</div><div class="line"><a name="l02110"></a><span class="lineno"> 2110</span>&#160;</div><div class="line"><a name="l02111"></a><span class="lineno"> 2111</span>&#160;        <span class="keywordflow">return</span> (<span class="keywordtype">size_t</span>)readable;</div><div class="line"><a name="l02112"></a><span class="lineno"> 2112</span>&#160;    }</div><div class="line"><a name="l02113"></a><span class="lineno"> 2113</span>&#160;    <span class="keywordflow">default</span>:</div><div class="line"><a name="l02114"></a><span class="lineno"> 2114</span>&#160;        <span class="comment">// Read byte-by-byte.</span></div><div class="line"><a name="l02115"></a><span class="lineno"> 2115</span>&#160;        <span class="keywordflow">return</span> 1;</div><div class="line"><a name="l02116"></a><span class="lineno"> 2116</span>&#160;    }</div><div class="line"><a name="l02117"></a><span class="lineno"> 2117</span>&#160;}</div><div class="line"><a name="l02118"></a><span class="lineno"> 2118</span>&#160;</div><div class="line"><a name="l02119"></a><span class="lineno"> 2119</span>&#160;<span class="keywordtype">int</span> <a class="code" href="classstored_1_1_file_layer.html#af12a800260514618e1ef49179a78dbd1">FileLayer::recv</a>(<span class="keywordtype">bool</span> block) {</div><div class="line"><a name="l02120"></a><span class="lineno"> 2120</span>&#160;    <span class="keywordtype">bool</span> didDecode = <span class="keyword">false</span>;</div><div class="line"><a name="l02121"></a><span class="lineno"> 2121</span>&#160;</div><div class="line"><a name="l02122"></a><span class="lineno"> 2122</span>&#160;    <a class="code" href="classstored_1_1_polled_layer.html#a70378f51cf130ff4aed4dce90a1b403a">setLastError</a>(0);</div><div class="line"><a name="l02123"></a><span class="lineno"> 2123</span>&#160;</div><div class="line"><a name="l02124"></a><span class="lineno"> 2124</span>&#160;    <span class="keywordflow">if</span>(block)</div><div class="line"><a name="l02125"></a><span class="lineno"> 2125</span>&#160;        <span class="keywordflow">if</span>(this-&gt;<a class="code" href="classstored_1_1_polled_layer.html#a79de5a08490722c111347ed8274d0f3a">block</a>(<a class="code" href="classstored_1_1_file_layer.html#ac1a3bb7c1dd0c85bde2072288f30024d">fd_r</a>(), <span class="keyword">true</span>))</div><div class="line"><a name="l02126"></a><span class="lineno"> 2126</span>&#160;            <span class="keywordflow">return</span> <a class="code" href="classstored_1_1_polled_layer.html#a5f93b36636abab8f4cacb5f1b4fbcd82">lastError</a>();</div><div class="line"><a name="l02127"></a><span class="lineno"> 2127</span>&#160;</div><div class="line"><a name="l02128"></a><span class="lineno"> 2128</span>&#160;again:</div><div class="line"><a name="l02129"></a><span class="lineno"> 2129</span>&#160;    DWORD read = 0;</div><div class="line"><a name="l02130"></a><span class="lineno"> 2130</span>&#160;    <span class="keywordflow">if</span>(GetOverlappedResult(m_fd_r, &amp;m_overlappedRead, &amp;read, FALSE)) {</div><div class="line"><a name="l02131"></a><span class="lineno"> 2131</span>&#160;        <span class="comment">// Finished the previous read.</span></div><div class="line"><a name="l02132"></a><span class="lineno"> 2132</span>&#160;        <a class="code" href="classstored_1_1_protocol_layer.html#a357b029311be09df61e019682a848ab5">decode</a>(&amp;m_bufferRead[0], read);</div><div class="line"><a name="l02133"></a><span class="lineno"> 2133</span>&#160;        <span class="comment">// Go issue the next read.</span></div><div class="line"><a name="l02134"></a><span class="lineno"> 2134</span>&#160;        <span class="keywordflow">return</span> startRead() == EAGAIN ? <a class="code" href="classstored_1_1_polled_layer.html#a70378f51cf130ff4aed4dce90a1b403a">setLastError</a>(0) : <a class="code" href="classstored_1_1_polled_layer.html#a5f93b36636abab8f4cacb5f1b4fbcd82">lastError</a>();</div><div class="line"><a name="l02135"></a><span class="lineno"> 2135</span>&#160;    } <span class="keywordflow">else</span> {</div><div class="line"><a name="l02136"></a><span class="lineno"> 2136</span>&#160;        <span class="keywordflow">switch</span>(GetLastError()) {</div><div class="line"><a name="l02137"></a><span class="lineno"> 2137</span>&#160;        <span class="keywordflow">case</span> ERROR_IO_INCOMPLETE:</div><div class="line"><a name="l02138"></a><span class="lineno"> 2138</span>&#160;        <span class="keywordflow">case</span> ERROR_IO_PENDING:</div><div class="line"><a name="l02139"></a><span class="lineno"> 2139</span>&#160;            <span class="comment">// Still waiting.</span></div><div class="line"><a name="l02140"></a><span class="lineno"> 2140</span>&#160;            <span class="keywordflow">if</span>(didDecode)</div><div class="line"><a name="l02141"></a><span class="lineno"> 2141</span>&#160;                <span class="comment">// But we did something already.</span></div><div class="line"><a name="l02142"></a><span class="lineno"> 2142</span>&#160;                <span class="keywordflow">return</span> <a class="code" href="classstored_1_1_polled_layer.html#a70378f51cf130ff4aed4dce90a1b403a">setLastError</a>(0);</div><div class="line"><a name="l02143"></a><span class="lineno"> 2143</span>&#160;</div><div class="line"><a name="l02144"></a><span class="lineno"> 2144</span>&#160;            <span class="keywordflow">if</span>(block) {</div><div class="line"><a name="l02145"></a><span class="lineno"> 2145</span>&#160;                <span class="comment">// Go block till we are readable.</span></div><div class="line"><a name="l02146"></a><span class="lineno"> 2146</span>&#160;                <span class="keywordflow">if</span>(this-&gt;<a class="code" href="classstored_1_1_polled_layer.html#a79de5a08490722c111347ed8274d0f3a">block</a>(<a class="code" href="classstored_1_1_file_layer.html#ac1a3bb7c1dd0c85bde2072288f30024d">fd_r</a>(), <span class="keyword">true</span>))</div><div class="line"><a name="l02147"></a><span class="lineno"> 2147</span>&#160;                    <span class="keywordflow">return</span> <a class="code" href="classstored_1_1_polled_layer.html#a5f93b36636abab8f4cacb5f1b4fbcd82">lastError</a>();</div><div class="line"><a name="l02148"></a><span class="lineno"> 2148</span>&#160;</div><div class="line"><a name="l02149"></a><span class="lineno"> 2149</span>&#160;                <span class="keywordflow">goto</span> again;</div><div class="line"><a name="l02150"></a><span class="lineno"> 2150</span>&#160;            }</div><div class="line"><a name="l02151"></a><span class="lineno"> 2151</span>&#160;</div><div class="line"><a name="l02152"></a><span class="lineno"> 2152</span>&#160;            <span class="comment">// Non blocking.</span></div><div class="line"><a name="l02153"></a><span class="lineno"> 2153</span>&#160;            <span class="keywordflow">return</span> <a class="code" href="classstored_1_1_polled_layer.html#a70378f51cf130ff4aed4dce90a1b403a">setLastError</a>(EAGAIN);</div><div class="line"><a name="l02154"></a><span class="lineno"> 2154</span>&#160;        <span class="keywordflow">default</span>:</div><div class="line"><a name="l02155"></a><span class="lineno"> 2155</span>&#160;            <a class="code" href="classstored_1_1_file_layer.html#ab9e526fff86fae14f35909ac23983131">close</a>();</div><div class="line"><a name="l02156"></a><span class="lineno"> 2156</span>&#160;            <span class="keywordflow">return</span> <a class="code" href="classstored_1_1_polled_layer.html#a70378f51cf130ff4aed4dce90a1b403a">setLastError</a>(EIO);</div><div class="line"><a name="l02157"></a><span class="lineno"> 2157</span>&#160;        }</div><div class="line"><a name="l02158"></a><span class="lineno"> 2158</span>&#160;    }</div><div class="line"><a name="l02159"></a><span class="lineno"> 2159</span>&#160;}</div><div class="line"><a name="l02160"></a><span class="lineno"> 2160</span>&#160;</div><div class="line"><a name="l02161"></a><span class="lineno"> 2161</span>&#160;OVERLAPPED&amp; FileLayer::overlappedRead() {</div><div class="line"><a name="l02162"></a><span class="lineno"> 2162</span>&#160;    <span class="keywordflow">return</span> m_overlappedRead;</div><div class="line"><a name="l02163"></a><span class="lineno"> 2163</span>&#160;}</div><div class="line"><a name="l02164"></a><span class="lineno"> 2164</span>&#160;</div><div class="line"><a name="l02165"></a><span class="lineno"> 2165</span>&#160;OVERLAPPED&amp; FileLayer::overlappedWrite() {</div><div class="line"><a name="l02166"></a><span class="lineno"> 2166</span>&#160;    <span class="keywordflow">return</span> m_overlappedWrite;</div><div class="line"><a name="l02167"></a><span class="lineno"> 2167</span>&#160;}</div><div class="line"><a name="l02168"></a><span class="lineno"> 2168</span>&#160;</div><div class="line"><a name="l02169"></a><span class="lineno"> 2169</span>&#160;<span class="keywordtype">void</span> FileLayer::resetOverlappedRead() {</div><div class="line"><a name="l02170"></a><span class="lineno"> 2170</span>&#160;    HANDLE hEvent = m_overlappedRead.hEvent;</div><div class="line"><a name="l02171"></a><span class="lineno"> 2171</span>&#160;    memset(&amp;m_overlappedRead, 0, <span class="keyword">sizeof</span>(m_overlappedRead));</div><div class="line"><a name="l02172"></a><span class="lineno"> 2172</span>&#160;    m_overlappedRead.hEvent = hEvent;</div><div class="line"><a name="l02173"></a><span class="lineno"> 2173</span>&#160;    ResetEvent(hEvent);</div><div class="line"><a name="l02174"></a><span class="lineno"> 2174</span>&#160;}</div><div class="line"><a name="l02175"></a><span class="lineno"> 2175</span>&#160;</div><div class="line"><a name="l02176"></a><span class="lineno"> 2176</span>&#160;<span class="keywordtype">void</span> FileLayer::resetOverlappedWrite() {</div><div class="line"><a name="l02177"></a><span class="lineno"> 2177</span>&#160;    HANDLE hEvent = m_overlappedWrite.hEvent;</div><div class="line"><a name="l02178"></a><span class="lineno"> 2178</span>&#160;    memset(&amp;m_overlappedWrite, 0, <span class="keyword">sizeof</span>(m_overlappedWrite));</div><div class="line"><a name="l02179"></a><span class="lineno"> 2179</span>&#160;    m_overlappedWrite.hEvent = hEvent;</div><div class="line"><a name="l02180"></a><span class="lineno"> 2180</span>&#160;    ResetEvent(hEvent);</div><div class="line"><a name="l02181"></a><span class="lineno"> 2181</span>&#160;}</div><div class="line"><a name="l02182"></a><span class="lineno"> 2182</span>&#160;</div><div class="line"><a name="l02183"></a><span class="lineno"> 2183</span>&#160;</div><div class="line"><a name="l02184"></a><span class="lineno"> 2184</span>&#160;</div><div class="line"><a name="l02186"></a><span class="lineno"> 2186</span>&#160;<span class="comment">// NamedPipeLayer</span></div><div class="line"><a name="l02187"></a><span class="lineno"> 2187</span>&#160;<span class="comment">//</span></div><div class="line"><a name="l02188"></a><span class="lineno"> 2188</span>&#160;</div><div class="line"><a name="l02189"></a><span class="lineno"> 2189</span>&#160;NamedPipeLayer::NamedPipeLayer(<span class="keywordtype">char</span> <span class="keyword">const</span>* <a class="code" href="namespacesetup.html#ab3a7a0638d76a01367c5bc3cc699447f">name</a>, <a class="code" href="classstored_1_1_protocol_layer.html">ProtocolLayer</a>* up, <a class="code" href="classstored_1_1_protocol_layer.html">ProtocolLayer</a>* down)</div><div class="line"><a name="l02190"></a><span class="lineno"> 2190</span>&#160;    : <a class="code" href="classstored_1_1_file_layer.html#a62a89dd5d15ce541bccdab3c2c8326d1">base</a>(up, down)</div><div class="line"><a name="l02191"></a><span class="lineno"> 2191</span>&#160;    , m_state(StateInit)</div><div class="line"><a name="l02192"></a><span class="lineno"> 2192</span>&#160;{</div><div class="line"><a name="l02193"></a><span class="lineno"> 2193</span>&#160;    <a class="code" href="group__libstored__util.html#gab750e51b876450a0a4ad419588a82a4d">stored_assert</a>(name);</div><div class="line"><a name="l02194"></a><span class="lineno"> 2194</span>&#160;</div><div class="line"><a name="l02195"></a><span class="lineno"> 2195</span>&#160;    m_name = <span class="stringliteral">&quot;\\\\.\\pipe\\&quot;</span>;</div><div class="line"><a name="l02196"></a><span class="lineno"> 2196</span>&#160;    m_name += <a class="code" href="namespacesetup.html#ab3a7a0638d76a01367c5bc3cc699447f">name</a>;</div><div class="line"><a name="l02197"></a><span class="lineno"> 2197</span>&#160;</div><div class="line"><a name="l02198"></a><span class="lineno"> 2198</span>&#160;    HANDLE h = CreateNamedPipe(m_name.c_str(),</div><div class="line"><a name="l02199"></a><span class="lineno"> 2199</span>&#160;        PIPE_ACCESS_DUPLEX | FILE_FLAG_OVERLAPPED, <span class="comment">// NOLINT(hicpp-signed-bitwise)</span></div><div class="line"><a name="l02200"></a><span class="lineno"> 2200</span>&#160;        PIPE_TYPE_BYTE | PIPE_READMODE_BYTE | PIPE_WAIT, <span class="comment">// NOLINT(hicpp-signed-bitwise)</span></div><div class="line"><a name="l02201"></a><span class="lineno"> 2201</span>&#160;        1, <a class="code" href="classstored_1_1_file_layer.html#add1204842977b02378bba7b8ae4f122fa2927e7823f567f182fe3f7f28e9f9abf">BufferSize</a>, <a class="code" href="classstored_1_1_file_layer.html#add1204842977b02378bba7b8ae4f122fa2927e7823f567f182fe3f7f28e9f9abf">BufferSize</a>,</div><div class="line"><a name="l02202"></a><span class="lineno"> 2202</span>&#160;        0, NULL);</div><div class="line"><a name="l02203"></a><span class="lineno"> 2203</span>&#160;</div><div class="line"><a name="l02204"></a><span class="lineno"> 2204</span>&#160;    <span class="keywordflow">if</span>(!isValidHandle(h)) {</div><div class="line"><a name="l02205"></a><span class="lineno"> 2205</span>&#160;        <a class="code" href="classstored_1_1_file_layer.html#aa319f69ae9b0d305b60e139ed4a941fa">close_</a>();</div><div class="line"><a name="l02206"></a><span class="lineno"> 2206</span>&#160;        <a class="code" href="classstored_1_1_polled_layer.html#a70378f51cf130ff4aed4dce90a1b403a">setLastError</a>(EAGAIN);</div><div class="line"><a name="l02207"></a><span class="lineno"> 2207</span>&#160;        <span class="keywordflow">return</span>;</div><div class="line"><a name="l02208"></a><span class="lineno"> 2208</span>&#160;    }</div><div class="line"><a name="l02209"></a><span class="lineno"> 2209</span>&#160;</div><div class="line"><a name="l02210"></a><span class="lineno"> 2210</span>&#160;    <a class="code" href="classstored_1_1_file_layer.html#a53480909edeb9ba1c033552dc27fe309">init</a>(h, h);</div><div class="line"><a name="l02211"></a><span class="lineno"> 2211</span>&#160;}</div><div class="line"><a name="l02212"></a><span class="lineno"> 2212</span>&#160;</div><div class="line"><a name="l02213"></a><span class="lineno"> 2213</span>&#160;NamedPipeLayer::~NamedPipeLayer() {</div><div class="line"><a name="l02214"></a><span class="lineno"> 2214</span>&#160;    <a class="code" href="classstored_1_1_file_layer.html#aa319f69ae9b0d305b60e139ed4a941fa">close_</a>();</div><div class="line"><a name="l02215"></a><span class="lineno"> 2215</span>&#160;}</div><div class="line"><a name="l02216"></a><span class="lineno"> 2216</span>&#160;</div><div class="line"><a name="l02217"></a><span class="lineno"> 2217</span>&#160;<span class="keywordtype">void</span> NamedPipeLayer::close_() {</div><div class="line"><a name="l02218"></a><span class="lineno"> 2218</span>&#160;    <span class="keywordflow">if</span>(isValidHandle(handle())) {</div><div class="line"><a name="l02219"></a><span class="lineno"> 2219</span>&#160;        FlushFileBuffers(handle());</div><div class="line"><a name="l02220"></a><span class="lineno"> 2220</span>&#160;        CancelIo(handle());</div><div class="line"><a name="l02221"></a><span class="lineno"> 2221</span>&#160;        DisconnectNamedPipe(handle());</div><div class="line"><a name="l02222"></a><span class="lineno"> 2222</span>&#160;    }</div><div class="line"><a name="l02223"></a><span class="lineno"> 2223</span>&#160;</div><div class="line"><a name="l02224"></a><span class="lineno"> 2224</span>&#160;    <a class="code" href="classstored_1_1_polled_layer.html#af5b7fffdba945fa6063da0e4accd0ace">base::close</a>();</div><div class="line"><a name="l02225"></a><span class="lineno"> 2225</span>&#160;}</div><div class="line"><a name="l02226"></a><span class="lineno"> 2226</span>&#160;</div><div class="line"><a name="l02227"></a><span class="lineno"> 2227</span>&#160;<span class="keywordtype">void</span> NamedPipeLayer::close() {</div><div class="line"><a name="l02228"></a><span class="lineno"> 2228</span>&#160;    <span class="keywordflow">if</span>(isValidHandle(handle())) {</div><div class="line"><a name="l02229"></a><span class="lineno"> 2229</span>&#160;        <span class="comment">// Don&#39;t really close, just reconnect.</span></div><div class="line"><a name="l02230"></a><span class="lineno"> 2230</span>&#160;        FlushFileBuffers(handle());</div><div class="line"><a name="l02231"></a><span class="lineno"> 2231</span>&#160;        CancelIo(handle());</div><div class="line"><a name="l02232"></a><span class="lineno"> 2232</span>&#160;        DisconnectNamedPipe(handle());</div><div class="line"><a name="l02233"></a><span class="lineno"> 2233</span>&#160;        m_state = StateInit;</div><div class="line"><a name="l02234"></a><span class="lineno"> 2234</span>&#160;        <a class="code" href="classstored_1_1_polled_layer.html#a70378f51cf130ff4aed4dce90a1b403a">setLastError</a>(EIO);</div><div class="line"><a name="l02235"></a><span class="lineno"> 2235</span>&#160;        <span class="comment">// Reconnect.</span></div><div class="line"><a name="l02236"></a><span class="lineno"> 2236</span>&#160;        <a class="code" href="classstored_1_1_file_layer.html#af12a800260514618e1ef49179a78dbd1">recv</a>();</div><div class="line"><a name="l02237"></a><span class="lineno"> 2237</span>&#160;    }</div><div class="line"><a name="l02238"></a><span class="lineno"> 2238</span>&#160;}</div><div class="line"><a name="l02239"></a><span class="lineno"> 2239</span>&#160;</div><div class="line"><a name="l02240"></a><span class="lineno"> 2240</span>&#160;<span class="keywordtype">int</span> NamedPipeLayer::recv(<span class="keywordtype">bool</span> block) {</div><div class="line"><a name="l02241"></a><span class="lineno"> 2241</span>&#160;    <span class="keywordtype">bool</span> didDecode = <span class="keyword">false</span>;</div><div class="line"><a name="l02242"></a><span class="lineno"> 2242</span>&#160;again:</div><div class="line"><a name="l02243"></a><span class="lineno"> 2243</span>&#160;    <span class="keywordflow">switch</span>(m_state) {</div><div class="line"><a name="l02244"></a><span class="lineno"> 2244</span>&#160;    <span class="keywordflow">case</span> StateInit:</div><div class="line"><a name="l02245"></a><span class="lineno"> 2245</span>&#160;        <span class="keywordflow">if</span>(ConnectNamedPipe(handle(), &amp;overlappedRead())) {</div><div class="line"><a name="l02246"></a><span class="lineno"> 2246</span>&#160;            <span class="comment">// Connected immediately.</span></div><div class="line"><a name="l02247"></a><span class="lineno"> 2247</span>&#160;            m_state = StateConnected;</div><div class="line"><a name="l02248"></a><span class="lineno"> 2248</span>&#160;            didDecode = <span class="keyword">true</span>;</div><div class="line"><a name="l02249"></a><span class="lineno"> 2249</span>&#160;            <span class="keywordflow">goto</span> again;</div><div class="line"><a name="l02250"></a><span class="lineno"> 2250</span>&#160;        } <span class="keywordflow">else</span> {</div><div class="line"><a name="l02251"></a><span class="lineno"> 2251</span>&#160;            <span class="keywordflow">switch</span>(GetLastError()) {</div><div class="line"><a name="l02252"></a><span class="lineno"> 2252</span>&#160;            <span class="keywordflow">case</span> ERROR_IO_INCOMPLETE:</div><div class="line"><a name="l02253"></a><span class="lineno"> 2253</span>&#160;            <span class="keywordflow">case</span> ERROR_IO_PENDING:</div><div class="line"><a name="l02254"></a><span class="lineno"> 2254</span>&#160;                m_state = StateConnecting;</div><div class="line"><a name="l02255"></a><span class="lineno"> 2255</span>&#160;                <span class="keywordflow">return</span> <a class="code" href="classstored_1_1_polled_layer.html#a70378f51cf130ff4aed4dce90a1b403a">setLastError</a>(EAGAIN);</div><div class="line"><a name="l02256"></a><span class="lineno"> 2256</span>&#160;            <span class="keywordflow">case</span> ERROR_PIPE_CONNECTED:</div><div class="line"><a name="l02257"></a><span class="lineno"> 2257</span>&#160;                <span class="comment">// The client arrived early.</span></div><div class="line"><a name="l02258"></a><span class="lineno"> 2258</span>&#160;                m_state = StateConnected;</div><div class="line"><a name="l02259"></a><span class="lineno"> 2259</span>&#160;                didDecode = <span class="keyword">true</span>;</div><div class="line"><a name="l02260"></a><span class="lineno"> 2260</span>&#160;                <span class="keywordflow">goto</span> again;</div><div class="line"><a name="l02261"></a><span class="lineno"> 2261</span>&#160;            <span class="keywordflow">default</span>:</div><div class="line"><a name="l02262"></a><span class="lineno"> 2262</span>&#160;                <a class="code" href="classstored_1_1_file_layer.html#ab9e526fff86fae14f35909ac23983131">close</a>();</div><div class="line"><a name="l02263"></a><span class="lineno"> 2263</span>&#160;                <span class="comment">// Give up.</span></div><div class="line"><a name="l02264"></a><span class="lineno"> 2264</span>&#160;                m_state = StateError;</div><div class="line"><a name="l02265"></a><span class="lineno"> 2265</span>&#160;                <span class="keywordflow">return</span> <a class="code" href="classstored_1_1_polled_layer.html#a70378f51cf130ff4aed4dce90a1b403a">setLastError</a>(EIO);</div><div class="line"><a name="l02266"></a><span class="lineno"> 2266</span>&#160;            }</div><div class="line"><a name="l02267"></a><span class="lineno"> 2267</span>&#160;        }</div><div class="line"><a name="l02268"></a><span class="lineno"> 2268</span>&#160;        <span class="keywordflow">break</span>;</div><div class="line"><a name="l02269"></a><span class="lineno"> 2269</span>&#160;    <span class="keywordflow">case</span> StateConnecting: {</div><div class="line"><a name="l02270"></a><span class="lineno"> 2270</span>&#160;        DWORD dummy = 0;</div><div class="line"><a name="l02271"></a><span class="lineno"> 2271</span>&#160;        <span class="keywordflow">if</span>(block)</div><div class="line"><a name="l02272"></a><span class="lineno"> 2272</span>&#160;            this-&gt;<a class="code" href="classstored_1_1_polled_layer.html#a79de5a08490722c111347ed8274d0f3a">block</a>(<a class="code" href="classstored_1_1_file_layer.html#ac1a3bb7c1dd0c85bde2072288f30024d">fd_r</a>(), <span class="keyword">true</span>);</div><div class="line"><a name="l02273"></a><span class="lineno"> 2273</span>&#160;</div><div class="line"><a name="l02274"></a><span class="lineno"> 2274</span>&#160;        <span class="keywordflow">if</span>(GetOverlappedResult(<a class="code" href="classstored_1_1_file_layer.html#ac1a3bb7c1dd0c85bde2072288f30024d">fd_r</a>(), &amp;overlappedRead(), &amp;dummy, FALSE)) {</div><div class="line"><a name="l02275"></a><span class="lineno"> 2275</span>&#160;            m_state = StateConnected;</div><div class="line"><a name="l02276"></a><span class="lineno"> 2276</span>&#160;            <span class="keywordflow">if</span>(startRead())</div><div class="line"><a name="l02277"></a><span class="lineno"> 2277</span>&#160;                <span class="keywordflow">return</span> <a class="code" href="classstored_1_1_polled_layer.html#a5f93b36636abab8f4cacb5f1b4fbcd82">lastError</a>();</div><div class="line"><a name="l02278"></a><span class="lineno"> 2278</span>&#160;            didDecode = <span class="keyword">true</span>;</div><div class="line"><a name="l02279"></a><span class="lineno"> 2279</span>&#160;            <span class="keywordflow">goto</span> again;</div><div class="line"><a name="l02280"></a><span class="lineno"> 2280</span>&#160;        } <span class="keywordflow">else</span> {</div><div class="line"><a name="l02281"></a><span class="lineno"> 2281</span>&#160;            <span class="keywordflow">switch</span>(GetLastError()) {</div><div class="line"><a name="l02282"></a><span class="lineno"> 2282</span>&#160;            <span class="keywordflow">case</span> ERROR_IO_INCOMPLETE:</div><div class="line"><a name="l02283"></a><span class="lineno"> 2283</span>&#160;            <span class="keywordflow">case</span> ERROR_IO_PENDING:</div><div class="line"><a name="l02284"></a><span class="lineno"> 2284</span>&#160;                <span class="keywordflow">return</span> <a class="code" href="classstored_1_1_polled_layer.html#a70378f51cf130ff4aed4dce90a1b403a">setLastError</a>(EAGAIN);</div><div class="line"><a name="l02285"></a><span class="lineno"> 2285</span>&#160;            <span class="keywordflow">default</span>:</div><div class="line"><a name="l02286"></a><span class="lineno"> 2286</span>&#160;                m_state = StateError;</div><div class="line"><a name="l02287"></a><span class="lineno"> 2287</span>&#160;                <span class="keywordflow">return</span> <a class="code" href="classstored_1_1_polled_layer.html#a70378f51cf130ff4aed4dce90a1b403a">setLastError</a>(EIO);</div><div class="line"><a name="l02288"></a><span class="lineno"> 2288</span>&#160;            }</div><div class="line"><a name="l02289"></a><span class="lineno"> 2289</span>&#160;        }</div><div class="line"><a name="l02290"></a><span class="lineno"> 2290</span>&#160;    }</div><div class="line"><a name="l02291"></a><span class="lineno"> 2291</span>&#160;    <span class="keywordflow">case</span> StateConnected:</div><div class="line"><a name="l02292"></a><span class="lineno"> 2292</span>&#160;        <span class="keywordflow">if</span>(<a class="code" href="classstored_1_1_polled_layer.html#a988e642fff4f1ee1ec3c8557be8bc0bf">base::recv</a>(block) == EAGAIN &amp;&amp; didDecode)</div><div class="line"><a name="l02293"></a><span class="lineno"> 2293</span>&#160;            <span class="keywordflow">return</span> <a class="code" href="classstored_1_1_polled_layer.html#a70378f51cf130ff4aed4dce90a1b403a">setLastError</a>(0);</div><div class="line"><a name="l02294"></a><span class="lineno"> 2294</span>&#160;        <span class="keywordflow">else</span></div><div class="line"><a name="l02295"></a><span class="lineno"> 2295</span>&#160;            <span class="keywordflow">return</span> <a class="code" href="classstored_1_1_polled_layer.html#a5f93b36636abab8f4cacb5f1b4fbcd82">lastError</a>();</div><div class="line"><a name="l02296"></a><span class="lineno"> 2296</span>&#160;</div><div class="line"><a name="l02297"></a><span class="lineno"> 2297</span>&#160;    <span class="keywordflow">case</span> StateError:</div><div class="line"><a name="l02298"></a><span class="lineno"> 2298</span>&#160;        <span class="keywordflow">return</span> <a class="code" href="classstored_1_1_polled_layer.html#a70378f51cf130ff4aed4dce90a1b403a">setLastError</a>(EINVAL);</div><div class="line"><a name="l02299"></a><span class="lineno"> 2299</span>&#160;</div><div class="line"><a name="l02300"></a><span class="lineno"> 2300</span>&#160;    <span class="keywordflow">default</span>:</div><div class="line"><a name="l02301"></a><span class="lineno"> 2301</span>&#160;        <a class="code" href="group__libstored__util.html#gab750e51b876450a0a4ad419588a82a4d">stored_assert</a>(<span class="keyword">false</span>);</div><div class="line"><a name="l02302"></a><span class="lineno"> 2302</span>&#160;        <span class="keywordflow">return</span> EINVAL;</div><div class="line"><a name="l02303"></a><span class="lineno"> 2303</span>&#160;    }</div><div class="line"><a name="l02304"></a><span class="lineno"> 2304</span>&#160;}</div><div class="line"><a name="l02305"></a><span class="lineno"> 2305</span>&#160;</div><div class="line"><a name="l02306"></a><span class="lineno"> 2306</span>&#160;<span class="keywordtype">int</span> NamedPipeLayer::startRead() {</div><div class="line"><a name="l02307"></a><span class="lineno"> 2307</span>&#160;    <span class="keywordflow">switch</span>(m_state) {</div><div class="line"><a name="l02308"></a><span class="lineno"> 2308</span>&#160;    <span class="keywordflow">case</span> StateInit:</div><div class="line"><a name="l02309"></a><span class="lineno"> 2309</span>&#160;        <span class="keywordflow">return</span> <a class="code" href="classstored_1_1_file_layer.html#af12a800260514618e1ef49179a78dbd1">recv</a>(<span class="keyword">false</span>);</div><div class="line"><a name="l02310"></a><span class="lineno"> 2310</span>&#160;    <span class="keywordflow">case</span> StateConnected:</div><div class="line"><a name="l02311"></a><span class="lineno"> 2311</span>&#160;        <span class="keywordflow">return</span> base::startRead();</div><div class="line"><a name="l02312"></a><span class="lineno"> 2312</span>&#160;    <span class="keywordflow">case</span> StateError:</div><div class="line"><a name="l02313"></a><span class="lineno"> 2313</span>&#160;        <span class="keywordflow">return</span> <a class="code" href="classstored_1_1_polled_layer.html#a70378f51cf130ff4aed4dce90a1b403a">setLastError</a>(EINVAL);</div><div class="line"><a name="l02314"></a><span class="lineno"> 2314</span>&#160;    <span class="keywordflow">default</span>:</div><div class="line"><a name="l02315"></a><span class="lineno"> 2315</span>&#160;        <span class="keywordflow">return</span> <a class="code" href="classstored_1_1_polled_layer.html#a70378f51cf130ff4aed4dce90a1b403a">setLastError</a>(EAGAIN);</div><div class="line"><a name="l02316"></a><span class="lineno"> 2316</span>&#160;    }</div><div class="line"><a name="l02317"></a><span class="lineno"> 2317</span>&#160;}</div><div class="line"><a name="l02318"></a><span class="lineno"> 2318</span>&#160;</div><div class="line"><a name="l02319"></a><span class="lineno"> 2319</span>&#160;std::string <span class="keyword">const</span>&amp; <a class="code" href="namespacesetup.html#ab3a7a0638d76a01367c5bc3cc699447f">NamedPipeLayer::name</a>()<span class="keyword"> const </span>{</div><div class="line"><a name="l02320"></a><span class="lineno"> 2320</span>&#160;    <span class="keywordflow">return</span> m_name;</div><div class="line"><a name="l02321"></a><span class="lineno"> 2321</span>&#160;}</div><div class="line"><a name="l02322"></a><span class="lineno"> 2322</span>&#160;</div><div class="line"><a name="l02323"></a><span class="lineno"> 2323</span>&#160;HANDLE NamedPipeLayer::handle()<span class="keyword"> const </span>{</div><div class="line"><a name="l02324"></a><span class="lineno"> 2324</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="classstored_1_1_file_layer.html#ac1a3bb7c1dd0c85bde2072288f30024d">fd_r</a>();</div><div class="line"><a name="l02325"></a><span class="lineno"> 2325</span>&#160;}</div><div class="line"><a name="l02326"></a><span class="lineno"> 2326</span>&#160;</div><div class="line"><a name="l02327"></a><span class="lineno"> 2327</span>&#160;<span class="preprocessor">#endif // STORED_OS_WINDOWS</span></div><div class="line"><a name="l02328"></a><span class="lineno"> 2328</span>&#160;</div><div class="line"><a name="l02329"></a><span class="lineno"> 2329</span>&#160;</div><div class="line"><a name="l02330"></a><span class="lineno"> 2330</span>&#160;</div><div class="line"><a name="l02332"></a><span class="lineno"> 2332</span>&#160;<span class="comment">// StdioLayer</span></div><div class="line"><a name="l02333"></a><span class="lineno"> 2333</span>&#160;<span class="comment">//</span></div><div class="line"><a name="l02334"></a><span class="lineno"> 2334</span>&#160;</div><div class="line"><a name="l02335"></a><span class="lineno"> 2335</span>&#160;<span class="preprocessor">#ifdef STORED_OS_WINDOWS</span></div><div class="line"><a name="l02336"></a><span class="lineno"> 2336</span>&#160;<a class="code" href="classstored_1_1_stdio_layer.html#a8b01067593fb46e1ca6a916d12635d32">StdioLayer::StdioLayer</a>(<a class="code" href="classstored_1_1_protocol_layer.html">ProtocolLayer</a>* up, <a class="code" href="classstored_1_1_protocol_layer.html">ProtocolLayer</a>* down)</div><div class="line"><a name="l02337"></a><span class="lineno"> 2337</span>&#160;    : <a class="code" href="classstored_1_1_file_layer.html#a62a89dd5d15ce541bccdab3c2c8326d1">base</a>(up, down)</div><div class="line"><a name="l02338"></a><span class="lineno"> 2338</span>&#160;    , m_fd_r(GetStdHandle(STD_INPUT_HANDLE))</div><div class="line"><a name="l02339"></a><span class="lineno"> 2339</span>&#160;    , m_fd_w(GetStdHandle(STD_OUTPUT_HANDLE))</div><div class="line"><a name="l02340"></a><span class="lineno"> 2340</span>&#160;    , m_pipe_r()</div><div class="line"><a name="l02341"></a><span class="lineno"> 2341</span>&#160;    , m_pipe_w()</div><div class="line"><a name="l02342"></a><span class="lineno"> 2342</span>&#160;{</div><div class="line"><a name="l02343"></a><span class="lineno"> 2343</span>&#160;    DWORD mode = 0;</div><div class="line"><a name="l02344"></a><span class="lineno"> 2344</span>&#160;    <span class="keywordflow">if</span>(GetConsoleMode(m_fd_r, &amp;mode)) {</div><div class="line"><a name="l02345"></a><span class="lineno"> 2345</span>&#160;        <span class="comment">// NOLINTNEXTLINE(hicpp-signed-bitwise)</span></div><div class="line"><a name="l02346"></a><span class="lineno"> 2346</span>&#160;        SetConsoleMode(m_fd_r, mode &amp; ~(DWORD)(ENABLE_MOUSE_INPUT | ENABLE_WINDOW_INPUT));</div><div class="line"><a name="l02347"></a><span class="lineno"> 2347</span>&#160;        FlushConsoleInputBuffer(m_fd_r);</div><div class="line"><a name="l02348"></a><span class="lineno"> 2348</span>&#160;    } <span class="keywordflow">else</span> {</div><div class="line"><a name="l02349"></a><span class="lineno"> 2349</span>&#160;        <span class="comment">// stdin is probably redirected, in which case it is a named pipe.</span></div><div class="line"><a name="l02350"></a><span class="lineno"> 2350</span>&#160;        m_pipe_r = <span class="keyword">true</span>;</div><div class="line"><a name="l02351"></a><span class="lineno"> 2351</span>&#160;    }</div><div class="line"><a name="l02352"></a><span class="lineno"> 2352</span>&#160;</div><div class="line"><a name="l02353"></a><span class="lineno"> 2353</span>&#160;    <span class="keywordflow">if</span>(GetConsoleMode(m_fd_w, &amp;mode)) {</div><div class="line"><a name="l02354"></a><span class="lineno"> 2354</span>&#160;        <span class="comment">// NOLINTNEXTLINE(hicpp-signed-bitwise)</span></div><div class="line"><a name="l02355"></a><span class="lineno"> 2355</span>&#160;        SetConsoleMode(m_fd_w, mode | 4 <span class="comment">/*ENABLE_VIRTUAL_TERMINAL_PROCESSING*/</span> );</div><div class="line"><a name="l02356"></a><span class="lineno"> 2356</span>&#160;    } <span class="keywordflow">else</span> {</div><div class="line"><a name="l02357"></a><span class="lineno"> 2357</span>&#160;        <span class="comment">// stdout is probably redirected, in which case it is a named pipe.</span></div><div class="line"><a name="l02358"></a><span class="lineno"> 2358</span>&#160;        m_pipe_w = <span class="keyword">true</span>;</div><div class="line"><a name="l02359"></a><span class="lineno"> 2359</span>&#160;    }</div><div class="line"><a name="l02360"></a><span class="lineno"> 2360</span>&#160;</div><div class="line"><a name="l02361"></a><span class="lineno"> 2361</span>&#160;    m_bufferRead.resize(<a class="code" href="classstored_1_1_file_layer.html#add1204842977b02378bba7b8ae4f122fa2927e7823f567f182fe3f7f28e9f9abf">BufferSize</a>);</div><div class="line"><a name="l02362"></a><span class="lineno"> 2362</span>&#160;}</div><div class="line"><a name="l02363"></a><span class="lineno"> 2363</span>&#160;</div><div class="line"><a name="l02364"></a><span class="lineno"> 2364</span>&#160;<a class="code" href="classstored_1_1_stdio_layer.html#ae8cbdf2cc3bf4c8b35b8685854c4035a">StdioLayer::~StdioLayer</a>() {</div><div class="line"><a name="l02365"></a><span class="lineno"> 2365</span>&#160;    <a class="code" href="classstored_1_1_file_layer.html#aa319f69ae9b0d305b60e139ed4a941fa">close_</a>();</div><div class="line"><a name="l02366"></a><span class="lineno"> 2366</span>&#160;}</div><div class="line"><a name="l02367"></a><span class="lineno"> 2367</span>&#160;</div><div class="line"><a name="l02368"></a><span class="lineno"> 2368</span>&#160;<span class="keywordtype">bool</span> StdioLayer::isPipeIn()<span class="keyword"> const </span>{</div><div class="line"><a name="l02369"></a><span class="lineno"> 2369</span>&#160;    <span class="keywordflow">return</span> m_pipe_r;</div><div class="line"><a name="l02370"></a><span class="lineno"> 2370</span>&#160;}</div><div class="line"><a name="l02371"></a><span class="lineno"> 2371</span>&#160;</div><div class="line"><a name="l02372"></a><span class="lineno"> 2372</span>&#160;<span class="keywordtype">bool</span> StdioLayer::isPipeOut()<span class="keyword"> const </span>{</div><div class="line"><a name="l02373"></a><span class="lineno"> 2373</span>&#160;    <span class="keywordflow">return</span> m_pipe_w;</div><div class="line"><a name="l02374"></a><span class="lineno"> 2374</span>&#160;}</div><div class="line"><a name="l02375"></a><span class="lineno"> 2375</span>&#160;</div><div class="line"><a name="l02376"></a><span class="lineno"> 2376</span>&#160;<span class="keywordtype">int</span> <a class="code" href="classstored_1_1_polled_layer.html#a79de5a08490722c111347ed8274d0f3a">StdioLayer::block</a>(<a class="code" href="classstored_1_1_file_layer.html#a4c9bc21201b7bd79875972d03fc1b7dc">fd_type</a> <a class="code" href="macros_8h.html#af17ee1aea7e7e70c19dc325e02552ed0">UNUSED_PAR</a>(<a class="code" href="classstored_1_1_file_layer.html#a58badaa958c01f0f22eaf298788148e8">fd</a>), <span class="keywordtype">bool</span> <a class="code" href="macros_8h.html#af17ee1aea7e7e70c19dc325e02552ed0">UNUSED_PAR</a>(forReading), <span class="keywordtype">bool</span> <a class="code" href="macros_8h.html#af17ee1aea7e7e70c19dc325e02552ed0">UNUSED_PAR</a>(suspend)) {</div><div class="line"><a name="l02377"></a><span class="lineno"> 2377</span>&#160;    <a class="code" href="group__libstored__util.html#gab750e51b876450a0a4ad419588a82a4d">stored_assert</a>(<span class="keyword">false</span>);</div><div class="line"><a name="l02378"></a><span class="lineno"> 2378</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="classstored_1_1_polled_layer.html#a70378f51cf130ff4aed4dce90a1b403a">setLastError</a>(EINVAL);</div><div class="line"><a name="l02379"></a><span class="lineno"> 2379</span>&#160;}</div><div class="line"><a name="l02380"></a><span class="lineno"> 2380</span>&#160;</div><div class="line"><a name="l02381"></a><span class="lineno"> 2381</span>&#160;<span class="keywordtype">bool</span> <a class="code" href="classstored_1_1_file_layer.html#a653122ce5a77c5d5999008337bce58b7">StdioLayer::isOpen</a>()<span class="keyword"> const </span>{</div><div class="line"><a name="l02382"></a><span class="lineno"> 2382</span>&#160;    <span class="keywordflow">return</span> isValidHandle(m_fd_r);</div><div class="line"><a name="l02383"></a><span class="lineno"> 2383</span>&#160;}</div><div class="line"><a name="l02384"></a><span class="lineno"> 2384</span>&#160;</div><div class="line"><a name="l02385"></a><span class="lineno"> 2385</span>&#160;<span class="keywordtype">void</span> <a class="code" href="classstored_1_1_file_layer.html#ab9e526fff86fae14f35909ac23983131">StdioLayer::close</a>() {</div><div class="line"><a name="l02386"></a><span class="lineno"> 2386</span>&#160;    <a class="code" href="classstored_1_1_file_layer.html#aa319f69ae9b0d305b60e139ed4a941fa">close_</a>();</div><div class="line"><a name="l02387"></a><span class="lineno"> 2387</span>&#160;}</div><div class="line"><a name="l02388"></a><span class="lineno"> 2388</span>&#160;</div><div class="line"><a name="l02389"></a><span class="lineno"> 2389</span>&#160;<span class="keywordtype">void</span> <a class="code" href="classstored_1_1_file_layer.html#aa319f69ae9b0d305b60e139ed4a941fa">StdioLayer::close_</a>() {</div><div class="line"><a name="l02390"></a><span class="lineno"> 2390</span>&#160;    <span class="keywordflow">if</span>(isValidHandle(m_fd_r) &amp;&amp; isPipeIn()) {</div><div class="line"><a name="l02391"></a><span class="lineno"> 2391</span>&#160;        CloseHandle(m_fd_r);</div><div class="line"><a name="l02392"></a><span class="lineno"> 2392</span>&#160;        <span class="comment">// NOLINTNEXTLINE(cppcoreguidelines-pro-type-cstyle-cast)</span></div><div class="line"><a name="l02393"></a><span class="lineno"> 2393</span>&#160;        m_fd_r = INVALID_HANDLE_VALUE;</div><div class="line"><a name="l02394"></a><span class="lineno"> 2394</span>&#160;    }</div><div class="line"><a name="l02395"></a><span class="lineno"> 2395</span>&#160;</div><div class="line"><a name="l02396"></a><span class="lineno"> 2396</span>&#160;    <a class="code" href="classstored_1_1_polled_layer.html#af5b7fffdba945fa6063da0e4accd0ace">base::close</a>();</div><div class="line"><a name="l02397"></a><span class="lineno"> 2397</span>&#160;}</div><div class="line"><a name="l02398"></a><span class="lineno"> 2398</span>&#160;</div><div class="line"><a name="l02399"></a><span class="lineno"> 2399</span>&#160;<a class="code" href="classstored_1_1_polled_layer.html#a4c9bc21201b7bd79875972d03fc1b7dc">StdioLayer::fd_type</a> <a class="code" href="classstored_1_1_file_layer.html#ac1a3bb7c1dd0c85bde2072288f30024d">StdioLayer::fd_r</a>()<span class="keyword"> const </span>{</div><div class="line"><a name="l02400"></a><span class="lineno"> 2400</span>&#160;    <span class="keywordflow">return</span> m_fd_r;</div><div class="line"><a name="l02401"></a><span class="lineno"> 2401</span>&#160;}</div><div class="line"><a name="l02402"></a><span class="lineno"> 2402</span>&#160;</div><div class="line"><a name="l02403"></a><span class="lineno"> 2403</span>&#160;<a class="code" href="classstored_1_1_polled_layer.html#a4c9bc21201b7bd79875972d03fc1b7dc">StdioLayer::fd_type</a> <a class="code" href="classstored_1_1_file_layer.html#a4aebe2812c392f4b25d12aa16021a65f">StdioLayer::fd_w</a>()<span class="keyword"> const </span>{</div><div class="line"><a name="l02404"></a><span class="lineno"> 2404</span>&#160;    <span class="keywordflow">return</span> m_fd_w;</div><div class="line"><a name="l02405"></a><span class="lineno"> 2405</span>&#160;}</div><div class="line"><a name="l02406"></a><span class="lineno"> 2406</span>&#160;</div><div class="line"><a name="l02407"></a><span class="lineno"> 2407</span>&#160;<span class="comment">// Guess what, Overlapped I/O is not supported on the console...</span></div><div class="line"><a name="l02408"></a><span class="lineno"> 2408</span>&#160;<span class="keywordtype">int</span> <a class="code" href="classstored_1_1_file_layer.html#af12a800260514618e1ef49179a78dbd1">StdioLayer::recv</a>(<span class="keywordtype">bool</span> block) {</div><div class="line"><a name="l02409"></a><span class="lineno"> 2409</span>&#160;    <span class="keywordflow">if</span>(!isValidHandle(<a class="code" href="classstored_1_1_file_layer.html#ac1a3bb7c1dd0c85bde2072288f30024d">fd_r</a>()))</div><div class="line"><a name="l02410"></a><span class="lineno"> 2410</span>&#160;        <span class="keywordflow">return</span> <a class="code" href="classstored_1_1_polled_layer.html#a70378f51cf130ff4aed4dce90a1b403a">setLastError</a>(EBADF);</div><div class="line"><a name="l02411"></a><span class="lineno"> 2411</span>&#160;</div><div class="line"><a name="l02412"></a><span class="lineno"> 2412</span>&#160;    <span class="keywordtype">bool</span> didDecode = <span class="keyword">false</span>;</div><div class="line"><a name="l02413"></a><span class="lineno"> 2413</span>&#160;    DWORD cnt = 0;</div><div class="line"><a name="l02414"></a><span class="lineno"> 2414</span>&#160;again:</div><div class="line"><a name="l02415"></a><span class="lineno"> 2415</span>&#160;    <span class="keywordflow">if</span>(isPipeIn()) {</div><div class="line"><a name="l02416"></a><span class="lineno"> 2416</span>&#160;        <span class="keywordflow">if</span>(!PeekNamedPipe(<a class="code" href="classstored_1_1_file_layer.html#ac1a3bb7c1dd0c85bde2072288f30024d">fd_r</a>(), NULL, 0, NULL, &amp;cnt, NULL))</div><div class="line"><a name="l02417"></a><span class="lineno"> 2417</span>&#160;            <span class="keywordflow">goto</span> error;</div><div class="line"><a name="l02418"></a><span class="lineno"> 2418</span>&#160;    } <span class="keywordflow">else</span> <span class="keywordflow">if</span>(!GetNumberOfConsoleInputEvents(<a class="code" href="classstored_1_1_file_layer.html#ac1a3bb7c1dd0c85bde2072288f30024d">fd_r</a>(), &amp;cnt)){</div><div class="line"><a name="l02419"></a><span class="lineno"> 2419</span>&#160;        <span class="keywordflow">goto</span> error;</div><div class="line"><a name="l02420"></a><span class="lineno"> 2420</span>&#160;    }</div><div class="line"><a name="l02421"></a><span class="lineno"> 2421</span>&#160;</div><div class="line"><a name="l02422"></a><span class="lineno"> 2422</span>&#160;    <span class="keywordflow">if</span>(cnt == 0) {</div><div class="line"><a name="l02423"></a><span class="lineno"> 2423</span>&#160;        <span class="keywordflow">if</span>(didDecode)</div><div class="line"><a name="l02424"></a><span class="lineno"> 2424</span>&#160;            <span class="keywordflow">return</span> <a class="code" href="classstored_1_1_polled_layer.html#a70378f51cf130ff4aed4dce90a1b403a">setLastError</a>(0);</div><div class="line"><a name="l02425"></a><span class="lineno"> 2425</span>&#160;        <span class="keywordflow">if</span>(!block)</div><div class="line"><a name="l02426"></a><span class="lineno"> 2426</span>&#160;            <span class="keywordflow">return</span> EAGAIN;</div><div class="line"><a name="l02427"></a><span class="lineno"> 2427</span>&#160;</div><div class="line"><a name="l02428"></a><span class="lineno"> 2428</span>&#160;        cnt = 1;</div><div class="line"><a name="l02429"></a><span class="lineno"> 2429</span>&#160;    }</div><div class="line"><a name="l02430"></a><span class="lineno"> 2430</span>&#160;</div><div class="line"><a name="l02431"></a><span class="lineno"> 2431</span>&#160;    <span class="keywordflow">if</span>((<span class="keywordtype">size_t</span>)cnt &gt; m_bufferRead.size())</div><div class="line"><a name="l02432"></a><span class="lineno"> 2432</span>&#160;        cnt = (DWORD)m_bufferRead.size();</div><div class="line"><a name="l02433"></a><span class="lineno"> 2433</span>&#160;</div><div class="line"><a name="l02434"></a><span class="lineno"> 2434</span>&#160;    <span class="keywordflow">if</span>(ReadFile(<a class="code" href="classstored_1_1_file_layer.html#ac1a3bb7c1dd0c85bde2072288f30024d">fd_r</a>(), &amp;m_bufferRead[0], cnt, &amp;cnt, NULL)) {</div><div class="line"><a name="l02435"></a><span class="lineno"> 2435</span>&#160;        <a class="code" href="classstored_1_1_protocol_layer.html#a357b029311be09df61e019682a848ab5">decode</a>(&amp;m_bufferRead[0], (<span class="keywordtype">size_t</span>)cnt);</div><div class="line"><a name="l02436"></a><span class="lineno"> 2436</span>&#160;        didDecode = <span class="keyword">true</span>;</div><div class="line"><a name="l02437"></a><span class="lineno"> 2437</span>&#160;        <span class="keywordflow">goto</span> again;</div><div class="line"><a name="l02438"></a><span class="lineno"> 2438</span>&#160;    }</div><div class="line"><a name="l02439"></a><span class="lineno"> 2439</span>&#160;</div><div class="line"><a name="l02440"></a><span class="lineno"> 2440</span>&#160;error:</div><div class="line"><a name="l02441"></a><span class="lineno"> 2441</span>&#160;    <a class="code" href="classstored_1_1_file_layer.html#ab9e526fff86fae14f35909ac23983131">close</a>();</div><div class="line"><a name="l02442"></a><span class="lineno"> 2442</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="classstored_1_1_polled_layer.html#a70378f51cf130ff4aed4dce90a1b403a">setLastError</a>(EIO);</div><div class="line"><a name="l02443"></a><span class="lineno"> 2443</span>&#160;}</div><div class="line"><a name="l02444"></a><span class="lineno"> 2444</span>&#160;</div><div class="line"><a name="l02445"></a><span class="lineno"> 2445</span>&#160;<span class="keywordtype">void</span> <a class="code" href="classstored_1_1_protocol_layer.html#a66c24cec6a17c44fac68213d358a5aa8">StdioLayer::encode</a>(<span class="keywordtype">void</span> <span class="keyword">const</span>* buffer, <span class="keywordtype">size_t</span> len, <span class="keywordtype">bool</span> last) {</div><div class="line"><a name="l02446"></a><span class="lineno"> 2446</span>&#160;    <span class="keywordflow">if</span>(!isValidHandle(<a class="code" href="classstored_1_1_file_layer.html#a4aebe2812c392f4b25d12aa16021a65f">fd_w</a>())) {</div><div class="line"><a name="l02447"></a><span class="lineno"> 2447</span>&#160;        <a class="code" href="classstored_1_1_polled_layer.html#a70378f51cf130ff4aed4dce90a1b403a">setLastError</a>(EBADF);</div><div class="line"><a name="l02448"></a><span class="lineno"> 2448</span>&#160;done:</div><div class="line"><a name="l02449"></a><span class="lineno"> 2449</span>&#160;        <a class="code" href="classstored_1_1_protocol_layer.html#a66c24cec6a17c44fac68213d358a5aa8">base::encode</a>(buffer, len, last);</div><div class="line"><a name="l02450"></a><span class="lineno"> 2450</span>&#160;        <span class="keywordflow">return</span>;</div><div class="line"><a name="l02451"></a><span class="lineno"> 2451</span>&#160;    }</div><div class="line"><a name="l02452"></a><span class="lineno"> 2452</span>&#160;</div><div class="line"><a name="l02453"></a><span class="lineno"> 2453</span>&#160;    <span class="keywordtype">char</span> <span class="keyword">const</span>* buf = <span class="keyword">static_cast&lt;</span><span class="keywordtype">char</span> <a class="code" href="namespaceed2_1_1gui_1_1____main____.html#a3c1fe823c9bbaf7e7dcef9ecc9fcb915">const</a>*<span class="keyword">&gt;</span>(buffer);</div><div class="line"><a name="l02454"></a><span class="lineno"> 2454</span>&#160;    <span class="keywordtype">size_t</span> rem = len;</div><div class="line"><a name="l02455"></a><span class="lineno"> 2455</span>&#160;    <span class="keywordflow">while</span>(rem &gt; 0) {</div><div class="line"><a name="l02456"></a><span class="lineno"> 2456</span>&#160;        DWORD written = 0;</div><div class="line"><a name="l02457"></a><span class="lineno"> 2457</span>&#160;        <span class="keywordflow">if</span>(!WriteFile(<a class="code" href="classstored_1_1_file_layer.html#a4aebe2812c392f4b25d12aa16021a65f">fd_w</a>(), buf, (DWORD)rem, &amp;written, NULL)) {</div><div class="line"><a name="l02458"></a><span class="lineno"> 2458</span>&#160;            <a class="code" href="classstored_1_1_file_layer.html#ab9e526fff86fae14f35909ac23983131">close</a>();</div><div class="line"><a name="l02459"></a><span class="lineno"> 2459</span>&#160;            <a class="code" href="classstored_1_1_polled_layer.html#a70378f51cf130ff4aed4dce90a1b403a">setLastError</a>(EIO);</div><div class="line"><a name="l02460"></a><span class="lineno"> 2460</span>&#160;            <span class="keywordflow">goto</span> done;</div><div class="line"><a name="l02461"></a><span class="lineno"> 2461</span>&#160;        }</div><div class="line"><a name="l02462"></a><span class="lineno"> 2462</span>&#160;</div><div class="line"><a name="l02463"></a><span class="lineno"> 2463</span>&#160;        buf += written;</div><div class="line"><a name="l02464"></a><span class="lineno"> 2464</span>&#160;        rem -= written;</div><div class="line"><a name="l02465"></a><span class="lineno"> 2465</span>&#160;    }</div><div class="line"><a name="l02466"></a><span class="lineno"> 2466</span>&#160;</div><div class="line"><a name="l02467"></a><span class="lineno"> 2467</span>&#160;    <span class="keywordflow">goto</span> done;</div><div class="line"><a name="l02468"></a><span class="lineno"> 2468</span>&#160;}</div><div class="line"><a name="l02469"></a><span class="lineno"> 2469</span>&#160;</div><div class="line"><a name="l02470"></a><span class="lineno"> 2470</span>&#160;<a class="code" href="classstored_1_1_polled_layer.html#a4c9bc21201b7bd79875972d03fc1b7dc">StdioLayer::fd_type</a> <a class="code" href="classstored_1_1_file_layer.html#a58badaa958c01f0f22eaf298788148e8">StdioLayer::fd</a>()<span class="keyword"> const </span>{</div><div class="line"><a name="l02471"></a><span class="lineno"> 2471</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="classstored_1_1_file_layer.html#ac1a3bb7c1dd0c85bde2072288f30024d">fd_r</a>();</div><div class="line"><a name="l02472"></a><span class="lineno"> 2472</span>&#160;}</div><div class="line"><a name="l02473"></a><span class="lineno"> 2473</span>&#160;</div><div class="line"><a name="l02474"></a><span class="lineno"> 2474</span>&#160;<span class="preprocessor">#else // !STORED_OS_WINDOWS</span></div><div class="line"><a name="l02475"></a><span class="lineno"> 2475</span>&#160;</div><div class="line"><a name="l02476"></a><span class="lineno"><a class="line" href="classstored_1_1_stdio_layer.html#aaedb7ea31f9197b59762dcec975d74a5"> 2476</a></span>&#160;<a class="code" href="classstored_1_1_stdio_layer.html#a8b01067593fb46e1ca6a916d12635d32">StdioLayer::StdioLayer</a>(<a class="code" href="classstored_1_1_protocol_layer.html">ProtocolLayer</a>* up, <a class="code" href="classstored_1_1_protocol_layer.html">ProtocolLayer</a>* down)</div><div class="line"><a name="l02477"></a><span class="lineno"> 2477</span>&#160;    : <a class="code" href="classstored_1_1_protocol_layer.html">base</a>(STDIN_FILENO, STDOUT_FILENO, up, down)</div><div class="line"><a name="l02478"></a><span class="lineno"> 2478</span>&#160;{}</div><div class="line"><a name="l02479"></a><span class="lineno"> 2479</span>&#160;</div><div class="line"><a name="l02480"></a><span class="lineno"> 2480</span>&#160;<span class="preprocessor">#endif // !STORED_OS_WINDOWS</span></div><div class="line"><a name="l02481"></a><span class="lineno"> 2481</span>&#160;</div><div class="line"><a name="l02482"></a><span class="lineno"> 2482</span>&#160;</div><div class="line"><a name="l02483"></a><span class="lineno"> 2483</span>&#160;} <span class="comment">// namespace</span></div><div class="line"><a name="l02484"></a><span class="lineno"> 2484</span>&#160;</div><div class="ttc" id="group__libstored__util_html_gaa0672ea7123854cc5f51902a06c473fb"><div class="ttname"><a href="group__libstored__util.html#gaa0672ea7123854cc5f51902a06c473fb">likely</a></div><div class="ttdeci">#define likely(expr)</div><div class="ttdoc">Marks the given expression to likely be evaluated to true. </div><div class="ttdef"><b>Definition:</b> <a href="util_8h_source.html#l00056">util.h:56</a></div></div>
<div class="ttc" id="classstored_1_1_protocol_layer_html_ac7cbd80b10e74166c661582027158b40"><div class="ttname"><a href="classstored_1_1_protocol_layer.html#ac7cbd80b10e74166c661582027158b40">stored::ProtocolLayer::up</a></div><div class="ttdeci">ProtocolLayer * up() const</div><div class="ttdoc">Returns the layer above this one. </div><div class="ttdef"><b>Definition:</b> <a href="protocol_8h_source.html#l00229">protocol.h:229</a></div></div>
<div class="ttc" id="classstored_1_1_arq_layer_html_a335ff281a24fb2aac70b381451589424"><div class="ttname"><a href="classstored_1_1_arq_layer.html#a335ff281a24fb2aac70b381451589424">stored::ArqLayer::NopFlag</a></div><div class="ttdeci">static uint8_t const NopFlag</div><div class="ttdoc">Flag to indicate that the payload should be ignored. </div><div class="ttdef"><b>Definition:</b> <a href="protocol_8h_source.html#l00510">protocol.h:510</a></div></div>
<div class="ttc" id="classstored_1_1_file_layer_html_aa319f69ae9b0d305b60e139ed4a941fa"><div class="ttname"><a href="classstored_1_1_file_layer.html#aa319f69ae9b0d305b60e139ed4a941fa">stored::FileLayer::close_</a></div><div class="ttdeci">void close_()</div><div class="ttdef"><b>Definition:</b> <a href="protocol_8cpp_source.html#l01590">protocol.cpp:1590</a></div></div>
<div class="ttc" id="classstored_1_1_terminal_layer_html_a189c272877b09b93aac1b1ddc96fe58c"><div class="ttname"><a href="classstored_1_1_terminal_layer.html#a189c272877b09b93aac1b1ddc96fe58c">stored::TerminalLayer::decode</a></div><div class="ttdeci">virtual void decode(void *buffer, size_t len) override</div><div class="ttdoc">Decode a frame and forward the decoded frame to the upper layer. </div><div class="ttdef"><b>Definition:</b> <a href="protocol_8cpp_source.html#l00221">protocol.cpp:221</a></div></div>
<div class="ttc" id="classstored_1_1_crc16_layer_html_af23ed68b74cf787171cf53ba75214b79"><div class="ttname"><a href="classstored_1_1_crc16_layer.html#af23ed68b74cf787171cf53ba75214b79">stored::Crc16Layer::Crc16Layer</a></div><div class="ttdeci">Crc16Layer(Crc16Layer const &amp;)=delete</div><div class="ttdoc">Deleted copy constructor. </div></div>
<div class="ttc" id="classstored_1_1_arq_layer_html_ab2f83fa2caaab88f9ee29855b3c527a7"><div class="ttname"><a href="classstored_1_1_arq_layer.html#ab2f83fa2caaab88f9ee29855b3c527a7">stored::ArqLayer::reset</a></div><div class="ttdeci">virtual void reset() override</div><div class="ttdoc">Reset the stack (top-down), and drop all messages. </div><div class="ttdef"><b>Definition:</b> <a href="protocol_8cpp_source.html#l00469">protocol.cpp:469</a></div></div>
<div class="ttc" id="classstored_1_1_polled_layer_html_a70378f51cf130ff4aed4dce90a1b403a"><div class="ttname"><a href="classstored_1_1_polled_layer.html#a70378f51cf130ff4aed4dce90a1b403a">stored::PolledLayer::setLastError</a></div><div class="ttdeci">int setLastError(int e)</div><div class="ttdef"><b>Definition:</b> <a href="protocol_8h_source.html#l00970">protocol.h:970</a></div></div>
<div class="ttc" id="macros_8h_html_aa64cd2b6d63a68c9c8ec5fba4000cf8f"><div class="ttname"><a href="macros_8h.html#aa64cd2b6d63a68c9c8ec5fba4000cf8f">STORED_cplusplus</a></div><div class="ttdeci">#define STORED_cplusplus</div><div class="ttdef"><b>Definition:</b> <a href="macros_8h_source.html#l00038">macros.h:38</a></div></div>
<div class="ttc" id="classstored_1_1_ascii_escape_layer_html_ab8b4f9f1ff917b09cb8853f8605a467c"><div class="ttname"><a href="classstored_1_1_ascii_escape_layer.html#ab8b4f9f1ff917b09cb8853f8605a467c">stored::AsciiEscapeLayer::AsciiEscapeLayer</a></div><div class="ttdeci">AsciiEscapeLayer(AsciiEscapeLayer const &amp;)=delete</div><div class="ttdoc">Deleted copy constructor. </div></div>
<div class="ttc" id="classstored_1_1_arq_layer_html_a8424408abd1c64b603fef6bf1d2b5052"><div class="ttname"><a href="classstored_1_1_arq_layer.html#a8424408abd1c64b603fef6bf1d2b5052">stored::ArqLayer::ArqLayer</a></div><div class="ttdeci">ArqLayer(ArqLayer const &amp;)=delete</div><div class="ttdoc">Deleted copy constructor. </div></div>
<div class="ttc" id="classstored_1_1_arq_layer_html_ad8b06247c0e2efa0f54c8a1addac8e2d"><div class="ttname"><a href="classstored_1_1_arq_layer.html#ad8b06247c0e2efa0f54c8a1addac8e2d">stored::ArqLayer::shrink_to_fit</a></div><div class="ttdeci">void shrink_to_fit()</div><div class="ttdoc">Free all unused memory. </div><div class="ttdef"><b>Definition:</b> <a href="protocol_8cpp_source.html#l00771">protocol.cpp:771</a></div></div>
<div class="ttc" id="classstored_1_1_file_layer_html_add1204842977b02378bba7b8ae4f122fa2927e7823f567f182fe3f7f28e9f9abf"><div class="ttname"><a href="classstored_1_1_file_layer.html#add1204842977b02378bba7b8ae4f122fa2927e7823f567f182fe3f7f28e9f9abf">stored::FileLayer::BufferSize</a></div><div class="ttdef"><b>Definition:</b> <a href="protocol_8h_source.html#l00985">protocol.h:985</a></div></div>
<div class="ttc" id="classstored_1_1_terminal_layer_html_aa520c45c348439dbf7a56f511bd5ac39"><div class="ttname"><a href="classstored_1_1_terminal_layer.html#aa520c45c348439dbf7a56f511bd5ac39">stored::TerminalLayer::reset</a></div><div class="ttdeci">virtual void reset() override</div><div class="ttdoc">Reset the stack (top-down), and drop all messages. </div><div class="ttdef"><b>Definition:</b> <a href="protocol_8cpp_source.html#l00209">protocol.cpp:209</a></div></div>
<div class="ttc" id="classstored_1_1_terminal_layer_html_ae159ad7d286f1f1f456f4fe42e9955b7"><div class="ttname"><a href="classstored_1_1_terminal_layer.html#ae159ad7d286f1f1f456f4fe42e9955b7">stored::TerminalLayer::TerminalLayer</a></div><div class="ttdeci">TerminalLayer(TerminalLayer const &amp;)=delete</div><div class="ttdoc">Deleted copy constructor. </div></div>
<div class="ttc" id="classstored_1_1_file_layer_html_a53480909edeb9ba1c033552dc27fe309"><div class="ttname"><a href="classstored_1_1_file_layer.html#a53480909edeb9ba1c033552dc27fe309">stored::FileLayer::init</a></div><div class="ttdeci">void init(fd_type fd_r, fd_type fd_w)</div><div class="ttdef"><b>Definition:</b> <a href="protocol_8cpp_source.html#l01567">protocol.cpp:1567</a></div></div>
<div class="ttc" id="classstored_1_1_polled_layer_html_a52a33d958169ab79bd11efc34cc2f0c9"><div class="ttname"><a href="classstored_1_1_polled_layer.html#a52a33d958169ab79bd11efc34cc2f0c9">stored::PolledLayer::poller</a></div><div class="ttdeci">Poller &amp; poller()</div><div class="ttdef"><b>Definition:</b> <a href="protocol_8cpp_source.html#l01496">protocol.cpp:1496</a></div></div>
<div class="ttc" id="classstored_1_1_ascii_escape_layer_html_a3387a996b07c01ff22e8fadecda9277d"><div class="ttname"><a href="classstored_1_1_ascii_escape_layer.html#a3387a996b07c01ff22e8fadecda9277d">stored::AsciiEscapeLayer::Esc</a></div><div class="ttdeci">static char const Esc</div><div class="ttdef"><b>Definition:</b> <a href="protocol_8h_source.html#l00334">protocol.h:334</a></div></div>
<div class="ttc" id="classstored_1_1_protocol_layer_html_ac9a6113262899388f922a6d466e9245a"><div class="ttname"><a href="classstored_1_1_protocol_layer.html#ac9a6113262899388f922a6d466e9245a">stored::ProtocolLayer::down</a></div><div class="ttdeci">ProtocolLayer * down() const</div><div class="ttdoc">Returns the layer below this one. </div><div class="ttdef"><b>Definition:</b> <a href="protocol_8h_source.html#l00235">protocol.h:235</a></div></div>
<div class="ttc" id="classstored_1_1_terminal_layer_html_a641d9407a8c7517bcbfb3748b86fa43d"><div class="ttname"><a href="classstored_1_1_terminal_layer.html#a641d9407a8c7517bcbfb3748b86fa43d">stored::TerminalLayer::EscStart</a></div><div class="ttdeci">static char const EscStart</div><div class="ttdef"><b>Definition:</b> <a href="protocol_8h_source.html#l00369">protocol.h:369</a></div></div>
<div class="ttc" id="classstored_1_1_terminal_layer_html_a9c91e6d99a16671d0e78c120288a1bda"><div class="ttname"><a href="classstored_1_1_terminal_layer.html#a9c91e6d99a16671d0e78c120288a1bda">stored::TerminalLayer::~TerminalLayer</a></div><div class="ttdeci">virtual ~TerminalLayer() override</div><div class="ttdoc">Destructor. </div></div>
<div class="ttc" id="classstored_1_1_segmentation_layer_html_adee6ee8d098ff67655b36c1ab269d490"><div class="ttname"><a href="classstored_1_1_segmentation_layer.html#adee6ee8d098ff67655b36c1ab269d490">stored::SegmentationLayer::decode</a></div><div class="ttdeci">virtual void decode(void *buffer, size_t len) override</div><div class="ttdoc">Decode a frame and forward the decoded frame to the upper layer. </div><div class="ttdef"><b>Definition:</b> <a href="protocol_8cpp_source.html#l00366">protocol.cpp:366</a></div></div>
<div class="ttc" id="classstored_1_1impl_1_1_loopback1_html_aa11ce490e7cb0f959dc692f78305cc5c"><div class="ttname"><a href="classstored_1_1impl_1_1_loopback1.html#aa11ce490e7cb0f959dc692f78305cc5c">stored::impl::Loopback1::~Loopback1</a></div><div class="ttdeci">~Loopback1() override final</div><div class="ttdoc">Destructor. </div><div class="ttdef"><b>Definition:</b> <a href="protocol_8cpp_source.html#l01394">protocol.cpp:1394</a></div></div>
<div class="ttc" id="classstored_1_1_protocol_layer_html_a43ca79c4b9503ce51f817ddc7fcd1cb5"><div class="ttname"><a href="classstored_1_1_protocol_layer.html#a43ca79c4b9503ce51f817ddc7fcd1cb5">stored::ProtocolLayer::setUp</a></div><div class="ttdeci">void setUp(ProtocolLayer *up)</div><div class="ttdoc">Change the layer that receives our decoded frames. </div><div class="ttdef"><b>Definition:</b> <a href="protocol_8h_source.html#l00181">protocol.h:181</a></div></div>
<div class="ttc" id="group__libstored__util_html_gab750e51b876450a0a4ad419588a82a4d"><div class="ttname"><a href="group__libstored__util.html#gab750e51b876450a0a4ad419588a82a4d">stored_assert</a></div><div class="ttdeci">#define stored_assert(expr)</div><div class="ttdoc">Like assert(), but only emits code when stored::Config::EnableAssert. </div><div class="ttdef"><b>Definition:</b> <a href="util_8h_source.html#l00185">util.h:185</a></div></div>
<div class="ttc" id="classstored_1_1_protocol_layer_html_a900026e43f2374c28e0cefcb6e002751"><div class="ttname"><a href="classstored_1_1_protocol_layer.html#a900026e43f2374c28e0cefcb6e002751">stored::ProtocolLayer::~ProtocolLayer</a></div><div class="ttdeci">virtual ~ProtocolLayer()</div><div class="ttdoc">Destructor. </div><div class="ttdef"><b>Definition:</b> <a href="protocol_8cpp_source.html#l00052">protocol.cpp:52</a></div></div>
<div class="ttc" id="classstored_1_1_file_layer_html"><div class="ttname"><a href="classstored_1_1_file_layer.html">stored::FileLayer</a></div><div class="ttdef"><b>Definition:</b> <a href="protocol_8h_source.html#l00979">protocol.h:979</a></div></div>
<div class="ttc" id="classstored_1_1_debug_arq_layer_html_ac5dab34e5ae9a79154eba3265be14bd1"><div class="ttname"><a href="classstored_1_1_debug_arq_layer.html#ac5dab34e5ae9a79154eba3265be14bd1">stored::DebugArqLayer::nextSeq</a></div><div class="ttdeci">static uint32_t nextSeq(uint32_t seq)</div><div class="ttdoc">Compute the successive sequence number. </div><div class="ttdef"><b>Definition:</b> <a href="protocol_8cpp_source.html#l01030">protocol.cpp:1030</a></div></div>
<div class="ttc" id="classstored_1_1impl_1_1_loopback1_html_a467b311cc00912a44ad9a1af3a901274a594188343a255bdf58034bdc4eaa2ac2"><div class="ttname"><a href="classstored_1_1impl_1_1_loopback1.html#a467b311cc00912a44ad9a1af3a901274a594188343a255bdf58034bdc4eaa2ac2">stored::impl::Loopback1::ExtraAlloc</a></div><div class="ttdef"><b>Definition:</b> <a href="protocol_8h_source.html#l00901">protocol.h:901</a></div></div>
<div class="ttc" id="classstored_1_1_ascii_escape_layer_html_a61f7a9fd55a71c7c6c73a0ff3d73b612"><div class="ttname"><a href="classstored_1_1_ascii_escape_layer.html#a61f7a9fd55a71c7c6c73a0ff3d73b612">stored::AsciiEscapeLayer::EscMask</a></div><div class="ttdeci">static char const EscMask</div><div class="ttdef"><b>Definition:</b> <a href="protocol_8h_source.html#l00335">protocol.h:335</a></div></div>
<div class="ttc" id="classstored_1_1_arq_layer_html_a1efacad0bccc60d7d202663ce984aab2"><div class="ttname"><a href="classstored_1_1_arq_layer.html#a1efacad0bccc60d7d202663ce984aab2">stored::ArqLayer::mtu</a></div><div class="ttdeci">virtual size_t mtu() const override</div><div class="ttdoc">Returns the maximum amount of data to be put in one message that is encoded. </div><div class="ttdef"><b>Definition:</b> <a href="protocol_8cpp_source.html#l00641">protocol.cpp:641</a></div></div>
<div class="ttc" id="classstored_1_1_crc16_layer_html_a00610c4aeabd33c565f5331a5aef3e01"><div class="ttname"><a href="classstored_1_1_crc16_layer.html#a00610c4aeabd33c565f5331a5aef3e01">stored::Crc16Layer::reset</a></div><div class="ttdeci">virtual void reset() override</div><div class="ttdoc">Reset the stack (top-down), and drop all messages. </div><div class="ttdef"><b>Definition:</b> <a href="protocol_8cpp_source.html#l01203">protocol.cpp:1203</a></div></div>
<div class="ttc" id="classstored_1_1_arq_layer_html_a1d3b18fc5b159e527b087385ac961e52afec9d8b5d2c8fe338525458da4909a48"><div class="ttname"><a href="classstored_1_1_arq_layer.html#a1d3b18fc5b159e527b087385ac961e52afec9d8b5d2c8fe338525458da4909a48">stored::ArqLayer::EventEncodeBufferOverflow</a></div><div class="ttdoc">The maximum buffer capactiy has passed. </div><div class="ttdef"><b>Definition:</b> <a href="protocol_8h_source.html#l00552">protocol.h:552</a></div></div>
<div class="ttc" id="namespacestd_html"><div class="ttname"><a href="namespacestd.html">std</a></div><div class="ttdoc">STL namespace. </div></div>
<div class="ttc" id="group__libstored__util_html_gad8700448546b3b5111404cc021061fd5"><div class="ttname"><a href="group__libstored__util.html#gad8700448546b3b5111404cc021061fd5">unlikely</a></div><div class="ttdeci">#define unlikely(expr)</div><div class="ttdoc">Marks the given expression to likely be evaluated to true. </div><div class="ttdef"><b>Definition:</b> <a href="util_8h_source.html#l00071">util.h:71</a></div></div>
<div class="ttc" id="classstored_1_1_segmentation_layer_html_a36b6e6bf8545558a5e1c95c9a3bbcd27"><div class="ttname"><a href="classstored_1_1_segmentation_layer.html#a36b6e6bf8545558a5e1c95c9a3bbcd27">stored::SegmentationLayer::ContinueMarker</a></div><div class="ttdeci">static char const ContinueMarker</div><div class="ttdef"><b>Definition:</b> <a href="protocol_8h_source.html#l00442">protocol.h:442</a></div></div>
<div class="ttc" id="classstored_1_1_arq_layer_html_a7fc718f8b8c05aef735e2c861535eabc"><div class="ttname"><a href="classstored_1_1_arq_layer.html#a7fc718f8b8c05aef735e2c861535eabc">stored::ArqLayer::retransmits</a></div><div class="ttdeci">size_t retransmits() const</div><div class="ttdoc">Returns the number of consecutive retransmits of the same message. </div><div class="ttdef"><b>Definition:</b> <a href="protocol_8cpp_source.html#l00681">protocol.cpp:681</a></div></div>
<div class="ttc" id="classstored_1_1_arq_layer_html_a57d385c32e28f7684d75567aeca702f4"><div class="ttname"><a href="classstored_1_1_arq_layer.html#a57d385c32e28f7684d75567aeca702f4">stored::ArqLayer::waitingForAck</a></div><div class="ttdeci">bool waitingForAck() const</div><div class="ttdoc">Checks if this layer is waiting for an ack. </div><div class="ttdef"><b>Definition:</b> <a href="protocol_8cpp_source.html#l00539">protocol.cpp:539</a></div></div>
<div class="ttc" id="namespaceed2_1_1gui_1_1____main_____html_a3c1fe823c9bbaf7e7dcef9ecc9fcb915"><div class="ttname"><a href="namespaceed2_1_1gui_1_1____main____.html#a3c1fe823c9bbaf7e7dcef9ecc9fcb915">ed2.gui.__main__.const</a></div><div class="ttdeci">const</div><div class="ttdef"><b>Definition:</b> <a href="build_2lib_2ed2_2gui_2____main_____8py_source.html#l00124">__main__.py:124</a></div></div>
<div class="ttc" id="classstored_1_1_protocol_layer_html_a654466d2b7502efdbd5b1b1e95263194"><div class="ttname"><a href="classstored_1_1_protocol_layer.html#a654466d2b7502efdbd5b1b1e95263194">stored::ProtocolLayer::flush</a></div><div class="ttdeci">virtual bool flush()</div><div class="ttdoc">Flushes all buffered message out of the stack (top-down), if possible. </div><div class="ttdef"><b>Definition:</b> <a href="protocol_8h_source.html#l00306">protocol.h:306</a></div></div>
<div class="ttc" id="classstored_1_1_crc16_layer_html_a4b48d4c95eb8f590ab7428e94221197b"><div class="ttname"><a href="classstored_1_1_crc16_layer.html#a4b48d4c95eb8f590ab7428e94221197b">stored::Crc16Layer::compute</a></div><div class="ttdeci">static uint16_t compute(uint8_t input, uint16_t crc=init)</div><div class="ttdef"><b>Definition:</b> <a href="protocol_8cpp_source.html#l01238">protocol.cpp:1238</a></div></div>
<div class="ttc" id="classstored_1_1_protocol_layer_html_a2b2523892617a43cf7421a654bfc3b6c"><div class="ttname"><a href="classstored_1_1_protocol_layer.html#a2b2523892617a43cf7421a654bfc3b6c">stored::ProtocolLayer::setDown</a></div><div class="ttdeci">void setDown(ProtocolLayer *down)</div><div class="ttdoc">Change the layer that receives our encoded frames. </div><div class="ttdef"><b>Definition:</b> <a href="protocol_8h_source.html#l00187">protocol.h:187</a></div></div>
<div class="ttc" id="classstored_1_1_crc16_layer_html_a58ea0fcf8981aa38941947c057f00ffaaeb8e182958fd03c1968f253e0bcb11c6"><div class="ttname"><a href="classstored_1_1_crc16_layer.html#a58ea0fcf8981aa38941947c057f00ffaaeb8e182958fd03c1968f253e0bcb11c6">stored::Crc16Layer::init</a></div><div class="ttdef"><b>Definition:</b> <a href="protocol_8h_source.html#l00818">protocol.h:818</a></div></div>
<div class="ttc" id="classstored_1_1_arq_layer_html_a6d481c24d715ceef8dcc2fd9cd19eab1"><div class="ttname"><a href="classstored_1_1_arq_layer.html#a6d481c24d715ceef8dcc2fd9cd19eab1">stored::ArqLayer::SeqMask</a></div><div class="ttdeci">static uint8_t const SeqMask</div><div class="ttdoc">Mask for sequence number. </div><div class="ttdef"><b>Definition:</b> <a href="protocol_8h_source.html#l00512">protocol.h:512</a></div></div>
<div class="ttc" id="classstored_1_1_stdio_layer_html_a8b01067593fb46e1ca6a916d12635d32"><div class="ttname"><a href="classstored_1_1_stdio_layer.html#a8b01067593fb46e1ca6a916d12635d32">stored::StdioLayer::StdioLayer</a></div><div class="ttdeci">StdioLayer(StdioLayer const &amp;)=delete</div><div class="ttdoc">Deleted copy constructor. </div></div>
<div class="ttc" id="classstored_1_1_terminal_layer_html_a0a19f65b341e78a98dca4f13747fb2a7"><div class="ttname"><a href="classstored_1_1_terminal_layer.html#a0a19f65b341e78a98dca4f13747fb2a7">stored::TerminalLayer::mtu</a></div><div class="ttdeci">virtual size_t mtu() const override</div><div class="ttdoc">Returns the maximum amount of data to be put in one message that is encoded. </div><div class="ttdef"><b>Definition:</b> <a href="protocol_8cpp_source.html#l00314">protocol.cpp:314</a></div></div>
<div class="ttc" id="classstored_1_1_arq_layer_html_a7e32f0946f88adc172b501b335c68632"><div class="ttname"><a href="classstored_1_1_arq_layer.html#a7e32f0946f88adc172b501b335c68632">stored::ArqLayer::pushEncodeQueueRaw</a></div><div class="ttdeci">std::string &amp; pushEncodeQueueRaw()</div><div class="ttdoc">Adds an entry in the encode queue, but do not populate the contents. </div><div class="ttdef"><b>Definition:</b> <a href="protocol_8cpp_source.html#l00739">protocol.cpp:739</a></div></div>
<div class="ttc" id="macros_8h_html_af17ee1aea7e7e70c19dc325e02552ed0"><div class="ttname"><a href="macros_8h.html#af17ee1aea7e7e70c19dc325e02552ed0">UNUSED_PAR</a></div><div class="ttdeci">#define UNUSED_PAR(name)</div><div class="ttdef"><b>Definition:</b> <a href="macros_8h_source.html#l00077">macros.h:77</a></div></div>
<div class="ttc" id="protocol_8h_html"><div class="ttname"><a href="protocol_8h.html">protocol.h</a></div></div>
<div class="ttc" id="namespacesetup_html_ab3a7a0638d76a01367c5bc3cc699447f"><div class="ttname"><a href="namespacesetup.html#ab3a7a0638d76a01367c5bc3cc699447f">setup.name</a></div><div class="ttdeci">name</div><div class="ttdef"><b>Definition:</b> <a href="setup_8py_source.html#l00015">setup.py:15</a></div></div>
<div class="ttc" id="classstored_1_1_debug_arq_layer_html_adb2ab020fb7e6aeca00c97be9545ced7"><div class="ttname"><a href="classstored_1_1_debug_arq_layer.html#adb2ab020fb7e6aeca00c97be9545ced7">stored::DebugArqLayer::mtu</a></div><div class="ttdeci">virtual size_t mtu() const override</div><div class="ttdoc">Returns the maximum amount of data to be put in one message that is encoded. </div><div class="ttdef"><b>Definition:</b> <a href="protocol_8cpp_source.html#l01018">protocol.cpp:1018</a></div></div>
<div class="ttc" id="classstored_1_1_poller_html_a563ec33f78322f6d39047dae05df0a4c"><div class="ttname"><a href="classstored_1_1_poller.html#a563ec33f78322f6d39047dae05df0a4c">stored::Poller::PollOut</a></div><div class="ttdeci">static events_t const PollOut</div><div class="ttdef"><b>Definition:</b> <a href="poller_8h_source.html#l00103">poller.h:103</a></div></div>
<div class="ttc" id="classstored_1_1_arq_layer_html_a5afc54c8eec96b06ba9c0a99d4dca7c1adc66734e4631a5349dcaba9bcf8dd524"><div class="ttname"><a href="classstored_1_1_arq_layer.html#a5afc54c8eec96b06ba9c0a99d4dca7c1adc66734e4631a5349dcaba9bcf8dd524">stored::ArqLayer::EncodeStateIdle</a></div><div class="ttdef"><b>Definition:</b> <a href="protocol_8h_source.html#l00612">protocol.h:612</a></div></div>
<div class="ttc" id="classstored_1_1_file_layer_html_a4c9bc21201b7bd79875972d03fc1b7dc"><div class="ttname"><a href="classstored_1_1_file_layer.html#a4c9bc21201b7bd79875972d03fc1b7dc">stored::FileLayer::fd_type</a></div><div class="ttdeci">int fd_type</div><div class="ttdef"><b>Definition:</b> <a href="protocol_8h_source.html#l00942">protocol.h:942</a></div></div>
<div class="ttc" id="classstored_1_1_file_layer_html_a58badaa958c01f0f22eaf298788148e8"><div class="ttname"><a href="classstored_1_1_file_layer.html#a58badaa958c01f0f22eaf298788148e8">stored::FileLayer::fd</a></div><div class="ttdeci">virtual fd_type fd() const override</div><div class="ttdef"><b>Definition:</b> <a href="protocol_8cpp_source.html#l01661">protocol.cpp:1661</a></div></div>
<div class="ttc" id="classstored_1_1_arq_layer_html_a1b2f96a8e25063dbf2631c5d2c765920"><div class="ttname"><a href="classstored_1_1_arq_layer.html#a1b2f96a8e25063dbf2631c5d2c765920">stored::ArqLayer::popEncodeQueue</a></div><div class="ttdeci">void popEncodeQueue()</div><div class="ttdoc">Drop front of encode queue. </div><div class="ttdef"><b>Definition:</b> <a href="protocol_8cpp_source.html#l00708">protocol.cpp:708</a></div></div>
<div class="ttc" id="classstored_1_1_segmentation_layer_html_a67b205f77f8a2517e16db48cc052ea27"><div class="ttname"><a href="classstored_1_1_segmentation_layer.html#a67b205f77f8a2517e16db48cc052ea27">stored::SegmentationLayer::lowerMtu</a></div><div class="ttdeci">size_t lowerMtu() const</div><div class="ttdoc">Returns the MTU used to split messages into. </div><div class="ttdef"><b>Definition:</b> <a href="protocol_8cpp_source.html#l00356">protocol.cpp:356</a></div></div>
<div class="ttc" id="classstored_1_1_debug_arq_layer_html_a0a71050aa34e149b3fd0a326c16d5c6a"><div class="ttname"><a href="classstored_1_1_debug_arq_layer.html#a0a71050aa34e149b3fd0a326c16d5c6a">stored::DebugArqLayer::decodeSeq</a></div><div class="ttdeci">static uint32_t decodeSeq(uint8_t *&amp;buffer, size_t &amp;len)</div><div class="ttdoc">Decode the sequence number from a buffer. </div><div class="ttdef"><b>Definition:</b> <a href="protocol_8cpp_source.html#l01038">protocol.cpp:1038</a></div></div>
<div class="ttc" id="classstored_1_1_ascii_escape_layer_html_ac773513d7ef5330f9fc7b46f08e79442"><div class="ttname"><a href="classstored_1_1_ascii_escape_layer.html#ac773513d7ef5330f9fc7b46f08e79442">stored::AsciiEscapeLayer::mtu</a></div><div class="ttdeci">virtual size_t mtu() const override</div><div class="ttdoc">Returns the maximum amount of data to be put in one message that is encoded. </div><div class="ttdef"><b>Definition:</b> <a href="protocol_8cpp_source.html#l00168">protocol.cpp:168</a></div></div>
<div class="ttc" id="classstored_1_1_poller_html"><div class="ttname"><a href="classstored_1_1_poller.html">stored::Poller</a></div><div class="ttdoc">A generic way of poll() for any blockable resource. </div><div class="ttdef"><b>Definition:</b> <a href="poller_8h_source.html#l00096">poller.h:96</a></div></div>
<div class="ttc" id="classstored_1_1_file_layer_html_af12a800260514618e1ef49179a78dbd1"><div class="ttname"><a href="classstored_1_1_file_layer.html#af12a800260514618e1ef49179a78dbd1">stored::FileLayer::recv</a></div><div class="ttdeci">virtual int recv(bool block=false) override</div><div class="ttdef"><b>Definition:</b> <a href="protocol_8cpp_source.html#l01673">protocol.cpp:1673</a></div></div>
<div class="ttc" id="classstored_1_1_polled_layer_html_a79de5a08490722c111347ed8274d0f3a"><div class="ttname"><a href="classstored_1_1_polled_layer.html#a79de5a08490722c111347ed8274d0f3a">stored::PolledLayer::block</a></div><div class="ttdeci">virtual int block(fd_type fd, bool forReading, bool suspend=false)</div><div class="ttdef"><b>Definition:</b> <a href="protocol_8cpp_source.html#l01454">protocol.cpp:1454</a></div></div>
<div class="ttc" id="classstored_1_1_arq_layer_html_ab1d2c6282a3ecad2e561ddb517421b09"><div class="ttname"><a href="classstored_1_1_arq_layer.html#ab1d2c6282a3ecad2e561ddb517421b09">stored::ArqLayer::keepAlive</a></div><div class="ttdeci">void keepAlive()</div><div class="ttdoc">Send a keep-alive packet to check the connection. </div><div class="ttdef"><b>Definition:</b> <a href="protocol_8cpp_source.html#l00693">protocol.cpp:693</a></div></div>
<div class="ttc" id="classstored_1_1_file_layer_html_ab9e526fff86fae14f35909ac23983131"><div class="ttname"><a href="classstored_1_1_file_layer.html#ab9e526fff86fae14f35909ac23983131">stored::FileLayer::close</a></div><div class="ttdeci">virtual void close() override</div><div class="ttdef"><b>Definition:</b> <a href="protocol_8cpp_source.html#l01586">protocol.cpp:1586</a></div></div>
<div class="ttc" id="classstored_1_1_polled_layer_html_a4c9bc21201b7bd79875972d03fc1b7dc"><div class="ttname"><a href="classstored_1_1_polled_layer.html#a4c9bc21201b7bd79875972d03fc1b7dc">stored::PolledLayer::fd_type</a></div><div class="ttdeci">int fd_type</div><div class="ttdef"><b>Definition:</b> <a href="protocol_8h_source.html#l00942">protocol.h:942</a></div></div>
<div class="ttc" id="classstored_1_1_arq_layer_html_abf63088fb9952dcc6599a023d0491d12"><div class="ttname"><a href="classstored_1_1_arq_layer.html#abf63088fb9952dcc6599a023d0491d12">stored::ArqLayer::flush</a></div><div class="ttdeci">virtual bool flush() override</div><div class="ttdoc">Flushes all buffered message out of the stack (top-down), if possible. </div><div class="ttdef"><b>Definition:</b> <a href="protocol_8cpp_source.html#l00576">protocol.cpp:576</a></div></div>
<div class="ttc" id="classstored_1_1_arq_layer_html_ad385593c1549539ec000943046860404"><div class="ttname"><a href="classstored_1_1_arq_layer.html#ad385593c1549539ec000943046860404">stored::ArqLayer::resetDidTransmit</a></div><div class="ttdeci">void resetDidTransmit()</div><div class="ttdoc">Reset the flag for didTransmit(). </div><div class="ttdef"><b>Definition:</b> <a href="protocol_8cpp_source.html#l00671">protocol.cpp:671</a></div></div>
<div class="ttc" id="classstored_1_1_file_layer_html_addb5cf9fb3707fa3da6dbf092faa0d82"><div class="ttname"><a href="classstored_1_1_file_layer.html#addb5cf9fb3707fa3da6dbf092faa0d82">stored::FileLayer::~FileLayer</a></div><div class="ttdeci">virtual ~FileLayer() override</div><div class="ttdef"><b>Definition:</b> <a href="protocol_8cpp_source.html#l01582">protocol.cpp:1582</a></div></div>
<div class="ttc" id="classstored_1_1_arq_layer_html_a4af8faa0449d4c0c048be13a0d250384"><div class="ttname"><a href="classstored_1_1_arq_layer.html#a4af8faa0449d4c0c048be13a0d250384">stored::ArqLayer::AckFlag</a></div><div class="ttdeci">static uint8_t const AckFlag</div><div class="ttdoc">Ack flag. </div><div class="ttdef"><b>Definition:</b> <a href="protocol_8h_source.html#l00511">protocol.h:511</a></div></div>
<div class="ttc" id="classstored_1_1_segmentation_layer_html_aba07293a3674e525d3ee929eebd3db10"><div class="ttname"><a href="classstored_1_1_segmentation_layer.html#aba07293a3674e525d3ee929eebd3db10">stored::SegmentationLayer::SegmentationLayer</a></div><div class="ttdeci">SegmentationLayer(SegmentationLayer const &amp;)=delete</div><div class="ttdoc">Deleted copy constructor. </div></div>
<div class="ttc" id="classstored_1_1_segmentation_layer_html_a5cd64512cd57378cf25bd2890266919a"><div class="ttname"><a href="classstored_1_1_segmentation_layer.html#a5cd64512cd57378cf25bd2890266919a">stored::SegmentationLayer::mtu</a></div><div class="ttdeci">size_t mtu() const final</div><div class="ttdoc">Returns the maximum amount of data to be put in one message that is encoded. </div><div class="ttdef"><b>Definition:</b> <a href="protocol_8cpp_source.html#l00348">protocol.cpp:348</a></div></div>
<div class="ttc" id="classstored_1_1_loopback_html_a26f5377becabea23ff50ff180c52a6d8"><div class="ttname"><a href="classstored_1_1_loopback.html#a26f5377becabea23ff50ff180c52a6d8">stored::Loopback::Loopback</a></div><div class="ttdeci">Loopback(Loopback const &amp;)=delete</div><div class="ttdoc">Deleted copy constructor. </div></div>
<div class="ttc" id="classstored_1_1_buffer_layer_html_a587c9ead02b35cfadabe5ea931a8874d"><div class="ttname"><a href="classstored_1_1_buffer_layer.html#a587c9ead02b35cfadabe5ea931a8874d">stored::BufferLayer::BufferLayer</a></div><div class="ttdeci">BufferLayer(BufferLayer const &amp;)=delete</div><div class="ttdoc">Deleted copy constructor. </div></div>
<div class="ttc" id="classstored_1_1_terminal_layer_html_a892633ca69a59684c9a964600c0cc181"><div class="ttname"><a href="classstored_1_1_terminal_layer.html#a892633ca69a59684c9a964600c0cc181">stored::TerminalLayer::Esc</a></div><div class="ttdeci">static char const Esc</div><div class="ttdef"><b>Definition:</b> <a href="protocol_8h_source.html#l00368">protocol.h:368</a></div></div>
<div class="ttc" id="classstored_1_1_crc16_layer_html_a82d88b7503bdb383c9416e2a0cad8503"><div class="ttname"><a href="classstored_1_1_crc16_layer.html#a82d88b7503bdb383c9416e2a0cad8503">stored::Crc16Layer::mtu</a></div><div class="ttdeci">virtual size_t mtu() const override</div><div class="ttdoc">Returns the maximum amount of data to be put in one message that is encoded. </div><div class="ttdef"><b>Definition:</b> <a href="protocol_8cpp_source.html#l01243">protocol.cpp:1243</a></div></div>
<div class="ttc" id="classstored_1_1_file_layer_html_a62a89dd5d15ce541bccdab3c2c8326d1"><div class="ttname"><a href="classstored_1_1_file_layer.html#a62a89dd5d15ce541bccdab3c2c8326d1">stored::FileLayer::base</a></div><div class="ttdeci">PolledLayer base</div><div class="ttdef"><b>Definition:</b> <a href="protocol_8h_source.html#l00982">protocol.h:982</a></div></div>
<div class="ttc" id="classstored_1_1_protocol_layer_html_a88195d7cdb7129ac7bc625ffeb24d449"><div class="ttname"><a href="classstored_1_1_protocol_layer.html#a88195d7cdb7129ac7bc625ffeb24d449">stored::ProtocolLayer::mtu</a></div><div class="ttdeci">virtual size_t mtu() const</div><div class="ttdoc">Returns the maximum amount of data to be put in one message that is encoded. </div><div class="ttdef"><b>Definition:</b> <a href="protocol_8h_source.html#l00293">protocol.h:293</a></div></div>
<div class="ttc" id="classstored_1_1_protocol_layer_html_a8e8b913345f11bf3cf3999c305905681"><div class="ttname"><a href="classstored_1_1_protocol_layer.html#a8e8b913345f11bf3cf3999c305905681">stored::ProtocolLayer::setPurgeableResponse</a></div><div class="ttdeci">virtual void setPurgeableResponse(bool purgeable=true)</div><div class="ttdoc">Flags the current response as purgeable. </div><div class="ttdef"><b>Definition:</b> <a href="protocol_8h_source.html#l00279">protocol.h:279</a></div></div>
<div class="ttc" id="classstored_1_1_polled_layer_html_a988e642fff4f1ee1ec3c8557be8bc0bf"><div class="ttname"><a href="classstored_1_1_polled_layer.html#a988e642fff4f1ee1ec3c8557be8bc0bf">stored::PolledLayer::recv</a></div><div class="ttdeci">virtual int recv(bool block=false)=0</div></div>
<div class="ttc" id="classstored_1_1_debug_arq_layer_html_ab96014cb5967321bc4d06871d5f7a727"><div class="ttname"><a href="classstored_1_1_debug_arq_layer.html#ab96014cb5967321bc4d06871d5f7a727">stored::DebugArqLayer::DebugArqLayer</a></div><div class="ttdeci">DebugArqLayer(DebugArqLayer const &amp;)=delete</div><div class="ttdoc">Deleted copy constructor. </div></div>
<div class="ttc" id="classstored_1_1_protocol_layer_html_a53fe78a7b405b981649112d9c84fe762"><div class="ttname"><a href="classstored_1_1_protocol_layer.html#a53fe78a7b405b981649112d9c84fe762">stored::ProtocolLayer::reset</a></div><div class="ttdeci">virtual void reset()</div><div class="ttdoc">Reset the stack (top-down), and drop all messages. </div><div class="ttdef"><b>Definition:</b> <a href="protocol_8h_source.html#l00313">protocol.h:313</a></div></div>
<div class="ttc" id="classstored_1_1_polled_layer_html_a5f93b36636abab8f4cacb5f1b4fbcd82"><div class="ttname"><a href="classstored_1_1_polled_layer.html#a5f93b36636abab8f4cacb5f1b4fbcd82">stored::PolledLayer::lastError</a></div><div class="ttdeci">int lastError() const</div><div class="ttdef"><b>Definition:</b> <a href="protocol_8h_source.html#l00955">protocol.h:955</a></div></div>
<div class="ttc" id="classstored_1_1_arq_layer_html_afbab2b5061d597434e4e1f6620bb110f"><div class="ttname"><a href="classstored_1_1_arq_layer.html#afbab2b5061d597434e4e1f6620bb110f">stored::ArqLayer::~ArqLayer</a></div><div class="ttdeci">virtual ~ArqLayer() override</div><div class="ttdoc">Dtor. </div><div class="ttdef"><b>Definition:</b> <a href="protocol_8cpp_source.html#l00462">protocol.cpp:462</a></div></div>
<div class="ttc" id="classstored_1_1_file_layer_html_af0f0a290b2bb5209b825ad8dd29e7ff0"><div class="ttname"><a href="classstored_1_1_file_layer.html#af0f0a290b2bb5209b825ad8dd29e7ff0">stored::FileLayer::FileLayer</a></div><div class="ttdeci">FileLayer(FileLayer const &amp;)=delete</div><div class="ttdoc">Deleted copy constructor. </div></div>
<div class="ttc" id="poller_8h_html"><div class="ttname"><a href="poller_8h.html">poller.h</a></div></div>
<div class="ttc" id="classstored_1_1_segmentation_layer_html_a85ac4ba426a9e49f2f8c1d14785bcc24"><div class="ttname"><a href="classstored_1_1_segmentation_layer.html#a85ac4ba426a9e49f2f8c1d14785bcc24">stored::SegmentationLayer::EndMarker</a></div><div class="ttdeci">static char const EndMarker</div><div class="ttdef"><b>Definition:</b> <a href="protocol_8h_source.html#l00443">protocol.h:443</a></div></div>
<div class="ttc" id="classstored_1_1_stdio_layer_html_ae8cbdf2cc3bf4c8b35b8685854c4035a"><div class="ttname"><a href="classstored_1_1_stdio_layer.html#ae8cbdf2cc3bf4c8b35b8685854c4035a">stored::StdioLayer::~StdioLayer</a></div><div class="ttdeci">virtual ~StdioLayer() override=default</div></div>
<div class="ttc" id="classstored_1_1_buffer_layer_html_a106b4baa477a0fac388215fc87a54fd4"><div class="ttname"><a href="classstored_1_1_buffer_layer.html#a106b4baa477a0fac388215fc87a54fd4">stored::BufferLayer::reset</a></div><div class="ttdeci">virtual void reset() override</div><div class="ttdoc">Reset the stack (top-down), and drop all messages. </div><div class="ttdef"><b>Definition:</b> <a href="protocol_8cpp_source.html#l01268">protocol.cpp:1268</a></div></div>
<div class="ttc" id="util_8h_html"><div class="ttname"><a href="util_8h.html">util.h</a></div></div>
<div class="ttc" id="classstored_1_1_ascii_escape_layer_html_a5acfb59ed33a8f0f3e27556421ff5245"><div class="ttname"><a href="classstored_1_1_ascii_escape_layer.html#a5acfb59ed33a8f0f3e27556421ff5245">stored::AsciiEscapeLayer::decode</a></div><div class="ttdeci">virtual void decode(void *buffer, size_t len) override</div><div class="ttdoc">Decode a frame and forward the decoded frame to the upper layer. </div><div class="ttdef"><b>Definition:</b> <a href="protocol_8cpp_source.html#l00074">protocol.cpp:74</a></div></div>
<div class="ttc" id="classstored_1_1_crc8_layer_html_ac3bb509c6ebf1a8c9c98f4985ea91bde"><div class="ttname"><a href="classstored_1_1_crc8_layer.html#ac3bb509c6ebf1a8c9c98f4985ea91bde">stored::Crc8Layer::mtu</a></div><div class="ttdeci">virtual size_t mtu() const override</div><div class="ttdoc">Returns the maximum amount of data to be put in one message that is encoded. </div><div class="ttdef"><b>Definition:</b> <a href="protocol_8cpp_source.html#l01157">protocol.cpp:1157</a></div></div>
<div class="ttc" id="namespaceed2_1_1gui_1_1____main_____html_a11587f112b0486278fe041290b1db064"><div class="ttname"><a href="namespaceed2_1_1gui_1_1____main____.html#a11587f112b0486278fe041290b1db064">ed2.gui.__main__.res</a></div><div class="ttdeci">res</div><div class="ttdef"><b>Definition:</b> <a href="build_2lib_2ed2_2gui_2____main_____8py_source.html#l00178">__main__.py:178</a></div></div>
<div class="ttc" id="classstored_1_1_poller_html_a28a96951d17fc9795ec7f81ad931dc0e"><div class="ttname"><a href="classstored_1_1_poller.html#a28a96951d17fc9795ec7f81ad931dc0e">stored::Poller::Result</a></div><div class="ttdeci">std::vector&lt; zmq_poller_event_t &gt; Result</div><div class="ttdef"><b>Definition:</b> <a href="poller_8h_source.html#l00227">poller.h:227</a></div></div>
<div class="ttc" id="group__libstored__util_html_ga6953f0800ee0798ebed8c960e3412d17"><div class="ttname"><a href="group__libstored__util.html#ga6953f0800ee0798ebed8c960e3412d17">stored::string_literal</a></div><div class="ttdeci">std::string string_literal(void const *buffer, size_t len, char const *prefix=nullptr)</div><div class="ttdoc">Converts the given buffer to a string literal. </div><div class="ttdef"><b>Definition:</b> <a href="util_8cpp_source.html#l00129">util.cpp:129</a></div></div>
<div class="ttc" id="classstored_1_1_crc8_layer_html_a92eeb73a06af54090715da5f336a2217"><div class="ttname"><a href="classstored_1_1_crc8_layer.html#a92eeb73a06af54090715da5f336a2217">stored::Crc8Layer::compute</a></div><div class="ttdeci">static uint8_t compute(uint8_t input, uint8_t crc=init)</div><div class="ttdef"><b>Definition:</b> <a href="protocol_8cpp_source.html#l01152">protocol.cpp:1152</a></div></div>
<div class="ttc" id="classstored_1_1_debug_arq_layer_html_a4f99570d92e54c761f31f330968187fb"><div class="ttname"><a href="classstored_1_1_debug_arq_layer.html#a4f99570d92e54c761f31f330968187fb">stored::DebugArqLayer::encodeSeq</a></div><div class="ttdeci">static size_t encodeSeq(uint32_t seq, void *buffer)</div><div class="ttdoc">Encode a sequence number into a buffer. </div><div class="ttdef"><b>Definition:</b> <a href="protocol_8cpp_source.html#l01056">protocol.cpp:1056</a></div></div>
<div class="ttc" id="classstored_1_1_arq_layer_html_a1d3b18fc5b159e527b087385ac961e52a67b425c96fa51d033359fbea7f1c344a"><div class="ttname"><a href="classstored_1_1_arq_layer.html#a1d3b18fc5b159e527b087385ac961e52a67b425c96fa51d033359fbea7f1c344a">stored::ArqLayer::EventRetransmit</a></div><div class="ttdoc">RetransmitCallbackThreshold has been reached on the current message. </div><div class="ttdef"><b>Definition:</b> <a href="protocol_8h_source.html#l00559">protocol.h:559</a></div></div>
<div class="ttc" id="classstored_1_1_terminal_layer_html_a16632f9e5395384bc8db6940eb26259f"><div class="ttname"><a href="classstored_1_1_terminal_layer.html#a16632f9e5395384bc8db6940eb26259f">stored::TerminalLayer::EscEnd</a></div><div class="ttdeci">static char const EscEnd</div><div class="ttdef"><b>Definition:</b> <a href="protocol_8h_source.html#l00370">protocol.h:370</a></div></div>
<div class="ttc" id="classstored_1_1_poller_html_a04390a8167a3ede3ea54b7d0879bdd1d"><div class="ttname"><a href="classstored_1_1_poller.html#a04390a8167a3ede3ea54b7d0879bdd1d">stored::Poller::remove</a></div><div class="ttdeci">int remove(int fd)</div><div class="ttdef"><b>Definition:</b> <a href="poller_8cpp_source.html#l00195">poller.cpp:195</a></div></div>
<div class="ttc" id="classstored_1_1_crc8_layer_html_af9a6cc6ac539027ee452c485611ec0ac"><div class="ttname"><a href="classstored_1_1_crc8_layer.html#af9a6cc6ac539027ee452c485611ec0ac">stored::Crc8Layer::reset</a></div><div class="ttdeci">virtual void reset() override</div><div class="ttdoc">Reset the stack (top-down), and drop all messages. </div><div class="ttdef"><b>Definition:</b> <a href="protocol_8cpp_source.html#l01118">protocol.cpp:1118</a></div></div>
<div class="ttc" id="classstored_1_1_debug_arq_layer_html_a87a309300610933db0afa522a0ae517a"><div class="ttname"><a href="classstored_1_1_debug_arq_layer.html#a87a309300610933db0afa522a0ae517a">stored::DebugArqLayer::ResetFlag</a></div><div class="ttdeci">static uint8_t const ResetFlag</div><div class="ttdef"><b>Definition:</b> <a href="protocol_8h_source.html#l00733">protocol.h:733</a></div></div>
<div class="ttc" id="classstored_1_1_arq_layer_html_a06104ba40460c0852457bbe651ddba48"><div class="ttname"><a href="classstored_1_1_arq_layer.html#a06104ba40460c0852457bbe651ddba48">stored::ArqLayer::transmit</a></div><div class="ttdeci">bool transmit()</div><div class="ttdoc">(Re)transmits the first message in the queue. </div><div class="ttdef"><b>Definition:</b> <a href="protocol_8cpp_source.html#l00585">protocol.cpp:585</a></div></div>
<div class="ttc" id="util_8h_html_a5e97f6533b7a0a1e8b49c4cea10f75fc"><div class="ttname"><a href="util_8h.html#a5e97f6533b7a0a1e8b49c4cea10f75fc">is_default</a></div><div class="ttdeci">#define is_default</div><div class="ttdef"><b>Definition:</b> <a href="util_8h_source.html#l00170">util.h:170</a></div></div>
<div class="ttc" id="classstored_1_1_crc8_layer_html_a3278e564ad9394b851dc727d9891bdaca1631c674509e8d7d495cab564f1cd8eb"><div class="ttname"><a href="classstored_1_1_crc8_layer.html#a3278e564ad9394b851dc727d9891bdaca1631c674509e8d7d495cab564f1cd8eb">stored::Crc8Layer::init</a></div><div class="ttdef"><b>Definition:</b> <a href="protocol_8h_source.html#l00786">protocol.h:786</a></div></div>
<div class="ttc" id="classstored_1_1_polled_layer_html_a21006ea40e3651fb8ce21e28126b0ec8"><div class="ttname"><a href="classstored_1_1_polled_layer.html#a21006ea40e3651fb8ce21e28126b0ec8">stored::PolledLayer::~PolledLayer</a></div><div class="ttdeci">virtual ~PolledLayer() override</div><div class="ttdef"><b>Definition:</b> <a href="protocol_8cpp_source.html#l01445">protocol.cpp:1445</a></div></div>
<div class="ttc" id="classstored_1_1_arq_layer_html_a1d3b18fc5b159e527b087385ac961e52ad7a25330d281170fe07445ea0b491f05"><div class="ttname"><a href="classstored_1_1_arq_layer.html#a1d3b18fc5b159e527b087385ac961e52ad7a25330d281170fe07445ea0b491f05">stored::ArqLayer::EventNone</a></div><div class="ttdoc">No event. </div><div class="ttdef"><b>Definition:</b> <a href="protocol_8h_source.html#l00535">protocol.h:535</a></div></div>
<div class="ttc" id="classstored_1_1_print_layer_html_aea312a1d43697789e614a761927288f9"><div class="ttname"><a href="classstored_1_1_print_layer.html#aea312a1d43697789e614a761927288f9">stored::PrintLayer::setFile</a></div><div class="ttdeci">void setFile(FILE *f)</div><div class="ttdoc">Set the FILE to write to. </div><div class="ttdef"><b>Definition:</b> <a href="protocol_8cpp_source.html#l01369">protocol.cpp:1369</a></div></div>
<div class="ttc" id="classstored_1_1_terminal_layer_html_ac734cdbc0cc6331ae456a530485d619a"><div class="ttname"><a href="classstored_1_1_terminal_layer.html#ac734cdbc0cc6331ae456a530485d619a">stored::TerminalLayer::encodeStart</a></div><div class="ttdeci">void encodeStart()</div><div class="ttdoc">Emits a start-of-frame sequence if it hasn&amp;#39;t done yet. </div><div class="ttdef"><b>Definition:</b> <a href="protocol_8cpp_source.html#l00293">protocol.cpp:293</a></div></div>
<div class="ttc" id="classstored_1_1_ascii_escape_layer_html_ad942b156ae7ac142b44f742ed5dca3a9"><div class="ttname"><a href="classstored_1_1_ascii_escape_layer.html#ad942b156ae7ac142b44f742ed5dca3a9">stored::AsciiEscapeLayer::base</a></div><div class="ttdeci">ProtocolLayer base</div><div class="ttdef"><b>Definition:</b> <a href="protocol_8h_source.html#l00332">protocol.h:332</a></div></div>
<div class="ttc" id="classstored_1_1_polled_layer_html_af5b7fffdba945fa6063da0e4accd0ace"><div class="ttname"><a href="classstored_1_1_polled_layer.html#af5b7fffdba945fa6063da0e4accd0ace">stored::PolledLayer::close</a></div><div class="ttdeci">virtual void close()</div><div class="ttdef"><b>Definition:</b> <a href="protocol_8h_source.html#l00968">protocol.h:968</a></div></div>
<div class="ttc" id="namespacestored_html"><div class="ttname"><a href="namespacestored.html">stored</a></div><div class="ttdef"><b>Definition:</b> <a href="compress_8h_source.html#l00026">compress.h:26</a></div></div>
<div class="ttc" id="classstored_1_1_poller_html_a34425a048a7959779ae5ec1df09c633d"><div class="ttname"><a href="classstored_1_1_poller.html#a34425a048a7959779ae5ec1df09c633d">stored::Poller::poll</a></div><div class="ttdeci">Result const  &amp; poll(long timeout_us=-1, bool suspend=false)</div><div class="ttdef"><b>Definition:</b> <a href="poller_8cpp_source.html#l00508">poller.cpp:508</a></div></div>
<div class="ttc" id="classstored_1_1_print_layer_html_aa77d727ebfa1e502f9383ab717b9724d"><div class="ttname"><a href="classstored_1_1_print_layer.html#aa77d727ebfa1e502f9383ab717b9724d">stored::PrintLayer::PrintLayer</a></div><div class="ttdeci">PrintLayer(PrintLayer const &amp;)=delete</div><div class="ttdoc">Deleted copy constructor. </div></div>
<div class="ttc" id="classstored_1_1_arq_layer_html_aae0973f22504fbff0b98fefec8d53013"><div class="ttname"><a href="classstored_1_1_arq_layer.html#aae0973f22504fbff0b98fefec8d53013">stored::ArqLayer::decode</a></div><div class="ttdeci">virtual void decode(void *buffer, size_t len) override</div><div class="ttdoc">Decode a frame and forward the decoded frame to the upper layer. </div><div class="ttdef"><b>Definition:</b> <a href="protocol_8cpp_source.html#l00483">protocol.cpp:483</a></div></div>
<div class="ttc" id="classstored_1_1_poller_html_a64dc1f4e5440d90ddaa1c971ed636fac"><div class="ttname"><a href="classstored_1_1_poller.html#a64dc1f4e5440d90ddaa1c971ed636fac">stored::Poller::PollIn</a></div><div class="ttdeci">static events_t const PollIn</div><div class="ttdef"><b>Definition:</b> <a href="poller_8h_source.html#l00102">poller.h:102</a></div></div>
<div class="ttc" id="classstored_1_1_arq_layer_html_a5afc54c8eec96b06ba9c0a99d4dca7c1a6a87d422220f79f0357e0f9c8d2dce8b"><div class="ttname"><a href="classstored_1_1_arq_layer.html#a5afc54c8eec96b06ba9c0a99d4dca7c1a6a87d422220f79f0357e0f9c8d2dce8b">stored::ArqLayer::EncodeStateEncoding</a></div><div class="ttdef"><b>Definition:</b> <a href="protocol_8h_source.html#l00612">protocol.h:612</a></div></div>
<div class="ttc" id="classstored_1_1_file_layer_html_a653122ce5a77c5d5999008337bce58b7"><div class="ttname"><a href="classstored_1_1_file_layer.html#a653122ce5a77c5d5999008337bce58b7">stored::FileLayer::isOpen</a></div><div class="ttdeci">virtual bool isOpen() const override</div><div class="ttdef"><b>Definition:</b> <a href="protocol_8cpp_source.html#l01603">protocol.cpp:1603</a></div></div>
<div class="ttc" id="classstored_1_1_ascii_escape_layer_html_a67ca09a867826eb4f22e9b7f78ceb0b6"><div class="ttname"><a href="classstored_1_1_ascii_escape_layer.html#a67ca09a867826eb4f22e9b7f78ceb0b6">stored::AsciiEscapeLayer::needEscape</a></div><div class="ttdeci">char needEscape(char c) const</div><div class="ttdef"><b>Definition:</b> <a href="protocol_8cpp_source.html#l00119">protocol.cpp:119</a></div></div>
<div class="ttc" id="classstored_1_1_print_layer_html_af92198162e84a80d70afbd76143df369"><div class="ttname"><a href="classstored_1_1_print_layer.html#af92198162e84a80d70afbd76143df369">stored::PrintLayer::decode</a></div><div class="ttdeci">virtual void decode(void *buffer, size_t len) override</div><div class="ttdoc">Decode a frame and forward the decoded frame to the upper layer. </div><div class="ttdef"><b>Definition:</b> <a href="protocol_8cpp_source.html#l01331">protocol.cpp:1331</a></div></div>
<div class="ttc" id="classstored_1_1_protocol_layer_html"><div class="ttname"><a href="classstored_1_1_protocol_layer.html">stored::ProtocolLayer</a></div><div class="ttdoc">Protocol layer base class. </div><div class="ttdef"><b>Definition:</b> <a href="protocol_8h_source.html#l00162">protocol.h:162</a></div></div>
<div class="ttc" id="classstored_1_1_debug_arq_layer_html_a2dc5a377d6c5f636cd0e3cf4343ddea4"><div class="ttname"><a href="classstored_1_1_debug_arq_layer.html#a2dc5a377d6c5f636cd0e3cf4343ddea4">stored::DebugArqLayer::decode</a></div><div class="ttdeci">virtual void decode(void *buffer, size_t len) override</div><div class="ttdoc">Decode a frame and forward the decoded frame to the upper layer. </div><div class="ttdef"><b>Definition:</b> <a href="protocol_8cpp_source.html#l00821">protocol.cpp:821</a></div></div>
<div class="ttc" id="classstored_1_1_crc8_layer_html_a53910dd8cb7f74db64011b5918c8c52a"><div class="ttname"><a href="classstored_1_1_crc8_layer.html#a53910dd8cb7f74db64011b5918c8c52a">stored::Crc8Layer::decode</a></div><div class="ttdeci">virtual void decode(void *buffer, size_t len) override</div><div class="ttdoc">Decode a frame and forward the decoded frame to the upper layer. </div><div class="ttdef"><b>Definition:</b> <a href="protocol_8cpp_source.html#l01123">protocol.cpp:1123</a></div></div>
<div class="ttc" id="classstored_1_1_crc16_layer_html_afc268baaaa18446a10a8ab23bf04e967"><div class="ttname"><a href="classstored_1_1_crc16_layer.html#afc268baaaa18446a10a8ab23bf04e967">stored::Crc16Layer::decode</a></div><div class="ttdeci">virtual void decode(void *buffer, size_t len) override</div><div class="ttdoc">Decode a frame and forward the decoded frame to the upper layer. </div><div class="ttdef"><b>Definition:</b> <a href="protocol_8cpp_source.html#l01208">protocol.cpp:1208</a></div></div>
<div class="ttc" id="classstored_1_1_debug_arq_layer_html_a036abba40a16df72e93b9fd9a9251bbb"><div class="ttname"><a href="classstored_1_1_debug_arq_layer.html#a036abba40a16df72e93b9fd9a9251bbb">stored::DebugArqLayer::setPurgeableResponse</a></div><div class="ttdeci">virtual void setPurgeableResponse(bool purgeable=true) override</div><div class="ttdoc">Flags the current response as purgeable. </div><div class="ttdef"><b>Definition:</b> <a href="protocol_8cpp_source.html#l00976">protocol.cpp:976</a></div></div>
<div class="ttc" id="classstored_1_1_terminal_layer_html_a3708a9baaf0751fd543e8290f6b008c3"><div class="ttname"><a href="classstored_1_1_terminal_layer.html#a3708a9baaf0751fd543e8290f6b008c3">stored::TerminalLayer::nonDebugDecode</a></div><div class="ttdeci">virtual void nonDebugDecode(void *buffer, size_t len)</div><div class="ttdoc">Receptor of non-debug data during decode(). </div><div class="ttdef"><b>Definition:</b> <a href="protocol_8cpp_source.html#l00276">protocol.cpp:276</a></div></div>
<div class="ttc" id="classstored_1_1_terminal_layer_html_a553f973e434533d14c48f898cc9d6d36"><div class="ttname"><a href="classstored_1_1_terminal_layer.html#a553f973e434533d14c48f898cc9d6d36">stored::TerminalLayer::encodeEnd</a></div><div class="ttdeci">void encodeEnd()</div><div class="ttdoc">Emits an end-of-frame sequence of the frame started using encodeStart(). </div><div class="ttdef"><b>Definition:</b> <a href="protocol_8cpp_source.html#l00305">protocol.cpp:305</a></div></div>
<div class="ttc" id="classstored_1_1_poller_html_a6d543d60c57a87422fdda7b8ea299b84"><div class="ttname"><a href="classstored_1_1_poller.html#a6d543d60c57a87422fdda7b8ea299b84">stored::Poller::events_t</a></div><div class="ttdeci">unsigned short events_t</div><div class="ttdef"><b>Definition:</b> <a href="poller_8h_source.html#l00099">poller.h:99</a></div></div>
<div class="ttc" id="classstored_1_1_protocol_layer_html_a66c24cec6a17c44fac68213d358a5aa8"><div class="ttname"><a href="classstored_1_1_protocol_layer.html#a66c24cec6a17c44fac68213d358a5aa8">stored::ProtocolLayer::encode</a></div><div class="ttdeci">void encode()</div><div class="ttdoc">Encodes the last part of the current frame. </div><div class="ttdef"><b>Definition:</b> <a href="protocol_8h_source.html#l00250">protocol.h:250</a></div></div>
<div class="ttc" id="classstored_1_1_file_layer_html_ac1a3bb7c1dd0c85bde2072288f30024d"><div class="ttname"><a href="classstored_1_1_file_layer.html#ac1a3bb7c1dd0c85bde2072288f30024d">stored::FileLayer::fd_r</a></div><div class="ttdeci">fd_type fd_r() const</div><div class="ttdef"><b>Definition:</b> <a href="protocol_8cpp_source.html#l01665">protocol.cpp:1665</a></div></div>
<div class="ttc" id="classstored_1_1_polled_layer_html"><div class="ttname"><a href="classstored_1_1_polled_layer.html">stored::PolledLayer</a></div><div class="ttdef"><b>Definition:</b> <a href="protocol_8h_source.html#l00934">protocol.h:934</a></div></div>
<div class="ttc" id="classstored_1_1_arq_layer_html_a1d3b18fc5b159e527b087385ac961e52"><div class="ttname"><a href="classstored_1_1_arq_layer.html#a1d3b18fc5b159e527b087385ac961e52">stored::ArqLayer::Event</a></div><div class="ttdeci">Event</div><div class="ttdef"><b>Definition:</b> <a href="protocol_8h_source.html#l00531">protocol.h:531</a></div></div>
<div class="ttc" id="classstored_1_1_crc8_layer_html_a5f87d2e04db6efb8d91e72d89266ef73"><div class="ttname"><a href="classstored_1_1_crc8_layer.html#a5f87d2e04db6efb8d91e72d89266ef73">stored::Crc8Layer::Crc8Layer</a></div><div class="ttdeci">Crc8Layer(Crc8Layer const &amp;)=delete</div><div class="ttdoc">Deleted copy constructor. </div></div>
<div class="ttc" id="classstored_1_1_arq_layer_html_a72a34dd87ec3fcee83db2a44f7e8a8e5"><div class="ttname"><a href="classstored_1_1_arq_layer.html#a72a34dd87ec3fcee83db2a44f7e8a8e5">stored::ArqLayer::didTransmit</a></div><div class="ttdeci">bool didTransmit() const</div><div class="ttdoc">Checks if a full message has been transmitted. </div><div class="ttdef"><b>Definition:</b> <a href="protocol_8cpp_source.html#l00663">protocol.cpp:663</a></div></div>
<div class="ttc" id="classstored_1_1_poller_html_aaae1953951626d294a17b65164794d92"><div class="ttname"><a href="classstored_1_1_poller.html#aaae1953951626d294a17b65164794d92">stored::Poller::PollHup</a></div><div class="ttdeci">static events_t const PollHup</div><div class="ttdef"><b>Definition:</b> <a href="poller_8h_source.html#l00105">poller.h:105</a></div></div>
<div class="ttc" id="classstored_1_1_terminal_layer_html_a2a0470a57c3c8065cb28b49d9101d533"><div class="ttname"><a href="classstored_1_1_terminal_layer.html#a2a0470a57c3c8065cb28b49d9101d533">stored::TerminalLayer::nonDebugEncode</a></div><div class="ttdeci">virtual void nonDebugEncode(void *buffer, size_t len)</div><div class="ttdef"><b>Definition:</b> <a href="protocol_8cpp_source.html#l00266">protocol.cpp:266</a></div></div>
<div class="ttc" id="classstored_1_1impl_1_1_loopback1_html_ac2f4ef6e8200a9391d6c04728922198b"><div class="ttname"><a href="classstored_1_1impl_1_1_loopback1.html#ac2f4ef6e8200a9391d6c04728922198b">stored::impl::Loopback1::reset</a></div><div class="ttdeci">void reset() override final</div><div class="ttdoc">Reset the stack (top-down), and drop all messages. </div><div class="ttdef"><b>Definition:</b> <a href="protocol_8cpp_source.html#l01399">protocol.cpp:1399</a></div></div>
<div class="ttc" id="classstored_1_1_protocol_layer_html_a357b029311be09df61e019682a848ab5"><div class="ttname"><a href="classstored_1_1_protocol_layer.html#a357b029311be09df61e019682a848ab5">stored::ProtocolLayer::decode</a></div><div class="ttdeci">virtual void decode(void *buffer, size_t len)</div><div class="ttdoc">Decode a frame and forward the decoded frame to the upper layer. </div><div class="ttdef"><b>Definition:</b> <a href="protocol_8h_source.html#l00242">protocol.h:242</a></div></div>
<div class="ttc" id="classstored_1_1_arq_layer_html_a1d3b18fc5b159e527b087385ac961e52a695faff43603c7debd9ac61f8b607c99"><div class="ttname"><a href="classstored_1_1_arq_layer.html#a1d3b18fc5b159e527b087385ac961e52a695faff43603c7debd9ac61f8b607c99">stored::ArqLayer::EventReconnect</a></div><div class="ttdoc">An unexpected reset message has been received. </div><div class="ttdef"><b>Definition:</b> <a href="protocol_8h_source.html#l00543">protocol.h:543</a></div></div>
<div class="ttc" id="namespaceed2_1_1cli_1_1____main_____html_a7dd4a7db291fe246593191db75b1fdca"><div class="ttname"><a href="namespaceed2_1_1cli_1_1____main____.html#a7dd4a7db291fe246593191db75b1fdca">ed2.cli.__main__.prefix</a></div><div class="ttdeci">string prefix</div><div class="ttdef"><b>Definition:</b> <a href="build_2lib_2ed2_2cli_2____main_____8py_source.html#l00045">__main__.py:45</a></div></div>
<div class="ttc" id="classstored_1_1_protocol_layer_html_a7d2f0987462196f77ca9067c050db09d"><div class="ttname"><a href="classstored_1_1_protocol_layer.html#a7d2f0987462196f77ca9067c050db09d">stored::ProtocolLayer::wrap</a></div><div class="ttdeci">void wrap(ProtocolLayer &amp;up)</div><div class="ttdoc">Sets the up/down layers of this layer and the given layer, such that this layer wraps the given one...</div><div class="ttdef"><b>Definition:</b> <a href="protocol_8h_source.html#l00195">protocol.h:195</a></div></div>
<div class="ttc" id="classstored_1_1impl_1_1_loopback1_html_a9ba9fec3c3b31d3cc7a09086ee70fdc8"><div class="ttname"><a href="classstored_1_1impl_1_1_loopback1.html#a9ba9fec3c3b31d3cc7a09086ee70fdc8">stored::impl::Loopback1::Loopback1</a></div><div class="ttdeci">Loopback1(Loopback1 const &amp;)=delete</div><div class="ttdoc">Deleted copy constructor. </div></div>
<div class="ttc" id="classstored_1_1_segmentation_layer_html_a3d4b430c6dab20da295fb67dacf5451a"><div class="ttname"><a href="classstored_1_1_segmentation_layer.html#a3d4b430c6dab20da295fb67dacf5451a">stored::SegmentationLayer::reset</a></div><div class="ttdeci">virtual void reset() override</div><div class="ttdoc">Reset the stack (top-down), and drop all messages. </div><div class="ttdef"><b>Definition:</b> <a href="protocol_8cpp_source.html#l00342">protocol.cpp:342</a></div></div>
<div class="ttc" id="classstored_1_1_arq_layer_html_a9a411e363eaca7a8060277363feee51b"><div class="ttname"><a href="classstored_1_1_arq_layer.html#a9a411e363eaca7a8060277363feee51b">stored::ArqLayer::pushEncodeQueue</a></div><div class="ttdeci">void pushEncodeQueue(void const *buffer, size_t len)</div><div class="ttdoc">Push the given buffer into the encode queue. </div><div class="ttdef"><b>Definition:</b> <a href="protocol_8cpp_source.html#l00725">protocol.cpp:725</a></div></div>
<div class="ttc" id="classstored_1_1_poller_html_a7fe572aa2ac38892434063776cf3b09d"><div class="ttname"><a href="classstored_1_1_poller.html#a7fe572aa2ac38892434063776cf3b09d">stored::Poller::add</a></div><div class="ttdeci">int add(int fd, void *user_data, events_t events)</div><div class="ttdef"><b>Definition:</b> <a href="poller_8cpp_source.html#l00187">poller.cpp:187</a></div></div>
<div class="ttc" id="classstored_1_1_debug_arq_layer_html_a6b16bc8ebeb3d6e2bc3fa2fd42a82998"><div class="ttname"><a href="classstored_1_1_debug_arq_layer.html#a6b16bc8ebeb3d6e2bc3fa2fd42a82998">stored::DebugArqLayer::reset</a></div><div class="ttdeci">virtual void reset() override</div><div class="ttdoc">Reset the stack (top-down), and drop all messages. </div><div class="ttdef"><b>Definition:</b> <a href="protocol_8cpp_source.html#l00809">protocol.cpp:809</a></div></div>
<div class="ttc" id="classstored_1_1_file_layer_html_a4aebe2812c392f4b25d12aa16021a65f"><div class="ttname"><a href="classstored_1_1_file_layer.html#a4aebe2812c392f4b25d12aa16021a65f">stored::FileLayer::fd_w</a></div><div class="ttdeci">fd_type fd_w() const</div><div class="ttdef"><b>Definition:</b> <a href="protocol_8cpp_source.html#l01669">protocol.cpp:1669</a></div></div>
<div class="ttc" id="classstored_1_1_arq_layer_html_af8bb680d2105264eaf4b7103eb0a3319"><div class="ttname"><a href="classstored_1_1_arq_layer.html#af8bb680d2105264eaf4b7103eb0a3319">stored::ArqLayer::event</a></div><div class="ttdeci">virtual void event(Event e)</div><div class="ttdoc">Forward the given event to the registered callback, if any. </div><div class="ttdef"><b>Definition:</b> <a href="protocol_8cpp_source.html#l00612">protocol.cpp:612</a></div></div>
<div class="ttc" id="classstored_1_1_poller_html_a540da5e0b855335235527e751eb704c4"><div class="ttname"><a href="classstored_1_1_poller.html#a540da5e0b855335235527e751eb704c4">stored::Poller::PollErr</a></div><div class="ttdeci">static events_t const PollErr</div><div class="ttdef"><b>Definition:</b> <a href="poller_8h_source.html#l00104">poller.h:104</a></div></div>
<div class="ttc" id="classstored_1_1_arq_layer_html_ad50ec60b848261f45640a39380f3ed74a39ab31057c8c5eea4f5e0afb1a8fcbc7"><div class="ttname"><a href="classstored_1_1_arq_layer.html#ad50ec60b848261f45640a39380f3ed74a39ab31057c8c5eea4f5e0afb1a8fcbc7">stored::ArqLayer::RetransmitCallbackThreshold</a></div><div class="ttdoc">Number of successive retransmits before the event is emitted. </div><div class="ttdef"><b>Definition:</b> <a href="protocol_8h_source.html#l00516">protocol.h:516</a></div></div>
<div class="ttc" id="classstored_1_1_arq_layer_html_aa6414510a8e158dd1df01b8738ac565b"><div class="ttname"><a href="classstored_1_1_arq_layer.html#aa6414510a8e158dd1df01b8738ac565b">stored::ArqLayer::nextSeq</a></div><div class="ttdeci">static uint8_t nextSeq(uint8_t seq)</div><div class="ttdoc">Compute the next sequence number. </div><div class="ttdef"><b>Definition:</b> <a href="protocol_8cpp_source.html#l00636">protocol.cpp:636</a></div></div>
</div><!-- fragment --></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="dir_68267d1309a1af8e8297ef4c3efbcdba.html">src</a></li><li class="navelem"><a class="el" href="protocol_8cpp.html">protocol.cpp</a></li>
    <li class="footer">Generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.13 </li>
  </ul>
</div>
</body>
</html>
